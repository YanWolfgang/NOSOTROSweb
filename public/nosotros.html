<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Central — NOSOTROS</title>
<link rel="icon" type="image/png" href="/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="content fade-in" id="content">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem">
      <div><h1 style="color:var(--nosotros)"><i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> NOSOTROS</h1><p>Plataforma de contenido digital con IA</p></div>
    </div>
    <div class="module-tabs" id="modTabs">
      <button class="module-tab active" onclick="setModTab('generar')" id="tabGenerar">Generar</button>
      <button class="module-tab" onclick="setModTab('historial')">Historial</button>
    </div>
    <div id="modContent"></div>
  </main>
</div>
<script>
// ========== AUTH ==========
const token=localStorage.getItem('token');
if(!token){window.location.href='/index.html';}
const user=JSON.parse(localStorage.getItem('user')||'{}');
const hdrs={'Content-Type':'application/json','Authorization':'Bearer '+token};
const perms=(user.permissions||{}).nosotros||[];
const canCreate=user.role==='admin'||perms.includes('crear');
const canEdit=user.role==='admin'||perms.includes('editar');

// ========== SIDEBAR ==========
const BUSINESSES=[
  {id:'nosotros',name:'NOSOTROS',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',url:'/nosotros.html'},
  {id:'duelazo',name:'DUELAZO',icon:'<i class="feather" data-icon="activity" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#10B981',url:'/duelazo.html'},
  {id:'spacebox',name:'SPACEBOX',icon:'<i class="feather" data-icon="package" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#3B82F6',url:'/spacebox.html'},
  {id:'styly',name:'STYLY',icon:'<i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#EC4899',url:'/styly.html'}
];
function renderSidebar(){
  const bs=user.businesses||[];const isAdmin=user.role==='admin';
  const items=BUSINESSES.filter(b=>isAdmin||bs.includes(b.id));
  document.getElementById('sidebar').innerHTML=`
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-header"><h2>Panel <span>Central</span></h2></div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/dashboard.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Dashboard</a></div>`:
    `<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/profile.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="user" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Panel Individual</a></div>`}
    <div class="sidebar-section"><div class="sidebar-label">Negocios</div>
      ${items.map(b=>`<a href="${b.url}" class="sidebar-item ${b.id==='nosotros'?'active':''}" style="--accent:${b.color}"><span class="icon">${b.icon}</span>${b.name}</a>`).join('')}
    </div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">Admin</div><a href="/admin.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Usuarios</a></div>`:''}
    <div class="sidebar-footer">
      <div class="sidebar-avatar">${(user.name||'U')[0].toUpperCase()}</div>
      <div class="sidebar-user"><div class="name">${user.name||'Usuario'}</div><div class="role">${user.role||'editor'}</div></div>
      <button class="theme-btn" onclick="toggleTheme()"><i class="feather" data-icon="moon" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
      <button class="theme-btn" onclick="logout()" style="font-size:.75rem"><i class="feather" data-icon="share-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
    </div>`;
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
function toggleTheme(){const t=document.documentElement.getAttribute('data-theme')==='light'?'':'light';document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t)}
function logout(){localStorage.clear();window.location.href='/index.html'}
if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light');
renderSidebar();

// ========== CONFIG ==========
const SYS='Eres el equipo creativo de NOSOTROS, un medio digital mexicano. Lenguaje coloquial mexicano pero sin perder seriedad. Solo usa lenguaje muy casual para ejemplificar o enfatizar. Ganchos constantes y atractivo.';

const FORMATS=[
  {id:'carrusel',name:'Carrusel IG',icon:'<i class="feather" data-icon="smartphone" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#E1306C',
   desc:'Slides con hook, contexto y CTA para Instagram',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'noticias_hoy',name:'Noticias de Hoy',icon:'<i class="feather" data-icon="globe" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#1DA1F2',
   desc:'Resumen diario de noticias internacionales y Mexico',
   badges:['Web Search'],steps:['Noticias','Contenido'],
   scope:'both',ns:4,ac:0,ma:0},
  {id:'sketch',name:'Sketch',icon:'<i class="feather" data-icon="smile" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#FF6B35',
   desc:'Sketch con humor, satira e indicaciones visuales',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'nr',name:'NR Investigacion',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',
   desc:'Investigacion a profundidad con multiples posturas',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'youtube',name:'YouTube Largo',icon:'<i class="feather" data-icon="video" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#FF0000',
   desc:'Guion completo 12-15 min con timestamps y clips',
   badges:['Web Search','Angulos','Estructuras'],steps:['Noticias','Angulos','Estructura','Contenido'],
   scope:'mx',ns:1,ac:6,ma:3},
  {id:'noticia_manual',name:'Noticia Manual',icon:'<i class="feather" data-icon="edit" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#06B6D4',
   desc:'Pega la noticia, elige formato y genera contenido',
   badges:['Angulos','Formatos'],steps:['TextInput','FormatSel','Angulos','Contenido'],
   scope:null,ns:0,ac:5,ma:2},
  {id:'copy',name:'Copy & Titulo',icon:'<i class="feather" data-icon="edit-3" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#F59E0B',
   desc:'Copy para redes y titulo YouTube desde cualquier texto',
   badges:[],steps:['Texto','Contenido'],
   scope:null,ns:0,ac:0,ma:0}
];

const CATS=[
  {id:null,label:'Todas'},{id:'internacional',label:'Internacional'},{id:'economia',label:'Economia'},
  {id:'tecnologia',label:'Tecnologia'},{id:'deportes',label:'Deportes'},
  {id:'entretenimiento',label:'Entretenimiento'},{id:'salud',label:'Salud'},
  {id:'ciencia',label:'Ciencia'},{id:'guerra',label:'Guerra'},{id:'mexico',label:'Mexico'}
];

// ========== YOUTUBE MASTER PROMPT ==========
function buildYtPrompt(noticia, angulos, estructura) {
  const seccionesCustom = estructura ? `\nEstructura elegida: ${estructura.name}\nSecciones de la estructura: ${estructura.sections.join(' -> ')}\n\nADAPTA el contenido de los bloques de desarrollo a estas secciones, pero MANTIENE la estructura obligatoria de 12 secciones con hooks, rehooks y CTAs.` : '';
  return `Noticia: ${noticia}
Angulos elegidos: ${angulos}${seccionesCustom}

Eres un guionista experto en videos de noticias para YouTube optimizados para retencion y crecimiento. Genera un guion para el canal NOSOTROS siguiendo OBLIGATORIAMENTE esta estructura. No omitas ninguna seccion. No cambies el orden. No ignores los timestamps de rehooks ni CTAs.

FORMATO: El guion debe estar en formato de DOS COLUMNAS:
- COLUMNA IZQUIERDA: Dialogo/narracion exacta (lo que se dice)
- COLUMNA DERECHA: Notas visuales (que aparece en pantalla: graficas, B-roll, texto overlay, cambios de camara, efectos)

Velocidad de habla: ~150 palabras por minuto. Video de 10 minutos = ~1,500 palabras de guion.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# TITULO YOUTUBE
SEO optimizado, curiosidad irresistible, maximo 70 caracteres. Formulas: numeros, preguntas, palabras power ("revelado", "nadie habla de", "la verdad sobre"). NO clickbait falso.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## [0:00-0:03] SECCION 1: HOOK

Capturar atencion en 3 segundos. El espectador debe sentir que NO PUEDE irse.
- Hook TRIPLE: visual impactante + texto en pantalla + frase verbal, los tres al mismo tiempo
- Crear un "open loop": idea incompleta que el cerebro necesita cerrar
- NUNCA empieces con "Hola, bienvenidos..." ni con el nombre del canal
- NUNCA empieces con "Sabias que...?"
Formulas: Dato impactante / Declaracion contraintuitiva / Resultado primero / Confrontacion directa
VISUAL: Imagen o clip de alto impacto + texto grande con la frase clave

## [0:03-0:15] SECCION 2: AMPLIFICACION DEL HOOK + PROMESA

Expandir el hook. Decir EXACTAMENTE que va a obtener si se queda.
- Mencionar 3-4 puntos especificos que se cubriran (crea lista mental)
- Lenguaje de urgencia: "lo que nadie te esta contando", "lo que realmente esta pasando", "y lo mas grave"
- La promesa debe ser CONCRETA, no vaga
VISUAL: Transicion rapida, previews/flashes de lo que viene (graficas, mapas, clips)

## [0:15-2:00] SECCION 3: CONTEXTO RAPIDO

Dar contexto minimo para que CUALQUIER espectador entienda la noticia.
- Frases cortas y directas. Cada oracion aporta info nueva
- Ritmo rapido. No divagar
- Datos duros: fechas, numeros, nombres de actores clave
- Open loop al final que conecte con lo que viene
VISUAL: Graficas explicativas, mapas, timeline, texto con datos resaltados

## [~2:00] SECCION 4: REHOOK #1

Evitar primer drop-off. Reenganchar.
- "Pero lo que te voy a contar ahora es lo que realmente causo todo esto, y no es lo que piensas."
- "Y aqui es donde la historia se pone interesante..."
- "Pero eso no es lo peor. Lo peor es lo que viene..."
VISUAL: Cambio de escenario, zoom dramatico, nueva grafica, cambio de tono musical

## [2:00-5:00] SECCION 5: DESARROLLO BLOQUE 1

Primera parte del contenido principal.
- Sub-bloques de 60-90 segundos maximo. Cada uno responde UNA pregunta
- Progresion ASCENDENTE: cada punto mas impactante que el anterior
- Pattern interrupt cada 45-60 segundos: cambio de angulo, grafica nueva, clip, zoom, texto nuevo
- NUNCA mas de 60 segundos con el mismo encuadre estatico
VISUAL: Alternar: presentador -> grafica/dato -> clip/imagen -> presentador

## [~3:30-4:00] SECCION 6: CTA #1 SUSCRIPCION (entre el 40-50% del video)

NUNCA decir "suscribete y dale a la campanita" de forma generica.
El CTA debe ser CONTEXTUAL, conectado con el contenido que se acaba de ver.
- "Si te interesa estar al dia con [TEMA], suscribete porque vamos a estar cubriendo esto cada semana."
- "Si esto te esta pareciendo importante, un subscribe nos ayuda a seguir investigando estos temas."
VISUAL: Animacion sutil del boton de suscripcion. Maximo 5 segundos

## [~5:00] SECCION 7: REHOOK #2

Evitar "slump de mitad de video".
- "Ahora, hay algo que la mayoria de los medios no estan cubriendo..."
- "Pero espera, porque aqui es donde la cosa se pone realmente seria."
- "Ahora te voy a dar el dato que lo cambia todo..."
VISUAL: Pattern interrupt fuerte: cambio de musica, nueva animacion, texto impactante

## [5:00-8:00] SECCION 8: DESARROLLO BLOQUE 2

Analisis profundo. Lo que DIFERENCIA este video de solo leer la noticia.
- Perspectivas multiples, datos de fuentes oficiales, opiniones de expertos
- Conectar con el impacto real en la vida de las personas
- Pattern interrupts cada 45-60 segundos
VISUAL: Clips de declaraciones, graficas comparativas, mapas, screenshots de fuentes

## [~8:00] SECCION 9: REHOOK #3

Retener para el cierre y analisis final.
- "Y lo mas importante de todo esto..."
- "Pero aqui viene la parte que a mi mas me preocupa..."
- "Y esto nos lleva a la conclusion mas importante..."

## [8:00-11:00] SECCION 10: BLOQUE FINAL + ANALISIS

Analisis personal, perspectiva editorial, proyeccion.
- Opinion o perspectiva CLARA (no ambiguedad)
- Proyectar escenarios: "Si esto sigue asi..." / "Lo que podria pasar es..."
- Conectar con impacto humano y emocional

## [~9:00-10:00] SECCION 11: CTA #2 COMENTARIOS

Pregunta ESPECIFICA, no generica. Conectada con el contenido.
Dar 2 opciones para que sea facil responder.
- "Tu que opinas? Crees que [ESCENARIO A] o que [ESCENARIO B]? Dejamelo en los comentarios."
- "En tu estado ya se esta sintiendo esto? Cuentame en los comentarios."

## [Ultimos 30s] SECCION 12: CIERRE + CTA FINAL + END SCREEN

1. Frase resumen POTENTE (1 oracion que resuma todo)
2. CTA: "Dale like si te sirvio, suscribete para no perderte la siguiente actualizacion."
3. Teaser proximo video: "Y si quieres entender [TEMA RELACIONADO], mira este video donde te lo explico a fondo."
4. End screen: tarjeta clicable (20 segundos)
VISUAL: End screen con thumbnail + animacion de suscripcion

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## DESCRIPCION YOUTUBE (OBLIGATORIO)

Genera descripcion completa siguiendo guidelines de YouTube SEO:
- Primeras 2-3 lineas (above the fold): resumen atractivo con keyword principal + CTA suscripcion
- Keyword principal en las primeras 25 palabras
- Longitud: 200-350 palabras

Estructura:
[2-3 lineas de resumen enganchante con keyword principal]

Suscribete a NOSOTROS: [LINK DEL CANAL]

En este video:
- [Punto 1 con keywords naturales]
- [Punto 2 con keywords naturales]
- [Punto 3 con keywords naturales]
- [Punto 4 con keywords naturales]

Timestamps:
0:00 — [Titulo seccion]
0:15 — [Titulo seccion]
2:00 — [Titulo seccion]
5:00 — [Titulo seccion]
8:00 — [Titulo seccion]

Fuentes:
- [Fuente 1]
- [Fuente 2]

Siguenos en redes:
- Instagram: [LINK]
- TikTok: [LINK]
- X/Twitter: [LINK]

#[HashtagPrincipal] #[Hashtag2] #[Hashtag3] #Nosotros #Noticias

Integrar 3-5 keywords secundarias naturalmente. NO incluir links de spam ni keywords stuffing.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 4 CLIPS PARA REDES SOCIALES (OBLIGATORIO)

Selecciona los 4 momentos mas potentes del guion. Priorizar: datos impactantes, declaraciones fuertes, momentos de tension, analisis que genere debate.

REGLAS:
- Duracion: 30-60 segundos cada clip (45-90 palabras)
- Cada clip debe funcionar de forma INDEPENDIENTE (alguien que no vio el video completo debe entenderlo)
- Cada clip debe terminar con un OPEN LOOP que haga querer ver el video completo
- El extracto debe ser 100% TEXTO EXACTO del guion, copiado literalmente. PROHIBIDO reescribir o parafrasear

Por cada clip:

CLIP [1/2/3/4]

TITULO YOUTUBE SHORTS:
[Max 70 caracteres, con keyword, curiosidad. Formulas: "Lo que nadie te dice sobre...", "La verdad sobre..."]

COPY PARA REDES (max 200 caracteres):
[1 emoji al inicio + hashtag principal + CTA: "Video completo en el canal" o "Link en bio"]

EXTRACTO EXACTO DEL GUION:
"[Copia EXACTAMENTE el fragmento. Palabra por palabra. No parafrasear.]"

TIMESTAMP EN EL VIDEO ORIGINAL:
[MM:SS - MM:SS]

POR QUE FUNCIONA COMO CLIP:
[1 linea]`;
}

// ========== STATE ==========
let S={view:'home',fid:null,step:0,phase:'input',ltxt:'',
  sq:'',cat:null,news:[],sn:new Set(),angles:[],sa:new Set(),
  structs:[],ss:null,result:'',itxt:'',err:null,selectedIds:new Set(),
  manual_news:'',manual_format:null,
  customAngle:'',
  analysis:null,analysisLoading:false};
let modTab='generar';
let newsPagination={page:1,pageSize:8,total:0,totalPages:0};

// ========== HELPERS ==========
function F(){return FORMATS.find(f=>f.id===S.fid)}
function getArticleId(article){return `${article.title}|${article.source}|${article.date}`}
function selN(){
  return S.news.filter((n,i)=>{
    const id=getArticleId(n);
    return S.selectedIds.has(id);
  })
}
function selA(){return[...S.sa].map(i=>S.angles[i])}
function pJ(t){const i=t.indexOf('{'),j=t.lastIndexOf('}');if(i===-1||j<=i)return null;try{return JSON.parse(t.substring(i,j+1))}catch{return null}}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function md(t){
  return esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/^### (.+)$/gm,'<h4>$1</h4>').replace(/^## (.+)$/gm,'<h3>$1</h3>').replace(/^# (.+)$/gm,'<h2>$1</h2>')
    .replace(/^---$/gm,'<hr>').replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>');
}

// ========== API ==========
async function apiNews(scope,category,page=1,pageSize=8){
  const r=await fetch('/api/nosotros/news-ai',{method:'POST',headers:hdrs,body:JSON.stringify({scope,category:category||undefined,page,pageSize})});
  const d=await r.json();if(d.error)throw new Error(d.error);
  if(d.pagination)newsPagination=d.pagination;
  return d.news||[];
}
async function apiGen(prompt,system,format_type){
  const r=await fetch('/api/nosotros/generate',{method:'POST',headers:hdrs,
    body:JSON.stringify({prompt,system:system||undefined,format_type:format_type||undefined})});
  const d=await r.json();if(d.error)throw new Error(d.error);return d.result||'';
}

// ========== MODULE TABS ==========
function setModTab(t){
  modTab=t;
  document.querySelectorAll('.module-tab').forEach((b,i)=>b.classList.toggle('active',(t==='generar'&&i===0)||(t==='historial'&&i===1)));
  if(t==='generar'){S.view='home';render()}
  else if(t==='historial'){loadHistory()}
}

let histSel=new Set();
let histPage=1,histPageSize=parseInt(localStorage.getItem('nosotros_hist_ps'))||10,histUserFilter='',histUsers=[];
async function loadHistory(){
  histSel.clear();
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    let url=`/api/nosotros/history?page=${histPage}&pageSize=${histPageSize}`;
    if(histUserFilter)url+=`&user_id=${histUserFilter}`;
    const r=await fetch(url,{headers:hdrs});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    const items=d.history||[];
    histUsers=d.users||histUsers;
    const pg=d.pagination||{page:1,totalPages:1,total:0};
    m.innerHTML=`
      <div class="hist-filters" style="display:flex;gap:.5rem;margin-bottom:.75rem;align-items:center;flex-wrap:wrap">
        <select onchange="histUserFilter=this.value;histPage=1;loadHistory()" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.8rem">
          <option value="">Todos los usuarios</option>
          ${histUsers.map(u=>`<option value="${u.id}" ${histUserFilter==u.id?'selected':''}>${esc(u.name)}</option>`).join('')}
        </select>
        <select onchange="histPageSize=+this.value;localStorage.setItem('nosotros_hist_ps',this.value);histPage=1;loadHistory()" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.8rem">
          <option value="5" ${histPageSize===5?'selected':''}>5 por pagina</option>
          <option value="10" ${histPageSize===10?'selected':''}>10 por pagina</option>
          <option value="20" ${histPageSize===20?'selected':''}>20 por pagina</option>
        </select>
        <span style="font-size:.75rem;color:var(--mt);margin-left:auto">${pg.total} resultado${pg.total!==1?'s':''}</span>
      </div>
      ${items.length?`
      ${canEdit?`<div style="display:flex;gap:.5rem;margin-bottom:.75rem;align-items:center;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:.35rem;cursor:pointer;font-size:.8rem;color:var(--mt)"><input type="checkbox" onchange="toggleAllHist(this.checked,${JSON.stringify(items.map(i=>i.id))})"> Seleccionar todos</label>
        <span id="histSelCount" style="font-size:.75rem;color:var(--mt)"></span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button id="btnBulkDel" onclick="bulkDelHistory()" style="display:none;background:#EF4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:.75rem;cursor:pointer">Eliminar seleccionados</button>
          <button onclick="delAllHistory()" style="background:none;border:1px solid #EF4444;color:#EF4444;border-radius:6px;padding:4px 12px;font-size:.75rem;cursor:pointer">Borrar todo</button>
        </div>
      </div>`:''}
      <div class="history-list">${items.map(h=>`
      <div class="history-item" style="position:relative">
        ${canEdit?`<input type="checkbox" data-hid="${h.id}" onchange="toggleHistSel(${h.id},this.checked)" style="position:absolute;top:.6rem;left:.5rem;cursor:pointer;accent-color:#EF4444">`:''}
        <div onclick="viewHistory(${h.id})" style="cursor:pointer;flex:1;${canEdit?'padding-left:1.5rem':''}">
          <div class="history-meta"><span>${h.format_type}</span><span style="color:var(--accent,#8B5CF6);font-weight:500">${esc(h.user_name||'Usuario')}</span><span>${new Date(h.created_at).toLocaleString('es-MX')}</span></div>
          <div class="history-preview">${esc(h.preview||'')}</div>
        </div>
        ${canEdit?`<button onclick="event.stopPropagation();delHistory(${h.id})" style="position:absolute;top:.5rem;right:.5rem;background:none;border:1px solid var(--border);border-radius:6px;color:var(--mt);cursor:pointer;padding:2px 6px;font-size:.7rem;transition:all .15s" onmouseover="this.style.borderColor='#EF4444';this.style.color='#EF4444'" onmouseout="this.style.borderColor='';this.style.color=''"><i class="feather" data-icon="trash-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>`:''}
      </div>`).join('')}</div>
      ${pg.totalPages>1?`<div style="display:flex;justify-content:center;gap:.4rem;margin-top:.75rem;flex-wrap:wrap">${Array.from({length:pg.totalPages},(_,i)=>i+1).map(p=>`<button onclick="histPage=${p};loadHistory()" style="padding:4px 10px;border-radius:6px;border:1px solid ${p===pg.page?'var(--accent,#8B5CF6)':'var(--border)'};background:${p===pg.page?'var(--accent,#8B5CF6)':'var(--card)'};color:${p===pg.page?'#fff':'var(--fg)'};cursor:pointer;font-size:.8rem">${p}</button>`).join('')}</div>`:''}`:'<p style="color:var(--mt);text-align:center;padding:2rem">No hay contenido generado aun.</p>'}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
function toggleHistSel(id,checked){if(checked)histSel.add(id);else histSel.delete(id);updHistSelUI()}
function toggleAllHist(checked,ids){histSel.clear();if(checked)ids.forEach(id=>histSel.add(id));document.querySelectorAll('[data-hid]').forEach(c=>c.checked=checked);updHistSelUI()}
function updHistSelUI(){const n=histSel.size;const c=document.getElementById('histSelCount');const b=document.getElementById('btnBulkDel');if(c)c.textContent=n?n+' seleccionado'+(n>1?'s':''):'';if(b)b.style.display=n?'inline-block':'none'}
async function bulkDelHistory(){if(!histSel.size)return;if(!confirm(`Eliminar ${histSel.size} elemento(s) del historial?`))return;try{const r=await fetch('/api/nosotros/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids:[...histSel]})});const d=await r.json();if(d.error)throw new Error(d.error);loadHistory()}catch(e){alert('Error: '+e.message)}}
async function delAllHistory(){if(!confirm('Eliminar TODO el historial de Nosotros? Esta accion no se puede deshacer.'))return;try{const r=await fetch('/api/nosotros/history?pageSize=9999',{headers:hdrs});const d=await r.json();const ids=(d.history||[]).map(h=>h.id);if(!ids.length)return;const r2=await fetch('/api/nosotros/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids})});const d2=await r2.json();if(d2.error)throw new Error(d2.error);loadHistory()}catch(e){alert('Error: '+e.message)}}

async function viewHistory(id){
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/nosotros/history/'+id,{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    const h=d.item;
    m.innerHTML=`<button class="btn-back" onclick="loadHistory()" style="margin-bottom:1rem">← Volver</button>
      <div class="result-box"><button class="copy-btn" onclick="cpText(this)"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button>
      <div class="result-content" data-raw="${esc(h.output_text)}">${md(h.output_text)}</div></div>`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}

async function delHistory(id){
  if(!confirm('Eliminar este contenido del historial?'))return;
  try{
    const r=await fetch('/api/nosotros/history/'+id,{method:'DELETE',headers:hdrs});
    if(!r.ok){const d=await r.json().catch(()=>({}));throw new Error(d.error||'Error HTTP '+r.status)}
    const d=await r.json();if(d.error)throw new Error(d.error);
    loadHistory();
  }catch(e){alert('Error al borrar: '+e.message)}
}

// ========== RENDER ==========
function render(){
  const m=document.getElementById('modContent');
  m.className='fade-in';
  m.innerHTML=S.view==='home'?rHome():rFlow();
  void m.offsetWidth;
  const si=document.getElementById('si');if(si)si.value=S.sq;
  const ti=document.getElementById('ti');if(ti)ti.value=S.itxt;
}

function rHome(){
  return`<div class="fmt-grid">${FORMATS.map(f=>`
    <div class="fmt-card" style="--c:${f.color}" onclick="goFmt('${f.id}')">
      <div class="fmt-icon">${f.icon}</div>
      <div class="fmt-name">${f.name}</div>
      <div class="fmt-desc">${f.desc}</div>
      ${f.badges.length?`<div class="fmt-badges">${f.badges.map(b=>`<span class="badge">${b}</span>`).join('')}</div>`:''}
    </div>`).join('')}</div>`;
}

function rFlow(){
  const f=F();
  return`<div style="--accent:${f.color}">
    <div class="flow-header">
      <button class="btn-back" onclick="goHome()">← Volver</button>
      <div class="flow-title"><span>${f.icon}</span> ${f.name}</div>
    </div>
    ${rSteps(f)}
    <div class="step-label">Paso ${S.step+1}: ${f.steps[S.step]}</div>
    ${S.err?`<div class="error-bar"><span>${esc(S.err)}</span><button onclick="clErr()">×</button></div>`:''}
    ${rContent(f)}
  </div>`;
}

function rSteps(f){
  let h='<div class="steps">';
  f.steps.forEach((s,i)=>{
    if(i>0)h+=`<div class="step-line ${i<=S.step?'done':''}"></div>`;
    h+=`<div class="step-dot ${i<S.step?'done':i===S.step?'active':''}">${i+1}</div>`;
  });
  return h+'</div>';
}

function rContent(f){
  if(S.phase==='loading')return`<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div><div class="loader-text">${S.ltxt}</div></div>`;
  if(S.phase==='result')return rResult();
  const st=f.steps[S.step];
  if(st==='Noticias'){
    if(S.news.length>0)return rNewsSel(f);
    return`<div class="actions"><button class="btn" onclick="retryFetch()">Reintentar carga de noticias</button></div>`;
  }
  if(st==='TextInput')return rManualNewsIn();
  if(st==='FormatSel')return rManualFormatSel();
  if(st==='Angulos')return rAngSel(f);
  if(st==='Estructura')return rStrSel();
  if(st==='Texto')return rTextIn();
  return'';
}

function rNewsSel(f){
  const n=f.ns,ok=S.selectedIds.size===n;
  const cats=`<div class="cats">${CATS.map(c=>`<button class="cat-btn ${S.cat===c.id?'active':''}" onclick="setCat(${c.id===null?'null':"'"+c.id+"'"})">${c.label}</button>`).join('')}</div>`;

  // Pagination controls
  const pag = newsPagination;
  const pagControls = pag.totalPages > 1 ? `
    <div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin-bottom:.75rem">
      <button class="btn-outline" ${pag.page===1?'disabled':''} onclick="changePage(${pag.page-1})" style="padding:4px 12px;font-size:.8rem">← Anterior</button>
      <span style="font-size:.8rem;color:var(--mt)">Página ${pag.page} de ${pag.totalPages}</span>
      <button class="btn-outline" ${pag.page===pag.totalPages?'disabled':''} onclick="changePage(${pag.page+1})" style="padding:4px 12px;font-size:.8rem">Siguiente →</button>
    </div>` : '';

  return`${cats}${pagControls}<p class="sel-hint">Selecciona ${n} noticia${n>1?'s':''} (${S.selectedIds.size}/${n})</p>
    <div class="sel-list">${S.news.map((nw,i)=>{
      const id=getArticleId(nw);
      return `<div class="sel-card ${S.selectedIds.has(id)?'on':''}" onclick="tgN(${i})">
        <div class="sel-check">${S.selectedIds.has(id)?'<i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>':''}</div>
        <div class="sel-body">
          <div class="sel-title">${esc(nw.title)}</div>
          <div class="sel-desc">${esc(nw.summary)}</div>
          <div class="sel-source">${esc(nw.source)} ${nw.date?'• '+formatNewsDate(nw.date):''}</div>
        </div></div>`;
    }).join('')}</div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="${f.steps[S.step+1]==='Contenido'?'goDirectContent()':'goAngles()'}">
      ${f.steps[S.step+1]==='Contenido'?'Generar contenido':'Generar angulos'}</button></div>`;
}

function rAngSel(f){
  const ok=S.sa.size>=1&&S.sa.size<=f.ma;
  const lbl=f.id==='youtube'?'Generar estructuras':f.id==='noticia_manual'?'Generar contenido':'Generar contenido';
  const nextFn=f.id==='noticia_manual'?'goManualFinalContent()':f.id==='youtube'?'goStructs()':'goFinalContent()';
  return`<p class="sel-hint">Selecciona 1-${f.ma} angulo${f.ma>1?'s':''} (${S.sa.size}/${f.ma})</p>
    <div class="sel-list">${S.angles.map((a,i)=>`
      <div class="sel-card ${S.sa.has(i)?'on':''}" onclick="tgA(${i})">
        <div class="sel-check">${S.sa.has(i)?'<i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>':''}</div>
        <div class="sel-body"><div class="sel-title">${esc(a.name)}</div><div class="sel-desc">${esc(a.description)}</div></div>
      </div>`).join('')}</div>
    <div style="margin-top:1rem;padding:1rem;border:1px dashed var(--border);border-radius:10px;background:rgba(255,255,255,0.03)">
      <div style="font-size:.8rem;font-weight:600;color:var(--mt);margin-bottom:.5rem">Agregar angulo propio</div>
      <div style="display:flex;gap:.5rem">
        <input type="text" id="customAngleInput" placeholder="Escribe tu angulo o enfoque..." value="${esc(S.customAngle)}" oninput="S.customAngle=this.value" onkeydown="if(event.key==='Enter'){event.preventDefault();addCustomAngle()}" style="flex:1;padding:.5rem .75rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-size:.85rem">
        <button onclick="addCustomAngle()" class="btn" style="white-space:nowrap;font-size:.8rem;padding:.5rem .75rem"><i class="fas fa-plus" style="margin-right:.25rem"></i>Agregar</button>
      </div>
    </div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="${nextFn}">${lbl}</button></div>`;
}

function rStrSel(){
  const ok=S.ss!==null;
  return`<p class="sel-hint">Selecciona 1 estructura</p>
    <div class="sel-list">${S.structs.map((s,i)=>`
      <div class="sel-card ${S.ss===i?'on':''}" onclick="selStr(${i})">
        <div class="sel-radio"></div>
        <div class="sel-body"><div class="sel-title">${esc(s.name)}</div><div class="sel-desc">${esc(s.description)}</div>
          ${s.sections?`<div class="sel-desc" style="margin-top:.25rem;opacity:.6;font-size:.75rem">${s.sections.map(x=>esc(x)).join(' → ')}</div>`:''}
        </div></div>`).join('')}</div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="goFinal()">Generar guion completo</button></div>`;
}

function rTextIn(){
  return`<textarea id="ti" class="ta" placeholder="Pega aqui el texto para generar copy y titulo..." oninput="S.itxt=this.value"></textarea>
    <div class="actions"><button class="btn" onclick="goCopy()">Generar copy y titulo</button></div>`;
}

function rManualNewsIn(){
  const html=`<textarea id="mn" class="ta" placeholder="Pega aqui la noticia que quieras convertir en contenido..." oninput="S.manual_news=this.value;render()">${esc(S.manual_news)}</textarea>
    <div class="actions"><button class="btn" ${S.manual_news.trim()?'':'disabled'} onclick="goManualFormatSel()">Siguiente paso</button></div>`;
  setTimeout(()=>{const ta=document.getElementById('mn');if(ta)ta.focus()},0);
  return html;
}

function rManualFormatSel(){
  const allowed=['carrusel','sketch','nr','youtube'];
  const allowedFormats=FORMATS.filter(f=>allowed.includes(f.id));
  const ok=S.manual_format!==null;
  return`<p class="sel-hint">Elige el formato para tu noticia</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem">
      ${allowedFormats.map((fmt,i)=>`
        <div class="fmt-card" ${S.manual_format===fmt.id?'style="border:2px solid '+fmt.color+';background:rgba(255,255,255,0.05)"':''} onclick="selManualFormat('${fmt.id}')" style="--c:${fmt.color};cursor:pointer;border:2px solid ${S.manual_format===fmt.id?fmt.color:'transparent'};transition:all 0.2s">
          <div class="fmt-icon">${fmt.icon}</div>
          <div class="fmt-name">${fmt.name}</div>
          <div class="fmt-desc" style="font-size:.75rem">${fmt.desc}</div>
        </div>`).join('')}
    </div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="goManualAngles()">Generar angulos</button></div>`;
}

function rResult(){
  let analysisHtml='';
  if(S.analysisLoading){
    analysisHtml=`<div class="analysis-bar" style="margin-top:1rem;padding:1rem;border-radius:12px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2)">
      <div style="display:flex;align-items:center;gap:.5rem;color:var(--nosotros)"><div class="loader-dots" style="display:flex;gap:4px"><span></span><span></span><span></span></div> Analizando viralidad...</div></div>`;
  }else if(S.analysis){
    const a=S.analysis;
    const scoreColor=a.score>=8?'#10B981':a.score>=5?'#F59E0B':'#EF4444';
    analysisHtml=`<div class="analysis-bar" style="margin-top:1rem;padding:1.25rem;border-radius:12px;background:rgba(139,92,246,0.06);border:1px solid rgba(139,92,246,0.15);backdrop-filter:blur(10px)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
        <div style="font-weight:600;font-size:.9rem;color:var(--text)"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:var(--nosotros)" aria-hidden="true"></i> Analisis de Viralidad</div>
        <div style="display:flex;align-items:center;gap:.5rem">
          <span style="font-size:1.5rem;font-weight:700;color:${scoreColor}">${a.score}</span>
          <span style="font-size:.8rem;color:var(--mt)">/10</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin-bottom:.75rem">
        <div style="padding:.6rem;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border)">
          <div style="font-size:.7rem;color:var(--mt);margin-bottom:.25rem">Engagement</div>
          <div style="font-weight:600;color:${a.engagement>=7?'#10B981':a.engagement>=4?'#F59E0B':'#EF4444'}">${a.engagement}/10</div>
        </div>
        <div style="padding:.6rem;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border)">
          <div style="font-size:.7rem;color:var(--mt);margin-bottom:.25rem">Noticia</div>
          <div style="font-weight:600;color:${a.news_quality>=7?'#10B981':a.news_quality>=4?'#F59E0B':'#EF4444'}">${a.news_quality}/10</div>
        </div>
        <div style="padding:.6rem;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border)">
          <div style="font-size:.7rem;color:var(--mt);margin-bottom:.25rem">Redaccion</div>
          <div style="font-weight:600;color:${a.writing>=7?'#10B981':a.writing>=4?'#F59E0B':'#EF4444'}">${a.writing}/10</div>
        </div>
      </div>
      <div style="font-size:.85rem;color:var(--text);line-height:1.5;margin-bottom:.75rem">
        <div style="font-weight:600;font-size:.75rem;color:var(--mt);margin-bottom:.35rem">Observaciones</div>
        ${a.observations.map(o=>'<div style="margin-bottom:.3rem">- '+esc(o)+'</div>').join('')}
      </div>
      <div style="margin-top:.75rem">
        <div style="font-weight:600;font-size:.75rem;color:var(--mt);margin-bottom:.35rem">Tus ajustes (opcional)</div>
        <textarea id="userAdjustments" placeholder="Escribe ajustes adicionales que quieras aplicar..." style="width:100%;min-height:60px;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:.8rem;resize:vertical;box-sizing:border-box"></textarea>
      </div>
      <button class="btn" onclick="improveResult()" style="width:100%;background:var(--nosotros);font-size:.85rem;padding:.6rem;margin-top:.5rem"><i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Mejorar basado en observaciones</button>
    </div>`;
  }else{
    analysisHtml=`<div style="margin-top:1rem"><button class="btn-outline btn" onclick="analyzeResult()" style="width:100%;border-color:var(--nosotros);color:var(--nosotros)"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Analizar viralidad con IA</button></div>`;
  }
  return`<div class="result-box">
    <button class="copy-btn" onclick="cpRes()"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button>
    <div class="result-content">${md(S.result)}</div></div>
    ${analysisHtml}
    <div class="actions"><button class="btn-outline btn" onclick="goHome()">Nuevo contenido</button></div>`;
}

// ========== HELPERS (Date formatting) ==========
function formatNewsDate(dateStr){
  if(!dateStr)return'';
  const d=new Date(dateStr);
  const today=new Date();today.setHours(0,0,0,0);
  const newsDate=new Date(d);newsDate.setHours(0,0,0,0);
  if(newsDate.getTime()===today.getTime())return'Hoy';
  const opts={month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'};
  return d.toLocaleDateString('es-MX',opts);
}

// ========== HANDLERS ==========
function goHome(){S={view:'home',fid:null,step:0,phase:'input',ltxt:'',sq:'',cat:null,news:[],sn:new Set(),angles:[],sa:new Set(),structs:[],ss:null,result:'',itxt:'',err:null,selectedIds:new Set(),manual_news:'',manual_format:null,customAngle:'',analysis:null,analysisLoading:false};newsPagination={page:1,pageSize:8,total:0,totalPages:0};render()}
function clErr(){S.err=null;render()}
function setCat(c){if(S.cat===c)return;S.cat=c;S.selectedIds=new Set();S.err=null;newsPagination.page=1;fetchN(F().scope,S.sq||undefined)}
function goFmt(id){
  S.view='flow';S.fid=id;S.step=0;S.news=[];S.sn=new Set();S.angles=[];S.sa=new Set();
  S.structs=[];S.ss=null;S.result='';S.err=null;S.sq='';S.cat=null;S.itxt='';S.selectedIds=new Set();
  S.manual_news='';S.manual_format=null;S.analysis=null;S.analysisLoading=false;
  newsPagination={page:1,pageSize:8,total:0,totalPages:0};
  const f=F();
  if(f.id==='copy'){S.phase='input';render();return}
  if(f.id==='noticia_manual'){S.phase='input';render();return}
  S.phase='loading';S.ltxt='Cargando noticias del dia...';render();fetchN(f.scope);
}
function retryFetch(){S.err=null;const f=F();newsPagination.page=1;S.phase='loading';S.ltxt='Cargando noticias...';render();fetchN(f.scope,S.sq||undefined)}
async function changePage(page){
  if(page<1||page>newsPagination.totalPages)return;
  newsPagination.page=page;
  // NO limpiar selecciones al cambiar página - mantener selecciones
  await fetchN(F().scope,S.sq||undefined,newsPagination.page);
}
async function fetchN(scope,query,page=1){
  S.phase='loading';S.ltxt='Buscando noticias actuales...';render();
  try{
    const news=await apiNews(scope,S.cat,page,newsPagination.pageSize);
    if(!news.length)throw new Error('No se encontraron noticias.');
    S.news=news;
    // Si es la primera página, limpiar selecciones. Si no, mantener las del usuario
    if(page===1)S.selectedIds=new Set();
    S.phase='select';
  }catch(e){S.err=e.message;S.phase='input';S.news=[]}
  render();
}
function tgN(i){
  const f=F();
  const article=S.news[i];
  const id=getArticleId(article);

  if(S.selectedIds.has(id)){
    S.selectedIds.delete(id);
  }else{
    if(f.ns===1)S.selectedIds.clear();
    if(S.selectedIds.size<f.ns)S.selectedIds.add(id);
  }
  render()
}
function tgA(i){const f=F();if(S.sa.has(i))S.sa.delete(i);else{if(S.sa.size<f.ma)S.sa.add(i)}render()}
function addCustomAngle(){const v=(S.customAngle||'').trim();if(!v)return;S.angles.push({id:S.angles.length+1,name:v,description:'Angulo personalizado'});S.sa.add(S.angles.length-1);S.customAngle='';render()}
function selStr(i){S.ss=i;render()}

async function goAngles(){
  const f=F(),news=selN();
  S.step=f.steps.indexOf('Angulos');S.phase='loading';S.ltxt='Generando angulos narrativos...';render();
  const nt=news.map(n=>`- ${n.title}: ${n.summary}`).join('\n');
  const prompt=news.length===1
    ?`Noticia:\n${nt}\n\nGenera ${f.ac} angulos narrativos distintos. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`
    :`Noticias:\n${nt}\n\nGenera ${f.ac} angulos narrativos generales para este conjunto. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.angles)throw new Error('No se pudieron parsear angulos');S.angles=p.angles;S.phase='select'}
  catch(e){S.err=e.message;S.step=0;S.phase='select'}render();
}

async function goNext(){if(F().id==='youtube')await goStructs();else await goFinalContent()}

async function goStructs(){
  const f=F(),news=selN(),ang=selA();
  S.step=f.steps.indexOf('Estructura');S.phase='loading';S.ltxt='Generando estructuras...';render();
  const n=news[0],at=ang.map(a=>a.name).join(', ');
  const prompt=`Noticia: ${n.title} - ${n.summary}\nAngulos: ${at}\n\nGenera 4 estructuras de storytelling para video YouTube de 10 minutos. Cada estructura propone una forma diferente de organizar el CONTENIDO DE DESARROLLO del video (los bloques donde se profundiza la noticia).\n\nEl video SIEMPRE tendra esta estructura fija:\n- Hook (0:00-0:03)\n- Amplificacion + Promesa (0:03-0:15)\n- Contexto rapido (0:15-2:00)\n- Rehook #1 (~2:00)\n- DESARROLLO BLOQUE 1 (2:00-5:00) ← las secciones que generes van AQUI\n- CTA suscripcion (~3:30)\n- Rehook #2 (~5:00)\n- DESARROLLO BLOQUE 2 (5:00-8:00) ← y AQUI\n- Rehook #3 (~8:00)\n- BLOQUE FINAL + Analisis (8:00-11:00) ← y AQUI\n- CTA comentarios (~9:00)\n- Cierre + End Screen\n\nTus 4 estructuras deben proponer DIFERENTES formas de organizar el contenido de desarrollo (los 3 bloques). Cada estructura tiene 3-5 secciones de desarrollo con nombres emocionantes que generen curiosidad.\n\nEjemplo: {"id":1,"name":"Cronologica Reveladora","description":"De los hechos al impacto oculto","sections":["Los hechos que nadie cuestiono","El dato que lo cambia todo","Las consecuencias que nadie ve venir"]}\n\nResponde SOLO con JSON valido:\n{"structures":[{"id":1,"name":"nombre","description":"descripcion breve","sections":["seccion1","seccion2","seccion3"]}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.structures)throw new Error('No se pudieron parsear estructuras');S.structs=p.structures;S.phase='select'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

async function goDirectContent(){
  const f=F(),news=selN();S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  try{const txt=await apiGen(buildFinal(f,news,[],null),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=0;S.phase='select'}render();
}

async function goFinalContent(){
  const f=F(),news=selN(),ang=selA();S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  try{const txt=await apiGen(buildFinal(f,news,ang,null),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

async function goFinal(){
  const f=F(),news=selN(),ang=selA(),str=S.structs[S.ss];
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando guion completo...';render();
  try{const txt=await apiGen(buildFinal(f,news,ang,str),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Estructura');S.phase='select'}render();
}

async function goCopy(){
  const t=S.itxt.trim();if(!t)return;const f=F();
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando copy y titulo...';render();
  const prompt=`Texto:\n${t}\n\nGenera:\n- Copy redes sociales (280 caracteres maximo, con emojis)\n- Titulo YouTube SEO`;
  try{const txt=await apiGen(prompt,SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=0;S.phase='input'}render();
}

function goManualFormatSel(){
  const t=S.manual_news.trim();
  if(!t){S.err='Por favor pega una noticia';render();return}
  S.step=F().steps.indexOf('FormatSel');
  S.phase='input';
  render();
}

function selManualFormat(fmt){
  S.manual_format=fmt;
  render();
}

async function goManualAngles(){
  const f=F(),news=S.manual_news.trim();
  if(!S.manual_format){S.err='Selecciona un formato';render();return}
  const fmt=FORMATS.find(x=>x.id===S.manual_format);
  if(!fmt){S.err='Formato inválido';render();return}
  S.step=f.steps.indexOf('Angulos');S.phase='loading';S.ltxt='Generando angulos narrativos...';render();
  const prompt=`Noticia:\n${news}\n\nGenera ${fmt.ac} angulos narrativos distintos. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.angles)throw new Error('No se pudieron parsear angulos');S.angles=p.angles;S.phase='select'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('FormatSel');S.phase='select'}render();
}

async function goManualFinalContent(){
  const f=F(),news=S.manual_news.trim(),fmt=FORMATS.find(x=>x.id===S.manual_format),ang=selA();
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  const nt=news;
  const at=ang.map(a=>a.name).join(', ');
  let prompt='';
  switch(S.manual_format){
    case'carrusel':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un redactor de noticias para Instagram. Escribes carruseles informativos para @nosotros.news.\n\nREGLAS DE ESTILO (OBLIGATORIAS EN TODO EL CARRUSEL):\n- Frases cortas y directas. Sin adornos.\n- Tono periodistico pero accesible. Como si le explicaras a un amigo inteligente.\n- PROHIBIDO usar emojis en cualquier parte (slides, copies, todo).\n- NO uses signos de exclamacion innecesarios.\n- NO uses palabras como "increible", "impactante", "sorprendente".\n- Usa datos concretos (numeros, nombres, porcentajes).\n\nESTRUCTURA (4 slides obligatorios):\n\nSLIDE 1 — GANCHO\n- UNA sola linea. MAXIMO 10 PALABRAS, ni una mas. Titular potente y directo. Si tiene mas de 10 palabras, reescribelo hasta que quepa.\n\nSLIDE 2 — QUE PASO\n- Cuenta inicialmente que paso en la noticia: los hechos concretos.\n- Responde que, donde, cuando, quienes.\n- Entre 150 y 200 caracteres.\n\nSLIDE 3 — CONTEXTO\n- Agrega contexto, analisis o consecuencias.\n- Conecta con el impacto real: politico, economico o social.\n- Entre 150 y 200 caracteres.\n\nSLIDE 4 — CIERRE\n- Exactamente: "Siguenos para mas noticias."\n\nADEMAS genera:\n\nCOPY LARGO (para Instagram):\n- FORZOSAMENTE 600 caracteres. Ni menos, ni mucho mas.\n- Es practicamente TODA la noticia resumida: que paso, donde paso, como paso, quienes estan involucrados, por que importa, que consecuencias tiene.\n- Escribe parrafos completos, no bullets.\n- Termina con 3 hashtags relevantes.\n- NO agregues call to action, ni CTA, ni "lee mas", ni "siguenos". Solo la noticia y los hashtags.\n- Sin emojis.\n\nCOPY CORTO (para Twitter/X):\n- Maximo 200 caracteres.\n- Version resumida del copy largo. Solo la noticia, directo.\n- Termina con 3 hashtags relevantes.\n- NO agregues CTA ni "lee mas". Sin emojis.\n\nGenera el carrusel siguiendo este formato exacto. Responde SOLO con los slides y los copies, sin explicaciones adicionales.`;break;
    case'sketch':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un guionista de sketches de noticias para @nosotros.news. Escribes guiones breves, faciles de grabar en casa, con humor inteligente.\n\nESTRUCTURA DEL SKETCH (seguir este orden exacto):\n\n## ESCENA — PERSONAJE A vs PERSONAJE B\n- Define dos personajes con posiciones opuestas sobre la noticia.\n- Nombre y descripcion breve de cada uno (ej: "Juan — el que siempre defiende al gobierno" / "Carlos — el esceptico que no le cree nada").\n- Escribe un dialogo corto entre ambos (maximo 6-8 lineas de dialogo total). Debe ser gracioso, satirico, exagerado pero que refleje las dos posturas reales sobre la noticia.\n- La escena debe ser MUY SIMPLE de grabar: dos personas hablando, sin escenografia especial, grabable en una sala o escritorio.\n- Indica si se puede reforzar con material audiovisual intercalado (ej: "Insertar clip/imagen de [referencia al tema]").\n\n## CONTEXTO A CAMARA\n- Despues de la escena, el presentador habla DIRECTO a camara.\n- Explica la noticia real con datos concretos: que paso, quienes, donde, por que importa.\n- Tono serio pero accesible. Entre 150 y 250 palabras.\n- Si aplica, menciona fuentes o datos duros.\n- SIEMPRE cierra el contexto con una conclusion de la noticia: que significa, que sigue, o que impacto tiene. No dejes la noticia sin cerrar.\n\n## CIERRE\n- Despues de la conclusion de la noticia, termina SIEMPRE con el CTA exacto: "Siguenos para mas noticias."\n\n## COPY REDES\n- Maximo 280 caracteres. Resumen directo de la noticia, sin emojis, sin CTA. Termina con 3 hashtags.\n\n## TITULO YOUTUBE\n- Titulo SEO optimizado, maximo 60 caracteres, que genere curiosidad.\n\nGenera el sketch completo. Responde SOLO con el guion, sin explicaciones adicionales.`;break;
    case'nr':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera una Nota de Investigacion con estos elementos:\n- Hook (gancho que atrape)\n- Contexto general\n- Contexto a fondo\n- Diferentes posturas sobre el tema\n- Cierre\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;break;
    case'youtube':prompt=buildYtPrompt(nt,at,null);break;
  }
  try{const txt=await apiGen(prompt,SYS,S.manual_format);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

function buildFinal(f,news,ang,str){
  const nt=news.map(n=>`${n.title}: ${n.summary}`).join('\n');
  const at=ang.map(a=>a.name).join(', ');
  switch(f.id){
    case'carrusel':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un redactor de noticias para Instagram. Escribes carruseles informativos para @nosotros.news.\n\nREGLAS DE ESTILO (OBLIGATORIAS EN TODO EL CARRUSEL):\n- Frases cortas y directas. Sin adornos.\n- Tono periodistico pero accesible. Como si le explicaras a un amigo inteligente.\n- PROHIBIDO usar emojis en cualquier parte (slides, copies, todo).\n- NO uses signos de exclamacion innecesarios.\n- NO uses palabras como "increible", "impactante", "sorprendente".\n- Usa datos concretos (numeros, nombres, porcentajes).\n\nESTRUCTURA (4 slides obligatorios):\n\nSLIDE 1 — GANCHO\n- UNA sola linea. MAXIMO 10 PALABRAS, ni una mas. Titular potente y directo. Si tiene mas de 10 palabras, reescribelo hasta que quepa.\n\nSLIDE 2 — QUE PASO\n- Cuenta inicialmente que paso en la noticia: los hechos concretos.\n- Responde que, donde, cuando, quienes.\n- Entre 150 y 200 caracteres.\n\nSLIDE 3 — CONTEXTO\n- Agrega contexto, analisis o consecuencias.\n- Conecta con el impacto real: politico, economico o social.\n- Entre 150 y 200 caracteres.\n\nSLIDE 4 — CIERRE\n- Exactamente: "Siguenos para mas noticias."\n\nADEMAS genera:\n\nCOPY LARGO (para Instagram):\n- FORZOSAMENTE 600 caracteres. Ni menos, ni mucho mas.\n- Es practicamente TODA la noticia resumida: que paso, donde paso, como paso, quienes estan involucrados, por que importa, que consecuencias tiene.\n- Escribe parrafos completos, no bullets.\n- Termina con 3 hashtags relevantes.\n- NO agregues call to action, ni CTA, ni "lee mas", ni "siguenos". Solo la noticia y los hashtags.\n- Sin emojis.\n\nCOPY CORTO (para Twitter/X):\n- Maximo 200 caracteres.\n- Version resumida del copy largo. Solo la noticia, directo.\n- Termina con 3 hashtags relevantes.\n- NO agregues CTA ni "lee mas". Sin emojis.\n\nGenera el carrusel siguiendo este formato exacto. Responde SOLO con los slides y los copies, sin explicaciones adicionales.`;
    case'noticias_hoy':case'noticias_mx':return`Noticias seleccionadas:\n${nt}\n\nGenera un guion de noticias con esta estructura FIJA (respetala exactamente):\n\n## HOOK\nUna linea por cada noticia, maximo 6 palabras cada una, estilo palabras clave impactantes. Van una tras otra, sin introduccion, sin contexto, sin saludo. Solo los hooks.\n\n## NOTICIAS\nINMEDIATAMENTE despues del hook, sin ninguna introduccion ni transicion, salta directo al desarrollo de cada noticia:\n- Noticia 1: desarrollo breve\n- Noticia 2: desarrollo breve\n- Noticia 3: desarrollo breve\n- Noticia 4: desarrollo breve\n\n## CIERRE\nSiempre termina con este CTA exacto: "No olvides seguirnos para mas noticias. Te enteraste con Nosotros."\n\n## COPY Y TITULO\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;
    case'sketch':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un guionista de sketches de noticias para @nosotros.news. Escribes guiones breves, faciles de grabar en casa, con humor inteligente.\n\nESTRUCTURA DEL SKETCH (seguir este orden exacto):\n\n## ESCENA — PERSONAJE A vs PERSONAJE B\n- Define dos personajes con posiciones opuestas sobre la noticia.\n- Nombre y descripcion breve de cada uno (ej: "Juan — el que siempre defiende al gobierno" / "Carlos — el esceptico que no le cree nada").\n- Escribe un dialogo corto entre ambos (maximo 6-8 lineas de dialogo total). Debe ser gracioso, satirico, exagerado pero que refleje las dos posturas reales sobre la noticia.\n- La escena debe ser MUY SIMPLE de grabar: dos personas hablando, sin escenografia especial, grabable en una sala o escritorio.\n- Indica si se puede reforzar con material audiovisual intercalado (ej: "Insertar clip/imagen de [referencia al tema]").\n\n## CONTEXTO A CAMARA\n- Despues de la escena, el presentador habla DIRECTO a camara.\n- Explica la noticia real con datos concretos: que paso, quienes, donde, por que importa.\n- Tono serio pero accesible. Entre 150 y 250 palabras.\n- Si aplica, menciona fuentes o datos duros.\n- SIEMPRE cierra el contexto con una conclusion de la noticia: que significa, que sigue, o que impacto tiene. No dejes la noticia sin cerrar.\n\n## CIERRE\n- Despues de la conclusion de la noticia, termina SIEMPRE con el CTA exacto: "Siguenos para mas noticias."\n\n## COPY REDES\n- Maximo 280 caracteres. Resumen directo de la noticia, sin emojis, sin CTA. Termina con 3 hashtags.\n\n## TITULO YOUTUBE\n- Titulo SEO optimizado, maximo 60 caracteres, que genere curiosidad.\n\nGenera el sketch completo. Responde SOLO con el guion, sin explicaciones adicionales.`;
    case'nr':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera una Nota de Investigacion con estos elementos:\n- Hook (gancho que atrape)\n- Contexto general\n- Contexto a fondo\n- Diferentes posturas sobre el tema\n- Cierre\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;
    case'youtube':return buildYtPrompt(nt,at,str);
    default:return'';
  }
}

async function analyzeResult(){
  S.analysisLoading=true;S.analysis=null;render();
  const prompt=`Analiza el siguiente contenido para redes sociales y evalua su potencial de viralidad.

CONTENIDO:
${S.result}

Responde SOLO con JSON valido en este formato exacto:
{"score":7,"engagement":8,"news_quality":6,"writing":7,"observations":["observacion 1","observacion 2","observacion 3"]}

Criterios de evaluacion:
- score: Calificacion general de viralidad del 1 al 10
- engagement: Potencial de interaccion (likes, comentarios, compartidos). Evalua si el gancho atrapa, si genera curiosidad, si invita a interactuar.
- news_quality: Calidad de la noticia. Evalua relevancia, datos concretos, fuentes, actualidad.
- writing: Calidad de redaccion. Evalua claridad, tono, estructura, longitud adecuada, ortografia.
- observations: Array de 3-5 observaciones especificas y accionables para mejorar el contenido. Se concreto: "El slide 1 tiene 15 palabras, reducir a 10" en vez de "mejorar el gancho".

Se critico y honesto. Un 10 es practicamente imposible.`;
  try{
    const txt=await apiGen(prompt);
    const parsed=pJ(txt);
    if(!parsed||!parsed.score)throw new Error('No se pudo analizar');
    S.analysis=parsed;
  }catch(e){S.err='Error al analizar: '+e.message;S.analysis=null}
  S.analysisLoading=false;render();
}

async function improveResult(){
  if(!S.analysis)return;
  const userAdj=(document.getElementById('userAdjustments')||{}).value||'';
  S.phase='loading';S.ltxt='Mejorando contenido basado en observaciones...';render();
  const obs=S.analysis.observations.join('\n- ');
  let adjustBlock='';
  if(userAdj.trim()){adjustBlock=`\n\nAjustes adicionales del usuario (PRIORIDAD ALTA, aplica estos cambios obligatoriamente):\n${userAdj.trim()}`}
  const prompt=`Aqui esta el contenido original:

${S.result}

Un analisis de viralidad detecto estas observaciones para mejorar:
- ${obs}${adjustBlock}

Reescribe el contenido COMPLETO aplicando TODAS las observaciones${userAdj.trim()?' y los ajustes del usuario':''}. Mantiene el mismo formato y estructura pero mejora cada punto senalado. Responde SOLO con el contenido mejorado, sin explicaciones.`;
  try{
    const txt=await apiGen(prompt,SYS,S.fid||S.manual_format);
    S.result=txt;S.analysis=null;S.analysisLoading=false;S.phase='result';
  }catch(e){S.err='Error al mejorar: '+e.message;S.phase='result'}
  render();
}

function cpRes(){
  const text=S.result;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>showCopied()).catch(()=>fallbackCopy(text));
  }else{fallbackCopy(text)}
}
function cpText(btn){
  const text=btn.parentElement.querySelector('.result-content').getAttribute('data-raw')||btn.parentElement.querySelector('.result-content').textContent;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{btn.textContent='Copiado!';setTimeout(()=>btn.textContent='<i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar',2000)}).catch(()=>fallbackCopy(text));
  }else{fallbackCopy(text)}
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0';
  document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showCopied();
}
function showCopied(){const b=document.querySelector('.copy-btn');if(b){b.textContent='Copiado!';setTimeout(()=>b.textContent='<i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar',2000)}}

// ========== PERMISSIONS ==========
if(!canCreate){document.getElementById('tabGenerar').style.display='none';modTab='historial';document.querySelectorAll('.module-tab')[1].classList.add('active')}

// ========== INIT ==========
if(modTab==='historial')loadHistory();else render();
</script>
<script src="/emoji-to-svg.js"></script></body>
</html>
