<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Central — NOSOTROS</title>
<link rel="icon" type="image/png" href="/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="content fade-in" id="content">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem">
      <div><h1 style="color:var(--nosotros)"><i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> NOSOTROS</h1><p>Plataforma de contenido digital con IA</p></div>
    </div>
    <div class="module-tabs" id="modTabs">
      <button class="module-tab active" onclick="setModTab('generar')" id="tabGenerar">Generar</button>
      <button class="module-tab" onclick="setModTab('historial')">Historial</button>
    </div>
    <div id="modContent"></div>
  </main>
</div>
<script>
// ========== AUTH ==========
const token=localStorage.getItem('token');
if(!token){window.location.href='/index.html';}
const user=JSON.parse(localStorage.getItem('user')||'{}');
const hdrs={'Content-Type':'application/json','Authorization':'Bearer '+token};
const perms=(user.permissions||{}).nosotros||[];
const canCreate=user.role==='admin'||perms.includes('crear');
const canEdit=user.role==='admin'||perms.includes('editar');

// ========== SIDEBAR ==========
const BUSINESSES=[
  {id:'nosotros',name:'NOSOTROS',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',url:'/nosotros.html'},
  {id:'duelazo',name:'DUELAZO',icon:'<i class="feather" data-icon="activity" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#10B981',url:'/duelazo.html'},
  {id:'spacebox',name:'SPACEBOX',icon:'<i class="feather" data-icon="package" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#3B82F6',url:'/spacebox.html'},
  {id:'styly',name:'STYLY',icon:'<i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#EC4899',url:'/styly.html'}
];
function renderSidebar(){
  const bs=user.businesses||[];const isAdmin=user.role==='admin';
  const items=BUSINESSES.filter(b=>isAdmin||bs.includes(b.id));
  document.getElementById('sidebar').innerHTML=`
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-header"><h2>Panel <span>Central</span></h2></div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/dashboard.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Dashboard</a></div>`:
    `<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/profile.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="user" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Panel Individual</a></div>`}
    <div class="sidebar-section"><div class="sidebar-label">Negocios</div>
      ${items.map(b=>`<a href="${b.url}" class="sidebar-item ${b.id==='nosotros'?'active':''}" style="--accent:${b.color}"><span class="icon">${b.icon}</span>${b.name}</a>`).join('')}
    </div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">Admin</div><a href="/admin.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Usuarios</a></div>`:''}
    <div class="sidebar-footer">
      <div class="sidebar-avatar">${(user.name||'U')[0].toUpperCase()}</div>
      <div class="sidebar-user"><div class="name">${user.name||'Usuario'}</div><div class="role">${user.role||'editor'}</div></div>
      <button class="theme-btn" onclick="toggleTheme()"><i class="feather" data-icon="moon" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
      <button class="theme-btn" onclick="logout()" style="font-size:.75rem"><i class="feather" data-icon="share-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
    </div>`;
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
function toggleTheme(){const t=document.documentElement.getAttribute('data-theme')==='light'?'':'light';document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t)}
function logout(){localStorage.clear();window.location.href='/index.html'}
if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light');
renderSidebar();

// ========== CONFIG ==========
const SYS='Eres el equipo creativo de NOSOTROS, un medio digital mexicano. Lenguaje coloquial mexicano pero sin perder seriedad. Solo usa lenguaje muy casual para ejemplificar o enfatizar. Ganchos constantes y atractivo.';

const FORMATS=[
  {id:'carrusel',name:'Carrusel IG',icon:'<i class="feather" data-icon="smartphone" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#E1306C',
   desc:'Slides con hook, contexto y CTA para Instagram',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'noticias_hoy',name:'Noticias de Hoy',icon:'<i class="feather" data-icon="globe" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#1DA1F2',
   desc:'Resumen diario de noticias internacionales y Mexico',
   badges:['Web Search'],steps:['Noticias','Contenido'],
   scope:'both',ns:4,ac:0,ma:0},
  {id:'sketch',name:'Sketch',icon:'<i class="feather" data-icon="smile" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#FF6B35',
   desc:'Sketch con humor, satira e indicaciones visuales',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'nr',name:'NR Investigacion',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',
   desc:'Investigacion a profundidad con multiples posturas',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'youtube',name:'YouTube Largo',icon:'<i class="feather" data-icon="video" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#FF0000',
   desc:'Guion completo 12-15 min con timestamps y clips',
   badges:['Web Search','Angulos','Estructuras'],steps:['Noticias','Angulos','Estructura','Contenido'],
   scope:'mx',ns:1,ac:6,ma:3},
  {id:'noticia_manual',name:'Noticia Manual',icon:'<i class="feather" data-icon="edit" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#06B6D4',
   desc:'Pega la noticia, elige formato y genera contenido',
   badges:['Angulos','Formatos'],steps:['TextInput','FormatSel','Angulos','Contenido'],
   scope:null,ns:0,ac:5,ma:2},
  {id:'copy',name:'Copy & Titulo',icon:'<i class="feather" data-icon="edit-3" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#F59E0B',
   desc:'Copy para redes y titulo YouTube desde cualquier texto',
   badges:[],steps:['Texto','Contenido'],
   scope:null,ns:0,ac:0,ma:0}
];

const CATS=[
  {id:null,label:'Todas'},{id:'internacional',label:'Internacional'},{id:'economia',label:'Economia'},
  {id:'tecnologia',label:'Tecnologia'},{id:'deportes',label:'Deportes'},
  {id:'entretenimiento',label:'Entretenimiento'},{id:'salud',label:'Salud'},
  {id:'ciencia',label:'Ciencia'},{id:'guerra',label:'Guerra'},{id:'mexico',label:'Mexico'}
];

// ========== STATE ==========
let S={view:'home',fid:null,step:0,phase:'input',ltxt:'',
  sq:'',cat:null,news:[],sn:new Set(),angles:[],sa:new Set(),
  structs:[],ss:null,result:'',itxt:'',err:null,selectedIds:new Set(),
  manual_news:'',manual_format:null};
let modTab='generar';
let newsPagination={page:1,pageSize:8,total:0,totalPages:0};

// ========== HELPERS ==========
function F(){return FORMATS.find(f=>f.id===S.fid)}
function getArticleId(article){return `${article.title}|${article.source}|${article.date}`}
function selN(){
  return S.news.filter((n,i)=>{
    const id=getArticleId(n);
    return S.selectedIds.has(id);
  })
}
function selA(){return[...S.sa].map(i=>S.angles[i])}
function pJ(t){const i=t.indexOf('{'),j=t.lastIndexOf('}');if(i===-1||j<=i)return null;try{return JSON.parse(t.substring(i,j+1))}catch{return null}}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function md(t){
  return esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/^### (.+)$/gm,'<h4>$1</h4>').replace(/^## (.+)$/gm,'<h3>$1</h3>').replace(/^# (.+)$/gm,'<h2>$1</h2>')
    .replace(/^---$/gm,'<hr>').replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>');
}

// ========== API ==========
async function apiNews(scope,category,page=1,pageSize=8){
  const r=await fetch('/api/nosotros/news-ai',{method:'POST',headers:hdrs,body:JSON.stringify({scope,category:category||undefined,page,pageSize})});
  const d=await r.json();if(d.error)throw new Error(d.error);
  if(d.pagination)newsPagination=d.pagination;
  return d.news||[];
}
async function apiGen(prompt,system,format_type){
  const r=await fetch('/api/nosotros/generate',{method:'POST',headers:hdrs,
    body:JSON.stringify({prompt,system:system||undefined,format_type:format_type||undefined})});
  const d=await r.json();if(d.error)throw new Error(d.error);return d.result||'';
}

// ========== MODULE TABS ==========
function setModTab(t){
  modTab=t;
  document.querySelectorAll('.module-tab').forEach((b,i)=>b.classList.toggle('active',(t==='generar'&&i===0)||(t==='historial'&&i===1)));
  if(t==='generar'){S.view='home';render()}
  else if(t==='historial'){loadHistory()}
}

let histSel=new Set();
async function loadHistory(){
  histSel.clear();
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/nosotros/history',{headers:hdrs});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    const items=d.history||[];
    m.innerHTML=items.length?`
      ${canEdit?`<div style="display:flex;gap:.5rem;margin-bottom:.75rem;align-items:center;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:.35rem;cursor:pointer;font-size:.8rem;color:var(--mt)"><input type="checkbox" onchange="toggleAllHist(this.checked,${JSON.stringify(items.map(i=>i.id))})"> Seleccionar todos</label>
        <span id="histSelCount" style="font-size:.75rem;color:var(--mt)"></span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button id="btnBulkDel" onclick="bulkDelHistory()" style="display:none;background:#EF4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:.75rem;cursor:pointer">Eliminar seleccionados</button>
          <button onclick="delAllHistory()" style="background:none;border:1px solid #EF4444;color:#EF4444;border-radius:6px;padding:4px 12px;font-size:.75rem;cursor:pointer">Borrar todo</button>
        </div>
      </div>`:''}
      <div class="history-list">${items.map(h=>`
      <div class="history-item" style="position:relative">
        ${canEdit?`<input type="checkbox" data-hid="${h.id}" onchange="toggleHistSel(${h.id},this.checked)" style="position:absolute;top:.6rem;left:.5rem;cursor:pointer;accent-color:#EF4444">`:''}
        <div onclick="viewHistory(${h.id})" style="cursor:pointer;flex:1;${canEdit?'padding-left:1.5rem':''}">
          <div class="history-meta"><span>${h.format_type}</span><span>${new Date(h.created_at).toLocaleString('es-MX')}</span></div>
          <div class="history-preview">${esc(h.preview||'')}</div>
        </div>
        ${canEdit?`<button onclick="event.stopPropagation();delHistory(${h.id})" style="position:absolute;top:.5rem;right:.5rem;background:none;border:1px solid var(--border);border-radius:6px;color:var(--mt);cursor:pointer;padding:2px 6px;font-size:.7rem;transition:all .15s" onmouseover="this.style.borderColor='#EF4444';this.style.color='#EF4444'" onmouseout="this.style.borderColor='';this.style.color=''"><i class="feather" data-icon="trash-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>`:''}
      </div>`).join('')}</div>`:'<p style="color:var(--mt);text-align:center;padding:2rem">No hay contenido generado aun.</p>';
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
function toggleHistSel(id,checked){if(checked)histSel.add(id);else histSel.delete(id);updHistSelUI()}
function toggleAllHist(checked,ids){histSel.clear();if(checked)ids.forEach(id=>histSel.add(id));document.querySelectorAll('[data-hid]').forEach(c=>c.checked=checked);updHistSelUI()}
function updHistSelUI(){const n=histSel.size;const c=document.getElementById('histSelCount');const b=document.getElementById('btnBulkDel');if(c)c.textContent=n?n+' seleccionado'+(n>1?'s':''):'';if(b)b.style.display=n?'inline-block':'none'}
async function bulkDelHistory(){if(!histSel.size)return;if(!confirm(`Eliminar ${histSel.size} elemento(s) del historial?`))return;try{const r=await fetch('/api/nosotros/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids:[...histSel]})});const d=await r.json();if(d.error)throw new Error(d.error);loadHistory()}catch(e){alert('Error: '+e.message)}}
async function delAllHistory(){if(!confirm('Eliminar TODO el historial de Nosotros? Esta accion no se puede deshacer.'))return;try{const r=await fetch('/api/nosotros/history',{headers:hdrs});const d=await r.json();const ids=(d.history||[]).map(h=>h.id);if(!ids.length)return;const r2=await fetch('/api/nosotros/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids})});const d2=await r2.json();if(d2.error)throw new Error(d2.error);loadHistory()}catch(e){alert('Error: '+e.message)}}

async function viewHistory(id){
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/nosotros/history/'+id,{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    const h=d.item;
    m.innerHTML=`<button class="btn-back" onclick="loadHistory()" style="margin-bottom:1rem">← Volver</button>
      <div class="result-box"><button class="copy-btn" onclick="cpText(this)"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button>
      <div class="result-content" data-raw="${esc(h.output_text)}">${md(h.output_text)}</div></div>`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}

async function delHistory(id){
  if(!confirm('Eliminar este contenido del historial?'))return;
  try{
    const r=await fetch('/api/nosotros/history/'+id,{method:'DELETE',headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    loadHistory();
  }catch(e){alert('Error: '+e.message)}
}

// ========== RENDER ==========
function render(){
  const m=document.getElementById('modContent');
  m.className='fade-in';
  m.innerHTML=S.view==='home'?rHome():rFlow();
  void m.offsetWidth;
  const si=document.getElementById('si');if(si)si.value=S.sq;
  const ti=document.getElementById('ti');if(ti)ti.value=S.itxt;
}

function rHome(){
  return`<div class="fmt-grid">${FORMATS.map(f=>`
    <div class="fmt-card" style="--c:${f.color}" onclick="goFmt('${f.id}')">
      <div class="fmt-icon">${f.icon}</div>
      <div class="fmt-name">${f.name}</div>
      <div class="fmt-desc">${f.desc}</div>
      ${f.badges.length?`<div class="fmt-badges">${f.badges.map(b=>`<span class="badge">${b}</span>`).join('')}</div>`:''}
    </div>`).join('')}</div>`;
}

function rFlow(){
  const f=F();
  return`<div style="--accent:${f.color}">
    <div class="flow-header">
      <button class="btn-back" onclick="goHome()">← Volver</button>
      <div class="flow-title"><span>${f.icon}</span> ${f.name}</div>
    </div>
    ${rSteps(f)}
    <div class="step-label">Paso ${S.step+1}: ${f.steps[S.step]}</div>
    ${S.err?`<div class="error-bar"><span>${esc(S.err)}</span><button onclick="clErr()">×</button></div>`:''}
    ${rContent(f)}
  </div>`;
}

function rSteps(f){
  let h='<div class="steps">';
  f.steps.forEach((s,i)=>{
    if(i>0)h+=`<div class="step-line ${i<=S.step?'done':''}"></div>`;
    h+=`<div class="step-dot ${i<S.step?'done':i===S.step?'active':''}">${i+1}</div>`;
  });
  return h+'</div>';
}

function rContent(f){
  if(S.phase==='loading')return`<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div><div class="loader-text">${S.ltxt}</div></div>`;
  if(S.phase==='result')return rResult();
  const st=f.steps[S.step];
  if(st==='Noticias'){
    if(S.news.length>0)return rNewsSel(f);
    return`<div class="actions"><button class="btn" onclick="retryFetch()">Reintentar carga de noticias</button></div>`;
  }
  if(st==='TextInput')return rManualNewsIn();
  if(st==='FormatSel')return rManualFormatSel();
  if(st==='Angulos')return rAngSel(f);
  if(st==='Estructura')return rStrSel();
  if(st==='Texto')return rTextIn();
  return'';
}

function rNewsSel(f){
  const n=f.ns,ok=S.selectedIds.size===n;
  const cats=`<div class="cats">${CATS.map(c=>`<button class="cat-btn ${S.cat===c.id?'active':''}" onclick="setCat(${c.id===null?'null':"'"+c.id+"'"})">${c.label}</button>`).join('')}</div>`;

  // Pagination controls
  const pag = newsPagination;
  const pagControls = pag.totalPages > 1 ? `
    <div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin-bottom:.75rem">
      <button class="btn-outline" ${pag.page===1?'disabled':''} onclick="changePage(${pag.page-1})" style="padding:4px 12px;font-size:.8rem">← Anterior</button>
      <span style="font-size:.8rem;color:var(--mt)">Página ${pag.page} de ${pag.totalPages}</span>
      <button class="btn-outline" ${pag.page===pag.totalPages?'disabled':''} onclick="changePage(${pag.page+1})" style="padding:4px 12px;font-size:.8rem">Siguiente →</button>
    </div>` : '';

  return`${cats}${pagControls}<p class="sel-hint">Selecciona ${n} noticia${n>1?'s':''} (${S.selectedIds.size}/${n})</p>
    <div class="sel-list">${S.news.map((nw,i)=>{
      const id=getArticleId(nw);
      return `<div class="sel-card ${S.selectedIds.has(id)?'on':''}" onclick="tgN(${i})">
        <div class="sel-check">${S.selectedIds.has(id)?'<i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>':''}</div>
        <div class="sel-body">
          <div class="sel-title">${esc(nw.title)}</div>
          <div class="sel-desc">${esc(nw.summary)}</div>
          <div class="sel-source">${esc(nw.source)} ${nw.date?'• '+formatNewsDate(nw.date):''}</div>
        </div></div>`;
    }).join('')}</div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="${f.steps[S.step+1]==='Contenido'?'goDirectContent()':'goAngles()'}">
      ${f.steps[S.step+1]==='Contenido'?'Generar contenido':'Generar angulos'}</button></div>`;
}

function rAngSel(f){
  const ok=S.sa.size>=1&&S.sa.size<=f.ma;
  const lbl=f.id==='youtube'?'Generar estructuras':f.id==='noticia_manual'?'Generar contenido':'Generar contenido';
  const nextFn=f.id==='noticia_manual'?'goManualFinalContent()':f.id==='youtube'?'goStructs()':'goFinalContent()';
  return`<p class="sel-hint">Selecciona 1-${f.ma} angulo${f.ma>1?'s':''} (${S.sa.size}/${f.ma})</p>
    <div class="sel-list">${S.angles.map((a,i)=>`
      <div class="sel-card ${S.sa.has(i)?'on':''}" onclick="tgA(${i})">
        <div class="sel-check">${S.sa.has(i)?'<i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>':''}</div>
        <div class="sel-body"><div class="sel-title">${esc(a.name)}</div><div class="sel-desc">${esc(a.description)}</div></div>
      </div>`).join('')}</div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="${nextFn}">${lbl}</button></div>`;
}

function rStrSel(){
  const ok=S.ss!==null;
  return`<p class="sel-hint">Selecciona 1 estructura</p>
    <div class="sel-list">${S.structs.map((s,i)=>`
      <div class="sel-card ${S.ss===i?'on':''}" onclick="selStr(${i})">
        <div class="sel-radio"></div>
        <div class="sel-body"><div class="sel-title">${esc(s.name)}</div><div class="sel-desc">${esc(s.description)}</div>
          ${s.sections?`<div class="sel-desc" style="margin-top:.25rem;opacity:.6;font-size:.75rem">${s.sections.map(x=>esc(x)).join(' → ')}</div>`:''}
        </div></div>`).join('')}</div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="goFinal()">Generar guion completo</button></div>`;
}

function rTextIn(){
  return`<textarea id="ti" class="ta" placeholder="Pega aqui el texto para generar copy y titulo..." oninput="S.itxt=this.value"></textarea>
    <div class="actions"><button class="btn" onclick="goCopy()">Generar copy y titulo</button></div>`;
}

function rManualNewsIn(){
  const html=`<textarea id="mn" class="ta" placeholder="Pega aqui la noticia que quieras convertir en contenido..." oninput="S.manual_news=this.value;render()">${esc(S.manual_news)}</textarea>
    <div class="actions"><button class="btn" ${S.manual_news.trim()?'':'disabled'} onclick="goManualFormatSel()">Siguiente paso</button></div>`;
  setTimeout(()=>{const ta=document.getElementById('mn');if(ta)ta.focus()},0);
  return html;
}

function rManualFormatSel(){
  const allowed=['carrusel','sketch','nr','youtube'];
  const allowedFormats=FORMATS.filter(f=>allowed.includes(f.id));
  const ok=S.manual_format!==null;
  return`<p class="sel-hint">Elige el formato para tu noticia</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem">
      ${allowedFormats.map((fmt,i)=>`
        <div class="fmt-card" ${S.manual_format===fmt.id?'style="border:2px solid '+fmt.color+';background:rgba(255,255,255,0.05)"':''} onclick="selManualFormat('${fmt.id}')" style="--c:${fmt.color};cursor:pointer;border:2px solid ${S.manual_format===fmt.id?fmt.color:'transparent'};transition:all 0.2s">
          <div class="fmt-icon">${fmt.icon}</div>
          <div class="fmt-name">${fmt.name}</div>
          <div class="fmt-desc" style="font-size:.75rem">${fmt.desc}</div>
        </div>`).join('')}
    </div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="goManualAngles()">Generar angulos</button></div>`;
}

function rResult(){
  return`<div class="result-box">
    <button class="copy-btn" onclick="cpRes()"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button>
    <div class="result-content">${md(S.result)}</div></div>
    <div class="actions"><button class="btn-outline btn" onclick="goHome()">Nuevo contenido</button></div>`;
}

// ========== HELPERS (Date formatting) ==========
function formatNewsDate(dateStr){
  if(!dateStr)return'';
  const d=new Date(dateStr);
  const today=new Date();today.setHours(0,0,0,0);
  const newsDate=new Date(d);newsDate.setHours(0,0,0,0);
  if(newsDate.getTime()===today.getTime())return'Hoy';
  const opts={month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'};
  return d.toLocaleDateString('es-MX',opts);
}

// ========== HANDLERS ==========
function goHome(){S={view:'home',fid:null,step:0,phase:'input',ltxt:'',sq:'',cat:null,news:[],sn:new Set(),angles:[],sa:new Set(),structs:[],ss:null,result:'',itxt:'',err:null,selectedIds:new Set(),manual_news:'',manual_format:null};newsPagination={page:1,pageSize:8,total:0,totalPages:0};render()}
function clErr(){S.err=null;render()}
function setCat(c){if(S.cat===c)return;S.cat=c;S.selectedIds=new Set();S.err=null;newsPagination.page=1;fetchN(F().scope,S.sq||undefined)}
function goFmt(id){
  S.view='flow';S.fid=id;S.step=0;S.news=[];S.sn=new Set();S.angles=[];S.sa=new Set();
  S.structs=[];S.ss=null;S.result='';S.err=null;S.sq='';S.cat=null;S.itxt='';S.selectedIds=new Set();
  S.manual_news='';S.manual_format=null;
  newsPagination={page:1,pageSize:8,total:0,totalPages:0};
  const f=F();
  if(f.id==='copy'){S.phase='input';render();return}
  if(f.id==='noticia_manual'){S.phase='input';render();return}
  S.phase='loading';S.ltxt='Cargando noticias del dia...';render();fetchN(f.scope);
}
function retryFetch(){S.err=null;const f=F();newsPagination.page=1;S.phase='loading';S.ltxt='Cargando noticias...';render();fetchN(f.scope,S.sq||undefined)}
async function changePage(page){
  if(page<1||page>newsPagination.totalPages)return;
  newsPagination.page=page;
  // NO limpiar selecciones al cambiar página - mantener selecciones
  await fetchN(F().scope,S.sq||undefined,newsPagination.page);
}
async function fetchN(scope,query,page=1){
  S.phase='loading';S.ltxt='Buscando noticias actuales...';render();
  try{
    const news=await apiNews(scope,S.cat,page,newsPagination.pageSize);
    if(!news.length)throw new Error('No se encontraron noticias.');
    S.news=news;
    // Si es la primera página, limpiar selecciones. Si no, mantener las del usuario
    if(page===1)S.selectedIds=new Set();
    S.phase='select';
  }catch(e){S.err=e.message;S.phase='input';S.news=[]}
  render();
}
function tgN(i){
  const f=F();
  const article=S.news[i];
  const id=getArticleId(article);

  if(S.selectedIds.has(id)){
    S.selectedIds.delete(id);
  }else{
    if(f.ns===1)S.selectedIds.clear();
    if(S.selectedIds.size<f.ns)S.selectedIds.add(id);
  }
  render()
}
function tgA(i){const f=F();if(S.sa.has(i))S.sa.delete(i);else{if(S.sa.size<f.ma)S.sa.add(i)}render()}
function selStr(i){S.ss=i;render()}

async function goAngles(){
  const f=F(),news=selN();
  S.step=f.steps.indexOf('Angulos');S.phase='loading';S.ltxt='Generando angulos narrativos...';render();
  const nt=news.map(n=>`- ${n.title}: ${n.summary}`).join('\n');
  const prompt=news.length===1
    ?`Noticia:\n${nt}\n\nGenera ${f.ac} angulos narrativos distintos. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`
    :`Noticias:\n${nt}\n\nGenera ${f.ac} angulos narrativos generales para este conjunto. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.angles)throw new Error('No se pudieron parsear angulos');S.angles=p.angles;S.phase='select'}
  catch(e){S.err=e.message;S.step=0;S.phase='select'}render();
}

async function goNext(){if(F().id==='youtube')await goStructs();else await goFinalContent()}

async function goStructs(){
  const f=F(),news=selN(),ang=selA();
  S.step=f.steps.indexOf('Estructura');S.phase='loading';S.ltxt='Generando estructuras...';render();
  const n=news[0],at=ang.map(a=>a.name).join(', ');
  const prompt=`Noticia: ${n.title} - ${n.summary}\nAngulos: ${at}\n\nGenera 4 estructuras de storytelling para video YouTube 12-15 min. Responde SOLO con JSON valido:\n{"structures":[{"id":1,"name":"nombre","description":"descripcion breve","sections":["seccion1","seccion2","seccion3"]}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.structures)throw new Error('No se pudieron parsear estructuras');S.structs=p.structures;S.phase='select'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

async function goDirectContent(){
  const f=F(),news=selN();S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  try{const txt=await apiGen(buildFinal(f,news,[],null),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=0;S.phase='select'}render();
}

async function goFinalContent(){
  const f=F(),news=selN(),ang=selA();S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  try{const txt=await apiGen(buildFinal(f,news,ang,null),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

async function goFinal(){
  const f=F(),news=selN(),ang=selA(),str=S.structs[S.ss];
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando guion completo...';render();
  try{const txt=await apiGen(buildFinal(f,news,ang,str),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Estructura');S.phase='select'}render();
}

async function goCopy(){
  const t=S.itxt.trim();if(!t)return;const f=F();
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando copy y titulo...';render();
  const prompt=`Texto:\n${t}\n\nGenera:\n- Copy redes sociales (280 caracteres maximo, con emojis)\n- Titulo YouTube SEO`;
  try{const txt=await apiGen(prompt,SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=0;S.phase='input'}render();
}

function goManualFormatSel(){
  const t=S.manual_news.trim();
  if(!t){S.err='Por favor pega una noticia';render();return}
  S.step=F().steps.indexOf('FormatSel');
  S.phase='input';
  render();
}

function selManualFormat(fmt){
  S.manual_format=fmt;
  render();
}

async function goManualAngles(){
  const f=F(),news=S.manual_news.trim();
  if(!S.manual_format){S.err='Selecciona un formato';render();return}
  const fmt=FORMATS.find(x=>x.id===S.manual_format);
  if(!fmt){S.err='Formato inválido';render();return}
  S.step=f.steps.indexOf('Angulos');S.phase='loading';S.ltxt='Generando angulos narrativos...';render();
  const prompt=`Noticia:\n${news}\n\nGenera ${fmt.ac} angulos narrativos distintos. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.angles)throw new Error('No se pudieron parsear angulos');S.angles=p.angles;S.phase='select'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('FormatSel');S.phase='select'}render();
}

async function goManualFinalContent(){
  const f=F(),news=S.manual_news.trim(),fmt=FORMATS.find(x=>x.id===S.manual_format),ang=selA();
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  const nt=news;
  const at=ang.map(a=>a.name).join(', ');
  let prompt='';
  switch(S.manual_format){
    case'carrusel':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un redactor de noticias para Instagram. Escribes carruseles informativos para @nosotros.news.\n\nREGLAS DE ESTILO (OBLIGATORIAS EN TODO EL CARRUSEL):\n- Frases cortas y directas. Sin adornos.\n- Tono periodistico pero accesible. Como si le explicaras a un amigo inteligente.\n- PROHIBIDO usar emojis en cualquier parte (slides, copies, todo).\n- NO uses signos de exclamacion innecesarios.\n- NO uses palabras como "increible", "impactante", "sorprendente".\n- Usa datos concretos (numeros, nombres, porcentajes).\n\nESTRUCTURA (4 slides obligatorios):\n\nSLIDE 1 — GANCHO\n- UNA sola linea. MAXIMO 10 PALABRAS, ni una mas. Titular potente y directo. Si tiene mas de 10 palabras, reescribelo hasta que quepa.\n\nSLIDE 2 — QUE PASO\n- Cuenta inicialmente que paso en la noticia: los hechos concretos.\n- Responde que, donde, cuando, quienes.\n- Entre 150 y 200 caracteres.\n\nSLIDE 3 — CONTEXTO\n- Agrega contexto, analisis o consecuencias.\n- Conecta con el impacto real: politico, economico o social.\n- Entre 150 y 200 caracteres.\n\nSLIDE 4 — CIERRE\n- Exactamente: "Siguenos para mas noticias."\n\nADEMAS genera:\n\nCOPY LARGO (para Instagram):\n- FORZOSAMENTE 600 caracteres. Ni menos, ni mucho mas.\n- Es practicamente TODA la noticia resumida: que paso, donde paso, como paso, quienes estan involucrados, por que importa, que consecuencias tiene.\n- Escribe parrafos completos, no bullets.\n- Termina con 3 hashtags relevantes.\n- NO agregues call to action, ni CTA, ni "lee mas", ni "siguenos". Solo la noticia y los hashtags.\n- Sin emojis.\n\nCOPY CORTO (para Twitter/X):\n- Maximo 200 caracteres.\n- Version resumida del copy largo. Solo la noticia, directo.\n- Termina con 3 hashtags relevantes.\n- NO agregues CTA ni "lee mas". Sin emojis.\n\nGenera el carrusel siguiendo este formato exacto. Responde SOLO con los slides y los copies, sin explicaciones adicionales.`;break;
    case'sketch':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera un sketch con estos elementos:\n- Parte 1: Humor y satira\n- Parte 2: Contexto serio\n- Indicaciones visuales para produccion\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;break;
    case'nr':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera una Nota de Investigacion con estos elementos:\n- Hook (gancho que atrape)\n- Contexto general\n- Contexto a fondo\n- Diferentes posturas sobre el tema\n- Cierre\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;break;
    case'youtube':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera un guion YouTube completo 12-15 minutos con esta estructura:\n\n# TITULO YOUTUBE (SEO optimizado)\n\n## [00:00] Introduccion\n(Gancho impactante y contexto inicial)\n\n## [MM:SS] Desarrollo\n(Explicacion detallada, datos, analisis)\n\n## [MM:SS] Conclusion\n(Resumen y reflexion final)\n\n---\n## CLIPS CORTOS\n4 clips con: titulo, duracion, extracto y copy para redes (280 caracteres maximo)`;break;
  }
  try{const txt=await apiGen(prompt,SYS,S.manual_format);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

function buildFinal(f,news,ang,str){
  const nt=news.map(n=>`${n.title}: ${n.summary}`).join('\n');
  const at=ang.map(a=>a.name).join(', ');
  switch(f.id){
    case'carrusel':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un redactor de noticias para Instagram. Escribes carruseles informativos para @nosotros.news.\n\nREGLAS DE ESTILO (OBLIGATORIAS EN TODO EL CARRUSEL):\n- Frases cortas y directas. Sin adornos.\n- Tono periodistico pero accesible. Como si le explicaras a un amigo inteligente.\n- PROHIBIDO usar emojis en cualquier parte (slides, copies, todo).\n- NO uses signos de exclamacion innecesarios.\n- NO uses palabras como "increible", "impactante", "sorprendente".\n- Usa datos concretos (numeros, nombres, porcentajes).\n\nESTRUCTURA (4 slides obligatorios):\n\nSLIDE 1 — GANCHO\n- UNA sola linea. MAXIMO 10 PALABRAS, ni una mas. Titular potente y directo. Si tiene mas de 10 palabras, reescribelo hasta que quepa.\n\nSLIDE 2 — QUE PASO\n- Cuenta inicialmente que paso en la noticia: los hechos concretos.\n- Responde que, donde, cuando, quienes.\n- Entre 150 y 200 caracteres.\n\nSLIDE 3 — CONTEXTO\n- Agrega contexto, analisis o consecuencias.\n- Conecta con el impacto real: politico, economico o social.\n- Entre 150 y 200 caracteres.\n\nSLIDE 4 — CIERRE\n- Exactamente: "Siguenos para mas noticias."\n\nADEMAS genera:\n\nCOPY LARGO (para Instagram):\n- FORZOSAMENTE 600 caracteres. Ni menos, ni mucho mas.\n- Es practicamente TODA la noticia resumida: que paso, donde paso, como paso, quienes estan involucrados, por que importa, que consecuencias tiene.\n- Escribe parrafos completos, no bullets.\n- Termina con 3 hashtags relevantes.\n- NO agregues call to action, ni CTA, ni "lee mas", ni "siguenos". Solo la noticia y los hashtags.\n- Sin emojis.\n\nCOPY CORTO (para Twitter/X):\n- Maximo 200 caracteres.\n- Version resumida del copy largo. Solo la noticia, directo.\n- Termina con 3 hashtags relevantes.\n- NO agregues CTA ni "lee mas". Sin emojis.\n\nGenera el carrusel siguiendo este formato exacto. Responde SOLO con los slides y los copies, sin explicaciones adicionales.`;
    case'noticias_hoy':case'noticias_mx':return`Noticias seleccionadas:\n${nt}\n\nGenera un guion de noticias con esta estructura FIJA (respetala exactamente):\n\n## HOOK\nUna linea por cada noticia, maximo 6 palabras cada una, estilo palabras clave impactantes. Van una tras otra, sin introduccion, sin contexto, sin saludo. Solo los hooks.\n\n## NOTICIAS\nINMEDIATAMENTE despues del hook, sin ninguna introduccion ni transicion, salta directo al desarrollo de cada noticia:\n- Noticia 1: desarrollo breve\n- Noticia 2: desarrollo breve\n- Noticia 3: desarrollo breve\n- Noticia 4: desarrollo breve\n\n## CIERRE\nSiempre termina con este CTA exacto: "No olvides seguirnos para mas noticias. Te enteraste con Nosotros."\n\n## COPY Y TITULO\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;
    case'sketch':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera un sketch con estos elementos:\n- Parte 1: Humor y satira\n- Parte 2: Contexto serio\n- Indicaciones visuales para produccion\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;
    case'nr':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera una Nota de Investigacion con estos elementos:\n- Hook (gancho que atrape)\n- Contexto general\n- Contexto a fondo\n- Diferentes posturas sobre el tema\n- Cierre\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;
    case'youtube':{
      const secs=str.sections.map((s,i)=>`Seccion ${i+1} — "${s}": Escribe TODO el texto narrado completo. Desarrolla el contenido real: datos, contexto, analisis, argumentos. Minimo 3 parrafos.`).join('\n');
      return`Noticia: ${nt}\nAngulos elegidos: ${at}\nEstructura elegida: ${str.name}\n\nIMPORTANTE: Escribe el guion COMPLETO, palabra por palabra. Cada seccion debe tener el texto DESARROLLADO.\n\nEstructura del guion (12-15 minutos):\n${secs}\n\nFormato de entrega:\n\n# TITULO YOUTUBE (SEO optimizado)\n\n## [00:00] Seccion 1\n(Texto narrado completo)\n\n## [MM:SS] Seccion 2\n(Texto narrado completo)\n\n---\n## DESCRIPCION YOUTUBE\n(200-300 palabras)\n\n---\n## CLIPS CORTOS\n4 clips con: titulo, duracion, extracto y copy para redes (280 caracteres)`;}
    default:return'';
  }
}

function cpRes(){
  const text=S.result;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>showCopied()).catch(()=>fallbackCopy(text));
  }else{fallbackCopy(text)}
}
function cpText(btn){
  const text=btn.parentElement.querySelector('.result-content').getAttribute('data-raw')||btn.parentElement.querySelector('.result-content').textContent;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{btn.textContent='Copiado!';setTimeout(()=>btn.textContent='<i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar',2000)}).catch(()=>fallbackCopy(text));
  }else{fallbackCopy(text)}
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0';
  document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showCopied();
}
function showCopied(){const b=document.querySelector('.copy-btn');if(b){b.textContent='Copiado!';setTimeout(()=>b.textContent='<i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar',2000)}}

// ========== PERMISSIONS ==========
if(!canCreate){document.getElementById('tabGenerar').style.display='none';modTab='historial';document.querySelectorAll('.module-tab')[1].classList.add('active')}

// ========== INIT ==========
if(modTab==='historial')loadHistory();else render();
</script>
<script src="/emoji-to-svg.js"></script></body>
</html>
