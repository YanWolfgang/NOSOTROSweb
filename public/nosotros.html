<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Central — NOSOTROS</title>
<link rel="icon" type="image/png" href="/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="content fade-in" id="content">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem">
      <div><h1 style="color:var(--nosotros)"><i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> NOSOTROS</h1><p>Plataforma de contenido digital con IA</p></div>
    </div>
    <div class="module-tabs" id="modTabs">
      <button class="module-tab active" onclick="setModTab('generar')" id="tabGenerar">Generar</button>
      <button class="module-tab" onclick="setModTab('historial')">Historial</button>
    </div>
    <div id="modContent"></div>
  </main>
</div>
<script>
// ========== AUTH ==========
const token=localStorage.getItem('token');
if(!token){window.location.href='/index.html';}
const user=JSON.parse(localStorage.getItem('user')||'{}');
const hdrs={'Content-Type':'application/json','Authorization':'Bearer '+token};
const perms=(user.permissions||{}).nosotros||[];
const canCreate=user.role==='admin'||perms.includes('crear');
const canEdit=user.role==='admin'||perms.includes('editar');

// ========== SIDEBAR ==========
const BUSINESSES=[
  {id:'nosotros',name:'NOSOTROS',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',url:'/nosotros.html'},
  {id:'duelazo',name:'DUELAZO',icon:'<i class="feather" data-icon="activity" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#10B981',url:'/duelazo.html'},
  {id:'spacebox',name:'SPACEBOX',icon:'<i class="feather" data-icon="package" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#3B82F6',url:'/spacebox.html'},
  {id:'styly',name:'STYLY',icon:'<i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#EC4899',url:'/styly.html'}
];
function renderSidebar(){
  const bs=user.businesses||[];const isAdmin=user.role==='admin';
  const items=BUSINESSES.filter(b=>isAdmin||bs.includes(b.id));
  document.getElementById('sidebar').innerHTML=`
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-header"><h2>Panel <span>Central</span></h2></div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/dashboard.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Dashboard</a></div>`:
    `<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/profile.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="user" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Panel Individual</a></div>`}
    <div class="sidebar-section"><div class="sidebar-label">Negocios</div>
      ${items.map(b=>`<a href="${b.url}" class="sidebar-item ${b.id==='nosotros'?'active':''}" style="--accent:${b.color}"><span class="icon">${b.icon}</span>${b.name}</a>`).join('')}
    </div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">Admin</div><a href="/admin.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Usuarios</a></div>`:''}
    <div class="sidebar-footer">
      <div class="sidebar-avatar">${(user.name||'U')[0].toUpperCase()}</div>
      <div class="sidebar-user"><div class="name">${user.name||'Usuario'}</div><div class="role">${user.role||'editor'}</div></div>
      <button class="theme-btn" onclick="toggleTheme()"><i class="feather" data-icon="moon" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
      <button class="theme-btn" onclick="logout()" style="font-size:.75rem"><i class="feather" data-icon="share-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
    </div>`;
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
function toggleTheme(){const t=document.documentElement.getAttribute('data-theme')==='light'?'':'light';document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t)}
function logout(){localStorage.clear();window.location.href='/index.html'}
if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light');
renderSidebar();

// ========== CONFIG ==========
const SYS='Eres el equipo creativo de NOSOTROS, un medio digital mexicano. Lenguaje coloquial mexicano pero sin perder seriedad. Solo usa lenguaje muy casual para ejemplificar o enfatizar. Ganchos constantes y atractivo.';

const FORMATS=[
  {id:'carrusel',name:'Carrusel IG',icon:'<i class="feather" data-icon="smartphone" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#E1306C',
   desc:'Slides con hook, contexto y CTA para Instagram',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'noticias_hoy',name:'Noticias de Hoy',icon:'<i class="feather" data-icon="globe" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#1DA1F2',
   desc:'Resumen diario de noticias internacionales y Mexico',
   badges:['Web Search'],steps:['Noticias','Contenido'],
   scope:'both',ns:4,ac:0,ma:0},
  {id:'sketch',name:'Sketch',icon:'<i class="feather" data-icon="smile" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#FF6B35',
   desc:'Sketch con humor, satira e indicaciones visuales',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'nr',name:'NR Investigacion',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',
   desc:'Investigacion a profundidad con multiples posturas',
   badges:['Web Search','Angulos'],steps:['Noticias','Angulos','Contenido'],
   scope:'mx',ns:1,ac:5,ma:2},
  {id:'youtube',name:'YouTube Largo',icon:'<i class="feather" data-icon="video" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#FF0000',
   desc:'Guion completo 12-15 min con timestamps y clips',
   badges:['Web Search','Angulos','Estructuras'],steps:['Noticias','Angulos','Estructura','Contenido'],
   scope:'mx',ns:1,ac:6,ma:3},
  {id:'noticia_manual',name:'Noticia Manual',icon:'<i class="feather" data-icon="edit" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#06B6D4',
   desc:'Pega la noticia, elige formato y genera contenido',
   badges:['Angulos','Formatos'],steps:['TextInput','FormatSel','Angulos','Contenido'],
   scope:null,ns:0,ac:5,ma:2},
  {id:'copy',name:'Copy & Titulo',icon:'<i class="feather" data-icon="edit-3" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#F59E0B',
   desc:'Copy para redes y titulo YouTube desde cualquier texto',
   badges:[],steps:['Texto','Contenido'],
   scope:null,ns:0,ac:0,ma:0}
];

const CATS=[
  {id:null,label:'Todas'},{id:'internacional',label:'Internacional'},{id:'economia',label:'Economia'},
  {id:'tecnologia',label:'Tecnologia'},{id:'deportes',label:'Deportes'},
  {id:'entretenimiento',label:'Entretenimiento'},{id:'salud',label:'Salud'},
  {id:'ciencia',label:'Ciencia'},{id:'guerra',label:'Guerra'},{id:'mexico',label:'Mexico'}
];

// ========== YOUTUBE MASTER PROMPT ==========
function buildYtPrompt(noticia, angulos, estructura) {
  const seccionesCustom = estructura ? `\nEstructura elegida: ${estructura.name}\nSecciones de la estructura: ${estructura.sections.join(' -> ')}\n\nADAPTA el contenido de los bloques de desarrollo a estas secciones.` : '';
  return `Noticia: ${noticia}
Angulos elegidos: ${angulos}${seccionesCustom}

Eres un guionista experto en videos de noticias para YouTube. Genera un guion COMPLETO para el canal NOSOTROS.

REGLAS FUNDAMENTALES:
1. El guion debe durar MINIMO 12 MINUTOS al leerse en voz alta (~150 palabras/minuto = MINIMO 1,800 palabras de dialogo). GENERA EL MAXIMO DE CONTENIDO POSIBLE.
2. Escribe TODO el dialogo palabra por palabra, listo para leer frente a camara como teleprompter. PROHIBIDO escribir indicaciones vagas como "hablar sobre X", "[desarrollar]", "[insertar datos]" o resumenes. Escribe EXACTAMENTE lo que el presentador dice.
3. NO HAY LIMITE de caracteres, parrafos ni longitud por seccion. Cada seccion debe ser TAN EXTENSA como necesite para cubrir el tema A FONDO.
4. Formato DOS COLUMNAS: izquierda = dialogo exacto | derecha = notas visuales (graficas, B-roll, texto overlay, cambios de camara)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# TITULO YOUTUBE
SEO optimizado, curiosidad irresistible, maximo 70 caracteres. NO clickbait falso.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## [0:00-0:30] APERTURA: HOOK + PROMESA

Los primeros 30 segundos determinan si el espectador se queda o se va. Esta seccion debe ser EXPLOSIVA.

HOOK (primeros 3-5 segundos):
- La primera frase debe ser una BOMBA. Un dato impactante, una declaracion que contradiga lo que todos creen, o un resultado presentado ANTES de explicar como se llego ahi
- Crear un "open loop": idea incompleta que el cerebro NECESITA cerrar
- NUNCA empieces con saludos, "Hola bienvenidos", nombre del canal, ni "Sabias que...?"
- Escribe la frase EXACTA, no la descripcion

Inmediatamente despues AMPLIFICAR el hook y hacer la PROMESA:
- Expandir la gravedad de lo que acabas de decir con 3-5 oraciones que suban la tension
- Mencionar 3-4 puntos ESPECIFICOS que se cubriran: "vamos a ver exactamente como paso", "te voy a mostrar los numeros que nadie quiere que veas", "y al final mi analisis de lo que realmente viene"
- La promesa debe ser CONCRETA, no vaga
- Cerrar con una frase que haga imposible irse

VISUAL: Imagen/clip de alto impacto + texto grande con frase clave + transicion rapida con previews de lo que viene

## [0:30-2:30] CONTEXTO: LOS HECHOS (~300 palabras de dialogo)

El espectador necesita entender perfectamente QUE PASO antes de entrar al analisis. Esta seccion construye la base de todo el video. NO la hagas corta.

Escribe MUCHOS parrafos completos de narracion cubriendo:
- Cronologia COMPLETA de los eventos: que paso primero, que paso despues, como llegamos al punto actual. Cada evento con su fecha, lugar y actores
- TODOS los actores principales: quienes son, que intereses tienen, que rol juegan, como se conectan entre si. Nombres completos, cargos, afiliaciones
- Datos duros REALES: fechas exactas, cifras con fuente, porcentajes, montos, lugares especificos
- Antecedentes historicos relevantes: que paso antes que explique por que estamos aqui hoy
- Cada oracion aporta informacion NUEVA. Cero relleno, cero repeticion
- Terminar con un open loop que conecte con lo que viene: "Pero eso es solo lo que se ve en la superficie. Lo que realmente esta pasando detras es mucho mas grave..."

VISUAL: Graficas explicativas, mapas con zonas marcadas, timeline visual, texto overlay con nombres/cifras, imagenes de actores, screenshots de fuentes

## [2:30-6:00] DESARROLLO PARTE 1: ANALISIS PROFUNDO (~500 palabras de dialogo)

Esta es la seccion MAS IMPORTANTE del guion. Aqui se va MAS ALLA de los hechos. Debe ser MUY LARGA Y DETALLADA.

IMPORTANTE: Empieza esta seccion con un REHOOK — una frase que reenganche al espectador y evite el drop-off del minuto 2: "Pero lo que te voy a contar ahora es lo que realmente causo todo esto. Y no es lo que piensas." Inmediatamente continua con el contenido.

Escribe TODO el contenido narrado, parrafo por parrafo. Cubre A FONDO:
- Las CAUSAS profundas: no solo que paso, sino POR QUE paso, quien se beneficia, quien pierde, que intereses estan detras
- Datos duros con fuentes: cifras, porcentajes, declaraciones textuales de expertos o involucrados, comparaciones con otros casos. CADA dato explicado y contextualizado
- Que significa cada dato para el espectador en su vida cotidiana. No solo dar numeros, explicar el IMPACTO REAL
- Ejemplos concretos y analogias que hagan tangible la informacion abstracta
- Datos comparativos: como esta la situacion en otros paises, como era antes vs como es ahora
- Micro-preguntas retoricas que mantengan pensando: "Y esto que significa para ti?" "Como es posible que esto pase?"

A la mitad de esta seccion (~3:30-4:00), integra un CTA de suscripcion de forma NATURAL dentro del flujo narrativo, conectado con lo que acabas de decir. NO lo separes como seccion aparte. Ejemplo: "...y esto es exactamente lo que vamos a seguir investigando. Si quieres estar al dia con este tema, suscribete porque vamos a cubrir cada actualizacion." E inmediatamente continua con mas contenido.

- Progresion ASCENDENTE: cada punto mas impactante que el anterior
- Pattern interrupts cada 45-60 segundos en las notas visuales
- Cerrar con un gancho hacia la siguiente seccion: "Pero espera, porque lo que viene cambia completamente la perspectiva..."

VISUAL: Alternar: presentador -> grafica/dato -> clip/imagen/B-roll -> presentador. Texto overlay con datos clave, screenshots de fuentes

## [6:00-9:30] DESARROLLO PARTE 2: PERSPECTIVAS Y CONSECUENCIAS (~500 palabras de dialogo)

Esta seccion es lo que DIFERENCIA este video de solo leer la noticia. Aqui se agrega VALOR REAL. Debe ser TAN EXTENSA como la Parte 1.

IMPORTANTE: Empieza con un REHOOK de mitad de video — el espectador lleva 6 minutos y necesita razon para quedarse: "Ahora, hay algo que la mayoria de los medios no estan cubriendo. Y cuando lo descubri, me quede sin palabras." Inmediatamente continua con contenido.

Escribe TODO el contenido narrado, parrafo por parrafo. Cubre A FONDO:
- Multiples perspectivas: que dicen los que estan a favor, que dicen los criticos, que dicen los expertos independientes. Desarrolla CADA perspectiva con argumentos y datos completos, no solo la menciones
- Fuentes oficiales con nombres especificos: estudios, reportes, declaraciones publicas, nombres de instituciones, fechas, cifras exactas
- IMPACTO REAL en la vida cotidiana: como afecta al bolsillo, a la seguridad, a la salud, al futuro. Ejemplos CONCRETOS y cercanos
- Comparaciones detalladas con otros paises, epocas, situaciones similares
- Analisis causa-efecto profundo: que cadena de eventos llevo a esta situacion, quienes son responsables
- CONSECUENCIAS a corto, mediano y largo plazo. Que pasa si esto continua. Que escenarios se abren
- Transiciones narrativas entre ideas: "Y esto nos lleva a otro punto crucial...", "Pero hay otro angulo que nadie esta mencionando..."
- Pattern interrupts cada 45-60 segundos en las notas visuales
- Cada revelacion construye sobre la anterior, subiendo la intensidad

VISUAL: Clips de declaraciones, graficas comparativas, mapas, screenshots de fuentes y reportes, infografias, split screen para comparar perspectivas

## [9:30-12:00] CIERRE: ANALISIS EDITORIAL + DESPEDIDA (~400 palabras de dialogo)

El climax intelectual del video. Aqui NOSOTROS se diferencia con perspectiva editorial PROPIA. Esta seccion NO es un resumen — es contenido NUEVO con opinion fundamentada.

IMPORTANTE: Empieza con un ultimo REHOOK: "Y lo mas importante de todo esto es algo que nadie esta diciendo en voz alta." Inmediatamente continua con el analisis.

Escribe TODO el contenido narrado. Cubre A FONDO:
- Opinion o perspectiva CLARA y fundamentada. No ser ambiguo ni tibio. Tomar postura con argumentos solidos basados en todo lo presentado
- Conectar los datos de TODO el video: "Como vimos al principio... y combinado con lo que acabamos de analizar... la conclusion es clara"
- Proyectar MULTIPLES escenarios futuros concretos y detallados: "Si esto sigue asi...", "Pero si cambia de rumbo...", "El peor escenario seria...", "El mejor escenario seria..."
- Impacto humano y emocional: como afecta a la gente real. Hacerlo PERSONAL y cercano
- Perspectiva unica: que ve NOSOTROS que otros medios no estan viendo
- Recomendaciones practicas: que puede hacer el espectador, a que debe estar atento, como prepararse
- Conexion con el panorama amplio: como se relaciona con otras tendencias y el futuro

Dentro del analisis, integra NATURALMENTE una pregunta que invite a comentar (NO como seccion aparte): "...y honestamente quiero saber tu opinion. Crees que [escenario A] o que [escenario B]? Dejamelo en los comentarios." Y continua cerrando.

CIERRE (ultimos 30 segundos):
- Frase resumen POTENTE que capture la esencia de todo el video
- "Dale like si te sirvio, suscribete para no perderte la siguiente actualizacion"
- Teaser proximo video: "Y si quieres entender [TEMA RELACIONADO], mira este video"
- "Nos vemos en el siguiente. Esto fue NOSOTROS."

VISUAL: Presentador en encuadre cercano e intimo, graficas de proyeccion, end screen con thumbnail + suscripcion (ultimos 20s)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
RECORDATORIO FINAL: El guion COMPLETO debe tener MINIMO 1,800 palabras de dialogo narrado (~12 minutos). Las 3 secciones de contenido (Contexto, Desarrollo 1, Desarrollo 2) son las mas largas y juntas deben sumar al menos 1,300 palabras. El Cierre con analisis editorial debe sumar al menos 400 palabras. NO escatimes en contenido. Escribe el guion mas completo, detallado y extenso posible.`;
}

// ========== STATE ==========
let S={view:'home',fid:null,step:0,phase:'input',ltxt:'',
  sq:'',cat:null,news:[],sn:new Set(),angles:[],sa:new Set(),
  structs:[],ss:null,result:'',itxt:'',err:null,selectedIds:new Set(),
  manual_news:'',manual_format:null,
  customAngle:'',
  analysis:null,analysisLoading:false};
let modTab='generar';
let newsPagination={page:1,pageSize:8,total:0,totalPages:0};

// ========== HELPERS ==========
function F(){return FORMATS.find(f=>f.id===S.fid)}
function getArticleId(article){return `${article.title}|${article.source}|${article.date}`}
function selN(){
  return S.news.filter((n,i)=>{
    const id=getArticleId(n);
    return S.selectedIds.has(id);
  })
}
function selA(){return[...S.sa].map(i=>S.angles[i])}
function pJ(t){const i=t.indexOf('{'),j=t.lastIndexOf('}');if(i===-1||j<=i)return null;try{return JSON.parse(t.substring(i,j+1))}catch{return null}}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function md(t){
  return esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/^### (.+)$/gm,'<h4>$1</h4>').replace(/^## (.+)$/gm,'<h3>$1</h3>').replace(/^# (.+)$/gm,'<h2>$1</h2>')
    .replace(/^---$/gm,'<hr>').replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>');
}

// ========== API ==========
async function apiNews(scope,category,page=1,pageSize=8){
  const r=await fetch('/api/nosotros/news-ai',{method:'POST',headers:hdrs,body:JSON.stringify({scope,category:category||undefined,page,pageSize})});
  const d=await r.json();if(d.error)throw new Error(d.error);
  if(d.pagination)newsPagination=d.pagination;
  return d.news||[];
}
async function apiGen(prompt,system,format_type){
  const r=await fetch('/api/nosotros/generate',{method:'POST',headers:hdrs,
    body:JSON.stringify({prompt,system:system||undefined,format_type:format_type||undefined})});
  const d=await r.json();if(d.error)throw new Error(d.error);return d.result||'';
}

// ========== MODULE TABS ==========
function setModTab(t){
  modTab=t;
  document.querySelectorAll('.module-tab').forEach((b,i)=>b.classList.toggle('active',(t==='generar'&&i===0)||(t==='historial'&&i===1)));
  if(t==='generar'){S.view='home';render()}
  else if(t==='historial'){loadHistory()}
}

let histSel=new Set();
let histPage=1,histPageSize=parseInt(localStorage.getItem('nosotros_hist_ps'))||10,histUserFilter='',histUsers=[];
async function loadHistory(){
  histSel.clear();
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    let url=`/api/nosotros/history?page=${histPage}&pageSize=${histPageSize}`;
    if(histUserFilter)url+=`&user_id=${histUserFilter}`;
    const r=await fetch(url,{headers:hdrs});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    const items=d.history||[];
    histUsers=d.users||histUsers;
    const pg=d.pagination||{page:1,totalPages:1,total:0};
    m.innerHTML=`
      <div class="hist-filters" style="display:flex;gap:.5rem;margin-bottom:.75rem;align-items:center;flex-wrap:wrap">
        <select onchange="histUserFilter=this.value;histPage=1;loadHistory()" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.8rem">
          <option value="">Todos los usuarios</option>
          ${histUsers.map(u=>`<option value="${u.id}" ${histUserFilter==u.id?'selected':''}>${esc(u.name)}</option>`).join('')}
        </select>
        <select onchange="histPageSize=+this.value;localStorage.setItem('nosotros_hist_ps',this.value);histPage=1;loadHistory()" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.8rem">
          <option value="5" ${histPageSize===5?'selected':''}>5 por pagina</option>
          <option value="10" ${histPageSize===10?'selected':''}>10 por pagina</option>
          <option value="20" ${histPageSize===20?'selected':''}>20 por pagina</option>
        </select>
        <span style="font-size:.75rem;color:var(--mt);margin-left:auto">${pg.total} resultado${pg.total!==1?'s':''}</span>
      </div>
      ${items.length?`
      ${canEdit?`<div style="display:flex;gap:.5rem;margin-bottom:.75rem;align-items:center;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:.35rem;cursor:pointer;font-size:.8rem;color:var(--mt)"><input type="checkbox" onchange="toggleAllHist(this.checked,${JSON.stringify(items.map(i=>i.id))})"> Seleccionar todos</label>
        <span id="histSelCount" style="font-size:.75rem;color:var(--mt)"></span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button id="btnBulkDel" onclick="bulkDelHistory()" style="display:none;background:#EF4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:.75rem;cursor:pointer">Eliminar seleccionados</button>
          <button onclick="delAllHistory()" style="background:none;border:1px solid #EF4444;color:#EF4444;border-radius:6px;padding:4px 12px;font-size:.75rem;cursor:pointer">Borrar todo</button>
        </div>
      </div>`:''}
      <div class="history-list">${items.map(h=>`
      <div class="history-item" style="position:relative">
        ${canEdit?`<input type="checkbox" data-hid="${h.id}" onchange="toggleHistSel(${h.id},this.checked)" style="position:absolute;top:.6rem;left:.5rem;cursor:pointer;accent-color:#EF4444">`:''}
        <div onclick="viewHistory(${h.id})" style="cursor:pointer;flex:1;${canEdit?'padding-left:1.5rem':''}">
          <div class="history-meta"><span>${h.format_type}</span><span style="color:var(--accent,#8B5CF6);font-weight:500">${esc(h.user_name||'Usuario')}</span><span>${new Date(h.created_at).toLocaleString('es-MX')}</span></div>
          <div class="history-preview">${esc(h.preview||'')}</div>
        </div>
        ${canEdit?`<button onclick="event.stopPropagation();delHistory(${h.id})" style="position:absolute;top:.5rem;right:.5rem;background:none;border:1px solid var(--border);border-radius:6px;color:var(--mt);cursor:pointer;padding:2px 6px;font-size:.7rem;transition:all .15s" onmouseover="this.style.borderColor='#EF4444';this.style.color='#EF4444'" onmouseout="this.style.borderColor='';this.style.color=''"><i class="feather" data-icon="trash-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>`:''}
      </div>`).join('')}</div>
      ${pg.totalPages>1?`<div style="display:flex;justify-content:center;gap:.4rem;margin-top:.75rem;flex-wrap:wrap">${Array.from({length:pg.totalPages},(_,i)=>i+1).map(p=>`<button onclick="histPage=${p};loadHistory()" style="padding:4px 10px;border-radius:6px;border:1px solid ${p===pg.page?'var(--accent,#8B5CF6)':'var(--border)'};background:${p===pg.page?'var(--accent,#8B5CF6)':'var(--card)'};color:${p===pg.page?'#fff':'var(--fg)'};cursor:pointer;font-size:.8rem">${p}</button>`).join('')}</div>`:''}`:'<p style="color:var(--mt);text-align:center;padding:2rem">No hay contenido generado aun.</p>'}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
function toggleHistSel(id,checked){if(checked)histSel.add(id);else histSel.delete(id);updHistSelUI()}
function toggleAllHist(checked,ids){histSel.clear();if(checked)ids.forEach(id=>histSel.add(id));document.querySelectorAll('[data-hid]').forEach(c=>c.checked=checked);updHistSelUI()}
function updHistSelUI(){const n=histSel.size;const c=document.getElementById('histSelCount');const b=document.getElementById('btnBulkDel');if(c)c.textContent=n?n+' seleccionado'+(n>1?'s':''):'';if(b)b.style.display=n?'inline-block':'none'}
async function bulkDelHistory(){if(!histSel.size)return;if(!confirm(`Eliminar ${histSel.size} elemento(s) del historial?`))return;try{const r=await fetch('/api/nosotros/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids:[...histSel]})});const d=await r.json();if(d.error)throw new Error(d.error);loadHistory()}catch(e){alert('Error: '+e.message)}}
async function delAllHistory(){if(!confirm('Eliminar TODO el historial de Nosotros? Esta accion no se puede deshacer.'))return;try{const r=await fetch('/api/nosotros/history?pageSize=9999',{headers:hdrs});const d=await r.json();const ids=(d.history||[]).map(h=>h.id);if(!ids.length)return;const r2=await fetch('/api/nosotros/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids})});const d2=await r2.json();if(d2.error)throw new Error(d2.error);loadHistory()}catch(e){alert('Error: '+e.message)}}

async function viewHistory(id){
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/nosotros/history/'+id,{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    const h=d.item;
    m.innerHTML=`<button class="btn-back" onclick="loadHistory()" style="margin-bottom:1rem">← Volver</button>
      <div class="result-box"><button class="copy-btn" onclick="cpText(this)"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button>
      <div class="result-content" data-raw="${esc(h.output_text)}">${md(h.output_text)}</div></div>`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}

async function delHistory(id){
  if(!confirm('Eliminar este contenido del historial?'))return;
  try{
    const r=await fetch('/api/nosotros/history/'+id,{method:'DELETE',headers:hdrs});
    if(!r.ok){const d=await r.json().catch(()=>({}));throw new Error(d.error||'Error HTTP '+r.status)}
    const d=await r.json();if(d.error)throw new Error(d.error);
    loadHistory();
  }catch(e){alert('Error al borrar: '+e.message)}
}

// ========== RENDER ==========
function render(){
  const m=document.getElementById('modContent');
  m.className='fade-in';
  m.innerHTML=S.view==='home'?rHome():rFlow();
  void m.offsetWidth;
  const si=document.getElementById('si');if(si)si.value=S.sq;
  const ti=document.getElementById('ti');if(ti)ti.value=S.itxt;
}

function rHome(){
  return`<div class="fmt-grid">${FORMATS.map(f=>`
    <div class="fmt-card" style="--c:${f.color}" onclick="goFmt('${f.id}')">
      <div class="fmt-icon">${f.icon}</div>
      <div class="fmt-name">${f.name}</div>
      <div class="fmt-desc">${f.desc}</div>
      ${f.badges.length?`<div class="fmt-badges">${f.badges.map(b=>`<span class="badge">${b}</span>`).join('')}</div>`:''}
    </div>`).join('')}</div>`;
}

function rFlow(){
  const f=F();
  return`<div style="--accent:${f.color}">
    <div class="flow-header">
      <button class="btn-back" onclick="goHome()">← Volver</button>
      <div class="flow-title"><span>${f.icon}</span> ${f.name}</div>
    </div>
    ${rSteps(f)}
    <div class="step-label">Paso ${S.step+1}: ${f.steps[S.step]}</div>
    ${S.err?`<div class="error-bar"><span>${esc(S.err)}</span><button onclick="clErr()">×</button></div>`:''}
    ${rContent(f)}
  </div>`;
}

function rSteps(f){
  let h='<div class="steps">';
  f.steps.forEach((s,i)=>{
    if(i>0)h+=`<div class="step-line ${i<=S.step?'done':''}"></div>`;
    h+=`<div class="step-dot ${i<S.step?'done':i===S.step?'active':''}">${i+1}</div>`;
  });
  return h+'</div>';
}

function rContent(f){
  if(S.phase==='loading')return`<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div><div class="loader-text">${S.ltxt}</div></div>`;
  if(S.phase==='result')return rResult();
  const st=f.steps[S.step];
  if(st==='Noticias'){
    if(S.news.length>0)return rNewsSel(f);
    return`<div class="actions"><button class="btn" onclick="retryFetch()">Reintentar carga de noticias</button></div>`;
  }
  if(st==='TextInput')return rManualNewsIn();
  if(st==='FormatSel')return rManualFormatSel();
  if(st==='Angulos')return rAngSel(f);
  if(st==='Estructura')return rStrSel();
  if(st==='Texto')return rTextIn();
  return'';
}

function rNewsSel(f){
  const n=f.ns,ok=S.selectedIds.size===n;
  const cats=`<div class="cats">${CATS.map(c=>`<button class="cat-btn ${S.cat===c.id?'active':''}" onclick="setCat(${c.id===null?'null':"'"+c.id+"'"})">${c.label}</button>`).join('')}</div>`;

  // Pagination controls
  const pag = newsPagination;
  const pagControls = pag.totalPages > 1 ? `
    <div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin-bottom:.75rem">
      <button class="btn-outline" ${pag.page===1?'disabled':''} onclick="changePage(${pag.page-1})" style="padding:4px 12px;font-size:.8rem">← Anterior</button>
      <span style="font-size:.8rem;color:var(--mt)">Página ${pag.page} de ${pag.totalPages}</span>
      <button class="btn-outline" ${pag.page===pag.totalPages?'disabled':''} onclick="changePage(${pag.page+1})" style="padding:4px 12px;font-size:.8rem">Siguiente →</button>
    </div>` : '';

  return`${cats}${pagControls}<p class="sel-hint">Selecciona ${n} noticia${n>1?'s':''} (${S.selectedIds.size}/${n})</p>
    <div class="sel-list">${S.news.map((nw,i)=>{
      const id=getArticleId(nw);
      return `<div class="sel-card ${S.selectedIds.has(id)?'on':''}" onclick="tgN(${i})">
        <div class="sel-check">${S.selectedIds.has(id)?'<i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>':''}</div>
        <div class="sel-body">
          <div class="sel-title">${esc(nw.title)}</div>
          <div class="sel-desc">${esc(nw.summary)}</div>
          <div class="sel-source">${esc(nw.source)} ${nw.date?'• '+formatNewsDate(nw.date):''}</div>
        </div></div>`;
    }).join('')}</div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="${f.steps[S.step+1]==='Contenido'?'goDirectContent()':'goAngles()'}">
      ${f.steps[S.step+1]==='Contenido'?'Generar contenido':'Generar angulos'}</button></div>`;
}

function rAngSel(f){
  const ok=S.sa.size>=1&&S.sa.size<=f.ma;
  const lbl=f.id==='youtube'?'Generar estructuras':f.id==='noticia_manual'?'Generar contenido':'Generar contenido';
  const nextFn=f.id==='noticia_manual'?'goManualFinalContent()':f.id==='youtube'?'goStructs()':'goFinalContent()';
  return`<p class="sel-hint">Selecciona 1-${f.ma} angulo${f.ma>1?'s':''} (${S.sa.size}/${f.ma})</p>
    <div class="sel-list">${S.angles.map((a,i)=>`
      <div class="sel-card ${S.sa.has(i)?'on':''}" onclick="tgA(${i})">
        <div class="sel-check">${S.sa.has(i)?'<i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>':''}</div>
        <div class="sel-body"><div class="sel-title">${esc(a.name)}</div><div class="sel-desc">${esc(a.description)}</div></div>
      </div>`).join('')}</div>
    <div style="margin-top:1rem;padding:1rem;border:1px dashed var(--border);border-radius:10px;background:rgba(255,255,255,0.03)">
      <div style="font-size:.8rem;font-weight:600;color:var(--mt);margin-bottom:.5rem">Agregar angulo propio</div>
      <div style="display:flex;gap:.5rem">
        <input type="text" id="customAngleInput" placeholder="Escribe tu angulo o enfoque..." value="${esc(S.customAngle)}" oninput="S.customAngle=this.value" onkeydown="if(event.key==='Enter'){event.preventDefault();addCustomAngle()}" style="flex:1;padding:.5rem .75rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-size:.85rem">
        <button onclick="addCustomAngle()" class="btn" style="white-space:nowrap;font-size:.8rem;padding:.5rem .75rem"><i class="fas fa-plus" style="margin-right:.25rem"></i>Agregar</button>
      </div>
    </div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="${nextFn}">${lbl}</button></div>`;
}

function rStrSel(){
  const ok=S.ss!==null;
  return`<p class="sel-hint">Selecciona 1 estructura</p>
    <div class="sel-list">${S.structs.map((s,i)=>`
      <div class="sel-card ${S.ss===i?'on':''}" onclick="selStr(${i})">
        <div class="sel-radio"></div>
        <div class="sel-body"><div class="sel-title">${esc(s.name)}</div><div class="sel-desc">${esc(s.description)}</div>
          ${s.sections?`<div class="sel-desc" style="margin-top:.25rem;opacity:.6;font-size:.75rem">${s.sections.map(x=>esc(x)).join(' → ')}</div>`:''}
        </div></div>`).join('')}</div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="goFinal()">Generar guion completo</button></div>`;
}

function rTextIn(){
  return`<textarea id="ti" class="ta" placeholder="Pega aqui el texto para generar copy y titulo..." oninput="S.itxt=this.value"></textarea>
    <div class="actions"><button class="btn" onclick="goCopy()">Generar copy y titulo</button></div>`;
}

function rManualNewsIn(){
  const html=`<textarea id="mn" class="ta" placeholder="Pega aqui la noticia que quieras convertir en contenido..." oninput="S.manual_news=this.value;render()">${esc(S.manual_news)}</textarea>
    <div class="actions"><button class="btn" ${S.manual_news.trim()?'':'disabled'} onclick="goManualFormatSel()">Siguiente paso</button></div>`;
  setTimeout(()=>{const ta=document.getElementById('mn');if(ta)ta.focus()},0);
  return html;
}

function rManualFormatSel(){
  const allowed=['carrusel','sketch','nr','youtube'];
  const allowedFormats=FORMATS.filter(f=>allowed.includes(f.id));
  const ok=S.manual_format!==null;
  return`<p class="sel-hint">Elige el formato para tu noticia</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem">
      ${allowedFormats.map((fmt,i)=>`
        <div class="fmt-card" ${S.manual_format===fmt.id?'style="border:2px solid '+fmt.color+';background:rgba(255,255,255,0.05)"':''} onclick="selManualFormat('${fmt.id}')" style="--c:${fmt.color};cursor:pointer;border:2px solid ${S.manual_format===fmt.id?fmt.color:'transparent'};transition:all 0.2s">
          <div class="fmt-icon">${fmt.icon}</div>
          <div class="fmt-name">${fmt.name}</div>
          <div class="fmt-desc" style="font-size:.75rem">${fmt.desc}</div>
        </div>`).join('')}
    </div>
    <div class="actions"><button class="btn" ${ok?'':'disabled'} onclick="goManualAngles()">Generar angulos</button></div>`;
}

function rResult(){
  let analysisHtml='';
  if(S.analysisLoading){
    analysisHtml=`<div class="analysis-bar" style="margin-top:1rem;padding:1rem;border-radius:12px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2)">
      <div style="display:flex;align-items:center;gap:.5rem;color:var(--nosotros)"><div class="loader-dots" style="display:flex;gap:4px"><span></span><span></span><span></span></div> Analizando viralidad...</div></div>`;
  }else if(S.analysis){
    const a=S.analysis;
    const scoreColor=a.score>=8?'#10B981':a.score>=5?'#F59E0B':'#EF4444';
    analysisHtml=`<div class="analysis-bar" style="margin-top:1rem;padding:1.25rem;border-radius:12px;background:rgba(139,92,246,0.06);border:1px solid rgba(139,92,246,0.15);backdrop-filter:blur(10px)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
        <div style="font-weight:600;font-size:.9rem;color:var(--text)"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:var(--nosotros)" aria-hidden="true"></i> Analisis de Viralidad</div>
        <div style="display:flex;align-items:center;gap:.5rem">
          <span style="font-size:1.5rem;font-weight:700;color:${scoreColor}">${a.score}</span>
          <span style="font-size:.8rem;color:var(--mt)">/10</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin-bottom:.75rem">
        <div style="padding:.6rem;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border)">
          <div style="font-size:.7rem;color:var(--mt);margin-bottom:.25rem">Engagement</div>
          <div style="font-weight:600;color:${a.engagement>=7?'#10B981':a.engagement>=4?'#F59E0B':'#EF4444'}">${a.engagement}/10</div>
        </div>
        <div style="padding:.6rem;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border)">
          <div style="font-size:.7rem;color:var(--mt);margin-bottom:.25rem">Noticia</div>
          <div style="font-weight:600;color:${a.news_quality>=7?'#10B981':a.news_quality>=4?'#F59E0B':'#EF4444'}">${a.news_quality}/10</div>
        </div>
        <div style="padding:.6rem;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border)">
          <div style="font-size:.7rem;color:var(--mt);margin-bottom:.25rem">Redaccion</div>
          <div style="font-weight:600;color:${a.writing>=7?'#10B981':a.writing>=4?'#F59E0B':'#EF4444'}">${a.writing}/10</div>
        </div>
      </div>
      <div style="font-size:.85rem;color:var(--text);line-height:1.5;margin-bottom:.75rem">
        <div style="font-weight:600;font-size:.75rem;color:var(--mt);margin-bottom:.35rem">Observaciones</div>
        ${a.observations.map(o=>'<div style="margin-bottom:.3rem">- '+esc(o)+'</div>').join('')}
      </div>
      <div style="margin-top:.75rem">
        <div style="font-weight:600;font-size:.75rem;color:var(--mt);margin-bottom:.35rem">Tus ajustes (opcional)</div>
        <textarea id="userAdjustments" placeholder="Escribe ajustes adicionales que quieras aplicar..." style="width:100%;min-height:60px;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:.8rem;resize:vertical;box-sizing:border-box"></textarea>
      </div>
      <button class="btn" onclick="improveResult()" style="width:100%;background:var(--nosotros);font-size:.85rem;padding:.6rem;margin-top:.5rem"><i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Mejorar basado en observaciones</button>
    </div>`;
  }else{
    analysisHtml=`<div style="margin-top:1rem"><button class="btn-outline btn" onclick="analyzeResult()" style="width:100%;border-color:var(--nosotros);color:var(--nosotros)"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Analizar viralidad con IA</button></div>`;
  }
  return`<div class="result-box">
    <button class="copy-btn" onclick="cpRes()"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button>
    <div class="result-content">${md(S.result)}</div></div>
    ${analysisHtml}
    <div class="actions"><button class="btn-outline btn" onclick="goHome()">Nuevo contenido</button></div>`;
}

// ========== HELPERS (Date formatting) ==========
function formatNewsDate(dateStr){
  if(!dateStr)return'';
  const d=new Date(dateStr);
  const today=new Date();today.setHours(0,0,0,0);
  const newsDate=new Date(d);newsDate.setHours(0,0,0,0);
  if(newsDate.getTime()===today.getTime())return'Hoy';
  const opts={month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'};
  return d.toLocaleDateString('es-MX',opts);
}

// ========== HANDLERS ==========
function goHome(){S={view:'home',fid:null,step:0,phase:'input',ltxt:'',sq:'',cat:null,news:[],sn:new Set(),angles:[],sa:new Set(),structs:[],ss:null,result:'',itxt:'',err:null,selectedIds:new Set(),manual_news:'',manual_format:null,customAngle:'',analysis:null,analysisLoading:false};newsPagination={page:1,pageSize:8,total:0,totalPages:0};render()}
function clErr(){S.err=null;render()}
function setCat(c){if(S.cat===c)return;S.cat=c;S.selectedIds=new Set();S.err=null;newsPagination.page=1;fetchN(F().scope,S.sq||undefined)}
function goFmt(id){
  S.view='flow';S.fid=id;S.step=0;S.news=[];S.sn=new Set();S.angles=[];S.sa=new Set();
  S.structs=[];S.ss=null;S.result='';S.err=null;S.sq='';S.cat=null;S.itxt='';S.selectedIds=new Set();
  S.manual_news='';S.manual_format=null;S.analysis=null;S.analysisLoading=false;
  newsPagination={page:1,pageSize:8,total:0,totalPages:0};
  const f=F();
  if(f.id==='copy'){S.phase='input';render();return}
  if(f.id==='noticia_manual'){S.phase='input';render();return}
  S.phase='loading';S.ltxt='Cargando noticias del dia...';render();fetchN(f.scope);
}
function retryFetch(){S.err=null;const f=F();newsPagination.page=1;S.phase='loading';S.ltxt='Cargando noticias...';render();fetchN(f.scope,S.sq||undefined)}
async function changePage(page){
  if(page<1||page>newsPagination.totalPages)return;
  newsPagination.page=page;
  // NO limpiar selecciones al cambiar página - mantener selecciones
  await fetchN(F().scope,S.sq||undefined,newsPagination.page);
}
async function fetchN(scope,query,page=1){
  S.phase='loading';S.ltxt='Buscando noticias actuales...';render();
  try{
    const news=await apiNews(scope,S.cat,page,newsPagination.pageSize);
    if(!news.length)throw new Error('No se encontraron noticias.');
    S.news=news;
    // Si es la primera página, limpiar selecciones. Si no, mantener las del usuario
    if(page===1)S.selectedIds=new Set();
    S.phase='select';
  }catch(e){S.err=e.message;S.phase='input';S.news=[]}
  render();
}
function tgN(i){
  const f=F();
  const article=S.news[i];
  const id=getArticleId(article);

  if(S.selectedIds.has(id)){
    S.selectedIds.delete(id);
  }else{
    if(f.ns===1)S.selectedIds.clear();
    if(S.selectedIds.size<f.ns)S.selectedIds.add(id);
  }
  render()
}
function tgA(i){const f=F();if(S.sa.has(i))S.sa.delete(i);else{if(S.sa.size<f.ma)S.sa.add(i)}render()}
function addCustomAngle(){const v=(S.customAngle||'').trim();if(!v)return;S.angles.push({id:S.angles.length+1,name:v,description:'Angulo personalizado'});S.sa.add(S.angles.length-1);S.customAngle='';render()}
function selStr(i){S.ss=i;render()}

async function goAngles(){
  const f=F(),news=selN();
  S.step=f.steps.indexOf('Angulos');S.phase='loading';S.ltxt='Generando angulos narrativos...';render();
  const nt=news.map(n=>`- ${n.title}: ${n.summary}`).join('\n');
  const prompt=news.length===1
    ?`Noticia:\n${nt}\n\nGenera ${f.ac} angulos narrativos distintos. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`
    :`Noticias:\n${nt}\n\nGenera ${f.ac} angulos narrativos generales para este conjunto. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.angles)throw new Error('No se pudieron parsear angulos');S.angles=p.angles;S.phase='select'}
  catch(e){S.err=e.message;S.step=0;S.phase='select'}render();
}

async function goNext(){if(F().id==='youtube')await goStructs();else await goFinalContent()}

async function goStructs(){
  const f=F(),news=selN(),ang=selA();
  S.step=f.steps.indexOf('Estructura');S.phase='loading';S.ltxt='Generando estructuras...';render();
  const n=news[0],at=ang.map(a=>a.name).join(', ');
  const prompt=`Noticia: ${n.title} - ${n.summary}\nAngulos: ${at}\n\nGenera 4 estructuras de storytelling para video YouTube de 10 minutos. Cada estructura propone una forma diferente de organizar el CONTENIDO DE DESARROLLO del video (los bloques donde se profundiza la noticia).\n\nEl video SIEMPRE tendra esta estructura fija:\n- Hook (0:00-0:03)\n- Amplificacion + Promesa (0:03-0:15)\n- Contexto rapido (0:15-2:00)\n- Rehook #1 (~2:00)\n- DESARROLLO BLOQUE 1 (2:00-5:00) ← las secciones que generes van AQUI\n- CTA suscripcion (~3:30)\n- Rehook #2 (~5:00)\n- DESARROLLO BLOQUE 2 (5:00-8:00) ← y AQUI\n- Rehook #3 (~8:00)\n- BLOQUE FINAL + Analisis (8:00-11:00) ← y AQUI\n- CTA comentarios (~9:00)\n- Cierre + End Screen\n\nTus 4 estructuras deben proponer DIFERENTES formas de organizar el contenido de desarrollo (los 3 bloques). Cada estructura tiene 3-5 secciones de desarrollo con nombres emocionantes que generen curiosidad.\n\nEjemplo: {"id":1,"name":"Cronologica Reveladora","description":"De los hechos al impacto oculto","sections":["Los hechos que nadie cuestiono","El dato que lo cambia todo","Las consecuencias que nadie ve venir"]}\n\nResponde SOLO con JSON valido:\n{"structures":[{"id":1,"name":"nombre","description":"descripcion breve","sections":["seccion1","seccion2","seccion3"]}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.structures)throw new Error('No se pudieron parsear estructuras');S.structs=p.structures;S.phase='select'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

async function goDirectContent(){
  const f=F(),news=selN();S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  try{const txt=await apiGen(buildFinal(f,news,[],null),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=0;S.phase='select'}render();
}

async function goFinalContent(){
  const f=F(),news=selN(),ang=selA();S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  try{const txt=await apiGen(buildFinal(f,news,ang,null),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

async function goFinal(){
  const f=F(),news=selN(),ang=selA(),str=S.structs[S.ss];
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando guion completo...';render();
  try{const txt=await apiGen(buildFinal(f,news,ang,str),SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Estructura');S.phase='select'}render();
}

async function goCopy(){
  const t=S.itxt.trim();if(!t)return;const f=F();
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando copy y titulo...';render();
  const prompt=`Texto:\n${t}\n\nGenera:\n- Copy redes sociales (280 caracteres maximo, con emojis)\n- Titulo YouTube SEO`;
  try{const txt=await apiGen(prompt,SYS,f.id);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=0;S.phase='input'}render();
}

function goManualFormatSel(){
  const t=S.manual_news.trim();
  if(!t){S.err='Por favor pega una noticia';render();return}
  S.step=F().steps.indexOf('FormatSel');
  S.phase='input';
  render();
}

function selManualFormat(fmt){
  S.manual_format=fmt;
  render();
}

async function goManualAngles(){
  const f=F(),news=S.manual_news.trim();
  if(!S.manual_format){S.err='Selecciona un formato';render();return}
  const fmt=FORMATS.find(x=>x.id===S.manual_format);
  if(!fmt){S.err='Formato inválido';render();return}
  S.step=f.steps.indexOf('Angulos');S.phase='loading';S.ltxt='Generando angulos narrativos...';render();
  const prompt=`Noticia:\n${news}\n\nGenera ${fmt.ac} angulos narrativos distintos. Responde SOLO con JSON valido:\n{"angles":[{"id":1,"name":"nombre corto","description":"descripcion en 1 linea"}]}`;
  try{const txt=await apiGen(prompt);const p=pJ(txt);if(!p?.angles)throw new Error('No se pudieron parsear angulos');S.angles=p.angles;S.phase='select'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('FormatSel');S.phase='select'}render();
}

async function goManualFinalContent(){
  const f=F(),news=S.manual_news.trim(),fmt=FORMATS.find(x=>x.id===S.manual_format),ang=selA();
  S.step=f.steps.length-1;S.phase='loading';S.ltxt='Generando contenido final...';render();
  const nt=news;
  const at=ang.map(a=>a.name).join(', ');
  let prompt='';
  switch(S.manual_format){
    case'carrusel':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un redactor de noticias para Instagram. Escribes carruseles informativos para @nosotros.news.\n\nREGLAS DE ESTILO (OBLIGATORIAS EN TODO EL CARRUSEL):\n- Frases cortas y directas. Sin adornos.\n- Tono periodistico pero accesible. Como si le explicaras a un amigo inteligente.\n- PROHIBIDO usar emojis en cualquier parte (slides, copies, todo).\n- NO uses signos de exclamacion innecesarios.\n- NO uses palabras como "increible", "impactante", "sorprendente".\n- Usa datos concretos (numeros, nombres, porcentajes).\n\nESTRUCTURA (4 slides obligatorios):\n\nSLIDE 1 — GANCHO\n- UNA sola linea. MAXIMO 10 PALABRAS, ni una mas. Titular potente y directo. Si tiene mas de 10 palabras, reescribelo hasta que quepa.\n\nSLIDE 2 — QUE PASO\n- Cuenta inicialmente que paso en la noticia: los hechos concretos.\n- Responde que, donde, cuando, quienes.\n- Entre 150 y 200 caracteres.\n\nSLIDE 3 — CONTEXTO\n- Agrega contexto, analisis o consecuencias.\n- Conecta con el impacto real: politico, economico o social.\n- Entre 150 y 200 caracteres.\n\nSLIDE 4 — CIERRE\n- Exactamente: "Siguenos para mas noticias."\n\nADEMAS genera:\n\nCOPY LARGO (para Instagram):\n- FORZOSAMENTE 600 caracteres. Ni menos, ni mucho mas.\n- Es practicamente TODA la noticia resumida: que paso, donde paso, como paso, quienes estan involucrados, por que importa, que consecuencias tiene.\n- Escribe parrafos completos, no bullets.\n- Termina con 3 hashtags relevantes.\n- NO agregues call to action, ni CTA, ni "lee mas", ni "siguenos". Solo la noticia y los hashtags.\n- Sin emojis.\n\nCOPY CORTO (para Twitter/X):\n- Maximo 200 caracteres.\n- Version resumida del copy largo. Solo la noticia, directo.\n- Termina con 3 hashtags relevantes.\n- NO agregues CTA ni "lee mas". Sin emojis.\n\nGenera el carrusel siguiendo este formato exacto. Responde SOLO con los slides y los copies, sin explicaciones adicionales.`;break;
    case'sketch':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un guionista de sketches de noticias para @nosotros.news. Escribes guiones breves, faciles de grabar en casa, con humor inteligente.\n\nESTRUCTURA DEL SKETCH (seguir este orden exacto):\n\n## ESCENA — PERSONAJE A vs PERSONAJE B\n- Define dos personajes con posiciones opuestas sobre la noticia.\n- Nombre y descripcion breve de cada uno (ej: "Juan — el que siempre defiende al gobierno" / "Carlos — el esceptico que no le cree nada").\n- Escribe un dialogo corto entre ambos (maximo 6-8 lineas de dialogo total). Debe ser gracioso, satirico, exagerado pero que refleje las dos posturas reales sobre la noticia.\n- La escena debe ser MUY SIMPLE de grabar: dos personas hablando, sin escenografia especial, grabable en una sala o escritorio.\n- Indica si se puede reforzar con material audiovisual intercalado (ej: "Insertar clip/imagen de [referencia al tema]").\n\n## CTA REDES (OBLIGATORIO — justo despues de la escena, antes del contexto)\n- 1-2 oraciones INTEGRADAS de forma natural como transicion entre la escena y el contexto.\n- Debe sentirse como parte del guion, NO como un anuncio.\n- SIEMPRE debe incluir la frase "no olvides seguirnos" integrada naturalmente. NO menciones nombres de canales ni redes especificas.\n- Ejemplo: "Pero antes de meternos a fondo en lo que realmente esta pasando, no olvides seguirnos para que no te pierdas ninguno de estos formatos. Ahora si, vamos con los hechos."\n- SIEMPRE incluir este CTA. Es OBLIGATORIO.\n\n## CONTEXTO A CAMARA\n- Despues del CTA, el presentador habla DIRECTO a camara.\n- Explica la noticia real con datos concretos: que paso, quienes, donde, por que importa.\n- Tono serio pero accesible. Entre 150 y 250 palabras.\n- Si aplica, menciona fuentes o datos duros.\n- SIEMPRE cierra el contexto con una conclusion de la noticia: que significa, que sigue, o que impacto tiene. No dejes la noticia sin cerrar.\n\n## CIERRE\n- Despues de la conclusion de la noticia, termina SIEMPRE con el CTA exacto: "Siguenos para mas noticias."\n\n## COPY REDES\n- Maximo 280 caracteres. Resumen directo de la noticia, sin emojis, sin CTA. Termina con 3 hashtags.\n\n## TITULO YOUTUBE\n- Titulo SEO optimizado, maximo 60 caracteres, que genere curiosidad.\n\nGenera el sketch completo. Responde SOLO con el guion, sin explicaciones adicionales.`;break;
    case'nr':prompt=`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera una Nota de Investigacion con estos elementos en este orden exacto:\n\n## HOOK\nGancho que atrape al espectador desde el primer segundo.\n\n## CONTEXTO GENERAL\nQue paso, donde, cuando, quienes estan involucrados.\n\n## CTA REDES (OBLIGATORIO — despues del contexto general, antes del contexto a fondo)\n1-2 oraciones integradas NATURALMENTE como transicion entre el contexto general y el analisis profundo. Debe sentirse como parte del guion, NO como un anuncio aparte.\nSIEMPRE debe incluir la frase "no olvides seguirnos" integrada naturalmente. NO menciones nombres de canales ni redes especificas.\nEjemplo: "Y esto que te acabo de contar es apenas la superficie. No olvides seguirnos para que no te pierdas ninguna actualizacion. Ahora si, vamos a lo profundo."\nSIEMPRE incluir este CTA. Es OBLIGATORIO.\n\n## CONTEXTO A FONDO\nAnalisis profundo, datos duros, investigacion detallada.\n\n## DIFERENTES POSTURAS\nPerspectivas y opiniones contrastantes sobre el tema.\n\n## CIERRE\nConclusion y reflexion final.\n\n## COPY REDES\nCopy redes sociales: 280 caracteres.\n\n## TITULO YOUTUBE\nTitulo SEO optimizado.`;break;
    case'youtube':prompt=buildYtPrompt(nt,at,null);break;
  }
  try{const txt=await apiGen(prompt,SYS,S.manual_format);S.result=txt;S.phase='result'}
  catch(e){S.err=e.message;S.step=f.steps.indexOf('Angulos');S.phase='select'}render();
}

function buildFinal(f,news,ang,str){
  const nt=news.map(n=>`${n.title}: ${n.summary}`).join('\n');
  const at=ang.map(a=>a.name).join(', ');
  switch(f.id){
    case'carrusel':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un redactor de noticias para Instagram. Escribes carruseles informativos para @nosotros.news.\n\nREGLAS DE ESTILO (OBLIGATORIAS EN TODO EL CARRUSEL):\n- Frases cortas y directas. Sin adornos.\n- Tono periodistico pero accesible. Como si le explicaras a un amigo inteligente.\n- PROHIBIDO usar emojis en cualquier parte (slides, copies, todo).\n- NO uses signos de exclamacion innecesarios.\n- NO uses palabras como "increible", "impactante", "sorprendente".\n- Usa datos concretos (numeros, nombres, porcentajes).\n\nESTRUCTURA (4 slides obligatorios):\n\nSLIDE 1 — GANCHO\n- UNA sola linea. MAXIMO 10 PALABRAS, ni una mas. Titular potente y directo. Si tiene mas de 10 palabras, reescribelo hasta que quepa.\n\nSLIDE 2 — QUE PASO\n- Cuenta inicialmente que paso en la noticia: los hechos concretos.\n- Responde que, donde, cuando, quienes.\n- Entre 150 y 200 caracteres.\n\nSLIDE 3 — CONTEXTO\n- Agrega contexto, analisis o consecuencias.\n- Conecta con el impacto real: politico, economico o social.\n- Entre 150 y 200 caracteres.\n\nSLIDE 4 — CIERRE\n- Exactamente: "Siguenos para mas noticias."\n\nADEMAS genera:\n\nCOPY LARGO (para Instagram):\n- FORZOSAMENTE 600 caracteres. Ni menos, ni mucho mas.\n- Es practicamente TODA la noticia resumida: que paso, donde paso, como paso, quienes estan involucrados, por que importa, que consecuencias tiene.\n- Escribe parrafos completos, no bullets.\n- Termina con 3 hashtags relevantes.\n- NO agregues call to action, ni CTA, ni "lee mas", ni "siguenos". Solo la noticia y los hashtags.\n- Sin emojis.\n\nCOPY CORTO (para Twitter/X):\n- Maximo 200 caracteres.\n- Version resumida del copy largo. Solo la noticia, directo.\n- Termina con 3 hashtags relevantes.\n- NO agregues CTA ni "lee mas". Sin emojis.\n\nGenera el carrusel siguiendo este formato exacto. Responde SOLO con los slides y los copies, sin explicaciones adicionales.`;
    case'noticias_hoy':case'noticias_mx':return`Noticias seleccionadas:\n${nt}\n\nGenera un guion de noticias con esta estructura FIJA (respetala exactamente):\n\n## HOOK\nUna linea por cada noticia, maximo 6 palabras cada una, estilo palabras clave impactantes. Van una tras otra, sin introduccion, sin contexto, sin saludo. Solo los hooks.\n\n## CTA (OBLIGATORIO — justo despues del hook, antes de las noticias)\n1 oracion organica que sirva de transicion entre los hooks y el desarrollo. Debe sentirse natural, como parte del flujo del guion. NO menciones nombres de canales ni redes.\nEjemplo: "No olvides seguirnos para que no te pierdas ninguna de estas noticias. Empezamos."\nSIEMPRE incluir este CTA.\n\n## NOTICIAS\nINMEDIATAMENTE despues del CTA, sin ninguna introduccion ni transicion, salta directo al desarrollo de cada noticia:\n- Noticia 1: desarrollo breve\n- Noticia 2: desarrollo breve\n- Noticia 3: desarrollo breve\n- Noticia 4: desarrollo breve\n\n## CIERRE\nSiempre termina con este CTA exacto: "No olvides seguirnos para mas noticias. Te enteraste con Nosotros."\n\n## COPY Y TITULO\n- Copy redes sociales: 280 caracteres\n- Titulo YouTube`;
    case'sketch':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nEres un guionista de sketches de noticias para @nosotros.news. Escribes guiones breves, faciles de grabar en casa, con humor inteligente.\n\nESTRUCTURA DEL SKETCH (seguir este orden exacto):\n\n## ESCENA — PERSONAJE A vs PERSONAJE B\n- Define dos personajes con posiciones opuestas sobre la noticia.\n- Nombre y descripcion breve de cada uno (ej: "Juan — el que siempre defiende al gobierno" / "Carlos — el esceptico que no le cree nada").\n- Escribe un dialogo corto entre ambos (maximo 6-8 lineas de dialogo total). Debe ser gracioso, satirico, exagerado pero que refleje las dos posturas reales sobre la noticia.\n- La escena debe ser MUY SIMPLE de grabar: dos personas hablando, sin escenografia especial, grabable en una sala o escritorio.\n- Indica si se puede reforzar con material audiovisual intercalado (ej: "Insertar clip/imagen de [referencia al tema]").\n\n## CTA REDES (OBLIGATORIO — justo despues de la escena, antes del contexto)\n- 1-2 oraciones INTEGRADAS de forma natural como transicion entre la escena y el contexto.\n- Debe sentirse como parte del guion, NO como un anuncio. El presentador lo dice mientras transiciona al contexto.\n- Ejemplo: "Pero antes de meternos a fondo en lo que realmente esta pasando, no olvides seguirnos para que no te pierdas ninguno de estos formatos. Ahora si, vamos con los hechos."\n- SIEMPRE incluir este CTA. Es OBLIGATORIO.\n\n## CONTEXTO A CAMARA\n- Despues del CTA, el presentador habla DIRECTO a camara.\n- Explica la noticia real con datos concretos: que paso, quienes, donde, por que importa.\n- Tono serio pero accesible. Entre 150 y 250 palabras.\n- Si aplica, menciona fuentes o datos duros.\n- SIEMPRE cierra el contexto con una conclusion de la noticia: que significa, que sigue, o que impacto tiene. No dejes la noticia sin cerrar.\n\n## CIERRE\n- Despues de la conclusion de la noticia, termina SIEMPRE con el CTA exacto: "Siguenos para mas noticias."\n\n## COPY REDES\n- Maximo 280 caracteres. Resumen directo de la noticia, sin emojis, sin CTA. Termina con 3 hashtags.\n\n## TITULO YOUTUBE\n- Titulo SEO optimizado, maximo 60 caracteres, que genere curiosidad.\n\nGenera el sketch completo. Responde SOLO con el guion, sin explicaciones adicionales.`;
    case'nr':return`Noticia: ${nt}\nAngulos elegidos: ${at}\n\nGenera una Nota de Investigacion con estos elementos en este orden exacto:\n\n## HOOK\nGancho que atrape al espectador desde el primer segundo.\n\n## CONTEXTO GENERAL\nQue paso, donde, cuando, quienes estan involucrados.\n\n## CTA REDES (OBLIGATORIO — despues del contexto general, antes del contexto a fondo)\n1-2 oraciones integradas NATURALMENTE como transicion entre el contexto general y el analisis profundo. Debe sentirse como parte del guion, NO como un anuncio aparte.\nSIEMPRE debe incluir la frase "no olvides seguirnos" integrada naturalmente. NO menciones nombres de canales ni redes especificas.\nEjemplo: "Y esto que te acabo de contar es apenas la superficie. No olvides seguirnos para que no te pierdas ninguna actualizacion. Ahora si, vamos a lo profundo."\nSIEMPRE incluir este CTA. Es OBLIGATORIO.\n\n## CONTEXTO A FONDO\nAnalisis profundo, datos duros, investigacion detallada.\n\n## DIFERENTES POSTURAS\nPerspectivas y opiniones contrastantes sobre el tema.\n\n## CIERRE\nConclusion y reflexion final.\n\n## COPY REDES\nCopy redes sociales: 280 caracteres.\n\n## TITULO YOUTUBE\nTitulo SEO optimizado.`;
    case'youtube':return buildYtPrompt(nt,at,str);
    default:return'';
  }
}

async function analyzeResult(){
  S.analysisLoading=true;S.analysis=null;render();
  const prompt=`Analiza el siguiente contenido para redes sociales y evalua su potencial de viralidad.

CONTENIDO:
${S.result}

Responde SOLO con JSON valido en este formato exacto:
{"score":7,"engagement":8,"news_quality":6,"writing":7,"observations":["observacion 1","observacion 2","observacion 3"]}

Criterios de evaluacion:
- score: Calificacion general de viralidad del 1 al 10
- engagement: Potencial de interaccion (likes, comentarios, compartidos). Evalua si el gancho atrapa, si genera curiosidad, si invita a interactuar.
- news_quality: Calidad de la noticia. Evalua relevancia, datos concretos, fuentes, actualidad.
- writing: Calidad de redaccion. Evalua claridad, tono, estructura, longitud adecuada, ortografia.
- observations: Array de 3-5 observaciones especificas y accionables para mejorar el contenido. Se concreto: "El slide 1 tiene 15 palabras, reducir a 10" en vez de "mejorar el gancho".

Se critico y honesto. Un 10 es practicamente imposible.`;
  try{
    const txt=await apiGen(prompt);
    const parsed=pJ(txt);
    if(!parsed||!parsed.score)throw new Error('No se pudo analizar');
    S.analysis=parsed;
  }catch(e){S.err='Error al analizar: '+e.message;S.analysis=null}
  S.analysisLoading=false;render();
}

async function improveResult(){
  if(!S.analysis)return;
  const userAdj=(document.getElementById('userAdjustments')||{}).value||'';
  S.phase='loading';S.ltxt='Mejorando contenido basado en observaciones...';render();
  const obs=S.analysis.observations.join('\n- ');
  let adjustBlock='';
  if(userAdj.trim()){adjustBlock=`\n\nAjustes adicionales del usuario (PRIORIDAD ALTA, aplica estos cambios obligatoriamente):\n${userAdj.trim()}`}
  const prompt=`Aqui esta el contenido original:

${S.result}

Un analisis de viralidad detecto estas observaciones para mejorar:
- ${obs}${adjustBlock}

Reescribe el contenido COMPLETO aplicando TODAS las observaciones${userAdj.trim()?' y los ajustes del usuario':''}. Mantiene el mismo formato y estructura pero mejora cada punto senalado. Responde SOLO con el contenido mejorado, sin explicaciones.`;
  try{
    const txt=await apiGen(prompt,SYS,S.fid||S.manual_format);
    S.result=txt;S.analysis=null;S.analysisLoading=false;S.phase='result';
  }catch(e){S.err='Error al mejorar: '+e.message;S.phase='result'}
  render();
}

function cpRes(){
  const text=S.result;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>showCopied()).catch(()=>fallbackCopy(text));
  }else{fallbackCopy(text)}
}
function cpText(btn){
  const text=btn.parentElement.querySelector('.result-content').getAttribute('data-raw')||btn.parentElement.querySelector('.result-content').textContent;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{btn.textContent='Copiado!';setTimeout(()=>btn.textContent='<i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar',2000)}).catch(()=>fallbackCopy(text));
  }else{fallbackCopy(text)}
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0';
  document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showCopied();
}
function showCopied(){const b=document.querySelector('.copy-btn');if(b){b.textContent='Copiado!';setTimeout(()=>b.textContent='<i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar',2000)}}

// ========== PERMISSIONS ==========
if(!canCreate){document.getElementById('tabGenerar').style.display='none';modTab='historial';document.querySelectorAll('.module-tab')[1].classList.add('active')}

// ========== INIT ==========
if(modTab==='historial')loadHistory();else render();
</script>
<script src="/emoji-to-svg.js"></script></body>
</html>
