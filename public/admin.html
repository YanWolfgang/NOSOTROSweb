<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Central — Admin</title>
<link rel="icon" type="image/png" href="/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="content fade-in" id="content">
    <div class="page-header"><h1><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Usuarios</h1><p>Administrar usuarios y permisos</p></div>
    <div id="userList"></div>
  </main>
</div>
<div id="modal"></div>
<script>
const token=localStorage.getItem('token');
if(!token){window.location.href='/index.html';}
const user=JSON.parse(localStorage.getItem('user')||'{}');
if(user.role!=='admin'){window.location.href='/dashboard.html';}
const hdrs={'Content-Type':'application/json','Authorization':'Bearer '+token};

const BUSINESSES=[
  {id:'nosotros',name:'NOSOTROS',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',url:'/nosotros.html'},
  {id:'duelazo',name:'DUELAZO',icon:'<i class="feather" data-icon="activity" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#10B981',url:'/duelazo.html'},
  {id:'spacebox',name:'SPACEBOX',icon:'<i class="feather" data-icon="package" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#3B82F6',url:'/spacebox.html'},
  {id:'styly',name:'STYLY',icon:'<i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#EC4899',url:'/styly.html'}
];
const ALL_BIZ=['nosotros','duelazo','spacebox','styly'];
const ALL_PERMS=['ver','crear','editar'];
const ROLES=['admin','manager','editor','viewer'];
const ROLE_DEFAULTS={
  admin:ALL_BIZ.reduce((o,b)=>(o[b]=['ver','crear','editar'],o),{}),
  manager:ALL_BIZ.reduce((o,b)=>(o[b]=['ver','crear'],o),{}),
  editor:ALL_BIZ.reduce((o,b)=>(o[b]=['ver','crear','editar'],o),{}),
  viewer:ALL_BIZ.reduce((o,b)=>(o[b]=['ver'],o),{})
};

function renderSidebar(){
  const bs=user.businesses||[];const isAdmin=user.role==='admin';
  const items=BUSINESSES.filter(b=>isAdmin||bs.includes(b.id));
  document.getElementById('sidebar').innerHTML=`
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-header"><h2>Panel <span>Central</span></h2></div>
    <div class="sidebar-section"><div class="sidebar-label">General</div><a href="/dashboard.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Dashboard</a><a href="/profile.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="user" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Panel Individual</a></div>
    <div class="sidebar-section"><div class="sidebar-label">Negocios</div>
      ${items.map(b=>`<a href="${b.url}" class="sidebar-item" style="--accent:${b.color}"><span class="icon">${b.icon}</span>${b.name}</a>`).join('')}
    </div>
    <div class="sidebar-section"><div class="sidebar-label">Admin</div><a href="/admin.html" class="sidebar-item active"><span class="icon"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Usuarios</a></div>
    <div class="sidebar-footer">
      <div class="sidebar-avatar">${(user.name||'U')[0].toUpperCase()}</div>
      <div class="sidebar-user"><div class="name">${user.name||'Usuario'}</div><div class="role">${user.role||'editor'}</div></div>
      <button class="theme-btn" onclick="toggleTheme()"><i class="feather" data-icon="moon" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
      <button class="theme-btn" onclick="logout()" style="font-size:.75rem"><i class="feather" data-icon="share-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
    </div>`;
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
function toggleTheme(){const t=document.documentElement.getAttribute('data-theme')==='light'?'':'light';document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t)}
function logout(){localStorage.clear();window.location.href='/index.html'}
if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light');
renderSidebar();

let users=[];
async function loadUsers(){
  const el=document.getElementById('userList');
  el.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/admin/users',{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    users=d.users||[];
    renderUsers();
  }catch(e){el.innerHTML=`<div class="error-bar"><span>${e.message}</span></div>`}
}

function permSummary(perms){
  if(!perms||!Object.keys(perms).length)return'<span style="color:var(--mt)">Sin permisos</span>';
  return Object.entries(perms).filter(([,v])=>v&&v.length).map(([biz,acts])=>{
    const b=BUSINESSES.find(x=>x.id===biz);
    const label=b?b.name:biz.toUpperCase();
    const tags=acts.map(a=>{
      const colors={ver:'#3B82F6',crear:'#10B981',editar:'#F59E0B'};
      return`<span style="background:${colors[a]||'#666'};color:#fff;padding:1px 6px;border-radius:4px;font-size:.65rem;margin-left:2px">${a}</span>`;
    }).join('');
    return`<div style="margin-bottom:2px"><strong style="font-size:.75rem">${label}</strong> ${tags}</div>`;
  }).join('');
}

function renderUsers(){
  const el=document.getElementById('userList');
  el.innerHTML=`<div style="overflow-x:auto"><table class="admin-table">
    <thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Permisos</th><th>Estado</th><th>Acciones</th></tr></thead>
    <tbody>${users.map(u=>{
      return`<tr>
        <td>${u.name}</td><td>${u.email}</td>
        <td><span style="text-transform:capitalize;background:${u.role==='admin'?'#8B5CF6':u.role==='manager'?'#F59E0B':u.role==='viewer'?'#6B7280':'#3B82F6'};color:#fff;padding:2px 8px;border-radius:6px;font-size:.75rem">${u.role}</span></td>
        <td style="max-width:250px">${permSummary(u.permissions)}</td>
        <td><span class="badge-status ${u.status==='active'?'badge-active':'badge-pending'}">${u.status}</span></td>
        <td><div class="admin-actions">
          ${u.status==='pending'?`<button onclick="activateUser(${u.id})">Activar</button>`:''}
          <button onclick="editPermisos(${u.id})">Permisos</button>
          ${u.email!=='yan@admin.com'?`<button onclick="deleteUser(${u.id})" style="color:#f87171">Eliminar</button>`:''}
        </div></td>
      </tr>`}).join('')}</tbody></table></div>`;
}

async function activateUser(id){
  try{
    await fetch(`/api/admin/users/${id}`,{method:'PUT',headers:hdrs,body:JSON.stringify({status:'active'})});
    loadUsers();
  }catch(e){alert(e.message)}
}

let editingPerms={};
function editPermisos(id){
  const u=users.find(x=>x.id===id);if(!u)return;
  editingPerms=JSON.parse(JSON.stringify(u.permissions||{}));
  renderPermModal(u);
}

function renderPermModal(u){
  const permColors={ver:'#3B82F6',crear:'#10B981',editar:'#F59E0B'};
  const permLabels={ver:'Ver',crear:'Crear',editar:'Editar'};
  document.getElementById('modal').innerHTML=`
    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
      <div class="modal" style="max-width:500px">
        <h3 style="margin-bottom:1rem">Permisos para ${u.name}</h3>
        <div style="margin-bottom:1.2rem">
          <label style="font-size:.85rem;font-weight:600;display:block;margin-bottom:.4rem">Rol</label>
          <select id="roleSelect" onchange="onRoleChange(${u.id})" style="width:100%;padding:.6rem;border-radius:8px;border:1px solid var(--glass-border);background:var(--card-bg);color:var(--text);font-size:.9rem">
            ${ROLES.map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}
          </select>
        </div>
        <div style="margin-bottom:1rem">
          <label style="font-size:.85rem;font-weight:600;display:block;margin-bottom:.6rem">Permisos por modulo</label>
          ${BUSINESSES.map(b=>{
            const bp=editingPerms[b.id]||[];
            return`<div style="display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;margin-bottom:.4rem;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border)">
              <div style="min-width:90px;font-weight:600;font-size:.8rem;color:${b.color}">${b.name}</div>
              <div style="display:flex;gap:.5rem;flex-wrap:wrap">
                ${ALL_PERMS.map(p=>{
                  const on=bp.includes(p);
                  return`<label style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:3px 8px;border-radius:6px;font-size:.75rem;border:1px solid ${on?permColors[p]:'var(--glass-border)'};background:${on?permColors[p]+'22':'transparent'};transition:all .2s">
                    <input type="checkbox" data-biz="${b.id}" data-perm="${p}" ${on?'checked':''} onchange="togglePerm('${b.id}','${p}',this.checked,${u.id})" style="display:none">
                    <span style="color:${on?permColors[p]:'var(--mt)'};font-weight:${on?600:400}">${permLabels[p]}</span>
                  </label>`;
                }).join('')}
              </div>
            </div>`;
          }).join('')}
        </div>
        <div class="modal-actions">
          <button class="btn-outline btn" onclick="closeModal()">Cancelar</button>
          <button class="btn" onclick="savePermisos(${u.id})">Guardar</button>
        </div>
      </div>
    </div>`;
}

function onRoleChange(id){
  const role=document.getElementById('roleSelect').value;
  const defaults=ROLE_DEFAULTS[role]||{};
  editingPerms=JSON.parse(JSON.stringify(defaults));
  const u=users.find(x=>x.id===id);if(!u)return;
  // Temporarily update role for display
  const tempU={...u,role,permissions:editingPerms};
  renderPermModal(tempU);
}

function togglePerm(biz,perm,checked,uid){
  if(!editingPerms[biz])editingPerms[biz]=[];
  if(checked){
    if(!editingPerms[biz].includes(perm))editingPerms[biz].push(perm);
    // Auto-add 'ver' if creating/editing
    if((perm==='crear'||perm==='editar')&&!editingPerms[biz].includes('ver'))editingPerms[biz].push('ver');
  }else{
    editingPerms[biz]=editingPerms[biz].filter(p=>p!==perm);
    // Auto-remove crear/editar if removing ver
    if(perm==='ver')editingPerms[biz]=[];
  }
  // Clean empty
  if(!editingPerms[biz].length)delete editingPerms[biz];
  const u=users.find(x=>x.id===uid);if(!u)return;
  const role=document.getElementById('roleSelect').value;
  renderPermModal({...u,role,permissions:editingPerms});
}

async function savePermisos(id){
  const role=document.getElementById('roleSelect').value;
  try{
    await fetch(`/api/admin/users/${id}`,{method:'PUT',headers:hdrs,body:JSON.stringify({role,permissions:editingPerms})});
    closeModal();loadUsers();
  }catch(e){alert(e.message)}
}

function closeModal(){document.getElementById('modal').innerHTML=''}

async function deleteUser(id){
  if(!confirm('Eliminar este usuario? Se borrará su historial de contenido.'))return;
  try{
    const r=await fetch(`/api/admin/users/${id}`,{method:'DELETE',headers:hdrs});
    const d=await r.json();
    if(!r.ok)throw new Error(d.error||'Error al eliminar');
    loadUsers();
  }catch(e){alert('Error: '+e.message)}
}

loadUsers();
</script>
<script src="/emoji-to-svg.js"></script></body>
</html>
