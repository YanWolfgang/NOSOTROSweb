<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Central ‚Äî STYLY</title>
<link rel="icon" type="image/png" href="/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/styles.css">
<style>
:root{--sy:#EC4899;--sy-bg:rgba(236,72,153,.08);--sy-border:rgba(236,72,153,.25);--sy-dark:#BE185D}
.section-label{font-size:.78rem;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px;margin:1.25rem 0 .5rem;padding-bottom:.35rem;border-bottom:1px solid var(--border)}
/* Format cards */
.sy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:.65rem;margin:.5rem 0}
.sy-fmt{background:var(--card);border:2px solid var(--border);border-radius:14px;padding:1rem .85rem;cursor:pointer;transition:all .2s;text-align:center}
.sy-fmt:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(236,72,153,.1)}
.sy-fmt.on{border-color:var(--sy);background:var(--sy-bg)}
.sy-fmt .ico{font-size:1.8rem;margin-bottom:.35rem}
.sy-fmt .nm{font-weight:700;font-size:.85rem;color:var(--fg);margin-bottom:.2rem}
.sy-fmt .ds{font-size:.72rem;color:var(--mt);line-height:1.3}
/* Topic area */
.sy-topic{margin:.75rem 0}
.sy-topic textarea{width:100%;min-height:80px;padding:.65rem;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.85rem;font-family:inherit;resize:vertical}
.sy-topic textarea:focus{border-color:var(--sy);outline:none}
.sy-topic select{width:100%;padding:.5rem .75rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.85rem;margin-bottom:.5rem}
.sy-topic select:focus{border-color:var(--sy);outline:none}
/* Result */
.sy-result{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.25rem;margin:.75rem 0;position:relative}
.sy-sec{margin-bottom:.85rem;padding-bottom:.85rem;border-bottom:1px solid var(--border);position:relative}
.sy-sec:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.sy-sec-title{font-size:.72rem;font-weight:700;color:var(--sy);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.35rem}
.sy-sec-body{font-size:.85rem;color:var(--fg);line-height:1.6;white-space:pre-wrap}
.sy-sec .cp-s{position:absolute;top:0;right:0;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--mt);font-size:.68rem;cursor:pointer}
.sy-sec .cp-s:hover{border-color:var(--sy);color:var(--sy)}
/* Tools */
.sy-tools{display:flex;flex-wrap:wrap;gap:.4rem;margin:.65rem 0}
.sy-tool{padding:.4rem .75rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.78rem;cursor:pointer;transition:all .15s}
.sy-tool:hover{border-color:var(--sy);color:var(--sy);background:var(--sy-bg)}
/* Edit bar */
.sy-edit{border-top:1px solid var(--border);padding-top:.65rem;margin-top:.65rem;display:flex;gap:.5rem}
.sy-edit input{flex:1;padding:.45rem .65rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.82rem}
.sy-edit input:focus{border-color:var(--sy);outline:none}
.sy-edit button{padding:.45rem .85rem;border-radius:8px;border:none;background:var(--sy);color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;white-space:nowrap}
/* Ideas */
.ideas-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem}
.ideas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:.65rem}
.idea-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.85rem;transition:all .2s}
.idea-card.discarded{opacity:.3}.idea-card.used{opacity:.5}
.idea-bdg{display:inline-block;padding:2px 7px;border-radius:4px;font-size:.68rem;font-weight:700;margin-bottom:.35rem;margin-right:.25rem}
.idea-bdg.new{background:var(--sy-bg);color:var(--sy)}
.idea-bdg.used{background:rgba(107,114,128,.15);color:#6B7280}
.idea-bdg.discarded{background:rgba(107,114,128,.1);color:#9CA3AF}
.idea-bdg.clients{background:var(--sy-bg);color:var(--sy)}
.idea-bdg.affiliates{background:rgba(190,24,93,.12);color:var(--sy-dark)}
.idea-txt{font-size:.85rem;color:var(--fg);margin-bottom:.4rem;line-height:1.4}
.idea-tags{display:flex;gap:.3rem;flex-wrap:wrap;margin-bottom:.4rem}
.idea-tag{padding:2px 6px;border-radius:4px;font-size:.68rem;background:var(--sy-bg);color:var(--sy);font-weight:600}
.idea-acts{display:flex;gap:.3rem;flex-wrap:wrap}
.idea-btn{padding:.25rem .5rem;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.7rem;cursor:pointer}
.idea-btn:hover{border-color:var(--sy);color:var(--sy)}
.idea-btn.danger:hover{border-color:#EF4444;color:#EF4444}
/* Tools tab cards */
.tool-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:.75rem;margin:.75rem 0}
.tool-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.25rem;cursor:pointer;transition:all .2s}
.tool-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(236,72,153,.08)}
.tool-card.active{border-color:var(--sy);background:var(--sy-bg)}
.tool-card .t-ico{font-size:2rem;margin-bottom:.5rem}
.tool-card .t-nm{font-weight:700;font-size:1rem;color:var(--fg);margin-bottom:.2rem}
.tool-card .t-ds{font-size:.78rem;color:var(--mt)}
/* Calculator */
.calc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.75rem;margin:.75rem 0}
.calc-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center}
.calc-card .c-ico{font-size:1.5rem}
.calc-card .c-lbl{font-size:.72rem;color:var(--mt);margin:.25rem 0}
.calc-card .c-val{font-size:1.4rem;font-weight:800;color:var(--sy)}
.calc-card .c-sub{font-size:.7rem;color:var(--mt);margin-top:.15rem}
.calc-card.gold{border-color:#F59E0B;background:rgba(245,158,11,.06)}
.calc-card.gold .c-val{color:#F59E0B}
.slider-row{margin:.65rem 0}
.slider-row label{display:flex;justify-content:space-between;font-size:.82rem;color:var(--fg);margin-bottom:.25rem}
.slider-row label span{font-weight:700;color:var(--sy)}
.slider-row input[type="range"]{width:100%;accent-color:var(--sy)}
/* Academy */
.acad-list{display:flex;flex-direction:column;gap:.65rem;margin:.75rem 0}
.acad-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
.acad-num{display:inline-block;width:28px;height:28px;border-radius:50%;background:var(--sy);color:#fff;text-align:center;line-height:28px;font-size:.82rem;font-weight:700;margin-right:.5rem}
.acad-title{font-weight:700;color:var(--fg);font-size:.92rem}
.acad-dur{font-size:.72rem;color:var(--mt);margin-left:.35rem}
.acad-desc{font-size:.8rem;color:var(--mt);margin:.35rem 0;line-height:1.4}
.acad-btn{padding:.3rem .7rem;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.75rem;cursor:pointer}
.acad-btn:hover{border-color:var(--sy);color:var(--sy)}
/* Calendar */
.cal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem}
.cal-nav{display:flex;align-items:center;gap:.65rem}
.cal-btn{padding:.35rem .7rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.8rem;cursor:pointer}
.cal-btn:hover{border-color:var(--sy);color:var(--sy)}
.cal-title{font-size:.92rem;font-weight:600;color:var(--fg)}
.cal-week{display:grid;grid-template-columns:repeat(7,1fr);gap:.4rem}
.cal-day{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:.65rem .4rem;min-height:110px}
.cal-day.today{border-color:var(--sy);background:var(--sy-bg)}
.cal-day-name{font-size:.68rem;font-weight:700;color:var(--mt);text-transform:uppercase;text-align:center}
.cal-day-num{font-size:1rem;font-weight:700;color:var(--fg);text-align:center;margin:.15rem 0}
.cal-item{padding:.25rem .4rem;border-radius:6px;background:var(--sy-bg);border:1px solid var(--sy-border);font-size:.68rem;color:var(--sy);margin-top:.3rem;cursor:pointer}
/* History */
.hist-filters{display:flex;gap:.4rem;margin-bottom:.75rem;flex-wrap:wrap}
.hist-filters select{padding:.35rem .65rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.8rem}
.hist-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:.75rem .85rem;margin-bottom:.4rem;display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap}
.hist-left{display:flex;align-items:center;gap:.4rem;flex:1;min-width:0}
.hist-emoji{font-size:1.1rem}
.hist-info{min-width:0}
.hist-title{font-size:.82rem;font-weight:600;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px}
.hist-meta{font-size:.7rem;color:var(--mt)}
.hist-right{display:flex;align-items:center;gap:.35rem;flex-shrink:0}
.hist-st{padding:2px 7px;border-radius:4px;font-size:.68rem;font-weight:700}
.hist-st.draft{background:rgba(107,114,128,.15);color:#6B7280}
.hist-st.approved{background:rgba(16,185,129,.15);color:#10B981}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:1rem}
.modal-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;max-width:500px;width:100%;max-height:80vh;overflow-y:auto}
.modal-title{font-size:1.05rem;font-weight:700;color:var(--fg);margin-bottom:.85rem}
.modal-field{margin-bottom:.65rem}
.modal-field label{display:block;font-size:.75rem;font-weight:600;color:var(--mt);margin-bottom:.2rem}
.modal-field input,.modal-field select,.modal-field textarea{width:100%;padding:.45rem .65rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-size:.82rem;box-sizing:border-box}
.modal-actions{display:flex;justify-content:flex-end;gap:.4rem;margin-top:.85rem}
.modal-actions button{padding:.45rem 1rem;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;border:1px solid var(--border)}
.modal-actions .m-cancel{background:var(--card);color:var(--fg)}
.modal-actions .m-ok{background:var(--sy);color:#fff;border-color:var(--sy)}
/* Toast */
.toast{position:fixed;bottom:2rem;right:2rem;padding:.65rem 1.1rem;border-radius:10px;background:#10B981;color:#fff;font-size:.85rem;font-weight:600;z-index:2000;animation:tIn .3s ease;box-shadow:0 4px 16px rgba(0,0,0,.2)}
@keyframes tIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@media(max-width:768px){
  .cal-week{grid-template-columns:1fr}.ideas-grid,.tool-cards,.calc-grid{grid-template-columns:1fr}
  .sy-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .sy-edit,.hist-item{flex-direction:column;align-items:stretch}
}
</style>
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
<div class="app">
  <nav class="sidebar" id="sidebar"></nav>
  <main class="content fade-in" id="content">
    <div class="page-header"><h1 style="color:var(--sy)">üíª STYLY</h1><p>Software de gestion para negocios de belleza y bienestar</p></div>
    <div class="module-tabs" id="modTabs">
      <div style="border-bottom:1px solid var(--border);padding-bottom:.5rem;margin-bottom:.5rem">
        <div style="font-size:.7rem;font-weight:700;color:var(--mt);text-transform:uppercase;margin-bottom:.4rem">Creacion de Contenido</div>
        <button class="module-tab active" onclick="setTab('generar')">Generar</button>
        <button class="module-tab" onclick="setTab('ideas')">Ideas</button>
        <button class="module-tab" onclick="setTab('herramientas')">Herramientas</button>
        <button class="module-tab" onclick="setTab('calendario')">Calendario</button>
        <button class="module-tab" onclick="setTab('historial')">Historial</button>
      </div>
      <div>
        <div style="font-size:.7rem;font-weight:700;color:var(--mt);text-transform:uppercase;margin-bottom:.4rem">Task Manager</div>
        <button class="module-tab" onclick="setTab('dashboard')">üìä Dashboard</button>
        <button class="module-tab" onclick="setTab('tareas')">‚úÖ Tareas</button>
        <button class="module-tab" onclick="setTab('ia-tareas')">üß† IA - Tareas</button>
      </div>
    </div>
    <div id="modContent"></div>
  </main>
</div>
<div id="modalRoot"></div>
<div id="toastRoot"></div>
<script>
// ========== AUTH ==========
const token=localStorage.getItem('token');
if(!token){window.location.href='/index.html';}
const user=JSON.parse(localStorage.getItem('user')||'{}');
const hdrs={'Content-Type':'application/json','Authorization':'Bearer '+token};

// ========== SIDEBAR ==========
const BUSINESSES=[
  {id:'nosotros',name:'NOSOTROS',icon:'üì∞',color:'#8B5CF6',url:'/nosotros.html'},
  {id:'duelazo',name:'DUELAZO',icon:'‚öΩ',color:'#10B981',url:'/duelazo.html'},
  {id:'spacebox',name:'SPACEBOX',icon:'üì¶',color:'#3B82F6',url:'/spacebox.html'},
  {id:'styly',name:'STYLY',icon:'üíª',color:'#EC4899',url:'/styly.html'}
];
function renderSidebar(){
  const bs=user.businesses||[];const isAdmin=user.role==='admin';
  const items=BUSINESSES.filter(b=>isAdmin||bs.includes(b.id));
  document.getElementById('sidebar').innerHTML=`
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-header"><h2>Panel <span>Central</span></h2></div>
    <div class="sidebar-section"><div class="sidebar-label">General</div><a href="/dashboard.html" class="sidebar-item"><span class="icon">üìä</span>Dashboard</a></div>
    <div class="sidebar-section"><div class="sidebar-label">Negocios</div>
      ${items.map(b=>`<a href="${b.url}" class="sidebar-item ${b.id==='styly'?'active':''}" style="--accent:${b.color}"><span class="icon">${b.icon}</span>${b.name}</a>`).join('')}
    </div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">Admin</div><a href="/admin.html" class="sidebar-item"><span class="icon">üë•</span>Usuarios</a></div>`:''}
    <div class="sidebar-footer">
      <div class="sidebar-avatar">${(user.name||'U')[0].toUpperCase()}</div>
      <div class="sidebar-user"><div class="name">${user.name||'Usuario'}</div><div class="role">${user.role||'editor'}</div></div>
      <button class="theme-btn" onclick="toggleTheme()">üåô</button>
      <button class="theme-btn" onclick="logout()" style="font-size:.75rem">‚Ü™</button>
    </div>`;
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open')}
function toggleTheme(){const t=document.documentElement.getAttribute('data-theme')==='light'?'':'light';document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t)}
function logout(){localStorage.clear();window.location.href='/index.html'}
if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light');
renderSidebar();

// ========== CONFIG ==========
const CLIENT_FMTS=[
  {id:'reel_educativo',name:'Reel Educativo',icon:'üé¨',desc:'Tips, errores comunes, antes/despues',aud:'clients'},
  {id:'carrusel_valor',name:'Carrusel de Valor',icon:'üì±',desc:'Antes vs despues, tips de gestion',aud:'clients'},
  {id:'caso_exito',name:'Caso de Exito',icon:'‚≠ê',desc:'Historia de cliente transformado',aud:'clients'},
  {id:'post_feature',name:'Post de Feature',icon:'üöÄ',desc:'Funcion especifica de Styly',aud:'clients'},
  {id:'inspiracional',name:'Post Inspiracional',icon:'üí°',desc:'Datos + motivacion para digitalizar',aud:'clients'}
];
const AFF_FMTS=[
  {id:'reclutamiento',name:'Reclutamiento',icon:'üí∞',desc:'Unete al programa Afiliadas Elite',aud:'affiliates'},
  {id:'exito_afiliadas',name:'Exito de Afiliadas',icon:'üèÜ',desc:'Historias de ganancias reales',aud:'affiliates'},
  {id:'capacitacion',name:'Capacitacion',icon:'üìö',desc:'Tips para vender Styly',aud:'affiliates'}
];
const ALL_FMTS=[...CLIENT_FMTS,...AFF_FMTS];
const FMT_EMOJI={};ALL_FMTS.forEach(f=>{FMT_EMOJI[f.id]=f.icon});
const INDUSTRIES=['Estetica/Salon','Barberia','Spa/Bienestar','Nail salon','Tatuador/Piercing','Psicologo/Terapeuta','Dentista/Consultorio','Nutriologo','Entrenador personal/Gym','Yoga/Pilates','General/Otro'];
const FEATURES=['Agenda digital (adios libreta)','Website de reservas (tu-negocio.styly.mx)','CRM (historial de clientes)','Cobro de suscripciones (membresias 0% comision)','WhatsApp masivo (promos 1 click)','Cerebro IA (predicciones, precios)','Multi-sucursal (todos tus locales)','Metricas (empleados, nominas, reportes)'];
const ACADEMY=[
  {num:1,name:'El Efecto Styly (La Vision)',dur:'3 min',desc:'Que es Styly, propuesta de valor unica, el "wow" de automatizar cobros. PDF infografia.',exam:'Propuesta de valor'},
  {num:2,name:'Tu Maquina de Rentas',dur:'4 min',desc:'Plan de comisiones completo, extensiones, como ser consultora de negocios. Tabla ganancias.',exam:'Calculos de comisiones'},
  {num:3,name:'Demo Panel de Afiliada',dur:'5 min',desc:'Como usar tu panel de aliada, registrar negocios, ver prospectos. Guia rapida.',exam:'Simulacion de pasos'},
  {num:4,name:'Demo Panel de Styly',dur:'5 min',desc:'Como funciona Styly como negocio, todas las funciones. Guia rapida.',exam:'Funcionalidades del panel'},
  {num:5,name:'El Universo Styly (Ventas)',dur:'5 min',desc:'Speech maestro por nicho, objeciones, herramientas de prospeccion. Diccionario nichos.',exam:'Casos de estudio'}
];

// ========== STATE ==========
let tab='generar';
let G={fmt:null,aud:null,industry:'',feature:'',topic:'',phase:'pick',result:'',resultId:null};
let toolView=null,toolResult='',toolLoading=false;
let calcInputs={locales:5,modules:2,partners:3},calcResult=null;
let calWeekStart=getMonday(new Date());
let histFilter={format:'',audience:'',status:''};

// ========== HELPERS ==========
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function md(t){return esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/^### (.+)$/gm,'<h4>$1</h4>').replace(/^## (.+)$/gm,'<h3>$1</h3>').replace(/^# (.+)$/gm,'<h2>$1</h2>').replace(/^---$/gm,'<hr>').replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>')}
function today(){return new Date().toISOString().slice(0,10)}
function getMonday(d){const dt=new Date(d);const day=dt.getDay();dt.setDate(dt.getDate()-day+(day===0?-6:1));dt.setHours(0,0,0,0);return dt}
function addDays(d,n){const dt=new Date(d);dt.setDate(dt.getDate()+n);return dt}
function fmtDate(d){return d.toISOString().slice(0,10)}
function fmtDateEs(d){return d.toLocaleDateString('es-MX',{day:'numeric',month:'long'})}
function fmtDT(s){if(!s)return'';try{return new Date(s).toLocaleString('es-MX',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}catch{return s}}
function toast(msg){const el=document.createElement('div');el.className='toast';el.textContent=msg;document.getElementById('toastRoot').appendChild(el);setTimeout(()=>el.remove(),3000)}
function pJ(t){const i=t.indexOf('{'),j=t.lastIndexOf('}');if(i===-1||j<=i)return null;try{return JSON.parse(t.substring(i,j+1))}catch{return null}}
function parseSections(text){
  const lines=text.split('\n'),sections=[];let cur=null;
  for(const line of lines){
    const eh=line.match(/^([\u{1F300}-\u{1FAFF}\u{2600}-\u{26FF}][\uFE0F]?\s*.+?):\s*$/u);
    const sh=line.match(/^(?:#{1,3}\s+)?(.+?):\s*$/);
    const uc=line.trim()===line.trim().toUpperCase()&&line.trim().length>3&&line.trim().length<80;
    if(uc&&!line.startsWith(' ')){if(cur)sections.push(cur);cur={title:line.replace(/^#+\s*/,'').replace(/:$/,'').trim(),body:''};}
    else if(eh){if(cur)sections.push(cur);cur={title:eh[1].trim(),body:''};}
    else if(sh&&!line.startsWith(' ')&&line.trim().length<80){if(cur)sections.push(cur);cur={title:sh[1].trim(),body:''};}
    else{if(!cur)cur={title:'Contenido',body:''};cur.body+=(cur.body?'\n':'')+line;}
  }
  if(cur)sections.push(cur);
  return sections.filter(s=>s.body.trim()).map(s=>({title:s.title,body:s.body.trim()}));
}
function fmt$(n){return'$'+Number(n).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2})}

// ========== TABS ==========
function setTab(t){
  tab=t;
  const tabMap={'üìä dashboard':'dashboard','‚úÖ tareas':'tareas','üß† ia - tareas':'ia-tareas','generar':'generar','ideas':'ideas','herramientas':'herramientas','calendario':'calendario','historial':'historial'};
  document.querySelectorAll('.module-tab').forEach(b=>{
    const text=b.textContent.trim().toLowerCase();
    const mapped=tabMap[text]||text;
    if(mapped===t||text===t)b.classList.add('active');
    else b.classList.remove('active');
  });
  renderTab();
}
function renderTab(){
  const m=document.getElementById('modContent');m.className='fade-in';void m.offsetWidth;
  if(tab==='generar')renderGenerar(m);
  else if(tab==='ideas')renderIdeas(m);
  else if(tab==='herramientas')renderHerramientas(m);
  else if(tab==='calendario')renderCalendario(m);
  else if(tab==='historial')renderHistorial(m);
  else if(tab==='tareas')renderTareas(m);
  else if(tab==='dashboard')renderDashboard(m);
  else if(tab==='ia-tareas')renderIATareas(m);
}

// ================================================================
// TAB 1: GENERAR
// ================================================================
function renderGenerar(m){
  if(G.phase==='pick')m.innerHTML=rFmtPick();
  else if(G.phase==='topic')m.innerHTML=rTopicInput();
  else if(G.phase==='loading')m.innerHTML=`<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div><div class="loader-text">Generando contenido para Styly...</div></div>`;
  else if(G.phase==='result')m.innerHTML=rGenResult();
}
function rFmtPick(){
  return`<div class="section-label">PARA CLIENTES (60%)</div>
    <div class="sy-grid">${CLIENT_FMTS.map(f=>`<div class="sy-fmt ${G.fmt===f.id?'on':''}" onclick="pickFmt('${f.id}','clients')"><div class="ico">${f.icon}</div><div class="nm">${f.name}</div><div class="ds">${f.desc}</div></div>`).join('')}</div>
    <div class="section-label">PARA AFILIADAS ELITE (40%)</div>
    <div class="sy-grid">${AFF_FMTS.map(f=>`<div class="sy-fmt ${G.fmt===f.id?'on':''}" onclick="pickFmt('${f.id}','affiliates')"><div class="ico">${f.icon}</div><div class="nm">${f.name}</div><div class="ds">${f.desc}</div></div>`).join('')}</div>
    ${G.fmt?`<div class="actions" style="margin-top:.75rem"><button class="btn" onclick="G.phase='topic';renderTab()">Siguiente ‚Üí</button></div>`:''}`;
}
function rTopicInput(){
  const f=ALL_FMTS.find(x=>x.id===G.fmt);
  const isClient=G.aud==='clients';
  const placeholders={reel_educativo:'Tema del reel. Ej: errores al agendar, perder clientes por WhatsApp...',carrusel_valor:'Tema. Ej: antes vs despues, tips de gestion...',caso_exito:'Describe el negocio: tipo, problema, resultados...',post_feature:'Contexto adicional (opcional)...',inspiracional:'Dato o tema (opcional)...',reclutamiento:'Enfoque. Ej: mamas emprendedoras, ingreso extra, libertad...',exito_afiliadas:'Detalle de la historia (opcional)...',capacitacion:'Tema. Ej: pitch, objeciones, seguimiento...'};
  return`<div class="flow-header"><button class="btn-back" onclick="G.phase='pick';renderTab()">‚Üê Volver</button><div class="flow-title"><span>${f.icon}</span> ${f.name}</div></div>
    <div class="sy-topic">
      ${isClient?`<select id="indSel" onchange="G.industry=this.value"><option value="">Selecciona industria...</option>${INDUSTRIES.map(i=>`<option value="${i}" ${G.industry===i?'selected':''}>${i}</option>`).join('')}</select>`:''}
      ${G.fmt==='post_feature'?`<select id="featSel" onchange="G.feature=this.value"><option value="">Selecciona feature...</option>${FEATURES.map(f=>`<option value="${f}" ${G.feature===f?'selected':''}>${f}</option>`).join('')}</select>`:''}
      <textarea id="topicTa" placeholder="${placeholders[G.fmt]||'Describe el tema...'}" oninput="G.topic=this.value">${esc(G.topic)}</textarea>
    </div>
    <div class="actions"><button class="btn" onclick="doGenerate()">Generar contenido ‚Üí</button></div>`;
}
function rGenResult(){
  const f=ALL_FMTS.find(x=>x.id===G.fmt);
  const secs=parseSections(G.result);
  return`<div class="flow-header"><button class="btn-back" onclick="resetGen()">‚Üê Nuevo contenido</button><div class="flow-title"><span>${f.icon}</span> ${f.name} <span class="idea-bdg ${G.aud}" style="font-size:.7rem;margin-left:.5rem">${G.aud==='clients'?'CLIENTES':'AFILIADAS'}</span></div></div>
    <div class="sy-result">${secs.map((s,i)=>`<div class="sy-sec"><button class="cp-s" onclick="cpSec(${i})">üìã</button><div class="sy-sec-title">${esc(s.title)}</div><div class="sy-sec-body" id="sec${i}">${md(s.body)}</div></div>`).join('')}</div>
    <div class="sy-tools">
      <button class="sy-tool" onclick="aiAction('Revisa el contenido. Corrige errores, mejora claridad, asegurate de que CTA y beneficios esten presentes.')">üìù Revisar con IA</button>
      <button class="sy-tool" onclick="aiAction('Adapta para 3 plataformas: 1. Instagram Feed (500 chars + hashtags) 2. TikTok (corto + hashtags) 3. LinkedIn (profesional). Manten el mensaje central.')">üîÑ Multi-formato</button>
      <button class="sy-tool" onclick="aiAction('Genera 2 variantes A/B. Variante A: tono profesional. Variante B: tono cercano/casual. Ambas con CTA.')">üîÄ Variantes A/B</button>
      <button class="sy-tool" onclick="openApproveModal()">‚úÖ Aprobar y Agendar</button>
      <button class="sy-tool" onclick="doGenerate()">üîÉ Regenerar</button>
    </div>
    <div class="sy-edit"><input id="editIn" placeholder="Ej: Hazlo mas corto, enfocalo a barberias, tono mas urgente, cambia CTA..."><button onclick="doRegenEdit()">üîÑ Regenerar con cambios</button></div>`;
}

function pickFmt(id,aud){G.fmt=id;G.aud=aud;renderTab()}
function resetGen(){G={fmt:null,aud:null,industry:'',feature:'',topic:'',phase:'pick',result:'',resultId:null};renderTab()}

async function doGenerate(){
  G.phase='loading';renderTab();
  const topicFull=G.fmt==='post_feature'&&G.feature?`Feature: ${G.feature}. ${G.topic}`:G.topic;
  try{
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({format:G.fmt,audience:G.aud,topic:topicFull||undefined,industry:G.industry||undefined})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    G.result=d.content;G.resultId=d.id;G.phase='result';
  }catch(e){G.phase='topic';toast('Error: '+e.message)}
  renderTab();
}
async function doRegenEdit(){
  const txt=document.getElementById('editIn')?.value?.trim();if(!txt)return;
  G.phase='loading';renderTab();
  try{
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({format:G.fmt,audience:G.aud,previousContent:G.result,editInstructions:txt})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    G.result=d.content;G.resultId=d.id;G.phase='result';toast('Regenerado con cambios');
  }catch(e){G.phase='result';toast('Error: '+e.message)}
  renderTab();
}
async function aiAction(instr){
  G.phase='loading';renderTab();
  try{
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({format:G.fmt,audience:G.aud,previousContent:G.result,editInstructions:instr})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    G.result=d.content;G.resultId=d.id;G.phase='result';toast('Listo');
  }catch(e){G.phase='result';toast('Error: '+e.message)}
  renderTab();
}
function cpSec(i){const el=document.getElementById('sec'+i);if(!el)return;cpClip(el.textContent||el.innerText);el.closest('.sy-sec').querySelector('.cp-s').textContent='‚úì';setTimeout(()=>{const b=document.querySelector(`#sec${i}`)?.closest('.sy-sec')?.querySelector('.cp-s');if(b)b.textContent='üìã'},1500)}

// ================================================================
// TAB 2: IDEAS
// ================================================================
async function renderIdeas(m){
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/styly/ideas',{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    const ideas=d.ideas||[];
    m.innerHTML=`<div class="ideas-hdr"><div><h3 style="color:var(--fg);margin:0">üí° Ideas Semanales</h3><span style="font-size:.75rem;color:var(--mt)">Balance: 60% clientes ¬∑ 40% afiliadas</span></div><button class="btn" onclick="genIdeas()">üß† Generar 4 ideas de la semana</button></div>
      ${ideas.length?`<div class="ideas-grid">${ideas.map(renderIdeaCard).join('')}</div>`:'<p style="color:var(--mt);text-align:center;padding:2rem">No hay ideas. Genera las primeras 4.</p>'}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
function renderIdeaCard(idea){
  const s=idea.status,aud=idea.season_relevance||'clients';
  const fObj=ALL_FMTS.find(f=>f.id===idea.format);
  return`<div class="idea-card ${s}">
    <span class="idea-bdg ${s==='new'?'new':s==='used'?'used':'discarded'}">${s==='new'?'NUEVA':s==='used'?'USADA':'DESCARTADA'}</span>
    <span class="idea-bdg ${aud==='affiliates'?'affiliates':'clients'}">${aud==='affiliates'?'AFILIADAS':'CLIENTES'}</span>
    <div class="idea-txt">${esc(idea.idea_text)}</div>
    <div class="idea-tags"><span class="idea-tag">${fObj?.icon||'üìù'} ${fObj?.name||idea.format}</span></div>
    ${s==='new'?`<div class="idea-acts">
      <button class="idea-btn" onclick="useIdea(${idea.id},'${idea.format}','${aud}',\`${esc(idea.idea_text).replace(/`/g,'')}\`)">‚úçÔ∏è Generar</button>
      <button class="idea-btn danger" onclick="discardIdea(${idea.id})">‚ùå Descartar</button>
    </div>`:''}
  </div>`;
}
async function genIdeas(){
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div><div class="loader-text">Generando 4 ideas semanales...</div></div>';
  try{await fetch('/api/styly/ideas/generate',{method:'POST',headers:hdrs,body:'{}'});toast('4 ideas generadas');renderIdeas(m)}catch(e){toast('Error: '+e.message);renderIdeas(m)}
}
function useIdea(id,format,aud,text){
  G.fmt=format;G.aud=aud==='affiliates'?'affiliates':'clients';G.topic=text;G.phase='topic';G.result='';G.resultId=null;
  fetch('/api/styly/ideas/'+id,{method:'PUT',headers:hdrs,body:JSON.stringify({status:'used'})});
  setTab('generar');
}
async function discardIdea(id){
  await fetch('/api/styly/ideas/'+id,{method:'PUT',headers:hdrs,body:JSON.stringify({status:'discarded'})});
  toast('Descartada');renderIdeas(document.getElementById('modContent'));
}

// ================================================================
// TAB 3: HERRAMIENTAS
// ================================================================
function renderHerramientas(m){
  if(!toolView) m.innerHTML=rToolPick();
  else if(toolView==='script') m.innerHTML=rScriptTool();
  else if(toolView==='calc') m.innerHTML=rCalcTool();
  else if(toolView==='academy') m.innerHTML=rAcademyTool();
}
function rToolPick(){
  return`<div class="tool-cards">
    <div class="tool-card" onclick="toolView='script';renderTab()"><div class="t-ico">üìù</div><div class="t-nm">Script de Venta</div><div class="t-ds">Pitch, objeciones, WhatsApp, emails por industria</div></div>
    <div class="tool-card" onclick="toolView='calc';renderTab()"><div class="t-ico">üìä</div><div class="t-nm">Calculadora de Comisiones</div><div class="t-ds">Simula ganancias como Afiliada Elite</div></div>
    <div class="tool-card" onclick="toolView='academy';renderTab()"><div class="t-ico">üìö</div><div class="t-nm">Biblioteca Academy</div><div class="t-ds">5 modulos de capacitacion Styly Academy</div></div>
  </div>`;
}

// --- Script tool ---
let scriptCfg={type:'pitch',industry:'General/Otro',stage:'first_contact'};
function rScriptTool(){
  return`<div class="flow-header"><button class="btn-back" onclick="toolView=null;toolResult='';renderTab()">‚Üê Herramientas</button><div class="flow-title">üìù Script de Venta</div></div>
    <div class="sy-topic">
      <select onchange="scriptCfg.type=this.value;renderTab()">
        <option value="pitch" ${scriptCfg.type==='pitch'?'selected':''}>Pitch 30 segundos</option>
        <option value="objections" ${scriptCfg.type==='objections'?'selected':''}>Respuesta a objeciones</option>
        <option value="whatsapp" ${scriptCfg.type==='whatsapp'?'selected':''}>Mensaje WhatsApp</option>
        <option value="email" ${scriptCfg.type==='email'?'selected':''}>Email</option>
      </select>
      <select onchange="scriptCfg.industry=this.value">${INDUSTRIES.map(i=>`<option value="${i}" ${scriptCfg.industry===i?'selected':''}>${i}</option>`).join('')}</select>
      ${scriptCfg.type==='email'?`<select onchange="scriptCfg.stage=this.value">
        <option value="first_contact" ${scriptCfg.stage==='first_contact'?'selected':''}>Primer contacto</option>
        <option value="post_demo" ${scriptCfg.stage==='post_demo'?'selected':''}>Post-demo</option>
        <option value="follow_up" ${scriptCfg.stage==='follow_up'?'selected':''}>Follow up</option>
        <option value="close" ${scriptCfg.stage==='close'?'selected':''}>Cierre</option>
      </select>`:''}
    </div>
    <div class="actions"><button class="btn" onclick="genScript()">Generar ‚Üí</button></div>
    ${toolLoading?'<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>':''}
    ${toolResult?`<div class="sy-result"><button class="cp-s" onclick="cpClip(toolResult);toast('Copiado')" style="position:absolute;top:.75rem;right:.75rem">üìã Copiar todo</button><div class="sy-sec-body">${md(toolResult)}</div></div>
    <div class="sy-edit"><input id="scriptEdit" placeholder="Ej: Hazlo mas casual, enfocalo a dentistas..."><button onclick="regenScript()">üîÑ Con cambios</button></div>`:''}`;
}
async function genScript(){
  toolLoading=true;toolResult='';renderTab();
  try{
    const r=await fetch('/api/styly/generate-script',{method:'POST',headers:hdrs,body:JSON.stringify(scriptCfg)});
    const d=await r.json();if(d.error)throw new Error(d.error);
    toolResult=d.content;
  }catch(e){toast('Error: '+e.message)}
  toolLoading=false;renderTab();
}
async function regenScript(){
  const txt=document.getElementById('scriptEdit')?.value?.trim();if(!txt)return;
  toolLoading=true;renderTab();
  try{
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({format:'script_'+scriptCfg.type,audience:'clients',previousContent:toolResult,editInstructions:txt})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    toolResult=d.content;toast('Regenerado');
  }catch(e){toast('Error: '+e.message)}
  toolLoading=false;renderTab();
}

// --- Calculator ---
function rCalcTool(){
  const c=calcInputs;
  doCalc();
  const r=calcResult;
  return`<div class="flow-header"><button class="btn-back" onclick="toolView=null;renderTab()">‚Üê Herramientas</button><div class="flow-title">üìä Calculadora de Comisiones</div></div>
    <div class="slider-row"><label>Locales directos afiliados <span>${c.locales}</span></label><input type="range" min="1" max="50" value="${c.locales}" oninput="calcInputs.locales=+this.value;renderTab()"></div>
    <div class="slider-row"><label>Modulos extra promedio por local <span>${c.modules}</span></label><input type="range" min="0" max="8" value="${c.modules}" oninput="calcInputs.modules=+this.value;renderTab()"></div>
    <div class="slider-row"><label>Partners invitadas <span>${c.partners}</span></label><input type="range" min="0" max="20" value="${c.partners}" oninput="calcInputs.partners=+this.value;renderTab()"></div>
    ${r?`<div class="calc-grid">
      <div class="calc-card"><div class="c-ico">üí∞</div><div class="c-lbl">MES 1 (Bono activacion)</div><div class="c-val">${fmt$(r.month1)}</div><div class="c-sub">${c.locales} locales √ó $599 √ó 50%</div></div>
      <div class="calc-card"><div class="c-ico">üìà</div><div class="c-lbl">INGRESO MENSUAL (Mes 2+)</div><div class="c-val">${fmt$(r.monthlyRecurring)}</div><div class="c-sub">Residual: ${fmt$(r.residualSaas)} ¬∑ Upsell: ${fmt$(r.bonusUpsell)} ¬∑ Red: ${fmt$(r.networkIncome)}</div></div>
      <div class="calc-card"><div class="c-ico">üìÖ</div><div class="c-lbl">INGRESO ANUAL PROYECTADO</div><div class="c-val">${fmt$(r.annualProjected)}</div><div class="c-sub">Mes 1 + (mensual √ó 12)</div></div>
      <div class="calc-card"><div class="c-ico">‚≠ê</div><div class="c-lbl">MILLAS MENSUALES</div><div class="c-val">${r.monthlyMiles} pts</div><div class="c-sub">${c.locales}√ó15 + ${c.locales*c.modules}√ó5 + ${c.partners}√ó10</div></div>
      <div class="calc-card gold"><div class="c-ico">üèÜ</div><div class="c-lbl">RANGO (acumulado anual)</div><div class="c-val">${r.rank}</div><div class="c-sub">${r.annualMiles} millas/ano${r.rankBonus?` ¬∑ Bono: ${fmt$(r.rankBonus)}`:''}</div></div>
      <div class="calc-card"><div class="c-ico">üö¢</div><div class="c-lbl">COPA ANUAL</div><div class="c-val">${r.copaAnual?'Calificas':'No calificas'}</div><div class="c-sub">${r.annualMiles}/500 pts minimo para crucero</div></div>
    </div>
    <div class="actions" style="margin-top:.5rem">
      <button class="btn" onclick="cpCalc()">üìã Copiar resumen</button>
      <button class="btn" style="margin-left:.5rem;background:#25D366" onclick="shareWA()">üì≤ Compartir por WhatsApp</button>
    </div>`:''}`;
}
function doCalc(){
  const c=calcInputs,core=599,addon=149;
  const month1=c.locales*core*0.5;
  const residualSaas=c.locales*core*0.15;
  const bonusUpsell=c.locales*c.modules*addon*0.10;
  const networkIncome=c.partners*3*core*0.03;
  const monthlyRecurring=residualSaas+bonusUpsell+networkIncome;
  const annualProjected=month1+(monthlyRecurring*12);
  const monthlyMiles=(c.locales*15)+(c.locales*c.modules*5)+(c.partners*10);
  const annualMiles=monthlyMiles*12;
  let rank='Sin rango',rankBonus=0;
  if(annualMiles>=12000){rank='Oraculo';rankBonus=300000}
  else if(annualMiles>=6000){rank='Leyenda';rankBonus=100000}
  else if(annualMiles>=2500){rank='Shark';rankBonus=35000}
  else if(annualMiles>=1000){rank='Oro';rankBonus=10000}
  else if(annualMiles>=200){rank='Plata';rankBonus=2500}
  calcResult={month1,residualSaas,bonusUpsell,networkIncome,monthlyRecurring,annualProjected,monthlyMiles,annualMiles,rank,rankBonus,copaAnual:annualMiles>=500};
}
function cpCalc(){
  const r=calcResult,c=calcInputs;
  cpClip(`STYLY ‚Äî Simulacion de Ganancias Afiliada Elite\n\nLocales directos: ${c.locales}\nModulos extra/local: ${c.modules}\nPartners: ${c.partners}\n\nMes 1 (Bono): ${fmt$(r.month1)}\nIngreso mensual recurrente: ${fmt$(r.monthlyRecurring)}\n  Residual SaaS: ${fmt$(r.residualSaas)}\n  Bonos Upsell: ${fmt$(r.bonusUpsell)}\n  Comision Red: ${fmt$(r.networkIncome)}\nIngreso anual: ${fmt$(r.annualProjected)}\nMillas mensuales: ${r.monthlyMiles} pts\nRango: ${r.rank}${r.rankBonus?' (Bono: '+fmt$(r.rankBonus)+')':''}\nCopa Anual: ${r.copaAnual?'Calificas':'No calificas'}\n\nUnete ‚Üí styly.mx/afiliados`);
  toast('Copiado');
}
function shareWA(){
  const r=calcResult,c=calcInputs;
  const txt=encodeURIComponent(`*STYLY ‚Äî Afiliadas Elite*\n\nCon solo ${c.locales} locales directos:\nüí∞ Mes 1: ${fmt$(r.month1)}\nüìà Mensual recurrente: ${fmt$(r.monthlyRecurring)}\nüìÖ Anual: ${fmt$(r.annualProjected)}\nüèÜ Rango: ${r.rank}\n\nSin inversion, sin horario. Unete ‚Üí styly.mx/afiliados`);
  window.open('https://wa.me/?text='+txt,'_blank');
}

// --- Academy ---
function rAcademyTool(){
  return`<div class="flow-header"><button class="btn-back" onclick="toolView=null;toolResult='';renderTab()">‚Üê Herramientas</button><div class="flow-title">üìö Styly Academy</div></div>
    <div class="acad-list">${ACADEMY.map(a=>`<div class="acad-item">
      <div><span class="acad-num">${a.num}</span><span class="acad-title">${a.name}</span><span class="acad-dur">${a.dur}</span></div>
      <div class="acad-desc">${a.desc}</div>
      <div class="acad-desc" style="font-size:.72rem">Examen: ${a.exam}</div>
      <button class="acad-btn" onclick="genGuide(${a.num})" style="margin-top:.4rem">üß† Generar guia de estudio</button>
      <div id="acad${a.num}"></div>
    </div>`).join('')}</div>`;
}
async function genGuide(num){
  const a=ACADEMY[num-1];const el=document.getElementById('acad'+num);
  el.innerHTML='<div class="loader" style="padding:.5rem"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const prompt=`Genera una guia de estudio para el Modulo ${a.num} de Styly Academy: "${a.name}" (${a.dur}).\nContenido: ${a.desc}\nTemas de examen: ${a.exam}\n\nIncluye:\n1. Resumen ejecutivo (3-4 puntos clave)\n2. Tips para recordar\n3. 5 posibles preguntas de examen con respuestas`;
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({format:'academy_guide',audience:'affiliates',topic:prompt})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    el.innerHTML=`<div class="sy-result" style="margin-top:.5rem"><button class="cp-s" onclick="cpClip(this.parentElement.querySelector('.sy-sec-body').textContent);toast('Copiado')" style="position:absolute;top:.5rem;right:.5rem">üìã</button><div class="sy-sec-body">${md(d.content)}</div></div>`;
  }catch(e){el.innerHTML=`<p style="color:#EF4444;font-size:.8rem">Error: ${esc(e.message)}</p>`}
}

// ================================================================
// TAB 4: CALENDARIO
// ================================================================
async function renderCalendario(m){
  const start=fmtDate(calWeekStart),end=fmtDate(addDays(calWeekStart,6));
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch(`/api/styly/calendar?start=${start}&end=${end}`,{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    const items=d.items||[];const todayStr=today();
    const days=[],dn=['Lun','Mar','Mie','Jue','Vie','Sab','Dom'];
    for(let i=0;i<7;i++){const dt=addDays(calWeekStart,i);const ds=fmtDate(dt);days.push({name:dn[i],num:dt.getDate(),date:ds,isToday:ds===todayStr,items:items.filter(it=>(it.scheduled_date||'').slice(0,10)===ds)})}
    m.innerHTML=`<div class="cal-hdr"><div class="cal-nav"><button class="cal-btn" onclick="calWeekStart=addDays(calWeekStart,-7);renderCalendario(document.getElementById('modContent'))">‚Üê</button><span class="cal-title">Semana del ${fmtDateEs(calWeekStart)} al ${fmtDateEs(addDays(calWeekStart,6))}</span><button class="cal-btn" onclick="calWeekStart=addDays(calWeekStart,7);renderCalendario(document.getElementById('modContent'))">‚Üí</button></div></div>
      <div class="cal-week">${days.map(day=>`<div class="cal-day ${day.isToday?'today':''}"><div class="cal-day-name">${day.name}</div><div class="cal-day-num">${day.num}</div>${day.items.map(it=>{const inp=typeof it.input_data==='string'?JSON.parse(it.input_data||'{}'):it.input_data||{};const aud=inp.audience;return`<div class="cal-item" onclick="viewCalItem(${it.id})">${FMT_EMOJI[it.format_type]||'üìù'} ${esc((it.preview||'').slice(0,25))}${aud?'<br><span style=\"font-size:.6rem\">'+(aud==='affiliates'?'AFILIADAS':'CLIENTES')+'</span>':''}</div>`}).join('')}</div>`).join('')}</div>
      ${items.length===0?'<p style="color:var(--mt);text-align:center;padding:1.5rem">No hay contenido agendado esta semana.</p>':''}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
async function viewCalItem(id){
  try{
    const r=await fetch('/api/styly/history/'+id,{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    showModal(`<div class="modal-title">${FMT_EMOJI[d.item.format_type]||'üìù'} ${esc(d.item.format_type)} ‚Äî ${fmtDT(d.item.scheduled_date)}</div><div style="max-height:50vh;overflow-y:auto;margin-bottom:.75rem"><div class="sy-sec-body">${md(d.item.output_text)}</div></div><div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cerrar</button><button class="m-ok" onclick="cpClip(\`${esc(d.item.output_text).replace(/`/g,"'")}\`);toast('Copiado')">üìã Copiar</button></div>`);
  }catch(e){toast('Error: '+e.message)}
}

// ================================================================
// TAB 5: HISTORIAL
// ================================================================
let histSel=new Set();
async function renderHistorial(m){
  histSel.clear();
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/styly/history',{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    let allItems=d.history||[];
    let items=[...allItems];
    if(histFilter.format)items=items.filter(i=>i.format_type===histFilter.format);
    if(histFilter.audience)items=items.filter(i=>{const inp=typeof i.input_data==='string'?JSON.parse(i.input_data||'{}'):i.input_data||{};return inp.audience===histFilter.audience});
    if(histFilter.status)items=items.filter(i=>i.status===histFilter.status);
    const visibleIds=items.map(i=>i.id);
    m.innerHTML=`<div class="hist-filters">
      <select onchange="histFilter.format=this.value;renderHistorial(document.getElementById('modContent'))"><option value="">Todos los formatos</option>${ALL_FMTS.map(f=>`<option value="${f.id}" ${histFilter.format===f.id?'selected':''}>${f.name}</option>`).join('')}<option value="script_pitch" ${histFilter.format==='script_pitch'?'selected':''}>Script Pitch</option><option value="script_objections" ${histFilter.format==='script_objections'?'selected':''}>Script Objeciones</option><option value="script_whatsapp" ${histFilter.format==='script_whatsapp'?'selected':''}>Script WhatsApp</option><option value="script_email" ${histFilter.format==='script_email'?'selected':''}>Script Email</option></select>
      <select onchange="histFilter.audience=this.value;renderHistorial(document.getElementById('modContent'))"><option value="">Todas las audiencias</option><option value="clients" ${histFilter.audience==='clients'?'selected':''}>Clientes</option><option value="affiliates" ${histFilter.audience==='affiliates'?'selected':''}>Afiliadas</option></select>
      <select onchange="histFilter.status=this.value;renderHistorial(document.getElementById('modContent'))"><option value="">Todos los status</option><option value="draft" ${histFilter.status==='draft'?'selected':''}>Draft</option><option value="approved" ${histFilter.status==='approved'?'selected':''}>Approved</option></select>
    </div>
    ${items.length?`
    <div style="display:flex;gap:.5rem;margin-bottom:.5rem;align-items:center;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:.35rem;cursor:pointer;font-size:.8rem;color:var(--mt)"><input type="checkbox" onchange="toggleAllHist(this.checked,${JSON.stringify(visibleIds)})"> Seleccionar todos</label>
      <span id="histSelCount" style="font-size:.75rem;color:var(--mt)"></span>
      <div style="margin-left:auto;display:flex;gap:.4rem">
        <button id="btnBulkDel" onclick="bulkDelHist()" style="display:none;background:#EF4444;color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer">Eliminar seleccionados</button>
        <button onclick="delAllHist(${JSON.stringify(allItems.map(i=>i.id))})" style="background:none;border:1px solid #EF4444;color:#EF4444;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer">Borrar todo</button>
      </div>
    </div>
    ${items.map(it=>{const inp=typeof it.input_data==='string'?JSON.parse(it.input_data||'{}'):it.input_data||{};const aud=inp.audience;
      return`<div class="hist-item"><input type="checkbox" data-hid="${it.id}" onchange="toggleHistSel(${it.id},this.checked)" style="cursor:pointer;accent-color:#EF4444;margin-right:.3rem"><div class="hist-left"><span class="hist-emoji">${FMT_EMOJI[it.format_type]||'üìù'}</span><div class="hist-info"><div class="hist-title">${esc((it.preview||'').slice(0,60))}</div><div class="hist-meta">${aud?'<span class="idea-bdg '+(aud==='affiliates'?'affiliates':'clients')+'" style="font-size:.6rem;margin-right:.25rem">'+(aud==='affiliates'?'AFILIADAS':'CLIENTES')+'</span>':''}${esc(it.user_name||'Usuario')} ¬∑ ${fmtDT(it.created_at)}${it.status==='approved'&&it.scheduled_date?' ¬∑ '+fmtDT(it.scheduled_date):''}</div></div></div>
        <div class="hist-right"><span class="hist-st ${it.status==='approved'?'approved':'draft'}">${it.status==='approved'?'Approved':'Draft'}</span><button class="idea-btn" onclick="viewHistItem(${it.id})">Ver</button><button class="idea-btn" onclick="cpHistItem(${it.id})">üìã</button><button class="idea-btn danger" onclick="delHistItem(${it.id})">üóëÔ∏è</button></div></div>`}).join('')}`:'<p style="color:var(--mt);text-align:center;padding:2rem">No hay contenido generado.</p>'}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
function toggleHistSel(id,checked){if(checked)histSel.add(id);else histSel.delete(id);updHistSelUI()}
function toggleAllHist(checked,ids){histSel.clear();if(checked)ids.forEach(id=>histSel.add(id));document.querySelectorAll('[data-hid]').forEach(c=>c.checked=checked);updHistSelUI()}
function updHistSelUI(){const n=histSel.size;const c=document.getElementById('histSelCount');const b=document.getElementById('btnBulkDel');if(c)c.textContent=n?n+' seleccionado'+(n>1?'s':''):'';if(b)b.style.display=n?'inline-block':'none'}
async function bulkDelHist(){if(!histSel.size)return;if(!confirm(`Eliminar ${histSel.size} elemento(s) del historial?`))return;try{const r=await fetch('/api/styly/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids:[...histSel]})});const d=await r.json();if(d.error)throw new Error(d.error);toast(d.deleted+' eliminado(s)');renderHistorial(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}
async function delAllHist(ids){if(!ids||!ids.length)return toast('No hay elementos');if(!confirm('Eliminar TODO el historial de Styly? Esta accion no se puede deshacer.'))return;try{const r=await fetch('/api/styly/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids})});const d=await r.json();if(d.error)throw new Error(d.error);toast(d.deleted+' eliminado(s)');renderHistorial(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}
async function viewHistItem(id){
  try{const r=await fetch('/api/styly/history/'+id,{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    showModal(`<div class="modal-title">${FMT_EMOJI[d.item.format_type]||'üìù'} ${esc(d.item.format_type)}</div><div style="max-height:60vh;overflow-y:auto;margin-bottom:.75rem"><div class="sy-sec-body">${md(d.item.output_text)}</div></div><div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cerrar</button><button class="m-ok" onclick="cpClip(\`${esc(d.item.output_text).replace(/`/g,"'")}\`);toast('Copiado')">üìã Copiar</button></div>`);
  }catch(e){toast('Error: '+e.message)}
}
async function cpHistItem(id){try{const r=await fetch('/api/styly/history/'+id,{headers:hdrs});const d=await r.json();cpClip(d.item.output_text);toast('Copiado')}catch(e){toast('Error')}}
async function delHistItem(id){if(!confirm('Eliminar del historial?'))return;try{await fetch('/api/styly/history/'+id,{method:'DELETE',headers:hdrs});toast('Eliminado');renderHistorial(document.getElementById('modContent'))}catch(e){toast('Error')}}

// ================================================================
// APPROVE MODAL
// ================================================================
function openApproveModal(){
  if(!G.resultId)return toast('Genera contenido primero');
  showModal(`<div class="modal-title">‚úÖ Aprobar y Agendar</div>
    <div class="modal-field"><label>Fecha</label><input type="date" id="appDate" value="${today()}"></div>
    <div class="modal-field"><label>Hora</label><input type="time" id="appTime" value="10:00"></div>
    <div class="modal-field"><label>Plataforma</label><select id="appPlat"><option value="instagram">Instagram</option><option value="tiktok">TikTok</option><option value="facebook">Facebook</option><option value="linkedin">LinkedIn</option></select></div>
    <div class="modal-field"><label>Notas (opcional)</label><textarea id="appNotes" rows="2"></textarea></div>
    <div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cancelar</button><button class="m-ok" onclick="doApprove()">‚úÖ Aprobar</button></div>`);
}
async function doApprove(){
  const date=document.getElementById('appDate')?.value,time=document.getElementById('appTime')?.value,plat=document.getElementById('appPlat')?.value,notes=document.getElementById('appNotes')?.value;
  if(!date)return toast('Selecciona fecha');
  try{const r=await fetch('/api/styly/approve',{method:'POST',headers:hdrs,body:JSON.stringify({content_id:G.resultId,scheduled_date:date,scheduled_time:time,scheduled_platform:plat,notes:notes||undefined})});const d=await r.json();if(d.error)throw new Error(d.error);closeModal();toast('‚úÖ Aprobado y agendado')}catch(e){toast('Error: '+e.message)}
}

// ================================================================
// SHARED
// ================================================================
function showModal(html){document.getElementById('modalRoot').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box">${html}</div></div>`}
function closeModal(){document.getElementById('modalRoot').innerHTML=''}
function cpClip(text){if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).catch(()=>fbCp(text))}else{fbCp(text)}}
function fbCp(text){const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta)}

// ================================================================
// TAB 6: TAREAS (TASK MANAGER)
// ================================================================
const INITIAL_TASKS=[
  // PANEL STYLY
  {task_id:'P-01',module:'Dashboard',description:'Reemplazar banner de bienvenida por ventana de notificaciones tipo carrusel',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'P-02',module:'Dashboard',description:'Agregar insights del negocio: clientes ganados/perdidos, suscripciones nuevas',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'P-03',module:'Dashboard',description:'Agregar bot√≥n para descargar reporte del dashboard en Excel y PDF',priority:'Media',assigned_to:'Emilio'},
  {task_id:'P-04',module:'Mensajes',description:'Modulo de env√≠o de mails masivos con 2 templates HTML personalizables',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'P-05',module:'Mensajes',description:'Conectar email del due√±o para env√≠o de mensajes desde el m√≥dulo',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'P-06',module:'Pagos',description:'Permitir registrar un pago manual aunque no exista el servicio asociado',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'P-07',module:'Pagos',description:'Filtrar pagos por rango de fechas y descargar reporte en PDF, CSV o Excel',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'P-08',module:'Pagos',description:'Panel para administrar facturas generadas anteriormente',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'P-09',module:'Tareas',description:'Notificaciones al usuario en StylyPanel cada que hay un nuevo evento',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'P-10',module:'Tareas',description:'Permitir agregar, renombrar y eliminar columnas en el tablero de tareas',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'P-11',module:'Tareas',description:'En m√≥vil: drag & drop intuitivo para mover tareas entre columnas',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'P-12',module:'Tickets',description:'Renombrar m√≥dulo "Soporte" a "Tickets"',priority:'Baja',assigned_to:'Dami√°n'},
  {task_id:'P-13',module:'Tickets',description:'Auto-env√≠o de mensajes de atenci√≥n al cliente con notificaci√≥n push',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'P-14',module:'Cuenta',description:'Revisar funcionalidad de "Descargar datos"',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'P-15',module:'Cuenta',description:'Verificar que el email de soporte reciba mensajes de prueba',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'P-16',module:'Cuenta',description:'Configurar autenticaci√≥n de dos pasos con todos los m√©todos disponibles',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'P-17',module:'Registro',description:'Agregar t√©rminos y condiciones de Styly en el formulario de registro',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'P-18',module:'M√©tricas+',description:'Dropdown menu en m√≥vil para todas las secciones Plus',priority:'Media',assigned_to:'Emilio'},
  {task_id:'P-19',module:'IA',description:'Herramienta de IA en barra lateral para consultas sobre el negocio',priority:'Media',assigned_to:'Emilio'},
  {task_id:'P-20',module:'Facturaci√≥n',description:'Crear panel de facturaci√≥n: generar factura fiscal que timbre al SAT',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'P-21',module:'Stripe',description:'Quitar onboarding de Stripe externo; reemplazar por onboarding integrado',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'P-22',module:'QA',description:'Revisi√≥n completa de conectividad y funcionamiento',priority:'Alta',assigned_to:'Ambos'},
  // PANEL AFILIADOS
  {task_id:'A-01',module:'Puntaje',description:'Que funcione el sistema de puntaje real',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'A-02',module:'Puntaje',description:'Agregar secci√≥n del crucero en el tablero de puntaje',priority:'Media',assigned_to:'Emilio'},
  {task_id:'A-03',module:'Comisiones',description:'Widget de tasa de comisiones desglosadas y paginadas',priority:'Media',assigned_to:'Emilio'},
  {task_id:'A-04',module:'Comisiones',description:'Aplicar 50% en primera venta + mensaje en Academy',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'A-05',module:'Pagos',description:'Poder descargar historial de pagos completo',priority:'Media',assigned_to:'Emilio'},
  {task_id:'A-06',module:'Referidos',description:'Verificar que se exporten los datos de referidos correctamente',priority:'Media',assigned_to:'Emilio'},
  {task_id:'A-07',module:'Referidos',description:'Bot√≥n de descargar reporte en PDF y Excel',priority:'Media',assigned_to:'Emilio'},
  {task_id:'A-08',module:'Academy',description:'Agregar m√≥dulos 3 y 4',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'A-09',module:'Academy',description:'Meter los primeros 5 m√≥dulos como un solo curso',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'A-10',module:'Academy',description:'Cambiar duraci√≥n de m√≥dulos de la academy',priority:'Baja',assigned_to:'Dami√°n'},
  {task_id:'A-11',module:'Academy',description:'Al terminar la academy, mostrar certificado al usuario',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'A-12',module:'Consultor√≠a',description:'Crear m√≥dulo "Consultor√≠a": Survey para recabar info del negocio',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'A-13',module:'Consultor√≠a',description:'La herramienta sugiere extensiones basado en respuestas',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'A-14',module:'Clasificaci√≥n',description:'Agregar premios mensuales administrables en clasificaci√≥n global',priority:'Media',assigned_to:'Emilio'},
  {task_id:'A-15',module:'Clasificaci√≥n',description:'Banner del crucero Styly en la clasificaci√≥n global',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'A-16',module:'Tareas',description:'Reflejar mismos ajustes que Panel Styly: agregar/quitar/renombrar columnas',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'A-17',module:'Enlace',description:'Cambiar los textos de invitaci√≥n de las redes sociales en "Mi Enlace"',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'A-18',module:'Kit',description:'Implementar el kit de afiliado completo',priority:'Media',assigned_to:'Emilio'},
  {task_id:'A-19',module:'Demo',description:'En modo demo de Styly Panel, mostrar los add-ons sin bloqueos',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'A-20',module:'UI',description:'Ajustar mensaje de bienvenida del panel de afiliados',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'A-21',module:'UI',description:'Cambiar nombre de "Tickets" a "Soporte"',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'A-22',module:'Registro',description:'Que funcione bot√≥n "Quiero ser afiliado" con cuenta ya registrada',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'A-23',module:'Registro',description:'Agregar bot√≥n de "Dejar de ser afiliado" en panel de afiliado',priority:'Baja',assigned_to:'Dami√°n'},
  // LANDINGS
  {task_id:'L-01',module:'Landing',description:'Agregar vista previa de los add-ons al abrir detalles',priority:'Media',assigned_to:'Emilio'},
  {task_id:'L-02',module:'Landing',description:'Agregar demo interactiva del panel para visitantes',priority:'Media',assigned_to:'Emilio'},
  {task_id:'L-03',module:'Landing',description:'Chatbot de preguntas y respuestas predeterminadas',priority:'Media',assigned_to:'Emilio'},
  {task_id:'L-04',module:'Landing',description:'Cambiar animaci√≥n del hero section por imagen real del panel',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'L-05',module:'Landing',description:'Secci√≥n "Reservas autom√°ticas" ‚Üí renombrar, nuevo copy',priority:'Media',assigned_to:'Emilio'},
  {task_id:'L-06',module:'Afiliados LP',description:'Ajustar todo el texto de la p√°gina seg√∫n documento actualizado',priority:'Media',assigned_to:'Emilio'},
  {task_id:'L-07',module:'Afiliados LP',description:'Revisar flujo: c√≥digo de invitaci√≥n, login y panel completo',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'L-08',module:'Afiliados LP',description:'Que un usuario sin ser afiliado ni negocio se registre como afiliado',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'L-09',module:'Afiliados LP',description:'Quitar la parte de "solicitud de afiliado"',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'L-10',module:'Afiliados LP',description:'Ajustar m√≠nimo de puntos para participar en podio',priority:'Baja',assigned_to:'Emilio'},
  // SUBDOMINIOS
  {task_id:'S-01',module:'Subdominio',description:'Permitir que afiliados o due√±os se registren para comprar/suscribirse',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'S-02',module:'Subdominio',description:'Sincronizar empleados con servicios y reservas en la p√°gina web',priority:'Alta',assigned_to:'Dami√°n'},
  {task_id:'S-03',module:'Subdominio',description:'Permitir reservar un servicio sin estar registrado (usuario guest)',priority:'Media',assigned_to:'Dami√°n'},
  {task_id:'S-04',module:'Subdominio',description:'Crear panel en la web para que clientes puedan solicitar facturas',priority:'Media',assigned_to:'Dami√°n'},
  // ADMIN PANEL
  {task_id:'AD-01',module:'Admin Dashboard',description:'Renombrar m√©tricas + agregar filtros de tiempo',priority:'Alta',assigned_to:'Emilio'},
  {task_id:'AD-02',module:'Admin Dashboard',description:'Agregar filtro por persona (futuro)',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'AD-03',module:'Admin',description:'Eliminar secci√≥n de solicitudes',priority:'Baja',assigned_to:'Emilio'},
  {task_id:'AD-04',module:'Admin Pagos',description:'Gesti√≥n de pagos: descargar facturas + estados de cuenta mensuales',priority:'Media',assigned_to:'Emilio'},
  {task_id:'AD-05',module:'Admin',description:'Agregar filtros de b√∫squeda y paginaci√≥n en "Todos los negocios"',priority:'Media',assigned_to:'Emilio'},
  {task_id:'AD-06',module:'Admin',description:'Restringir acceso al m√≥dulo de soporte solo a ciertos usuarios',priority:'Media',assigned_to:'Emilio'}
];

let tasks=[],projects=[],users=[],tasksLoaded=false;

const PROJECT_CONFIG={
  'Landing Page':{emoji:'üåê',color:'#84CC16',order:1},
  'M√≥dulo Panel':{emoji:'üìä',color:'#3B82F6',order:2},
  'Afiliados Landing':{emoji:'üë•',color:'#EC4899',order:3},
  'Panel Afiliados':{emoji:'‚≠ê',color:'#F59E0B',order:4},
  'Subdominios':{emoji:'üè™',color:'#10B981',order:5},
  'Admin Panel':{emoji:'‚öôÔ∏è',color:'#8B5CF6',order:6}
};

const PROJECT_TASKS={
  'Landing Page':['L-01','L-02','L-03','L-04','L-05'],
  'Afiliados Landing':['L-06','L-07','L-08','L-09','L-10'],
  'M√≥dulo Panel':['P-01','P-02','P-03','P-04','P-05','P-06','P-07','P-08','P-09','P-10','P-11','P-12','P-13','P-14','P-15','P-16','P-17','P-18','P-19','P-20','P-21','P-22'],
  'Panel Afiliados':['A-01','A-02','A-03','A-04','A-05','A-06','A-07','A-08','A-09','A-10','A-11','A-12','A-13','A-14','A-15','A-16','A-17','A-18','A-19','A-20','A-21','A-22','A-23'],
  'Subdominios':['S-01','S-02','S-03','S-04'],
  'Admin Panel':['AD-01','AD-02','AD-03','AD-04','AD-05','AD-06']
};

async function loadTasks(){
  if(tasksLoaded)return;
  try{
    // Cargar proyectos
    let r=await fetch('/api/styly/projects',{headers:hdrs});
    let d=await r.json();
    projects=d.projects||[];

    // Si no hay proyectos, crearlos
    if(projects.length===0){
      for(const [name,cfg] of Object.entries(PROJECT_CONFIG)){
        const r2=await fetch('/api/styly/projects',{method:'POST',headers:hdrs,body:JSON.stringify({name,color:cfg.color,description:name})});
        const d2=await r2.json();
        projects.push(d2.project);
      }
    }

    // Cargar tareas
    r=await fetch('/api/styly/tasks',{headers:hdrs});
    d=await r.json();
    tasks=d.tasks||[];

    // Si no hay tareas, crearlas todas con sus proyectos
    if(tasks.length===0){
      for(const task of INITIAL_TASKS){
        let projectName=null;
        // Buscar en qu√© proyecto est√° esta tarea
        for(const [pname,taskIds] of Object.entries(PROJECT_TASKS)){
          if(taskIds.includes(task.task_id)){
            projectName=pname;
            break;
          }
        }
        const proj=projects.find(p=>p.name===projectName);
        const payload={...task,project_id:proj?.id||null};
        try{
          await fetch('/api/styly/tasks',{method:'POST',headers:hdrs,body:JSON.stringify(payload)});
        }catch(err){console.error('Error creando tarea',task.task_id,err.message)}
      }
      // Recargar tareas
      r=await fetch('/api/styly/tasks',{headers:hdrs});
      d=await r.json();
      tasks=d.tasks||[];
    }

    // Cargar usuarios
    r=await fetch('/api/styly/users',{headers:hdrs});
    d=await r.json();
    users=d.users||[];

    tasksLoaded=true;
  }catch(e){console.error('Error cargando tareas:',e.message)}
}

async function renderTareas(m){
  await loadTasks();
  let filters=window._taskFilters||{status:'',assigned:'',priority:'',project:'',search:''};

  const MODULECONFIG={
    'Dashboard':{emoji:'üìä',color:'#3B82F6',order:1},'Mensajes':{emoji:'üí¨',color:'#8B5CF6',order:2},'Pagos':{emoji:'üí∞',color:'#10B981',order:3},'Tareas':{emoji:'‚úÖ',color:'#F59E0B',order:4},'Tickets':{emoji:'üé´',color:'#EC4899',order:5},'Cuenta':{emoji:'üë§',color:'#6366F1',order:6},'Registro':{emoji:'‚úçÔ∏è',color:'#06B6D4',order:7},'M√©tricas+':{emoji:'üìà',color:'#EF4444',order:8},'IA':{emoji:'üß†',color:'#14B8A6',order:9},'Facturaci√≥n':{emoji:'üßæ',color:'#F97316',order:10},'Stripe':{emoji:'üí≥',color:'#0EA5E9',order:11},'QA':{emoji:'üîç',color:'#84CC16',order:12},'Puntaje':{emoji:'‚≠ê',color:'#EC4899',order:13},'Comisiones':{emoji:'üíµ',color:'#10B981',order:14},'Referidos':{emoji:'üë•',color:'#8B5CF6',order:15},'Academy':{emoji:'üìö',color:'#F59E0B',order:16},'Consultor√≠a':{emoji:'üéØ',color:'#06B6D4',order:17},'Clasificaci√≥n':{emoji:'üèÜ',color:'#EF4444',order:18},'Enlace':{emoji:'üîó',color:'#6366F1',order:19},'Kit':{emoji:'üì¶',color:'#14B8A6',order:20},'Demo':{emoji:'üé¨',color:'#F97316',order:21},'UI':{emoji:'üé®',color:'#0EA5E9',order:22},'Landing':{emoji:'üåê',color:'#84CC16',order:23},'Afiliados LP':{emoji:'üë•',color:'#EC4899',order:24},'Subdominio':{emoji:'üè™',color:'#10B981',order:25},'Admin Dashboard':{emoji:'‚öôÔ∏è',color:'#8B5CF6',order:26},'Admin Pagos':{emoji:'üíº',color:'#F59E0B',order:27},'Admin':{emoji:'üõ°Ô∏è',color:'#06B6D4',order:28}
  };

  // Calcular estad√≠sticas
  const pending=tasks.filter(t=>t.status==='Pendiente').length;
  const inProgress=tasks.filter(t=>t.status==='En Progreso').length;
  const completed=tasks.filter(t=>t.status==='Completada').length;
  const userStats={};
  users.forEach(u=>{userStats[u.name]={total:0,pending:0,completed:0};});
  tasks.forEach(t=>{
    if(t.assigned_to&&userStats[t.assigned_to]){
      userStats[t.assigned_to].total++;
      if(t.status==='Pendiente')userStats[t.assigned_to].pending++;
      if(t.status==='Completada')userStats[t.assigned_to].completed++;
    }
  });

  // Filtrar tareas
  let filtered=tasks;
  if(filters.status)filtered=filtered.filter(t=>t.status===filters.status);
  if(filters.assigned)filtered=filtered.filter(t=>t.assigned_to===filters.assigned);
  if(filters.priority)filtered=filtered.filter(t=>t.priority===filters.priority);
  if(filters.search)filtered=filtered.filter(t=>t.task_id.toLowerCase().includes(filters.search.toLowerCase())||t.description.toLowerCase().includes(filters.search.toLowerCase()));

  const sortedProjects=[...projects].sort((a,b)=>(PROJECT_CONFIG[a.name]?.order||999)-(PROJECT_CONFIG[b.name]?.order||999));

  m.innerHTML=`
    <div style="display:grid;grid-template-columns:250px 1fr;gap:1.5rem;height:calc(100vh - 250px);overflow:hidden">
      <!-- SIDEBAR IZQUIERDO -->
      <div style="border-right:1px solid var(--border);padding-right:1.5rem;overflow-y:auto;padding-bottom:2rem">
        <div style="margin-bottom:1.5rem">
          <div style="font-size:.7rem;font-weight:700;color:var(--mt);text-transform:uppercase;margin-bottom:.5rem">üéØ KPIs</div>
          <div style="background:rgba(59,130,246,.1);border:1px solid #3B82F6;border-radius:8px;padding:.75rem;margin-bottom:.5rem">
            <div style="font-size:.75rem;color:var(--mt);margin-bottom:.2rem">Pendientes</div>
            <div style="font-size:1.5rem;font-weight:700;color:#3B82F6">${pending}</div>
          </div>
          <div style="background:rgba(245,158,11,.1);border:1px solid #F59E0B;border-radius:8px;padding:.75rem;margin-bottom:.5rem">
            <div style="font-size:.75rem;color:var(--mt);margin-bottom:.2rem">En Progreso</div>
            <div style="font-size:1.5rem;font-weight:700;color:#F59E0B">${inProgress}</div>
          </div>
          <div style="background:rgba(16,185,129,.1);border:1px solid #10B981;border-radius:8px;padding:.75rem">
            <div style="font-size:.75rem;color:var(--mt);margin-bottom:.2rem">Completadas</div>
            <div style="font-size:1.5rem;font-weight:700;color:#10B981">${completed}</div>
          </div>
        </div>

        <div style="margin-bottom:1.5rem">
          <div style="font-size:.7rem;font-weight:700;color:var(--mt);text-transform:uppercase;margin-bottom:.5rem">üë• Usuarios</div>
          ${users.map(u=>`<div style="padding:.5rem;border-radius:6px;border:1px solid var(--border);margin-bottom:.4rem;cursor:pointer;transition:all .2s;${filters.assigned===u.name?'background:var(--sy-bg);border-color:var(--sy)':''}" onclick="window._taskFilters.assigned='${u.name}';renderTareas(document.getElementById('modContent'))">
            <div style="font-size:.75rem;font-weight:600;color:var(--fg)">${u.name}</div>
            <div style="font-size:.65rem;color:var(--mt)">${userStats[u.name]?.total||0} tareas</div>
          </div>`).join('')}
        </div>

        <div style="margin-bottom:1.5rem">
          <div style="font-size:.7rem;font-weight:700;color:var(--mt);text-transform:uppercase;margin-bottom:.5rem">üé® Status</div>
          <div onclick="window._taskFilters.status='';renderTareas(document.getElementById('modContent'))" style="padding:.5rem;border-radius:6px;border:1px solid var(--border);margin-bottom:.4rem;cursor:pointer;${!filters.status?'background:var(--sy-bg);border-color:var(--sy)':''}">Todos</div>
          <div onclick="window._taskFilters.status='Pendiente';renderTareas(document.getElementById('modContent'))" style="padding:.5rem;border-radius:6px;border:1px solid var(--border);margin-bottom:.4rem;cursor:pointer;${filters.status==='Pendiente'?'background:rgba(239,68,68,.15);border-color:#EF4444':''}">üî¥ Pendiente</div>
          <div onclick="window._taskFilters.status='En Progreso';renderTareas(document.getElementById('modContent'))" style="padding:.5rem;border-radius:6px;border:1px solid var(--border);margin-bottom:.4rem;cursor:pointer;${filters.status==='En Progreso'?'background:rgba(245,158,11,.15);border-color:#F59E0B':''}">üü° En Progreso</div>
          <div onclick="window._taskFilters.status='Completada';renderTareas(document.getElementById('modContent'))" style="padding:.5rem;border-radius:6px;border:1px solid var(--border);cursor:pointer;${filters.status==='Completada'?'background:rgba(16,185,129,.1);border-color:#10B981':''}">‚úÖ Completada</div>
        </div>
      </div>

      <!-- CONTENIDO PRINCIPAL -->
      <div style="overflow-y:auto;padding-bottom:2rem">
        <!-- BARRA SUPERIOR -->
        <div style="margin-bottom:1.5rem;position:sticky;top:0;background:var(--bg);padding:.75rem 0;z-index:10;border-bottom:1px solid var(--border);padding-bottom:1rem">
          <div style="display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">
            <input type="text" id="searchTasks" placeholder="üîç Buscar por ID o descripci√≥n..." onchange="window._taskFilters.search=this.value;renderTareas(document.getElementById('modContent'))" oninput="window._taskFilters.search=this.value;renderTareas(document.getElementById('modContent'))" value="${filters.search}" style="flex:1;min-width:200px;padding:.45rem .65rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.85rem">
            <select id="filterPrio" onchange="window._taskFilters.priority=this.value;renderTareas(document.getElementById('modContent'))" style="padding:.45rem .65rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.85rem">
              <option value="">Todas las Prioridades</option>
              <option value="Alta" ${filters.priority==='Alta'?'selected':''}>Alta</option>
              <option value="Media" ${filters.priority==='Media'?'selected':''}>Media</option>
              <option value="Baja" ${filters.priority==='Baja'?'selected':''}>Baja</option>
            </select>
            <button onclick="window._taskFilters={status:'',assigned:'',priority:'',project:'',search:''};renderTareas(document.getElementById('modContent'))" style="padding:.45rem 1rem;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);font-size:.85rem;font-weight:600;cursor:pointer;white-space:nowrap">üîÑ Limpiar</button>
            <button onclick="openNewTaskModal()" style="padding:.45rem 1rem;border-radius:8px;border:none;background:var(--sy);color:#fff;font-size:.85rem;font-weight:600;cursor:pointer;white-space:nowrap">‚ûï Tarea</button>
          </div>
          <div style="font-size:.8rem;color:var(--mt)"><strong>${filtered.length}</strong> tareas mostradas ¬∑ <strong>${pending}</strong> pendientes ¬∑ <strong>${inProgress}</strong> en progreso ¬∑ <strong>${completed}</strong> completadas</div>
        </div>

        <!-- TAREAS POR PROYECTO -->
        ${sortedProjects.map(proj=>{
          const cfg=PROJECT_CONFIG[proj.name]||{emoji:'üìå',color:'#6B7280'};
          const projTasks=filtered.filter(t=>t.project_id===proj.id);
          if(projTasks.length===0)return'';
          const projId='proj-'+(proj.id||proj.name.replace(/\s+/g,'-'));

          const grouped={};
          projTasks.forEach(t=>{
            if(!grouped[t.module])grouped[t.module]=[];
            grouped[t.module].push(t);
          });
          const sortedModules=Object.keys(grouped).sort((a,b)=>(MODULECONFIG[a]?.order||999)-(MODULECONFIG[b]?.order||999));

          return `
          <div style="margin-bottom:2rem">
            <button onclick="toggleProject('${projId}')" style="width:100%;text-align:left;padding:.9rem 1.2rem;background:linear-gradient(135deg,${cfg.color}20 0%,${cfg.color}05 100%);border:2px solid ${cfg.color}60;border-radius:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;color:var(--fg);font-weight:700;font-size:1.05rem;transition:all .2s">
              <div style="display:flex;align-items:center;gap:.7rem">
                <span style="font-size:1.5rem">${cfg.emoji}</span>
                <div>
                  <div>${proj.name}</div>
                  <div style="font-size:.7rem;color:var(--mt);font-weight:400">${projTasks.length} tareas</div>
                </div>
              </div>
              <span id="toggle-${projId}" style="font-size:1.1rem;transition:transform .2s">‚ñ∂</span>
            </button>
            <div id="${projId}" style="display:block;margin-top:1rem;padding-left:.5rem;border-left:3px solid ${cfg.color}">
              ${sortedModules.map(mod=>{
                const mCfg=MODULECONFIG[mod]||{emoji:'üìå',color:'#6B7280'};
                const mTasks=grouped[mod];
                const modId=projId+'-mod-'+(mod.replace(/\s+/g,'-'));
                return `
                <div style="margin-bottom:1.5rem">
                  <button onclick="toggleModule('${modId}')" style="width:100%;text-align:left;padding:.65rem 1rem;background:linear-gradient(135deg,${mCfg.color}10 0%,${mCfg.color}02 100%);border:1px solid ${mCfg.color}30;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;color:var(--fg);font-weight:600;font-size:.95rem;transition:all .2s">
                    <div style="display:flex;align-items:center;gap:.4rem">
                      <span style="font-size:1rem">${mCfg.emoji}</span>
                      <span>${mod} (${mTasks.length})</span>
                    </div>
                    <span id="toggle-${modId}" style="font-size:.85rem">‚ñ∂</span>
                  </button>
                  <div id="mod-${modId}" style="display:none;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:.75rem;margin-top:.75rem">
                    ${mTasks.map(t=>`
                      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;transition:all .2s" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,.1)'" onmouseout="this.style.boxShadow='none'">
                        <div style="display:flex;justify-content:space-between;align-items:start;gap:.5rem;margin-bottom:.5rem">
                          <div style="flex:1">
                            <div style="font-size:.75rem;font-weight:700;color:${mCfg.color};text-transform:uppercase;letter-spacing:.5px">${t.task_id}</div>
                            <div style="font-size:.9rem;font-weight:600;color:var(--fg);margin-top:.25rem;line-height:1.4">${esc(t.description)}</div>
                          </div>
                          <button onclick="deleteTask(${t.id})" style="padding:.25rem;border:none;background:transparent;color:#EF4444;font-size:.9rem;cursor:pointer;opacity:.5;transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.5'">üóëÔ∏è</button>
                        </div>
                        <div style="display:flex;gap:.4rem;margin-bottom:.75rem;flex-wrap:wrap">
                          <span style="padding:3px 8px;border-radius:4px;font-size:.7rem;font-weight:700;background:${t.priority==='Alta'?'rgba(239,68,68,.15)':t.priority==='Media'?'rgba(245,158,11,.15)':'rgba(107,114,128,.1)'};color:${t.priority==='Alta'?'#DC2626':t.priority==='Media'?'#D97706':'#6B7280'}">${t.priority}</span>
                          <span style="padding:3px 8px;border-radius:4px;font-size:.7rem;font-weight:700;background:${t.status==='Pendiente'?'rgba(239,68,68,.1)':t.status==='En Progreso'?'rgba(245,158,11,.1)':'rgba(16,185,129,.1)'};color:${t.status==='Pendiente'?'#EF4444':t.status==='En Progreso'?'#F59E0B':'#10B981'}">${t.status}</span>
                          ${t.assigned_to?`<span style="padding:3px 8px;border-radius:4px;font-size:.7rem;font-weight:700;background:var(--sy-bg);color:var(--sy)">üë§ ${t.assigned_to}</span>`:'<span style="padding:3px 8px;border-radius:4px;font-size:.7rem;font-weight:700;background:var(--border);color:var(--mt)">‚äò Sin asignar</span>'}
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.4rem">
                          <select onchange="updateTaskStatus(${t.id},this.value)" style="padding:.35rem;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-size:.7rem;font-weight:600;cursor:pointer">
                            <option value="Pendiente" ${t.status==='Pendiente'?'selected':''}>Pendiente</option>
                            <option value="En Progreso" ${t.status==='En Progreso'?'selected':''}>En Progreso</option>
                            <option value="Completada" ${t.status==='Completada'?'selected':''}>Completada</option>
                          </select>
                          <select onchange="updateTaskAssigned(${t.id},this.value)" style="padding:.35rem;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-size:.7rem;font-weight:600;cursor:pointer">
                            <option value="">Sin asignar</option>
                            ${users.map(u=>`<option value="${u.name}" ${t.assigned_to===u.name?'selected':''}>${u.name}</option>`).join('')}
                          </select>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                `;
              }).join('')}
            </div>
          </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
  window._taskFilters=filters;
}

// ================================================================
// DASHBOARD DE TAREAS CON ESTAD√çSTICAS Y ANAL√çTICOS
// ================================================================
async function renderDashboard(m){
  await loadTasks();

  // Calcular todas las estad√≠sticas
  const total=tasks.length;
  const pending=tasks.filter(t=>t.status==='Pendiente').length;
  const inProgress=tasks.filter(t=>t.status==='En Progreso').length;
  const completed=tasks.filter(t=>t.status==='Completada').length;
  const completionRate=total>0?Math.round((completed/total)*100):0;

  // Estad√≠sticas por usuario
  const userStats={};
  users.forEach(u=>{
    userStats[u.name]={name:u.name,total:0,pending:0,inProgress:0,completed:0,completion:0};
  });
  tasks.forEach(t=>{
    if(t.assigned_to&&userStats[t.assigned_to]){
      userStats[t.assigned_to].total++;
      if(t.status==='Pendiente')userStats[t.assigned_to].pending++;
      else if(t.status==='En Progreso')userStats[t.assigned_to].inProgress++;
      else if(t.status==='Completada')userStats[t.assigned_to].completed++;
    }
  });
  Object.values(userStats).forEach(u=>{
    u.completion=u.total>0?Math.round((u.completed/u.total)*100):0;
  });

  // Estad√≠sticas por proyecto
  const projStats={};
  projects.forEach(p=>{
    projStats[p.name]={name:p.name,emoji:PROJECT_CONFIG[p.name]?.emoji||'üìå',total:0,pending:0,completed:0,completion:0};
  });
  tasks.forEach(t=>{
    const proj=projects.find(p=>p.id===t.project_id);
    if(proj&&projStats[proj.name]){
      projStats[proj.name].total++;
      if(t.status==='Completada')projStats[proj.name].completed++;
      if(t.status==='Pendiente')projStats[proj.name].pending++;
    }
  });
  Object.values(projStats).forEach(p=>{
    p.completion=p.total>0?Math.round((p.completed/p.total)*100):0;
  });

  // Estad√≠sticas por prioridad
  const byPriority={Alta:0,Media:0,Baja:0};
  const byPriorityDone={Alta:0,Media:0,Baja:0};
  tasks.forEach(t=>{
    if(byPriority[t.priority]!==undefined){
      byPriority[t.priority]++;
      if(t.status==='Completada')byPriorityDone[t.priority]++;
    }
  });

  const usersList=Object.values(userStats).filter(u=>u.total>0).sort((a,b)=>b.total-a.total);
  const projList=Object.values(projStats).sort((a,b)=>b.total-a.total);

  m.innerHTML=`
    <div style="padding:0">
      <!-- KPI CARDS -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem">
        <div style="background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(59,130,246,.05));border:2px solid #3B82F6;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem">üìä Total de Tareas</div>
          <div style="font-size:2.5rem;font-weight:700;color:#3B82F6">${total}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">Tareas en el sistema</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(239,68,68,.1),rgba(239,68,68,.05));border:2px solid #EF4444;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem">üî¥ Pendientes</div>
          <div style="font-size:2.5rem;font-weight:700;color:#EF4444">${pending}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${total>0?Math.round((pending/total)*100):'0'}% del total</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(245,158,11,.05));border:2px solid #F59E0B;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem">üü° En Progreso</div>
          <div style="font-size:2.5rem;font-weight:700;color:#F59E0B">${inProgress}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${total>0?Math.round((inProgress/total)*100):'0'}% del total</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(16,185,129,.05));border:2px solid #10B981;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem">‚úÖ Completadas</div>
          <div style="font-size:2.5rem;font-weight:700;color:#10B981">${completed}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${completionRate}% de completaci√≥n</div>
        </div>
      </div>

      <!-- DOS COLUMNAS -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem">
        <!-- COLUMNA IZQUIERDA: Usuarios y Proyectos -->
        <div>
          <h3 style="font-size:1.1rem;font-weight:700;color:var(--fg);margin-bottom:1rem">üë• Carga de Trabajo por Usuario</h3>
          ${usersList.map(u=>`
            <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:.75rem">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                <div style="font-weight:600;color:var(--fg)">${u.name}</div>
                <div style="font-size:.75rem;font-weight:700;background:var(--sy-bg);color:var(--sy);padding:2px 8px;border-radius:4px">${u.completion}%</div>
              </div>
              <div style="display:flex;gap:.5rem;font-size:.75rem;color:var(--mt);margin-bottom:.5rem">
                <span>üìå ${u.total} tareas</span>
                <span>üî¥ ${u.pending}</span>
                <span>üü° ${u.inProgress}</span>
                <span>‚úÖ ${u.completed}</span>
              </div>
              <div style="width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
                <div style="width:${u.completion}%;height:100%;background:linear-gradient(90deg,#3B82F6,#10B981);transition:width .3s"></div>
              </div>
            </div>
          `).join('')}
        </div>

        <!-- COLUMNA DERECHA: Proyectos -->
        <div>
          <h3 style="font-size:1.1rem;font-weight:700;color:var(--fg);margin-bottom:1rem">üéØ Progreso por Proyecto</h3>
          ${projList.map(p=>`
            <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:.75rem">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                <div style="font-weight:600;color:var(--fg)"><span style="font-size:1.2rem;margin-right:.5rem">${p.emoji}</span>${p.name}</div>
                <div style="font-size:.75rem;font-weight:700;background:var(--sy-bg);color:var(--sy);padding:2px 8px;border-radius:4px">${p.completion}%</div>
              </div>
              <div style="display:flex;gap:.5rem;font-size:.75rem;color:var(--mt);margin-bottom:.5rem">
                <span>üìå ${p.total} tareas</span>
                <span>‚úÖ ${p.completed}</span>
              </div>
              <div style="width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
                <div style="width:${p.completion}%;height:100%;background:linear-gradient(90deg,#3B82F6,#10B981);transition:width .3s"></div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- PRIORIDADES -->
      <div style="margin-top:2rem">
        <h3 style="font-size:1.1rem;font-weight:700;color:var(--fg);margin-bottom:1rem">‚ö° Tareas por Prioridad</h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem">
          <div style="background:rgba(220,38,38,.1);border:1px solid #DC2626;border-radius:10px;padding:1.5rem;text-align:center">
            <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem">üî¥ Alta Prioridad</div>
            <div style="font-size:2rem;font-weight:700;color:#DC2626">${byPriority.Alta}</div>
            <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${byPriorityDone.Alta} completadas (${byPriority.Alta>0?Math.round((byPriorityDone.Alta/byPriority.Alta)*100):'0'}%)</div>
          </div>
          <div style="background:rgba(217,119,6,.1);border:1px solid #D97706;border-radius:10px;padding:1.5rem;text-align:center">
            <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem">üü° Prioridad Media</div>
            <div style="font-size:2rem;font-weight:700;color:#D97706">${byPriority.Media}</div>
            <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${byPriorityDone.Media} completadas (${byPriority.Media>0?Math.round((byPriorityDone.Media/byPriority.Media)*100):'0'}%)</div>
          </div>
          <div style="background:rgba(107,114,128,.1);border:1px solid #6B7280;border-radius:10px;padding:1.5rem;text-align:center">
            <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem">üü¢ Baja Prioridad</div>
            <div style="font-size:2rem;font-weight:700;color:#6B7280">${byPriority.Baja}</div>
            <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${byPriorityDone.Baja} completadas (${byPriority.Baja>0?Math.round((byPriorityDone.Baja/byPriority.Baja)*100):'0'}%)</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ================================================================
// IA - AN√ÅLISIS INTELIGENTE DE TAREAS
// ================================================================
async function renderIATareas(m){
  await loadTasks();

  let iaState=window._iaState||{mode:'menu',result:'',loading:false};

  const total=tasks.length;
  const pending=tasks.filter(t=>t.status==='Pendiente').length;
  const completed=tasks.filter(t=>t.status==='Completada').length;

  // An√°lisis de patrones
  const getBottlenecks=()=>{
    const bottlenecks=[];
    const userLoads={};
    tasks.forEach(t=>{
      if(t.assigned_to&&t.status!=='Completada'){
        userLoads[t.assigned_to]=(userLoads[t.assigned_to]||0)+1;
      }
    });
    Object.entries(userLoads).forEach(([user,count])=>{
      if(count>Math.ceil(total/users.length)*1.5){
        bottlenecks.push({user,overload:count});
      }
    });
    return bottlenecks;
  };

  const bottlenecks=getBottlenecks();
  const oldestTasks=tasks.filter(t=>t.status==='Pendiente').sort((a,b)=>new Date(a.created_at)-new Date(b.created_at)).slice(0,5);

  m.innerHTML=`
    <div style="padding:1rem">
      ${iaState.mode==='menu'?`
        <div style="max-width:900px">
          <h2 style="font-size:1.5rem;font-weight:700;color:var(--fg);margin-bottom:1.5rem">üß† Inteligencia Artificial - An√°lisis de Tareas</h2>

          <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:2rem">
            <p style="color:var(--mt);margin-bottom:1rem;line-height:1.6">La IA analiza tus tareas para identificar bottlenecks, sugerir optimizaciones y predecir riesgos de atrasos.</p>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem;font-size:.85rem">
              <div>üìä <strong>${total}</strong> tareas totales</div>
              <div>üî¥ <strong>${pending}</strong> pendientes</div>
              <div>‚úÖ <strong>${completed}</strong> completadas</div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem">
            <div onclick="window._iaState={mode:'bottlenecks',result:'',loading:true};renderIATareas(document.getElementById('modContent'))" style="background:linear-gradient(135deg,rgba(239,68,68,.1),rgba(239,68,68,.05));border:2px solid #EF4444;border-radius:12px;padding:1.5rem;cursor:pointer;transition:all .2s;text-align:center" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 4px 12px rgba(239,68,68,.2)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
              <div style="font-size:2rem;margin-bottom:.5rem">‚ö†Ô∏è</div>
              <div style="font-weight:700;color:#EF4444;margin-bottom:.5rem">Detectar Bottlenecks</div>
              <div style="font-size:.75rem;color:var(--mt)">Identifica usuarios sobrecargados</div>
            </div>

            <div onclick="window._iaState={mode:'recommendations',result:'',loading:true};renderIATareas(document.getElementById('modContent'))" style="background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(59,130,246,.05));border:2px solid #3B82F6;border-radius:12px;padding:1.5rem;cursor:pointer;transition:all .2s;text-align:center" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 4px 12px rgba(59,130,246,.2)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
              <div style="font-size:2rem;margin-bottom:.5rem">üí°</div>
              <div style="font-weight:700;color:#3B82F6;margin-bottom:.5rem">Recomendaciones</div>
              <div style="font-size:.75rem;color:var(--mt)">Asignaciones y optimizaciones</div>
            </div>

            <div onclick="window._iaState={mode:'riskanalysis',result:'',loading:true};renderIATareas(document.getElementById('modContent'))" style="background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(245,158,11,.05));border:2px solid #F59E0B;border-radius:12px;padding:1.5rem;cursor:pointer;transition:all .2s;text-align:center" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 4px 12px rgba(245,158,11,.2)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
              <div style="font-size:2rem;margin-bottom:.5rem">üéØ</div>
              <div style="font-weight:700;color:#F59E0B;margin-bottom:.5rem">An√°lisis de Riesgo</div>
              <div style="font-size:.75rem;color:var(--mt)">Tareas en riesgo de atrasos</div>
            </div>

            <div onclick="window._iaState={mode:'report',result:'',loading:true};renderIATareas(document.getElementById('modContent'))" style="background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(16,185,129,.05));border:2px solid #10B981;border-radius:12px;padding:1.5rem;cursor:pointer;transition:all .2s;text-align:center" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 4px 12px rgba(16,185,129,.2)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
              <div style="font-size:2rem;margin-bottom:.5rem">üìà</div>
              <div style="font-weight:700;color:#10B981;margin-bottom:.5rem">Reporte Ejecutivo</div>
              <div style="font-size:.75rem;color:var(--mt)">Resumen y tendencias</div>
            </div>
          </div>
        </div>
      `:iaState.mode==='bottlenecks'?`
        <button onclick="window._iaState={mode:'menu',result:'',loading:false};renderIATareas(document.getElementById('modContent'))" style="margin-bottom:1.5rem;padding:.5rem 1rem;border:1px solid var(--border);background:var(--card);border-radius:6px;color:var(--fg);cursor:pointer;font-weight:600">‚Üê Volver</button>
        <h2 style="font-size:1.3rem;font-weight:700;color:var(--fg);margin-bottom:1rem">‚ö†Ô∏è An√°lisis de Bottlenecks</h2>
        ${iaState.loading?'<div style="color:var(--mt)">üîÑ Analizando carga de trabajo...</div>':`
          <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem">
            ${bottlenecks.length===0?`
              <div style="text-align:center;padding:2rem;color:var(--mt)">
                <div style="font-size:3rem;margin-bottom:1rem">‚úÖ</div>
                <p>Excelente distribuci√≥n de carga. Ning√∫n usuario est√° sobrecargado.</p>
              </div>
            `:`
              <div>
                <div style="color:#EF4444;font-weight:700;margin-bottom:1rem">Se detectaron los siguientes usuarios con sobrecarga:</div>
                ${bottlenecks.map(b=>`
                  <div style="background:rgba(239,68,68,.1);border-left:3px solid #EF4444;padding:1rem;margin-bottom:.75rem;border-radius:6px">
                    <div style="font-weight:600;color:var(--fg)">${b.user}</div>
                    <div style="font-size:.85rem;color:var(--mt);margin-top:.25rem">${b.overload} tareas asignadas (25% por encima del promedio)</div>
                    <div style="font-size:.8rem;color:var(--mt);margin-top:.5rem;font-style:italic">üí° Recomendaci√≥n: Redistribuir tareas o priorizar completaciones</div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        `}
      `:iaState.mode==='recommendations'?`
        <button onclick="window._iaState={mode:'menu',result:'',loading:false};renderIATareas(document.getElementById('modContent'))" style="margin-bottom:1.5rem;padding:.5rem 1rem;border:1px solid var(--border);background:var(--card);border-radius:6px;color:var(--fg);cursor:pointer;font-weight:600">‚Üê Volver</button>
        <h2 style="font-size:1.3rem;font-weight:700;color:var(--fg);margin-bottom:1rem">üí° Recomendaciones de IA</h2>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem">
          <div style="margin-bottom:1.5rem">
            <div style="font-weight:700;color:var(--fg);margin-bottom:.75rem">1. üìù Nuevas Tareas Sugeridas</div>
            <div style="font-size:.9rem;color:var(--mt);background:rgba(59,130,246,.05);padding:1rem;border-radius:6px;border-left:3px solid #3B82F6">
              Basado en tus proyectos actuales, se sugieren crear tareas para: Testing, Documentaci√≥n, y Revisi√≥n de c√≥digo. Esto mejorar√° la calidad del producto.
            </div>
          </div>
          <div style="margin-bottom:1.5rem">
            <div style="font-weight:700;color:var(--fg);margin-bottom:.75rem">2. üë• Redistribuci√≥n √ìptima</div>
            <div style="font-size:.9rem;color:var(--mt);background:rgba(245,158,11,.05);padding:1rem;border-radius:6px;border-left:3px solid #F59E0B">
              ${bottlenecks.length>0?bottlenecks.map(b=>'Transferir 2-3 tareas de '+b.user+' a usuarios con menor carga').join('. '):'Mantener distribuci√≥n actual - est√° bien balanceada'}
            </div>
          </div>
          <div>
            <div style="font-weight:700;color:var(--fg);margin-bottom:.75rem">3. ‚ö° Optimizaci√≥n de Prioridades</div>
            <div style="font-size:.9rem;color:var(--mt);background:rgba(16,185,129,.05);padding:1rem;border-radius:6px;border-left:3px solid #10B981">
              Priorizar primero las tareas de "Alta" en estado "Pendiente". Esto acelerar√° la finalizaci√≥n de hitos cr√≠ticos.
            </div>
          </div>
        </div>
      `:iaState.mode==='riskanalysis'?`
        <button onclick="window._iaState={mode:'menu',result:'',loading:false};renderIATareas(document.getElementById('modContent'))" style="margin-bottom:1.5rem;padding:.5rem 1rem;border:1px solid var(--border);background:var(--card);border-radius:6px;color:var(--fg);cursor:pointer;font-weight:600">‚Üê Volver</button>
        <h2 style="font-size:1.3rem;font-weight:700;color:var(--fg);margin-bottom:1rem">üéØ An√°lisis de Riesgo</h2>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem">
          <div style="margin-bottom:1.5rem">
            <div style="font-weight:700;color:#EF4444;margin-bottom:.75rem">‚ö†Ô∏è Tareas Antiguas en Pendiente</div>
            ${oldestTasks.length===0?'<div style="color:var(--mt);font-size:.9rem">No hay tareas antiguas pendientes.</div>':'<div style="display:flex;flex-direction:column;gap:.5rem">'+oldestTasks.map(t=>{const days=Math.floor((new Date()-new Date(t.created_at))/(1000*60*60*24));return '<div style="background:rgba(239,68,68,.1);padding:.75rem;border-radius:6px;border-left:3px solid #EF4444;font-size:.85rem"><div style="font-weight:600;color:var(--fg)">'+t.task_id+' - '+t.description.substring(0,50)+'...</div><div style="color:var(--mt);margin-top:.25rem">Pendiente desde hace '+days+' d√≠as</div></div>';}).join('')+'</div>'}
          </div>
          <div>
            <div style="font-weight:700;color:#F59E0B;margin-bottom:.75rem">üü° Tareas Sin Asignar</div>
            ${tasks.filter(t=>!t.assigned_to).length===0?'<div style="color:var(--mt);font-size:.9rem">‚úÖ Todas las tareas est√°n asignadas.</div>':`<div style="color:var(--mt);font-size:.9rem">${tasks.filter(t=>!t.assigned_to).length} tareas sin asignar. Esto puede retrasar el progreso.</div>`}
          </div>
        </div>
      `:''}
    </div>
  `;
  window._iaState=iaState;
}

function toggleProject(projId){
  const el=document.getElementById(projId);
  const icon=document.getElementById('toggle-'+projId);
  if(el){
    const hidden=el.style.display==='none';
    el.style.display=hidden?'block':'none';
    if(icon)icon.textContent=hidden?'‚ñº':'‚ñ∂';
  }
}

function toggleAllProjects(){
  const projs=document.querySelectorAll('[id^="proj-"]');
  const allHidden=Array.from(projs).every(p=>p.style.display==='none');
  projs.forEach(p=>{
    p.style.display=allHidden?'block':'none';
    const projId=p.id;
    const icon=document.getElementById('toggle-'+projId);
    if(icon)icon.textContent=allHidden?'‚ñº':'‚ñ∂';
  });
}

function toggleModule(modId){
  const id='mod-'+modId;
  const toggle='toggle-'+modId;
  const el=document.getElementById(id);
  const icon=document.getElementById(toggle);
  if(el){
    const hidden=el.style.display==='none';
    el.style.display=hidden?'grid':'none';
    if(icon)icon.textContent=hidden?'‚ñº':'‚ñ∂';
  }
}

function toggleAllModules(){
  const modules=document.querySelectorAll('[id^="mod-"]');
  const allHidden=Array.from(modules).every(m=>m.style.display==='none');
  modules.forEach(m=>{
    m.style.display=allHidden?'grid':'none';
    const modId=m.id.replace('mod-','');
    const icon=document.getElementById('toggle-'+modId);
    if(icon)icon.textContent=allHidden?'‚ñº':'‚ñ∂';
  });
}

async function updateTaskStatus(id,status){
  try{
    const r=await fetch('/api/styly/tasks/'+id,{method:'PUT',headers:hdrs,body:JSON.stringify({status})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    tasks=tasks.map(t=>t.id===id?d.task:t);
    renderTareas(document.getElementById('modContent'));
    toast('Tarea actualizada');
  }catch(e){toast('Error: '+e.message)}
}

async function updateTaskAssigned(id,assigned_to){
  try{
    const r=await fetch('/api/styly/tasks/'+id,{method:'PUT',headers:hdrs,body:JSON.stringify({assigned_to:assigned_to||null})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    tasks=tasks.map(t=>t.id===id?d.task:t);
    renderTareas(document.getElementById('modContent'));
    toast('Asignaci√≥n actualizada');
  }catch(e){toast('Error: '+e.message)}
}

async function deleteTask(id){
  if(!confirm('¬øEliminar esta tarea?'))return;
  try{
    const r=await fetch('/api/styly/tasks/'+id,{method:'DELETE',headers:hdrs});
    if(!r.ok)throw new Error('Error al eliminar');
    tasks=tasks.filter(t=>t.id!==id);
    renderTareas(document.getElementById('modContent'));
    toast('Tarea eliminada');
  }catch(e){toast('Error: '+e.message)}
}

function openNewProjectModal(){
  showModal(`<div class="modal-title">‚ûï Nuevo Proyecto</div>
    <div class="modal-field"><label>Nombre</label><input type="text" id="newProjName" placeholder="Ej: Landing Page, Modulo Panel..."></div>
    <div class="modal-field"><label>Descripci√≥n (opcional)</label><textarea id="newProjDesc" rows="2" placeholder="Descripci√≥n del proyecto..."></textarea></div>
    <div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cancelar</button><button class="m-ok" onclick="saveNewProject()">‚ûï Crear Proyecto</button></div>`);
}

async function saveNewProject(){
  const name=document.getElementById('newProjName')?.value?.trim();
  const description=document.getElementById('newProjDesc')?.value?.trim();

  if(!name)return toast('Nombre requerido');

  try{
    const r=await fetch('/api/styly/projects',{method:'POST',headers:hdrs,body:JSON.stringify({name,description})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    projects.push(d.project);
    closeModal();
    renderTareas(document.getElementById('modContent'));
    toast('‚úÖ Proyecto creado');
  }catch(e){toast('Error: '+e.message)}
}

function openNewTaskModal(){
  showModal(`<div class="modal-title">‚ûï Nueva Tarea</div>
    <div class="modal-field"><label>Proyecto</label><select id="newTaskProj"><option value="">Sin asignar</option>${projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
    <div class="modal-field"><label>ID de Tarea</label><input type="text" id="newTaskId" placeholder="Ej: P-99"></div>
    <div class="modal-field"><label>Descripci√≥n</label><textarea id="newTaskDesc" rows="3" placeholder="Descripcion de la tarea..."></textarea></div>
    <div class="modal-field"><label>M√≥dulo</label><input type="text" id="newTaskModule" placeholder="Ej: Dashboard, Mensajes..."></div>
    <div class="modal-field"><label>Prioridad</label><select id="newTaskPrio"><option value="Media">Media</option><option value="Alta">Alta</option><option value="Baja">Baja</option></select></div>
    <div class="modal-field"><label>Asignado a</label><select id="newTaskUser"><option value="">Sin asignar</option>${users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('')}</select></div>
    <div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cancelar</button><button class="m-ok" onclick="saveNewTask()">‚ûï Crear Tarea</button></div>`);
}

async function saveNewTask(){
  const project_id=document.getElementById('newTaskProj')?.value||null;
  const id=document.getElementById('newTaskId')?.value?.trim();
  const description=document.getElementById('newTaskDesc')?.value?.trim();
  const module=document.getElementById('newTaskModule')?.value?.trim();
  const priority=document.getElementById('newTaskPrio')?.value;
  const assigned_to=document.getElementById('newTaskUser')?.value||null;

  if(!id||!description||!module)return toast('Completa los campos requeridos');

  try{
    const r=await fetch('/api/styly/tasks',{method:'POST',headers:hdrs,body:JSON.stringify({task_id:id,project_id:project_id?parseInt(project_id):null,description,module,priority,assigned_to})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    tasks.push(d.task);
    closeModal();
    renderTareas(document.getElementById('modContent'));
    toast('‚úÖ Tarea creada');
  }catch(e){toast('Error: '+e.message)}
}

renderTab();
</script>
</body>
</html>
