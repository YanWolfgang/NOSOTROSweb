<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Central ‚Äî STYLY</title>
<link rel="icon" type="image/png" href="/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/css/styles.css">
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
:root{--sy:#EC4899;--sy-bg:rgba(236,72,153,.06);--sy-border:rgba(236,72,153,.2);--sy-dark:#BE185D}
/* STYLY unified header bar */
.styly-header-bar{display:flex;align-items:center;gap:1.5rem;background:rgba(255,255,255,0.08);border-radius:16px;border:1px solid rgba(255,255,255,0.15);padding:24px;margin-bottom:1.5rem;-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);box-shadow:0 8px 32px 0 rgba(31,38,135,0.15)}
.styly-brand{display:flex;align-items:center;gap:.75rem;flex-shrink:0;border-right:1px solid var(--glass-border);padding-right:1.5rem;min-width:max-content}
.brand-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#EC4899,#BE185D);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem}
.brand-text{display:flex;flex-direction:column;gap:0}
.brand-text h1{margin:0;font-size:1.1rem;color:#fff;font-weight:700}
.brand-text p{margin:0;font-size:.7rem;color:var(--mt);font-weight:500}
.module-tabs{flex:1;display:grid;grid-template-columns:repeat(6,1fr);gap:.3rem}
.module-tab{display:inline-flex;align-items:center;gap:.35rem;padding:10px 20px;border-radius:12px;border:1px solid rgba(139,92,246,0.3);background:rgba(139,92,246,0.15);color:var(--fg);font-size:.8rem;font-weight:500;cursor:pointer;transition:all 0.3s ease;white-space:nowrap;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}
.module-tab i{font-size:.95rem;min-width:18px}
.module-tab:hover{background:rgba(139,92,246,0.3);border-color:rgba(139,92,246,0.5);color:var(--sy);box-shadow:0 4px 16px rgba(139,92,246,0.2)}
.module-tab.active{background:rgba(139,92,246,0.3);border-color:rgba(139,92,246,0.6);color:var(--sy);font-weight:600;box-shadow:0 8px 24px rgba(139,92,246,0.25)}
.tab-text{line-height:1.2;font-size:.78rem}
@media(max-width:1200px){
  .styly-header-bar{gap:1rem;padding:.65rem 1rem}
  .styly-brand{padding-right:1rem}
  .module-tab{padding:.4rem .65rem;font-size:.75rem}
}
@media(max-width:992px){
  .styly-header-bar{flex-wrap:wrap}
  .styly-brand{border-right:none;border-bottom:1px solid var(--glass-border);padding-right:0;padding-bottom:.75rem;width:100%;margin-bottom:.5rem}
  .module-tabs{width:100%;grid-template-columns:repeat(6,1fr)}
  .module-tab{padding:.4rem .6rem;font-size:.72rem}
}
@media(max-width:768px){
  .styly-header-bar{gap:.5rem;padding:.75rem;border-radius:0;margin-left:-.7rem;margin-right:-.7rem;width:calc(100% + 1.4rem);border-left:none;border-right:none}
  .styly-brand{border-right:none;border-bottom:1px solid var(--glass-border);padding-right:0;padding-bottom:.5rem;width:100%;margin-bottom:.5rem;justify-content:center}
  .brand-icon{width:36px;height:36px;font-size:1rem}
  .brand-text h1{font-size:.95rem}
  .brand-text p{font-size:.65rem}
  /* Tabs: horizontal scroll instead of grid */
  .module-tabs{width:100%;display:flex;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;gap:.4rem;padding-bottom:.4rem;grid-template-columns:unset}
  .module-tabs::-webkit-scrollbar{display:none}
  .module-tab{flex-shrink:0;justify-content:center;min-width:auto;padding:.6rem 1rem;font-size:.8rem;border-radius:10px;flex-direction:row;gap:.35rem}
  .module-tab i{font-size:1rem}
  .tab-text{display:inline;font-size:.8rem;line-height:1;white-space:nowrap}
}
.section-label{font-size:.78rem;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px;margin:1.25rem 0 .5rem;padding-bottom:.35rem;border-bottom:1px solid var(--glass-border)}
/* Format cards */
.sy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:.65rem;margin:.5rem 0}
.sy-fmt{background:var(--glass);border:2px solid var(--glass-border);border-radius:16px;padding:1rem .85rem;cursor:pointer;transition:all .3s ease;text-align:center;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.sy-fmt:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(236,72,153,.1)}
.sy-fmt.on{border-color:var(--sy);background:var(--sy-bg)}
.sy-fmt .ico{font-size:1.8rem;margin-bottom:.35rem}
.sy-fmt .nm{font-weight:700;font-size:.85rem;color:var(--fg);margin-bottom:.2rem}
.sy-fmt .ds{font-size:.72rem;color:var(--mt);line-height:1.3}
/* Topic area */
.sy-topic{margin:.75rem 0}
.sy-topic textarea{width:100%;min-height:80px;padding:.65rem;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.85rem;font-family:inherit;resize:vertical;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur);transition:all .3s ease}
.sy-topic textarea:focus{border-color:var(--sy);outline:none;box-shadow:0 0 0 3px rgba(236,72,153,.12)}
.sy-topic select{width:100%;padding:.5rem .75rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.85rem;margin-bottom:.5rem;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.sy-topic select:focus{border-color:var(--sy);outline:none;box-shadow:0 0 0 3px rgba(236,72,153,.12)}
/* Result */
.sy-result{background:var(--card);border:1px solid var(--glass-border);border-radius:16px;padding:1.25rem;margin:.75rem 0;position:relative;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur);box-shadow:var(--shadow-sm)}
.sy-sec{margin-bottom:.85rem;padding-bottom:.85rem;border-bottom:1px solid var(--glass-border);position:relative}
.sy-sec:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.sy-sec-title{font-size:.72rem;font-weight:700;color:var(--sy);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.35rem}
.sy-sec-body{font-size:.85rem;color:var(--fg);line-height:1.6;white-space:pre-wrap}
.sy-sec .cp-s{position:absolute;top:0;right:0;padding:3px 8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--glass);color:var(--mt);font-size:.68rem;cursor:pointer;transition:all .2s ease}
.sy-sec .cp-s:hover{border-color:var(--sy);color:var(--sy)}
/* Tools */
.sy-tools{display:flex;flex-wrap:wrap;gap:.4rem;margin:.65rem 0}
.sy-tool{padding:.4rem .75rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.78rem;cursor:pointer;transition:all .2s ease;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.sy-tool:hover{border-color:var(--sy);color:var(--sy);background:var(--sy-bg)}
/* Edit bar */
.sy-edit{border-top:1px solid var(--glass-border);padding-top:.65rem;margin-top:.65rem;display:flex;gap:.5rem}
.sy-edit input{flex:1;padding:.5rem .7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.82rem;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur);transition:all .3s ease}
.sy-edit input:focus{border-color:var(--sy);outline:none;box-shadow:0 0 0 3px rgba(236,72,153,.12)}
.sy-edit button{padding:.5rem .85rem;border-radius:10px;border:none;background:linear-gradient(135deg,var(--sy),#f472b6);color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;white-space:nowrap;box-shadow:0 4px 12px rgba(236,72,153,.25)}
/* Ideas */
.ideas-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem}
.ideas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:.65rem}
.idea-card{background:var(--card);border:1px solid var(--glass-border);border-radius:14px;padding:.85rem;transition:all .3s ease;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.idea-card.discarded{opacity:.3}.idea-card.used{opacity:.5}
.idea-bdg{display:inline-block;padding:3px 9px;border-radius:6px;font-size:.68rem;font-weight:700;margin-bottom:.35rem;margin-right:.25rem}
.idea-bdg.new{background:var(--sy-bg);color:var(--sy)}
.idea-bdg.used{background:rgba(107,114,128,.1);color:#6B7280}
.idea-bdg.discarded{background:rgba(107,114,128,.08);color:#9CA3AF}
.idea-bdg.clients{background:var(--sy-bg);color:var(--sy)}
.idea-bdg.affiliates{background:rgba(190,24,93,.08);color:var(--sy-dark)}
.idea-txt{font-size:.85rem;color:var(--fg);margin-bottom:.4rem;line-height:1.4}
.idea-tags{display:flex;gap:.3rem;flex-wrap:wrap;margin-bottom:.4rem}
.idea-tag{padding:3px 8px;border-radius:6px;font-size:.68rem;background:var(--sy-bg);color:var(--sy);font-weight:600}
.idea-acts{display:flex;gap:.3rem;flex-wrap:wrap}
.idea-btn{padding:.25rem .5rem;border-radius:8px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.7rem;cursor:pointer;transition:all .2s ease}
.idea-btn:hover{border-color:var(--sy);color:var(--sy)}
.idea-btn.danger:hover{border-color:#EF4444;color:#EF4444}
/* Tools tab cards */
.tool-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:.75rem;margin:.75rem 0}
.tool-card{background:var(--card);border:1px solid var(--glass-border);border-radius:16px;padding:1.25rem;cursor:pointer;transition:all .3s ease;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.tool-card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(236,72,153,.08)}
.tool-card.active{border-color:var(--sy);background:var(--sy-bg)}
.tool-card .t-ico{font-size:2rem;margin-bottom:.5rem}
.tool-card .t-nm{font-weight:700;font-size:1rem;color:var(--fg);margin-bottom:.2rem}
.tool-card .t-ds{font-size:.78rem;color:var(--mt)}
/* Calculator */
.calc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.75rem;margin:.75rem 0}
.calc-card{background:var(--card);border:1px solid var(--glass-border);border-radius:14px;padding:1rem;text-align:center;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.calc-card .c-ico{font-size:1.5rem}
.calc-card .c-lbl{font-size:.72rem;color:var(--mt);margin:.25rem 0}
.calc-card .c-val{font-size:1.4rem;font-weight:800;color:var(--sy)}
.calc-card .c-sub{font-size:.7rem;color:var(--mt);margin-top:.15rem}
.calc-card.gold{border-color:#F59E0B;background:rgba(245,158,11,.04)}
.calc-card.gold .c-val{color:#F59E0B}
.slider-row{margin:.65rem 0}
.slider-row label{display:flex;justify-content:space-between;font-size:.82rem;color:var(--fg);margin-bottom:.25rem}
.slider-row label span{font-weight:700;color:var(--sy)}
.slider-row input[type="range"]{width:100%;accent-color:var(--sy)}
/* Academy */
.acad-list{display:flex;flex-direction:column;gap:.65rem;margin:.75rem 0}
.acad-item{background:var(--card);border:1px solid var(--glass-border);border-radius:14px;padding:1rem;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.acad-num{display:inline-block;width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--sy),#f472b6);color:#fff;text-align:center;line-height:28px;font-size:.82rem;font-weight:700;margin-right:.5rem}
.acad-title{font-weight:700;color:var(--fg);font-size:.92rem}
.acad-dur{font-size:.72rem;color:var(--mt);margin-left:.35rem}
.acad-desc{font-size:.8rem;color:var(--mt);margin:.35rem 0;line-height:1.4}
.acad-btn{padding:.3rem .7rem;border-radius:8px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.75rem;cursor:pointer;transition:all .2s ease}
.acad-btn:hover{border-color:var(--sy);color:var(--sy)}
/* Calendar */
.cal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem}
.cal-nav{display:flex;align-items:center;gap:.65rem}
.cal-btn{padding:.35rem .7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.8rem;cursor:pointer;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur);transition:all .2s ease}
.cal-btn:hover{border-color:var(--sy);color:var(--sy)}
.cal-title{font-size:.92rem;font-weight:600;color:var(--fg)}
.cal-week{display:grid;grid-template-columns:repeat(7,1fr);gap:.4rem}
.cal-day{background:var(--card);border:1px solid var(--glass-border);border-radius:12px;padding:.65rem .4rem;min-height:110px;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.cal-day.today{border-color:var(--sy);background:var(--sy-bg)}
.cal-day-name{font-size:.68rem;font-weight:700;color:var(--mt);text-transform:uppercase;text-align:center}
.cal-day-num{font-size:1rem;font-weight:700;color:var(--fg);text-align:center;margin:.15rem 0}
.cal-item{padding:.25rem .4rem;border-radius:8px;background:var(--sy-bg);border:1px solid var(--sy-border);font-size:.68rem;color:var(--sy);margin-top:.3rem;cursor:pointer;transition:all .2s ease}
/* History */
.hist-filters{display:flex;gap:.4rem;margin-bottom:.75rem;flex-wrap:wrap}
.hist-filters select{padding:.4rem .7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.8rem;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.hist-item{background:var(--card);border:1px solid var(--glass-border);border-radius:14px;padding:.75rem .85rem;margin-bottom:.4rem;display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.hist-left{display:flex;align-items:center;gap:.4rem;flex:1;min-width:0}
.hist-emoji{font-size:1.1rem}
.hist-info{min-width:0}
.hist-title{font-size:.82rem;font-weight:600;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px}
.hist-meta{font-size:.7rem;color:var(--mt)}
.hist-right{display:flex;align-items:center;gap:.35rem;flex-shrink:0}
.hist-st{padding:3px 9px;border-radius:6px;font-size:.68rem;font-weight:700}
.hist-st.draft{background:rgba(107,114,128,.1);color:#6B7280}
.hist-st.approved{background:rgba(16,185,129,.1);color:#10B981}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:1rem}
.modal-box{background:var(--glass-strong);border:1px solid var(--glass-border);border-radius:20px;padding:1.5rem;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;-webkit-backdrop-filter:var(--blur-strong);backdrop-filter:var(--blur-strong);box-shadow:var(--shadow)}
.modal-title{font-size:1.05rem;font-weight:700;color:var(--fg);margin-bottom:.85rem}
.modal-field{margin-bottom:.65rem}
.modal-field label{display:block;font-size:.75rem;font-weight:600;color:var(--mt);margin-bottom:.2rem}
.modal-field input,.modal-field select,.modal-field textarea{width:100%;padding:.5rem .7rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.82rem;box-sizing:border-box;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.modal-actions{display:flex;justify-content:flex-end;gap:.4rem;margin-top:.85rem}
.modal-actions button{padding:.5rem 1rem;border-radius:10px;font-size:.82rem;font-weight:600;cursor:pointer;border:1px solid var(--glass-border);transition:all .2s ease}
.modal-actions .m-cancel{background:var(--glass);color:var(--fg)}
.modal-actions .m-ok{background:linear-gradient(135deg,var(--sy),#f472b6);color:#fff;border-color:transparent;box-shadow:0 4px 12px rgba(236,72,153,.25)}
/* Toast */
.toast{position:fixed;bottom:2rem;right:2rem;padding:.65rem 1.1rem;border-radius:12px;background:linear-gradient(135deg,#10B981,#34d399);color:#fff;font-size:.85rem;font-weight:600;z-index:2000;animation:tIn .3s ease;box-shadow:0 8px 24px rgba(16,185,129,.3)}
@keyframes tIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
/* Glass morphism buttons */
.glass-btn{background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4);color:var(--fg);padding:10px 20px;border-radius:12px;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);cursor:pointer;transition:all 0.3s ease;font-weight:600;font-size:.85rem}
.glass-btn:hover{background:rgba(139,92,246,0.3);border-color:rgba(139,92,246,0.6);box-shadow:0 4px 16px rgba(139,92,246,0.2)}
/* Glass morphism cards */
.glass-card{background:rgba(255,255,255,0.07);-webkit-backdrop-filter:blur(15px);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.12);border-radius:16px;padding:20px;box-shadow:0 8px 32px 0 rgba(31,38,135,0.1);transition:all 0.3s ease}
.glass-card:hover{background:rgba(255,255,255,0.1);box-shadow:0 12px 40px rgba(31,38,135,0.2)}
/* View switcher buttons */
.view-btn{padding:10px 16px;border-radius:10px;border:1px solid rgba(139,92,246,0.2);background:transparent;color:var(--fg);font-size:.8rem;font-weight:500;cursor:pointer;transition:all 0.3s ease;white-space:nowrap}
.view-btn:hover{background:rgba(139,92,246,0.15);border-color:rgba(139,92,246,0.4)}
.view-btn.active{background:rgba(139,92,246,0.3);border-color:rgba(139,92,246,0.6);color:var(--sy);font-weight:600;box-shadow:0 4px 16px rgba(139,92,246,0.2)}
@media(max-width:768px){
  .cal-week{grid-template-columns:1fr}.ideas-grid,.tool-cards,.calc-grid{grid-template-columns:1fr}
  .sy-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .sy-edit,.hist-item{flex-direction:column;align-items:stretch}
  .sy-tools{gap:.3rem}
  .sy-tool{padding:.3rem .6rem;font-size:.72rem}
}
/* ========== MOBILE NATIVE APP FEEL ========== */
@media(max-width:768px){
  /* View bar: stack vertically */
  .styly-view-bar{flex-direction:column !important;gap:.75rem !important}
  .styly-view-tabs{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .styly-view-tabs::-webkit-scrollbar{display:none}
  .styly-view-actions{width:100%;display:flex !important;flex-wrap:wrap;gap:.5rem}
  .styly-view-actions .glass-btn{flex:1;min-width:0;text-align:center;justify-content:center;min-height:44px;padding:.6rem .5rem;font-size:.78rem}
  .view-btn{padding:.6rem .75rem !important;font-size:.78rem !important;min-height:44px}
  /* Task list cards: single column */
  .task-card-grid{grid-template-columns:1fr !important}
  /* List filter bar */
  #filterPanel{gap:.5rem !important}
  #filterPanel select{min-width:0 !important;flex:1 1 100% !important;min-height:44px}
  /* Dashboard: responsive grids */
  .dash-kpi-grid{grid-template-columns:1fr 1fr !important;gap:.75rem !important}
  .dash-kpi-grid > div{padding:1rem !important}
  .dash-two-col{grid-template-columns:1fr !important;gap:1.25rem !important}
  .dash-priority-grid{grid-template-columns:1fr !important;gap:.75rem !important}
  /* Modals: bottom sheet style */
  .modal-overlay{padding:0 !important;align-items:flex-end !important}
  .modal-box{max-width:100% !important;max-height:92vh !important;border-radius:20px 20px 0 0 !important;width:100% !important;padding:1.25rem !important;animation:slideUp .3s ease !important}
  .modal-two-col{grid-template-columns:1fr !important}
  .modal-bottom-actions{flex-direction:column !important;gap:.75rem !important}
  .modal-bottom-actions button{width:100%;min-height:44px}
  .modal-bottom-actions > div{width:100%;display:flex;gap:.75rem}
  .modal-bottom-actions > div button{flex:1;min-height:44px}
  .modal-field input,.modal-field select,.modal-field textarea{min-height:44px !important;font-size:16px !important}
  .import-actions-grid{grid-template-columns:1fr !important}
  /* Project admin cards: stack */
  .project-admin-card{flex-direction:column !important;gap:.75rem !important;padding:1rem !important}
  .project-admin-card > div:last-child{width:100%;display:flex}
  .project-admin-card > div:last-child button{flex:1;min-height:44px}
  /* Toast: full width bottom */
  .toast{left:1rem !important;right:1rem !important;bottom:1rem !important;text-align:center}
  /* General touch targets */
  select,input[type="text"],input[type="email"],input[type="password"],input[type="date"],textarea{min-height:44px}
}
/* Extra small (iPhone SE) */
@media(max-width:480px){
  .dash-kpi-grid{grid-template-columns:1fr !important}
  .styly-view-actions .glass-btn{font-size:.72rem;padding:.5rem .4rem}
}
/* Fix 360px tabs conflict with styles.css */
@media(max-width:360px){
  .module-tabs{display:flex !important;overflow-x:auto !important;grid-template-columns:unset !important}
}
/* Bottom sheet animation */
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}

/* Tarjetas de tareas - Dise√±o compacto pero completo */
.board-card{min-height:auto!important;max-height:none!important;height:auto!important;padding:0.9rem!important;display:flex!important;flex-direction:column!important;gap:0.5rem!important;overflow:visible!important}
.board-card-header{display:flex!important;justify-content:space-between!important;align-items:flex-start!important;margin-bottom:0.3rem!important;gap:0.6rem!important;flex-wrap:wrap!important}
.board-card-project{font-size:0.7rem!important;color:#9CA3AF!important;flex:1!important;white-space:normal!important;min-width:0!important;font-weight:500!important}
.board-card-id{font-size:0.65rem!important;flex-shrink:0!important;white-space:nowrap!important;background:rgba(139,92,246,0.1)!important;padding:0.2rem 0.5rem!important;border-radius:3px!important;font-weight:600!important}
.board-card-title{font-size:0.9rem!important;font-weight:600!important;line-height:1.4!important;white-space:normal!important;word-wrap:break-word!important;overflow:visible!important;color:#F3F4F6!important;margin:0.3rem 0!important;min-width:0!important}
.board-card-notes{font-size:0.78rem!important;color:#D1D5DB!important;line-height:1.3!important;white-space:normal!important;word-wrap:break-word!important;margin:0.3rem 0!important;max-height:none!important;overflow:visible!important;font-style:italic!important;display:-webkit-box!important;-webkit-line-clamp:2!important;-webkit-box-orient:vertical!important}
.board-card-section{background:rgba(139,92,246,0.12)!important;padding:0.25rem 0.6rem!important;border-radius:4px!important;display:inline-block!important;color:#A5B4FC!important;font-size:0.7rem!important;white-space:normal!important;margin:0.3rem 0!important;font-weight:500!important}
.board-card-progress{height:0.35rem!important;margin:0.4rem 0!important;background:rgba(255,255,255,0.08)!important;border-radius:2px!important;overflow:hidden!important}
.board-card-progress-fill{background:linear-gradient(90deg,#8B5CF6,#EC4899)!important;height:100%!important}
.board-card-footer{display:flex!important;flex-direction:column!important;gap:0.5rem!important;font-size:0.78rem!important;margin-top:0.5rem!important;padding-top:0.5rem!important;border-top:1px solid rgba(255,255,255,0.08)!important;width:100%!important}
.board-card-assignee{display:flex!important;align-items:center!important;gap:0!important;font-size:0.78rem!important;white-space:normal!important;word-wrap:break-word!important;overflow:visible!important;color:#E5E7EB!important;flex-wrap:wrap!important}
.board-card-assignee .avatar{width:auto!important;height:auto!important;border-radius:0!important;display:inline!important;align-items:center!important;justify-content:center!important;font-size:0.78rem!important;color:#A5B4FC!important;flex-shrink:0!important;font-weight:600!important;background:transparent!important;padding:0!important;margin:0!important}
.board-card-assignee span{display:none!important}
.board-card-due{display:flex!important;align-items:center!important;gap:0.3rem!important;font-size:0.72rem!important;white-space:normal!important;padding:0.25rem 0.6rem!important;border-radius:4px!important;width:fit-content!important;font-weight:500!important}
.board-card-due.on-time{background:rgba(59,130,246,0.1)!important;color:#60A5FA!important}
.board-card-due.overdue{background:rgba(239,68,68,0.1)!important;color:#EF4444!important}
.board-card-tags{display:flex!important;flex-wrap:wrap!important;gap:0.4rem!important;margin-top:0.3rem!important;width:100%!important}
.board-card-tag{font-size:0.68rem!important;padding:0.25rem 0.5rem!important;border-radius:3px!important;white-space:normal!important;font-weight:500!important;display:inline-flex!important;align-items:center!important;gap:0.2rem!important}
</style>
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="content fade-in" id="content">
    <div class="styly-header-bar">
      <div class="styly-brand">
        <div class="brand-icon"><i class="fas fa-laptop"></i></div>
        <div class="brand-text">
          <h1>STYLY</h1>
          <p>Gesti√≥n para negocios de belleza</p>
        </div>
      </div>
      <nav class="module-tabs" id="modTabs" role="tablist" aria-label="Secciones de STYLY">
        <button class="module-tab active" onclick="setTab('generar')" role="tab" aria-selected="true" aria-label="Generar contenido">
          <i class="far fa-pen-to-square"></i>
          <span class="tab-text">Generar</span>
        </button>
        <button class="module-tab" onclick="setTab('ideas')" role="tab" aria-selected="false" aria-label="Ideas pendientes">
          <i class="far fa-lightbulb"></i>
          <span class="tab-text">Ideas</span>
        </button>
        <button class="module-tab" onclick="setTab('calendario')" role="tab" aria-selected="false" aria-label="Calendario">
          <i class="far fa-calendar"></i>
          <span class="tab-text">Calendario</span>
        </button>
        <button class="module-tab" onclick="setTab('historial')" role="tab" aria-selected="false" aria-label="Historial">
          <i class="far fa-clock"></i>
          <span class="tab-text">Historial</span>
        </button>
        <button class="module-tab" onclick="setTab('tareas')" role="tab" aria-selected="false" aria-label="Tareas">
          <i class="far fa-check-square"></i>
          <span class="tab-text">Tareas</span>
        </button>
      </nav>
    </div>
    <div id="modContent"></div>
  </main>
</div>
<div id="modalRoot"></div>
<div id="toastRoot"></div>
<script>
// ========== AUTH ==========
const token=localStorage.getItem('token');
if(!token){window.location.href='/index.html';}
const user=JSON.parse(localStorage.getItem('user')||'{}');
const hdrs={'Content-Type':'application/json','Authorization':'Bearer '+token,'x-business':'styly'};

// ========== SIDEBAR ==========
const BUSINESSES=[
  {id:'nosotros',name:'NOSOTROS',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',url:'/nosotros.html'},
  {id:'duelazo',name:'DUELAZO',icon:'<i class="feather" data-icon="activity" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#10B981',url:'/duelazo.html'},
  {id:'spacebox',name:'SPACEBOX',icon:'<i class="feather" data-icon="package" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#3B82F6',url:'/spacebox.html'},
  {id:'styly',name:'STYLY',icon:'<i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#EC4899',url:'/styly.html'}
];
function renderSidebar(){
  const bs=user.businesses||[];const isAdmin=user.role==='admin';
  const items=BUSINESSES.filter(b=>isAdmin||bs.includes(b.id));
  document.getElementById('sidebar').innerHTML=`
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-header"><h2>Panel <span>Central</span></h2></div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/dashboard.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Dashboard</a></div>`:
    `<div class="sidebar-section"><div class="sidebar-label">General</div><a href="/profile.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="user" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Panel Individual</a></div>`}
    <div class="sidebar-section"><div class="sidebar-label">Negocios</div>
      ${items.map(b=>`<a href="${b.url}" class="sidebar-item ${b.id==='styly'?'active':''}" style="--accent:${b.color}"><span class="icon">${b.icon}</span>${b.name}</a>`).join('')}
    </div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">Admin</div><a href="/admin.html" class="sidebar-item"><span class="icon"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Usuarios</a></div>`:''}
    <div class="sidebar-footer">
      <div class="sidebar-avatar">${(user.name||'U')[0].toUpperCase()}</div>
      <div class="sidebar-user"><div class="name">${user.name||'Usuario'}</div><div class="role">${user.role||'editor'}</div></div>
      <button class="theme-btn" onclick="toggleTheme()"><i class="feather" data-icon="moon" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
      <button class="theme-btn" onclick="logout()" style="font-size:.75rem"><i class="feather" data-icon="share-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
    </div>`;
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
function toggleTheme(){const t=document.documentElement.getAttribute('data-theme')==='light'?'':'light';document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t)}
function logout(){localStorage.clear();window.location.href='/index.html'}
if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light');
renderSidebar();

// ========== CONFIG ==========
// ===== NUEVAS CATEGOR√çAS (reemplaza CLIENT_FMTS y AFF_FMTS) =====
const CLIENT_CATEGORIES=[
  {id:'caso_exito',name:'Casos de √âxito',icon:'‚≠ê',desc:'Historias transformadoras'},
  {id:'post_feature',name:'Post de Features',icon:'üì£',desc:'Funcionalidades de STYLY'},
  {id:'post_inspiracional',name:'Post Inspiracional',icon:'üí°',desc:'Motivaci√≥n + datos'},
  {id:'comercial_styly',name:'Comercial para STYLY',icon:'üéØ',desc:'Venta directa + CTA'}
];
const AFFILIATE_CATEGORIES=[
  {id:'reclutamiento',name:'Reclutamiento',icon:'üí∞',desc:'Unirse al programa'},
  {id:'exito_afiliadas',name:'√âxito de Afiliadas',icon:'üèÜ',desc:'Historias de ganancias'},
  {id:'capacitacion',name:'Capacitaci√≥n',icon:'üìö',desc:'Tips para vender STYLY'}
];

// ===== FORMATOS DE PUBLICACI√ìN (nuevo nivel intermedio) =====
const PUBLICATION_FORMATS=[
  {id:'reel',name:'Gui√≥n para Reel',icon:'üé¨',desc:'Video corto con hook + desarrollo'},
  {id:'estatico',name:'Publicaci√≥n Est√°tica',icon:'üì±',desc:'Post simple con imagen'},
  {id:'carrusel',name:'Carrusel de 4 Slides',icon:'üé¥',desc:'Secuencia de 4 im√°genes'}
];

// Mantener TODAS_CATEGOR√çAS para b√∫squeda/filtrado
const ALL_CATEGORIES=[...CLIENT_CATEGORIES,...AFFILIATE_CATEGORIES];

// Mantener compatibilidad - crear ALL_FMTS como combinaci√≥n de categor√≠as
const CLIENT_FMTS=CLIENT_CATEGORIES;
const AFF_FMTS=AFFILIATE_CATEGORIES;
const ALL_FMTS=[...CLIENT_CATEGORIES,...AFFILIATE_CATEGORIES];
const FMT_EMOJI={};ALL_CATEGORIES.forEach(f=>{FMT_EMOJI[f.id]=f.icon});
const INDUSTRIES=['Estetica/Salon','Barberia','Spa/Bienestar','Nail salon','Tatuador/Piercing','Psicologo/Terapeuta','Dentista/Consultorio','Nutriologo','Entrenador personal/Gym','Yoga/Pilates','General/Otro'];
const FEATURES=['Agenda digital (adios libreta)','Website de reservas (tu-negocio.styly.mx)','CRM (historial de clientes)','Cobro de suscripciones (membresias 0% comision)','WhatsApp masivo (promos 1 click)','Cerebro IA (predicciones, precios)','Multi-sucursal (todos tus locales)','Metricas (empleados, nominas, reportes)'];
// ========== STATE ==========
let tab='generar';
let G={category:null,format:null,aud:null,industry:'',feature:'',topic:'',phase:'category',result:'',resultId:null};
let calWeekStart=getMonday(new Date());
let histFilter={format:'',audience:'',status:''};
let ideasMultiSelectMode=false;
let selectedIdeas=[];

// ========== HELPERS ==========
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function md(t){return esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/^### (.+)$/gm,'<h4>$1</h4>').replace(/^## (.+)$/gm,'<h3>$1</h3>').replace(/^# (.+)$/gm,'<h2>$1</h2>').replace(/^---$/gm,'<hr>').replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>')}
function today(){return new Date().toISOString().slice(0,10)}
function getMonday(d){const dt=new Date(d);const day=dt.getDay();dt.setDate(dt.getDate()-day+(day===0?-6:1));dt.setHours(0,0,0,0);return dt}
function addDays(d,n){const dt=new Date(d);dt.setDate(dt.getDate()+n);return dt}
function fmtDate(d){return d.toISOString().slice(0,10)}
function fmtDateEs(d){return d.toLocaleDateString('es-MX',{day:'numeric',month:'long'})}
function fmtDT(s){if(!s)return'';try{return new Date(s).toLocaleString('es-MX',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}catch{return s}}
function toast(msg){const el=document.createElement('div');el.className='toast';el.textContent=msg;document.getElementById('toastRoot').appendChild(el);setTimeout(()=>el.remove(),3000)}
function pJ(t){const i=t.indexOf('{'),j=t.lastIndexOf('}');if(i===-1||j<=i)return null;try{return JSON.parse(t.substring(i,j+1))}catch{return null}}
function parseSections(text){
  const lines=text.split('\n'),sections=[];let cur=null;
  for(const line of lines){
    const eh=line.match(/^([\u{1F300}-\u{1FAFF}\u{2600}-\u{26FF}][\uFE0F]?\s*.+?):\s*$/u);
    const sh=line.match(/^(?:#{1,3}\s+)?(.+?):\s*$/);
    const uc=line.trim()===line.trim().toUpperCase()&&line.trim().length>3&&line.trim().length<80;
    if(uc&&!line.startsWith(' ')){if(cur)sections.push(cur);cur={title:line.replace(/^#+\s*/,'').replace(/:$/,'').trim(),body:''};}
    else if(eh){if(cur)sections.push(cur);cur={title:eh[1].trim(),body:''};}
    else if(sh&&!line.startsWith(' ')&&line.trim().length<80){if(cur)sections.push(cur);cur={title:sh[1].trim(),body:''};}
    else{if(!cur)cur={title:'Contenido',body:''};cur.body+=(cur.body?'\n':'')+line;}
  }
  if(cur)sections.push(cur);
  return sections.filter(s=>s.body.trim()).map(s=>({title:s.title,body:s.body.trim()}));
}
function fmt$(n){return'$'+Number(n).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2})}

// ========== TABS ==========
function setTab(t){
  tab=t;
  document.querySelectorAll('.module-tab').forEach(b=>{
    const text=b.querySelector('.tab-text')?.textContent.trim().toLowerCase()||'';
    const isActive=text===t;
    b.classList.toggle('active',isActive);
    b.setAttribute('aria-selected',isActive?'true':'false');
  });
  renderTab();
}
function renderTab(){
  const m=document.getElementById('modContent');m.className='fade-in';void m.offsetWidth;
  if(tab==='generar')renderGenerar(m);
  else if(tab==='ideas')renderIdeas(m);
  else if(tab==='calendario')renderCalendario(m);
  else if(tab==='historial')renderHistorial(m);
  else if(tab==='tareas')renderTareas(m);
}

// ================================================================
// TAB 1: GENERAR
// ================================================================
function renderGenerar(m){
  if(G.phase==='category')m.innerHTML=rCategoryPick();
  else if(G.phase==='format')m.innerHTML=rFormatPick();
  else if(G.phase==='topic')m.innerHTML=rTopicInput();
  else if(G.phase==='loading')m.innerHTML=`<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div><div class="loader-text">Generando contenido para Styly...</div></div>`;
  else if(G.phase==='result')m.innerHTML=rGenResult();
}
function rCategoryPick(){
  return`<div class="section-label">PARA CLIENTES (60%)</div>
    <div class="sy-grid">${CLIENT_CATEGORIES.map(c=>`<div class="sy-fmt ${G.category===c.id?'on':''}" onclick="pickCategory('${c.id}','clients')"><div class="ico">${c.icon}</div><div class="nm">${c.name}</div><div class="ds">${c.desc}</div></div>`).join('')}</div>
    <div class="section-label">AFILIADAS ELITE (40%)</div>
    <div class="sy-grid">${AFFILIATE_CATEGORIES.map(c=>`<div class="sy-fmt ${G.category===c.id?'on':''}" onclick="pickCategory('${c.id}','affiliates')"><div class="ico">${c.icon}</div><div class="nm">${c.name}</div><div class="ds">${c.desc}</div></div>`).join('')}</div>`;
}

function rFormatPick(){
  const cat=ALL_CATEGORIES.find(c=>c.id===G.category);
  return`<div class="flow-header"><button class="btn-back" onclick="G.category=null;G.phase='category';renderTab()">‚Üê Volver</button><div class="flow-title"><span>${cat.icon}</span> ${cat.name}</div></div>
    <div class="section-label" style="margin-top:1rem">ELIGE FORMATO DE PUBLICACI√ìN</div>
    <div class="sy-grid">${PUBLICATION_FORMATS.map(f=>`<div class="sy-fmt ${G.format===f.id?'on':''}" onclick="pickFormat('${f.id}')"><div class="ico">${f.icon}</div><div class="nm">${f.name}</div><div class="ds">${f.desc}</div></div>`).join('')}</div>
    ${G.format?`<div class="actions" style="margin-top:.75rem"><button class="btn" onclick="G.phase='topic';renderTab()">Siguiente ‚Üí</button></div>`:''}`;
}
function rTopicInput(){
  const cat=ALL_CATEGORIES.find(c=>c.id===G.category);
  const isClient=G.aud==='clients';
  const placeholders={
    caso_exito:'Describe el negocio: tipo, problema, resultados...',
    post_feature:'Contexto adicional (opcional)...',
    post_inspiracional:'Dato o tema (opcional)...',
    comercial_styly:'Enfoque del anuncio, p√∫blico objetivo...',
    reclutamiento:'Enfoque. Ej: mamas emprendedoras, ingreso extra, libertad...',
    exito_afiliadas:'Detalle de la historia (opcional)...',
    capacitacion:'Tema. Ej: pitch, objeciones, seguimiento...'
  };
  return`<div class="flow-header"><button class="btn-back" onclick="G.category=null;G.format=null;G.phase='format';renderTab()">‚Üê Volver</button><div class="flow-title"><span>${cat.icon}</span> ${cat.name}</div></div>
    <div class="sy-topic">
      ${isClient?`<select id="indSel" onchange="G.industry=this.value"><option value="">Selecciona industria...</option>${INDUSTRIES.map(i=>`<option value="${i}" ${G.industry===i?'selected':''}>${i}</option>`).join('')}</select>`:''}
      ${G.category==='post_feature'?`<select id="featSel" onchange="G.feature=this.value"><option value="">Selecciona feature...</option>${FEATURES.map(f=>`<option value="${f}" ${G.feature===f?'selected':''}>${f}</option>`).join('')}</select>`:''}
      <textarea id="topicTa" placeholder="${placeholders[G.category]||'Describe el tema...'}" oninput="G.topic=this.value">${esc(G.topic)}</textarea>
    </div>
    <div class="actions"><button class="btn" onclick="doGenerate()">Generar contenido ‚Üí</button></div>`;
}
function rGenResult(){
  const cat=ALL_CATEGORIES.find(c=>c.id===G.category);
  const secs=parseSections(G.result);
  return`<div class="flow-header"><button class="btn-back" onclick="resetGen()">‚Üê Nuevo contenido</button><div class="flow-title"><span>${cat?.icon||'üìù'}</span> ${cat?.name||G.category||'Contenido'} <span class="idea-bdg ${G.aud}" style="font-size:.7rem;margin-left:.5rem">${G.aud==='clients'?'CLIENTES':'AFILIADAS'}</span></div></div>
    <div class="sy-result">${secs.map((s,i)=>`<div class="sy-sec"><button class="cp-s" onclick="cpSec(${i})"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button><div class="sy-sec-title">${esc(s.title)}</div><div class="sy-sec-body" id="sec${i}">${md(s.body)}</div></div>`).join('')}</div>
    <div class="sy-tools">
      <button class="sy-tool" onclick="aiAction('Revisa el contenido. Corrige errores, mejora claridad, asegurate de que CTA y beneficios esten presentes.')"><i class="feather" data-icon="clipboard" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Revisar con IA</button>
      <button class="sy-tool" onclick="aiAction('Adapta para 3 plataformas: 1. Instagram Feed (500 chars + hashtags) 2. TikTok (corto + hashtags) 3. LinkedIn (profesional). Manten el mensaje central.')"><i class="feather" data-icon="refresh-cw" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Multi-formato</button>
      <button class="sy-tool" onclick="aiAction('Genera 2 variantes A/B. Variante A: tono profesional. Variante B: tono cercano/casual. Ambas con CTA.')">üîÄ Variantes A/B</button>
      <button class="sy-tool" onclick="approveAndSchedule()"><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Aprobar y Agendar</button>
      <button class="sy-tool" onclick="doGenerate()">üîÉ Regenerar</button>
    </div>
    <div class="sy-edit"><input id="editIn" placeholder="Ej: Hazlo mas corto, enfocalo a barberias, tono mas urgente, cambia CTA..."><button onclick="doRegenEdit()"><i class="feather" data-icon="refresh-cw" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Regenerar con cambios</button></div>`;
}

function pickCategory(categoryId,audience){
  G.category=categoryId;
  G.aud=audience;
  G.phase='format';
  renderTab();
}

function pickFormat(formatId){
  G.format=formatId;
  G.phase='topic';
  renderTab();
}

function approveAndSchedule(){
  if(!G.resultId){toast('Error: no hay contenido para aprobar');return}
  openApproveModal();
}

function resetGen(){
  G={category:null,format:null,aud:null,industry:'',feature:'',topic:'',phase:'category',result:'',resultId:null};
  renderTab();
}

async function doGenerate(){
  G.phase='loading';renderTab();
  const topicFull=G.category==='post_feature'&&G.feature?`Feature: ${G.feature}. ${G.topic}`:G.topic;
  try{
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({category:G.category,format:G.format,audience:G.aud,topic:topicFull||undefined,industry:G.industry||undefined,feature:G.feature||undefined})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    G.result=d.content;G.resultId=d.id;G.phase='result';renderTab();
  }catch(e){console.error('Error en doGenerate:',e);toast('Error: '+e.message + ' - Reintentando en 2s...');setTimeout(()=>doGenerate(),2000)}
}
async function doRegenEdit(){
  const txt=document.getElementById('editIn')?.value?.trim();if(!txt)return;
  G.phase='loading';renderTab();
  try{
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({category:G.category,format:G.format,audience:G.aud,previousContent:G.result,editInstructions:txt})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    G.result=d.content;G.resultId=d.id;G.phase='result';toast('Regenerado con cambios');
  }catch(e){G.phase='result';toast('Error: '+e.message)}
  renderTab();
}
async function aiAction(instr){
  G.phase='loading';renderTab();
  try{
    const r=await fetch('/api/styly/generate',{method:'POST',headers:hdrs,body:JSON.stringify({category:G.category,format:G.format,audience:G.aud,previousContent:G.result,editInstructions:instr})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    G.result=d.content;G.resultId=d.id;G.phase='result';toast('Listo');
  }catch(e){G.phase='result';toast('Error: '+e.message)}
  renderTab();
}
function cpSec(i){const el=document.getElementById('sec'+i);if(!el)return;cpClip(el.textContent||el.innerText);el.closest('.sy-sec').querySelector('.cp-s').textContent='<i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>';setTimeout(()=>{const b=document.querySelector(`#sec${i}`)?.closest('.sy-sec')?.querySelector('.cp-s');if(b)b.textContent='<i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'},1500)}

// ================================================================
// TAB 2: IDEAS
// ================================================================
async function renderIdeas(m){
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/styly/ideas',{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    const ideas=d.ideas||[];
    m.innerHTML=`<div class="ideas-hdr">
      <div><h3 style="color:var(--fg);margin:0">üí° Ideas Semanales</h3><span style="font-size:.75rem;color:var(--mt)">Balance: 60% clientes ¬∑ 40% afiliadas</span></div>
      <div style="display:flex;gap:.5rem;align-items:center">
        ${!ideasMultiSelectMode?`
          <button class="btn" onclick="genIdeas()"><i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Generar ideas</button>
          ${ideas.length?`<button class="btn" style="background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.3)" onclick="enableMultiSelect()"><i class="feather" data-icon="trash-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Eliminar</button>`:''}
        `:`
          <span style="color:var(--fg);font-size:.9rem">${selectedIdeas.length} seleccionadas</span>
          <button class="btn" style="background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.3)" onclick="deleteMultipleIdeas()" ${selectedIdeas.length===0?'disabled':''}><i class="feather" data-icon="trash-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Confirmar eliminaci√≥n</button>
          <button class="btn" onclick="cancelMultiSelect()"><i class="feather" data-icon="x" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Cancelar</button>
        `}
      </div>
    </div>
      ${ideas.length?`<div class="ideas-grid">${ideas.map(renderIdeaCard).join('')}</div>`:'<p style="color:var(--mt);text-align:center;padding:2rem">No hay ideas. Genera las primeras 4.</p>'}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
function renderIdeaCard(idea){
  const s=idea.status,aud=idea.season_relevance||'clients';
  const fObj=ALL_CATEGORIES.find(f=>f.id===idea.format);
  const isSelected=selectedIdeas.includes(idea.id);

  // Mapeo de IDs de categor√≠a a nombres legibles
  const categoryMap={
    'caso_exito':'Caso de √âxito',
    'post_feature':'Post Feature',
    'post_inspiracional':'Inspiracional',
    'comercial_styly':'Comercial',
    'reclutamiento':'Reclutamiento',
    'exito_afiliadas':'√âxito de Afiliadas',
    'capacitacion':'Capacitaci√≥n'
  };
  const categoryName=categoryMap[idea.format]||idea.format;

  return`<div class="idea-card ${s} ${ideasMultiSelectMode?'selectable':''} ${isSelected?'selected':''}" ${ideasMultiSelectMode?`onclick="toggleIdeaSelection(${idea.id})"`:''}style="${ideasMultiSelectMode?'cursor:pointer':''} ${isSelected?'border-color:rgba(139,92,246,0.5);background:rgba(139,92,246,0.1)':''}position:relative">
    <button class="idea-btn danger" onclick="event.stopPropagation();deleteIdea(${idea.id})" style="position:absolute;top:.25rem;right:.25rem;padding:.12rem .2rem;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);border-radius:3px;cursor:pointer;font-size:.7rem;line-height:1;color:rgba(239,68,68,0.9);font-weight:bold;min-width:auto" title="Eliminar idea">‚úï</button>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem">
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding-right:2rem">
        ${ideasMultiSelectMode?`<input type="checkbox" ${isSelected?'checked':''} onclick="event.stopPropagation();toggleIdeaSelection(${idea.id})" style="width:1.2rem;height:1.2rem;cursor:pointer">`:''}
        <span class="idea-bdg ${s==='new'?'new':s==='used'?'used':'discarded'}">${s==='new'?'NUEVA':s==='used'?'USADA':'DESCARTADA'}</span>
        <span class="idea-bdg ${aud==='affiliates'?'affiliates':'clients'}">${aud==='affiliates'?'AFILIADAS':'CLIENTES'}</span>
      </div>
    </div>
    <div style="font-size:.75rem;color:rgba(139,92,246,0.7);font-weight:600;margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.5px">${categoryName}</div>
    <div class="idea-txt">${esc(idea.idea_text)}</div>
    <div class="idea-tags"><span class="idea-tag">${fObj?.icon||'<i class="feather" data-icon="clipboard" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'} ${fObj?.name||idea.format}</span></div>
    ${s==='new'&&!ideasMultiSelectMode?`<div class="idea-acts">
      <button class="idea-btn" onclick="showFormatSelectModal(${idea.id},'${idea.format}','${aud}',\`${esc(idea.idea_text).replace(/`/g,'')}\`)"><i class="feather" data-icon="edit-3" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Generar</button>
      <button class="idea-btn danger" onclick="discardIdea(${idea.id})"><i class="feather" data-icon="x-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Descartar</button>
    </div>`:''}
  </div>`;
}
async function genIdeas(){
  const m=document.getElementById('modContent');
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div><div class="loader-text">Generando 4 ideas semanales...</div></div>';
  try{
    const r=await fetch('/api/styly/ideas/generate',{method:'POST',headers:hdrs,body:'{}'});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    if(!d.ideas||d.ideas.length===0)throw new Error('No se generaron ideas');
    toast('‚úì 4 ideas generadas');
    renderIdeas(m);
  }catch(e){
    console.error('Error genIdeas:',e);
    toast('Error: '+e.message);
    renderIdeas(m);
  }
}
function showFormatSelectModal(ideaId,category,aud,text){
  const modal=document.getElementById('modalRoot');
  modal.innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal glass-card" style="max-width:500px">
      <div class="modal-header">
        <h3 style="margin:0;color:var(--fg)">Selecciona formato para generar</h3>
        <button class="modal-close" onclick="closeModal()"><i class="feather" data-icon="x" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
      </div>
      <div class="modal-body">
        <p style="color:var(--mt);margin-bottom:1rem">Elige el formato en que deseas generar este contenido:</p>
        <div style="display:flex;flex-direction:column;gap:.75rem">
          ${PUBLICATION_FORMATS.map(f=>`
            <button onclick="useIdeaWithFormat(${ideaId},'${category}','${aud}',\`${text}\`,'${f.id}')" style="text-align:left;padding:1rem;border:1px solid rgba(255,255,255,0.12);border-radius:8px;background:rgba(255,255,255,0.05);cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(139,92,246,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
              <div style="display:flex;align-items:center;gap:1rem">
                <div style="font-size:2rem">${f.icon}</div>
                <div>
                  <div style="font-weight:600;color:var(--fg);margin-bottom:.25rem">${f.name}</div>
                  <div style="font-size:.8rem;color:var(--mt)">${f.desc}</div>
                </div>
              </div>
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  </div>`;
  modal.style.display='flex';
}
function useIdeaWithFormat(ideaId,category,aud,text,format){
  closeModal();
  G.category=category;G.format=format;G.aud=aud==='affiliates'?'affiliates':'clients';G.topic=text;G.phase='loading';G.result='';G.resultId=null;
  fetch('/api/styly/ideas/'+ideaId,{method:'PUT',headers:hdrs,body:JSON.stringify({status:'used'})}).catch(e=>console.error('Error marking idea as used:',e));
  setTab('generar');
  setTimeout(()=>doGenerate(),150);
}
function useIdea(id,format,aud,text){
  G.fmt=format;G.aud=aud==='affiliates'?'affiliates':'clients';G.topic=text;G.phase='topic';G.result='';G.resultId=null;
  fetch('/api/styly/ideas/'+id,{method:'PUT',headers:hdrs,body:JSON.stringify({status:'used'})});
  setTab('generar');
}
async function discardIdea(id){
  await fetch('/api/styly/ideas/'+id,{method:'PUT',headers:hdrs,body:JSON.stringify({status:'discarded'})});
  toast('Descartada');renderIdeas(document.getElementById('modContent'));
}
async function deleteIdea(id){
  if(!confirm('¬øEliminar esta idea permanentemente?'))return;
  try{
    await fetch('/api/styly/ideas/'+id,{method:'DELETE',headers:hdrs});
    toast('Idea eliminada');
    renderIdeas(document.getElementById('modContent'));
  }catch(e){
    toast('Error: '+e.message);
  }
}
function enableMultiSelect(){
  ideasMultiSelectMode=true;
  selectedIdeas=[];
  renderIdeas(document.getElementById('modContent'));
}
function cancelMultiSelect(){
  ideasMultiSelectMode=false;
  selectedIdeas=[];
  renderIdeas(document.getElementById('modContent'));
}
function toggleIdeaSelection(id){
  if(selectedIdeas.includes(id)){
    selectedIdeas=selectedIdeas.filter(i=>i!==id);
  }else{
    selectedIdeas.push(id);
  }
  renderIdeas(document.getElementById('modContent'));
}
async function deleteMultipleIdeas(){
  if(selectedIdeas.length===0){
    toast('Selecciona al menos una idea');
    return;
  }
  if(!confirm(`¬øEliminar ${selectedIdeas.length} idea(s) permanentemente?`))return;
  console.log('Eliminando ideas:', selectedIdeas);
  try{
    const promises=selectedIdeas.map(async id=>{
      console.log('DELETE request para idea:', id);
      const res=await fetch('/api/styly/ideas/'+id,{method:'DELETE',headers:hdrs});
      const data=await res.json();
      console.log('Response para idea', id, ':', res.status, data);
      if(!res.ok)throw new Error(data.error||'Error al eliminar');
      return data;
    });
    const results=await Promise.all(promises);
    console.log('Todas eliminadas:', results);
    toast(`${selectedIdeas.length} ideas eliminadas`);
    ideasMultiSelectMode=false;
    selectedIdeas=[];
    renderIdeas(document.getElementById('modContent'));
  }catch(e){
    console.error('Error eliminando:', e);
    toast('Error: '+e.message);
    renderIdeas(document.getElementById('modContent'));
  }
}

// ================================================================
// TAB 4: CALENDARIO
// ================================================================
async function renderCalendario(m){
  const start=fmtDate(calWeekStart),end=fmtDate(addDays(calWeekStart,6));
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch(`/api/styly/calendar?start=${start}&end=${end}`,{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    const items=d.items||[];const todayStr=today();
    const days=[],dn=['Lun','Mar','Mie','Jue','Vie','Sab','Dom'];
    for(let i=0;i<7;i++){const dt=addDays(calWeekStart,i);const ds=fmtDate(dt);days.push({name:dn[i],num:dt.getDate(),date:ds,isToday:ds===todayStr,items:items.filter(it=>(it.scheduled_date||'').slice(0,10)===ds)})}
    m.innerHTML=`<div class="cal-hdr"><div class="cal-nav"><button class="cal-btn" onclick="calWeekStart=addDays(calWeekStart,-7);renderCalendario(document.getElementById('modContent'))">‚Üê</button><span class="cal-title">Semana del ${fmtDateEs(calWeekStart)} al ${fmtDateEs(addDays(calWeekStart,6))}</span><button class="cal-btn" onclick="calWeekStart=addDays(calWeekStart,7);renderCalendario(document.getElementById('modContent'))">‚Üí</button></div></div>
      <div class="cal-week">${days.map(day=>`<div class="cal-day ${day.isToday?'today':''}"><div class="cal-day-name">${day.name}</div><div class="cal-day-num">${day.num}</div>${day.items.map(it=>{const inp=typeof it.input_data==='string'?JSON.parse(it.input_data||'{}'):it.input_data||{};const aud=inp.audience;return`<div class="cal-item" onclick="viewCalItem(${it.id})">${FMT_EMOJI[it.format_type]||'<i class="feather" data-icon="clipboard" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'} ${esc((it.preview||'').slice(0,25))}${aud?'<br><span style=\"font-size:.6rem\">'+(aud==='affiliates'?'AFILIADAS':'CLIENTES')+'</span>':''}</div>`}).join('')}</div>`).join('')}</div>
      ${items.length===0?'<p style="color:var(--mt);text-align:center;padding:1.5rem">No hay contenido agendado esta semana.</p>':''}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
async function viewCalItem(id){
  try{
    const r=await fetch('/api/styly/history/'+id,{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    showModal(`<div class="modal-title">${FMT_EMOJI[d.item.format_type]||'<i class="feather" data-icon="clipboard" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'} ${esc(d.item.format_type)} ‚Äî ${fmtDT(d.item.scheduled_date)}</div><div style="max-height:50vh;overflow-y:auto;margin-bottom:.75rem"><div class="sy-sec-body">${md(d.item.output_text)}</div></div><div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cerrar</button><button class="m-ok" onclick="cpClip(\`${esc(d.item.output_text).replace(/`/g,"'")}\`);toast('Copiado')"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button></div>`);
  }catch(e){toast('Error: '+e.message)}
}

// ================================================================
// TAB 5: HISTORIAL
// ================================================================
let histSel=new Set();
async function renderHistorial(m){
  histSel.clear();
  m.innerHTML='<div class="loader"><div class="loader-dots"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/styly/history',{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    let allItems=d.history||[];
    let items=[...allItems];
    if(histFilter.format)items=items.filter(i=>i.format_type===histFilter.format);
    if(histFilter.audience)items=items.filter(i=>{const inp=typeof i.input_data==='string'?JSON.parse(i.input_data||'{}'):i.input_data||{};return inp.audience===histFilter.audience});
    if(histFilter.status)items=items.filter(i=>i.status===histFilter.status);
    const visibleIds=items.map(i=>i.id);
    m.innerHTML=`<div class="hist-filters">
      <select onchange="histFilter.format=this.value;renderHistorial(document.getElementById('modContent'))"><option value="">Todos los formatos</option>${ALL_FMTS.map(f=>`<option value="${f.id}" ${histFilter.format===f.id?'selected':''}>${f.name}</option>`).join('')}<option value="script_pitch" ${histFilter.format==='script_pitch'?'selected':''}>Script Pitch</option><option value="script_objections" ${histFilter.format==='script_objections'?'selected':''}>Script Objeciones</option><option value="script_whatsapp" ${histFilter.format==='script_whatsapp'?'selected':''}>Script WhatsApp</option><option value="script_email" ${histFilter.format==='script_email'?'selected':''}>Script Email</option></select>
      <select onchange="histFilter.audience=this.value;renderHistorial(document.getElementById('modContent'))"><option value="">Todas las audiencias</option><option value="clients" ${histFilter.audience==='clients'?'selected':''}>Clientes</option><option value="affiliates" ${histFilter.audience==='affiliates'?'selected':''}>Afiliadas</option></select>
      <select onchange="histFilter.status=this.value;renderHistorial(document.getElementById('modContent'))"><option value="">Todos los status</option><option value="draft" ${histFilter.status==='draft'?'selected':''}>Draft</option><option value="approved" ${histFilter.status==='approved'?'selected':''}>Approved</option></select>
    </div>
    ${items.length?`
    <div style="display:flex;gap:.5rem;margin-bottom:.5rem;align-items:center;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:.35rem;cursor:pointer;font-size:.8rem;color:var(--mt)"><input type="checkbox" onchange="toggleAllHist(this.checked,${JSON.stringify(visibleIds)})"> Seleccionar todos</label>
      <span id="histSelCount" style="font-size:.75rem;color:var(--mt)"></span>
      <div style="margin-left:auto;display:flex;gap:.4rem">
        <button id="btnBulkDel" onclick="bulkDelHist()" style="display:none;background:#EF4444;color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer">Eliminar seleccionados</button>
        <button onclick="delAllHist(${JSON.stringify(allItems.map(i=>i.id))})" style="background:none;border:1px solid #EF4444;color:#EF4444;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer">Borrar todo</button>
      </div>
    </div>
    ${items.map(it=>{const inp=typeof it.input_data==='string'?JSON.parse(it.input_data||'{}'):it.input_data||{};const aud=inp.audience;
      return`<div class="hist-item"><input type="checkbox" data-hid="${it.id}" onchange="toggleHistSel(${it.id},this.checked)" style="cursor:pointer;accent-color:#EF4444;margin-right:.3rem"><div class="hist-left"><span class="hist-emoji">${FMT_EMOJI[it.format_type]||'<i class="feather" data-icon="clipboard" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'}</span><div class="hist-info"><div class="hist-title">${esc((it.preview||'').slice(0,60))}</div><div class="hist-meta">${aud?'<span class="idea-bdg '+(aud==='affiliates'?'affiliates':'clients')+'" style="font-size:.6rem;margin-right:.25rem">'+(aud==='affiliates'?'AFILIADAS':'CLIENTES')+'</span>':''}${esc(it.user_name||'Usuario')} ¬∑ ${fmtDT(it.created_at)}${it.status==='approved'&&it.scheduled_date?' ¬∑ '+fmtDT(it.scheduled_date):''}</div></div></div>
        <div class="hist-right"><span class="hist-st ${it.status==='approved'?'approved':'draft'}">${it.status==='approved'?'Approved':'Draft'}</span><button class="idea-btn" onclick="viewHistItem(${it.id})">Ver</button><button class="idea-btn" onclick="cpHistItem(${it.id})"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button><button class="idea-btn danger" onclick="delHistItem(${it.id})"><i class="feather" data-icon="trash-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button></div></div>`}).join('')}`:'<p style="color:var(--mt);text-align:center;padding:2rem">No hay contenido generado.</p>'}`;
  }catch(e){m.innerHTML=`<div class="error-bar"><span>${esc(e.message)}</span></div>`}
}
function toggleHistSel(id,checked){if(checked)histSel.add(id);else histSel.delete(id);updHistSelUI()}
function toggleAllHist(checked,ids){histSel.clear();if(checked)ids.forEach(id=>histSel.add(id));document.querySelectorAll('[data-hid]').forEach(c=>c.checked=checked);updHistSelUI()}
function updHistSelUI(){const n=histSel.size;const c=document.getElementById('histSelCount');const b=document.getElementById('btnBulkDel');if(c)c.textContent=n?n+' seleccionado'+(n>1?'s':''):'';if(b)b.style.display=n?'inline-block':'none'}
async function bulkDelHist(){if(!histSel.size)return;if(!confirm(`Eliminar ${histSel.size} elemento(s) del historial?`))return;try{const r=await fetch('/api/styly/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids:[...histSel]})});const d=await r.json();if(d.error)throw new Error(d.error);toast(d.deleted+' eliminado(s)');renderHistorial(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}
async function delAllHist(ids){if(!ids||!ids.length)return toast('No hay elementos');if(!confirm('Eliminar TODO el historial de Styly? Esta accion no se puede deshacer.'))return;try{const r=await fetch('/api/styly/history/bulk-delete',{method:'POST',headers:hdrs,body:JSON.stringify({ids})});const d=await r.json();if(d.error)throw new Error(d.error);toast(d.deleted+' eliminado(s)');renderHistorial(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}
async function viewHistItem(id){
  try{const r=await fetch('/api/styly/history/'+id,{headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);
    showModal(`<div class="modal-title">${FMT_EMOJI[d.item.format_type]||'<i class="feather" data-icon="clipboard" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'} ${esc(d.item.format_type)}</div><div style="max-height:60vh;overflow-y:auto;margin-bottom:.75rem"><div class="sy-sec-body">${md(d.item.output_text)}</div></div><div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cerrar</button><button class="m-ok" onclick="cpClip(\`${esc(d.item.output_text).replace(/`/g,"'")}\`);toast('Copiado')"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button></div>`);
  }catch(e){toast('Error: '+e.message)}
}
async function cpHistItem(id){try{const r=await fetch('/api/styly/history/'+id,{headers:hdrs});const d=await r.json();cpClip(d.item.output_text);toast('Copiado')}catch(e){toast('Error')}}
async function delHistItem(id){if(!confirm('Eliminar del historial?'))return;try{await fetch('/api/styly/history/'+id,{method:'DELETE',headers:hdrs});toast('Eliminado');renderHistorial(document.getElementById('modContent'))}catch(e){toast('Error')}}

// ================================================================
// APPROVE MODAL
// ================================================================
function openApproveModal(){
  if(!G.resultId)return toast('Genera contenido primero');
  showModal(`<div class="modal-title"><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Aprobar y Agendar</div>
    <div class="modal-field"><label>Fecha</label><input type="date" id="appDate" value="${today()}"></div>
    <div class="modal-field"><label>Hora</label><input type="time" id="appTime" value="10:00"></div>
    <div class="modal-field"><label>Plataforma</label><select id="appPlat"><option value="instagram">Instagram</option><option value="tiktok">TikTok</option><option value="facebook">Facebook</option><option value="linkedin">LinkedIn</option></select></div>
    <div class="modal-field"><label>Notas (opcional)</label><textarea id="appNotes" rows="2"></textarea></div>
    <div class="modal-actions"><button class="m-cancel" onclick="closeModal()">Cancelar</button><button class="m-ok" onclick="doApprove()"><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Aprobar</button></div>`);
}
async function doApprove(){
  const date=document.getElementById('appDate')?.value,time=document.getElementById('appTime')?.value,plat=document.getElementById('appPlat')?.value,notes=document.getElementById('appNotes')?.value;
  if(!date)return toast('Selecciona fecha');
  try{const r=await fetch('/api/styly/approve',{method:'POST',headers:hdrs,body:JSON.stringify({content_id:G.resultId,scheduled_date:date,scheduled_time:time,scheduled_platform:plat,notes:notes||undefined})});const d=await r.json();if(d.error)throw new Error(d.error);closeModal();toast('<i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Aprobado y agendado')}catch(e){toast('Error: '+e.message)}
}

// ================================================================
// SHARED
// ================================================================
function showModal(html){document.getElementById('modalRoot').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box">${html}</div></div>`}
function closeModal(){const m=document.getElementById('modalRoot');m.innerHTML='';m.style.display='none'}
function cpClip(text){if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).catch(()=>fbCp(text))}else{fbCp(text)}}
function fbCp(text){const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta)}

// ================================================================
// TAB 6: TAREAS (TASK MANAGER) - MEGA TASK MANAGER REDESIGN
// ================================================================

let tasks=[],projects=[],users=[],tasksLoaded=false;
let taskView=localStorage.getItem('styly_task_view')||'list';let tasksSubView='tareas';let taskFilters={status:'',assigned:'',priority:'',project:'',search:'',dateRange:{start:null,end:null}};let selectedTask=null;

// Board columns configuration (stored in localStorage)
const DEFAULT_BOARD_COLS=[{name:'Pendiente',color:'#EF4444'},{name:'En Progreso',color:'#F59E0B'},{name:'Completada',color:'#10B981'}];
let boardColumns=JSON.parse(localStorage.getItem('styly_board_columns')||'null')||DEFAULT_BOARD_COLS.map(c=>({...c}));
function saveBoardColumns(){localStorage.setItem('styly_board_columns',JSON.stringify(boardColumns))}
function getBoardColColor(status){const col=boardColumns.find(c=>c.name===status);return col?col.color:'#6B7280'}
function getStatusStyle(status){const c=getBoardColColor(status);return{bg:c+'18',b:c,c:c}}
function getStatusOptions(selected='Pendiente'){return boardColumns.map(c=>`<option value="${c.name}" ${selected===c.name?'selected':''}>${c.name}</option>`).join('')}
function addBoardColumn(){const name=prompt('Nombre de la nueva columna:');if(!name||!name.trim())return;if(boardColumns.find(c=>c.name===name.trim()))return toast('Ya existe una columna con ese nombre');boardColumns.push({name:name.trim(),color:'#6B7280'});saveBoardColumns();renderTareas(document.getElementById('modContent'))}
async function renameBoardColumn(idx){const col=boardColumns[idx];if(!col)return;const name=prompt('Nuevo nombre:',col.name);if(!name||!name.trim()||name.trim()===col.name)return;if(boardColumns.find(c=>c.name===name.trim()))return toast('Ya existe una columna con ese nombre');const oldName=col.name;col.name=name.trim();saveBoardColumns();const affected=tasks.filter(t=>t.estado===oldName);if(affected.length>0){toast('Actualizando '+affected.length+' tareas...');await Promise.all(affected.map(t=>fetch('/api/styly/tasks/'+t.id,{method:'PUT',headers:hdrs,body:JSON.stringify({estado:name.trim()})})));affected.forEach(t=>{t.estado=name.trim()})}renderTareas(document.getElementById('modContent'))}
async function deleteBoardColumn(idx){const col=boardColumns[idx];if(!col)return;if(boardColumns.length<=1)return toast('Debe haber al menos una columna');if(!confirm('Eliminar columna "'+col.name+'"? Las tareas se moveran a la primera columna disponible.'))return;const target=boardColumns[0].name!==col.name?boardColumns[0].name:boardColumns[1].name;const affected=tasks.filter(t=>t.estado===col.name);if(affected.length>0){toast('Moviendo '+affected.length+' tareas...');await Promise.all(affected.map(t=>fetch('/api/styly/tasks/'+t.id,{method:'PUT',headers:hdrs,body:JSON.stringify({estado:target})})));affected.forEach(t=>{t.estado=target})}boardColumns.splice(idx,1);saveBoardColumns();renderTareas(document.getElementById('modContent'))}
function changeBoardColColor(idx,color){boardColumns[idx].color=color;saveBoardColumns();renderTareas(document.getElementById('modContent'))}

// Icon bank for project icon selector
const ICON_BANK=[
  {id:'folder',name:'Carpeta'},{id:'briefcase',name:'Negocio'},{id:'layout',name:'Layout'},{id:'grid',name:'Grid'},
  {id:'code',name:'Codigo'},{id:'terminal',name:'Terminal'},{id:'globe',name:'Web'},{id:'monitor',name:'Monitor'},
  {id:'settings',name:'Config'},{id:'sliders',name:'Sliders'},{id:'tool',name:'Herramienta'},{id:'zap',name:'Rayo'},
  {id:'users',name:'Usuarios'},{id:'user-check',name:'Usuario OK'},{id:'award',name:'Premio'},{id:'star',name:'Estrella'},
  {id:'bar-chart-2',name:'Grafica'},{id:'trending-up',name:'Tendencia'},{id:'pie-chart',name:'Pastel'},{id:'activity',name:'Actividad'},
  {id:'dollar-sign',name:'Dinero'},{id:'credit-card',name:'Tarjeta'},{id:'shopping-cart',name:'Tienda'},{id:'package',name:'Paquete'},
  {id:'target',name:'Objetivo'},{id:'send',name:'Enviar'},{id:'share-2',name:'Compartir'},{id:'heart',name:'Corazon'},
  {id:'layers',name:'Capas'},{id:'box',name:'Caja'}
];
const COLOR_PRESETS=[
  {hex:'#8B5CF6',name:'Purpura'},{hex:'#3B82F6',name:'Azul'},{hex:'#06B6D4',name:'Cian'},{hex:'#10B981',name:'Verde'},
  {hex:'#84CC16',name:'Lima'},{hex:'#FBBF24',name:'Amarillo'},{hex:'#F97316',name:'Naranja'},{hex:'#EF4444',name:'Rojo'},
  {hex:'#EC4899',name:'Rosa'},{hex:'#6B7280',name:'Gris'}
];
function getProjectIconBox(p,size=40){
  const icon=p?.icono||'folder';const cl=p?.color||'#6B7280';const iSz=Math.round(size*0.8);
  return `<div style="width:${size}px;height:${size}px;min-width:${size}px;border-radius:${Math.round(size*0.3)}px;background:${cl};display:inline-flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0;box-shadow:0 4px 12px ${cl}40;line-height:0"><i class="feather" data-icon="${icon}" data-size="${iSz}px" data-color="#fff" style="display:block;width:${iSz}px;height:${iSz}px" aria-hidden="true"></i></div>`;
}
function getProjectConfig(p){
  return {iconBox:getProjectIconBox(p),color:p?.color||'#6B7280'};
}

async function loadTasks(){
  if(tasksLoaded)return;
  try{
    let r=await fetch('/api/styly/projects',{headers:hdrs});
    if(!r.ok)throw new Error(`Error HTTP: ${r.status}`);
    let d=await r.json();
    if(d.error)throw new Error(d.error);
    projects=d.projects||[];
    r=await fetch('/api/styly/tasks',{headers:hdrs});
    if(!r.ok)throw new Error(`Error HTTP: ${r.status}`);
    d=await r.json();
    if(d.error)throw new Error(d.error);
    tasks=d.tasks||[];
    r=await fetch('/api/styly/users',{headers:hdrs});
    if(!r.ok)throw new Error(`Error HTTP: ${r.status}`);
    d=await r.json();
    if(d.error)throw new Error(d.error);
    users=d.users||[];
    tasksLoaded=true;
  }catch(e){
    console.error('Error cargando tareas:',e.message);
    tasks=[];projects=[];users=[];
    toast('Error al cargar datos: '+e.message);
  }
}

function switchView(view){taskView=view;localStorage.setItem('styly_task_view',view);renderTareas(document.getElementById('modContent'))}
function switchTasksSubView(subView){tasksSubView=subView;renderTareas(document.getElementById('modContent'))}
function applyFilters(list){let r=[...list];if(taskFilters.search){const s=taskFilters.search.toLowerCase();r=r.filter(t=>t.task_id?.toLowerCase().includes(s)||t.titulo?.toLowerCase().includes(s)||t.seccion?.toLowerCase().includes(s))}if(taskFilters.status)r=r.filter(t=>t.estado===taskFilters.status);if(taskFilters.assigned){const assignedNames=taskFilters.assigned.toLowerCase();r=r.filter(t=>t.asignados?.some(a=>a.name?.toLowerCase()===assignedNames))}if(taskFilters.priority)r=r.filter(t=>t.prioridad===taskFilters.priority);if(taskFilters.project)r=r.filter(t=>t.proyecto_id==taskFilters.project);return r}
function clearFilters(){taskFilters={status:'',assigned:'',priority:'',project:'',search:'',dateRange:{start:null,end:null}};renderTareas(document.getElementById('modContent'))}
function formatDateShort(d){if(!d)return'';const dt=new Date(d);const today=new Date();const tm=new Date(today);tm.setDate(tm.getDate()+1);if(dt.toDateString()===today.toDateString())return'Hoy';if(dt.toDateString()===tm.toDateString())return'Ma√±ana';return dt.toLocaleDateString('es-MX',{day:'numeric',month:'short'})}
async function quickUpdateStatus(id,s){try{const r=await fetch(`/api/styly/tasks/${id}`,{method:'PUT',headers:hdrs,body:JSON.stringify({estado:s})});const d=await r.json();if(d.error)throw new Error(d.error);const idx=tasks.findIndex(t=>t.id===id);if(idx!==-1)tasks[idx]=d.task;renderTareas(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}
async function deleteTask(id){if(!confirm('¬øEliminar esta tarea?'))return;try{const r=await fetch(`/api/styly/tasks/${id}`,{method:'DELETE',headers:hdrs});const d=await r.json();if(d.error)throw new Error(d.error);tasks=tasks.filter(t=>t.id!==id);toast('Tarea eliminada');renderTareas(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}

function renderTaskCard(t){const s=getStatusStyle(t.estado);const pc={'Alta':{bg:'rgba(239,68,68,.12)',c:'#DC2626'},'Media':{bg:'rgba(245,158,11,.12)',c:'#D97706'},'Baja':{bg:'rgba(107,114,128,.1)',c:'#6B7280'}};const p=pc[t.prioridad]||pc['Media'];const ds=t.fecha_vencimiento?formatDateShort(t.fecha_vencimiento):'';const iso=t.fecha_vencimiento&&new Date(t.fecha_vencimiento)<new Date()&&t.estado!=='Completada';const assignedNames=t.asignados&&t.asignados.length>0?t.asignados.map(a=>a.name).join(', '):'';return`<div class="task-card" onclick="openTaskModal(${t.id})" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;cursor:pointer;transition:all .3s;position:relative" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 24px rgba(0,0,0,.1)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'"><div style="position:absolute;top:.75rem;right:.75rem;padding:3px 8px;border-radius:6px;background:var(--sy-bg);font-size:.65rem;font-weight:700;color:var(--sy)">${t.task_id||'#'+t.id}</div><div style="font-size:1rem;font-weight:600;color:var(--fg);line-height:1.4;margin-bottom:.5rem;padding-right:3rem">${esc(t.titulo)}</div>${t.notas?`<div style="font-size:.8rem;color:var(--mt);font-style:italic;line-height:1.4;margin-bottom:.75rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden"><i class="fas fa-sticky-note" style="font-size:.65rem;margin-right:.3rem;color:var(--sy)"></i>${esc(t.notas)}</div>`:''}${t.seccion?`<div style="display:inline-block;padding:4px 10px;border-radius:6px;background:rgba(139,92,246,.1);color:#8B5CF6;font-size:.7rem;font-weight:600;margin-bottom:.75rem"><i class="fas fa-tag" style="font-size:.65rem;margin-right:.25rem"></i>${t.seccion}</div>`:''}<div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.75rem"><span style="padding:5px 10px;border-radius:6px;font-size:.75rem;font-weight:600;background:${s.bg};color:${s.c};border:1px solid ${s.b}"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${s.c};margin-right:.3rem;vertical-align:middle"></span>${t.estado}</span><span style="padding:5px 10px;border-radius:6px;font-size:.75rem;font-weight:600;background:${p.bg};color:${p.c}">${t.prioridad}</span>${assignedNames?`<span style="padding:5px 10px;border-radius:6px;font-size:.75rem;font-weight:600;background:var(--sy-bg);color:var(--sy)"><i class="fas fa-user" style="font-size:.7rem;margin-right:.3rem"></i>${assignedNames}</span>`:`<span style="padding:5px 10px;border-radius:6px;font-size:.75rem;font-weight:600;background:var(--border);color:var(--mt)"><i class="fas fa-user-slash" style="font-size:.7rem;margin-right:.3rem"></i>Sin asignar</span>`}${ds?`<span style="padding:5px 10px;border-radius:6px;font-size:.75rem;font-weight:600;background:${iso?'rgba(239,68,68,.15)':'rgba(59,130,246,.1)'};color:${iso?'#DC2626':'#2563EB'}"><i class="far fa-calendar" style="font-size:.7rem;margin-right:.3rem"></i>${ds}</span>`:''}</div><div style="display:flex;gap:.5rem" onclick="event.stopPropagation()"><select onchange="quickUpdateStatus(${t.id},this.value)" style="flex:1;padding:.4rem;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-size:.75rem;cursor:pointer">${getStatusOptions(t.estado)}</select><button onclick="deleteTask(${t.id});event.stopPropagation()" style="padding:.4rem .7rem;border:1px solid #EF4444;background:transparent;color:#EF4444;border-radius:6px;cursor:pointer;font-size:.75rem;transition:all .2s" onmouseover="this.style.background='#EF4444';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#EF4444'"><i class="fas fa-trash"></i></button></div></div>`}

async function renderListView(){if(!Array.isArray(tasks)||!Array.isArray(projects)||!Array.isArray(users)){return`<div style="text-align:center;padding:4rem;color:var(--mt)"><div style="font-size:3rem;margin-bottom:1rem">‚ö†Ô∏è</div><div style="font-size:1.1rem;font-weight:600;margin-bottom:.5rem">Error al cargar datos</div><div style="font-size:.85rem">No se pudieron cargar las tareas. <button onclick="tasksLoaded=false;renderTareas(document.getElementById('modContent'))" class="btn" style="margin-top:1rem">Reintentar</button></div></div>`}let filtered=applyFilters(tasks);const activeFilters=(taskFilters.project?1:0)+(taskFilters.status?1:0)+(taskFilters.assigned?1:0)+(taskFilters.priority?1:0);const filterBar=`<div style="margin-bottom:1.5rem;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:12px"><div style="display:flex;gap:.75rem;align-items:center"><input type="text" id="searchTasks" placeholder="Buscar tareas..." value="${taskFilters.search}" oninput="taskFilters.search=this.value;renderTareas(document.getElementById('modContent'))" style="flex:1;min-width:0;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg)"><button onclick="const p=document.getElementById('filterPanel');p.style.display=p.style.display==='none'?'flex':'none'" style="padding:.5rem .75rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg);cursor:pointer;white-space:nowrap;font-size:.85rem;position:relative"><i class="fas fa-sliders-h"></i> Filtros${activeFilters>0?` <span style="background:var(--sy);color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;margin-left:.25rem">${activeFilters}</span>`:''}</button></div><div id="filterPanel" style="display:none;flex-wrap:wrap;gap:.75rem;margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--border)"><select onchange="taskFilters.project=this.value;renderTareas(document.getElementById('modContent'))" style="flex:1;min-width:140px;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg)"><option value="">Todos los Proyectos</option>${projects.map(p=>`<option value="${p.id||''}" ${taskFilters.project==p.id?'selected':''}>${p.name||'Sin nombre'}</option>`).join('')}</select><select onchange="taskFilters.status=this.value;renderTareas(document.getElementById('modContent'))" style="flex:1;min-width:140px;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg)"><option value="">Todos los Estados</option>${boardColumns.map(c=>`<option value="${c.name}" ${taskFilters.status===c.name?'selected':''}>${c.name}</option>`).join('')}</select><select onchange="taskFilters.assigned=this.value;renderTareas(document.getElementById('modContent'))" style="flex:1;min-width:140px;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg)"><option value="">Todos los Usuarios</option>${users.map(u=>`<option value="${u.name||''}" ${taskFilters.assigned===u.name?'selected':''}>${u.name||'Sin nombre'}</option>`).join('')}</select><select onchange="taskFilters.priority=this.value;renderTareas(document.getElementById('modContent'))" style="flex:1;min-width:140px;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--fg)"><option value="">Todas las Prioridades</option><option value="Alta" ${taskFilters.priority==='Alta'?'selected':''}>Alta</option><option value="Media" ${taskFilters.priority==='Media'?'selected':''}>Media</option><option value="Baja" ${taskFilters.priority==='Baja'?'selected':''}>Baja</option></select><button onclick="clearFilters()" class="m-ok" style="background:var(--card);color:var(--fg);border:1px solid var(--border);white-space:nowrap"><i class="fas fa-times"></i> Limpiar</button></div></div>`;if(filtered.length===0&&projects.length>0){return filterBar+`<div style="text-align:center;padding:4rem;color:var(--mt)"><div style="font-size:3rem;margin-bottom:1rem"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></div><div style="font-size:1.1rem;font-weight:600;margin-bottom:.5rem">No hay tareas</div><div style="font-size:.85rem">Crea tu primera tarea para comenzar</div><button onclick="openNewTaskModal()" class="btn" style="margin-top:1.5rem"><i class="fas fa-plus"></i> Nueva Tarea</button></div>`}let pHTML='';for(const proj of projects){if(!proj||!proj.id)continue;const projTasks=filtered.filter(t=>t&&t.proyecto_id===proj.id);if(projTasks.length===0)continue;const cfg=getProjectConfig(proj);const projId='list-proj-'+proj.id;pHTML+=`<div style="margin-bottom:2rem"><button onclick="toggleProject('${projId}')" style="width:100%;text-align:left;padding:1rem 1.25rem;background:linear-gradient(135deg,${cfg.color}15,${cfg.color}05);border:2px solid ${cfg.color}40;border-radius:14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all .2s"><div style="display:flex;align-items:center;gap:.75rem">${getProjectIconBox(proj,44)}<div><div style="font-size:1.1rem;font-weight:700;color:var(--fg)">${proj.name||'Sin nombre'}</div><div style="font-size:.75rem;color:var(--mt);font-weight:400;margin-top:.15rem">${projTasks.length} tareas ¬∑ ${projTasks.filter(t=>t&&t.estado==='Completada').length} completadas</div></div></div><span id="toggle-${projId}" style="font-size:1.2rem;transition:transform .2s">‚ñ∂</span></button><div id="${projId}" style="display:none;margin-top:1rem"><div style="margin-bottom:1rem;padding:1rem;background:var(--card);border:1px dashed var(--border);border-radius:10px;cursor:pointer;text-align:center;color:var(--mt);transition:all .2s" onclick="openNewTaskModal(${proj.id})" onmouseover="this.style.borderColor='var(--sy)';this.style.color='var(--sy)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--mt)'"><i class="fas fa-plus-circle"></i> Agregar tarea a ${proj.name}</div><div class="task-card-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem">${projTasks.map(t=>renderTaskCard(t)).join('')}</div></div></div>`}return filterBar+pHTML}

let draggedTask=null;let draggedColIdx=null;let boardEditMode=false;
function handleDragStart(e){draggedTask=parseInt(e.currentTarget.dataset.taskId);e.currentTarget.classList.add('dragging');e.dataTransfer.effectAllowed='move'}
function handleDragEnd(e){e.currentTarget.classList.remove('dragging');draggedTask=null;document.querySelectorAll('.kanban-column.drag-over').forEach(c=>c.classList.remove('drag-over'))}
function handleDragOver(e){if(e.preventDefault)e.preventDefault();e.dataTransfer.dropEffect='move';return false}
async function handleDrop(e){if(e.stopPropagation)e.stopPropagation();e.preventDefault();e.currentTarget.classList.remove('drag-over');if(draggedColIdx!==null){const targetIdx=parseInt(e.currentTarget.dataset.colIdx);if(!isNaN(targetIdx)&&draggedColIdx!==targetIdx){const[col]=boardColumns.splice(draggedColIdx,1);boardColumns.splice(targetIdx,0,col);saveBoardColumns();draggedColIdx=null;renderTareas(document.getElementById('modContent'))}return}if(!draggedTask)return;const ns=e.currentTarget.dataset.status;await quickUpdateStatus(draggedTask,ns)}
function handleColDragStart(e){e.stopPropagation();draggedColIdx=parseInt(e.currentTarget.closest('.kanban-column').dataset.colIdx);e.currentTarget.closest('.kanban-column').style.opacity='0.5';e.dataTransfer.effectAllowed='move'}
function handleColDragEnd(e){e.currentTarget.closest('.kanban-column').style.opacity='1';draggedColIdx=null}
function toggleBoardEdit(){boardEditMode=!boardEditMode;renderTareas(document.getElementById('modContent'))}

// Mobile swipe handling for board columns
let touchStartX=0;let currentX=0;
function initBoardSwipe(){
  const board=document.querySelector('.kanban-board');
  if(!board)return;
  board.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX},{passive:true});
  board.addEventListener('touchmove',e=>{currentX=e.touches[0].clientX},{passive:true});
  board.addEventListener('touchend',()=>{
    const difference=touchStartX-currentX;
    const threshold=50;
    if(Math.abs(difference)>threshold){
      const columnWidth=window.innerWidth-48;
      if(difference>0){
        board.scrollBy({left:columnWidth,behavior:'smooth'});
      }else{
        board.scrollBy({left:-columnWidth,behavior:'smooth'});
      }
    }
  },{passive:true});
}

async function renderBoardView(){
  let filtered=applyFilters(tasks);
  const af=(taskFilters.project?1:0)+(taskFilters.status?1:0)+(taskFilters.assigned?1:0)+(taskFilters.priority?1:0);
  const em=boardEditMode;
  const filterBar=`<div class="board-filter-bar">
    <div class="board-filter-row">
      <input type="text" class="board-filter-input" id="searchTasks" placeholder="Buscar tareas..." value="${taskFilters.search}" oninput="taskFilters.search=this.value;renderTareas(document.getElementById('modContent'))">
      <button onclick="toggleBoardEdit()" class="board-filter-btn ${em?'active-edit':''}" title="${em?'Salir de edicion':'Editar columnas'}"><i class="fas fa-pen"></i></button>
      <button onclick="document.getElementById('filterPanel').classList.toggle('open')" class="board-filter-btn"><i class="fas fa-sliders-h"></i> Filtros${af>0?`<span class="filter-badge">${af}</span>`:''}</button>
    </div>
    <div id="filterPanel" class="board-filter-panel">
      <select class="board-filter-select" onchange="taskFilters.project=this.value;renderTareas(document.getElementById('modContent'))"><option value="">Todos los Proyectos</option>${projects.map(p=>`<option value="${p.id||''}" ${taskFilters.project==p.id?'selected':''}>${p.name||'Sin nombre'}</option>`).join('')}</select>
      <select class="board-filter-select" onchange="taskFilters.status=this.value;renderTareas(document.getElementById('modContent'))"><option value="">Todos los Estados</option>${boardColumns.map(c=>`<option value="${c.name}" ${taskFilters.status===c.name?'selected':''}>${c.name}</option>`).join('')}</select>
      <select class="board-filter-select" onchange="taskFilters.assigned=this.value;renderTareas(document.getElementById('modContent'))"><option value="">Todos los Usuarios</option>${users.map(u=>`<option value="${u.name||''}" ${taskFilters.assigned===u.name?'selected':''}>${u.name||'Sin nombre'}</option>`).join('')}</select>
      <select class="board-filter-select" onchange="taskFilters.priority=this.value;renderTareas(document.getElementById('modContent'))"><option value="">Todas las Prioridades</option><option value="Alta" ${taskFilters.priority==='Alta'?'selected':''}>Alta</option><option value="Media" ${taskFilters.priority==='Media'?'selected':''}>Media</option><option value="Baja" ${taskFilters.priority==='Baja'?'selected':''}>Baja</option></select>
      <button onclick="clearFilters()" class="board-filter-btn"><i class="fas fa-times"></i> Limpiar</button>
    </div>
  </div>`;
  const colsHTML=boardColumns.map((col,idx)=>{
    const colTasks=filtered.filter(t=>t.estado===col.name);
    const c=col.color;
    const cardsHTML=colTasks.map((t,ci)=>{
      const proj=projects.find(p=>p.id===t.proyecto_id);
      const pc=proj?getProjectConfig(proj):null;
      const pName=proj?(proj.name||proj.nombre||''):'';
      const pColor=pc?pc.color:'var(--mt)';
      const aName=t.asignados&&t.asignados.length>0?t.asignados[0].name:'';
      const isOverdue=t.fecha_vencimiento&&new Date(t.fecha_vencimiento)<new Date()&&t.estado!=='Completada';
      const prioClass=t.prioridad==='Alta'?'tag-alta':t.prioridad==='Media'?'tag-media':'tag-baja';
      const prog=parseInt(t.progreso)||0;
      const sc=parseInt(t.subtasks_count)||0;
      const cc=parseInt(t.comentarios_count)||0;
      const aInitial=aName?aName.charAt(0).toUpperCase():'';
      const aColor=pColor!=='var(--mt)'?pColor:'#8B5CF6';
      return`<div class="board-card" draggable="true" data-task-id="${t.id}" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" onclick="openTaskModal(${t.id})" style="--accent-col:${c};animation-delay:${ci*40}ms">
        <div class="board-card-header">
          <div class="board-card-project"><span class="dot" style="background:${pColor}"></span>${esc(pName)}</div>
          <span class="board-card-id">${t.task_id||'#'+t.id}</span>
        </div>
        <div class="board-card-title">${esc(t.titulo)}</div>
        ${t.notas?`<div class="board-card-notes"><i class="fas fa-sticky-note" style="font-size:.6rem;margin-right:.2rem;opacity:.6"></i>${esc(t.notas)}</div>`:''}
        ${t.seccion?`<div class="board-card-section"><i class="fas fa-tag" style="font-size:.55rem"></i>${esc(t.seccion)}</div>`:''}
        ${prog>0?`<div class="board-card-progress"><div class="board-card-progress-fill" style="width:${prog}%;background:${c}"></div></div>`:''}
        ${aName||t.fecha_vencimiento?`<div class="board-card-footer">
          ${aName?`<div class="board-card-assignee"><span class="avatar" style="background:${aColor};padding:0.3rem 0.6rem;border-radius:4px;display:inline-block;font-weight:500">${esc(aName)}</span></div>`:`<div class="board-card-assignee" style="color:var(--mt);opacity:.5"><i class="fas fa-user-slash" style="font-size:.65rem"></i><span>Sin asignar</span></div>`}
          ${t.fecha_vencimiento?`<div class="board-card-due ${isOverdue?'overdue':'on-time'}"><i class="far fa-calendar" style="font-size:.6rem"></i>${formatDateShort(t.fecha_vencimiento)}</div>`:''}
        </div>`:''}
        <div class="board-card-tags">
          ${t.prioridad?`<span class="board-card-tag ${prioClass}">${t.prioridad}</span>`:''}
          ${sc>0?`<span class="board-card-tag tag-subtasks"><i class="fas fa-list-check" style="font-size:.6rem"></i> ${sc} subtareas</span>`:''}
          ${cc>0?`<span class="board-card-tag tag-comments"><i class="fas fa-comment" style="font-size:.6rem"></i> ${cc}</span>`:''}
        </div>
      </div>`;
    }).join('');
    const emptyState=colTasks.length===0?`<div class="kanban-empty"><i class="fas fa-inbox" style="font-size:1.5rem"></i><span>Arrastra tareas aqui</span></div>`:'';
    return`<div class="kanban-column${em?' editing':''}" data-status="${col.name}" data-col-idx="${idx}" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragenter="this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" style="border-color:${c}30">
      <div class="kanban-col-header" ${em?`style="cursor:grab" draggable="true" ondragstart="handleColDragStart(event)" ondragend="handleColDragEnd(event)"`:''}>
        <div class="kanban-col-title">
          ${em?'<i class="fas fa-grip-vertical" style="color:var(--mt);font-size:.7rem;cursor:grab"></i>':''}
          <span class="dot" style="background:${c};color:${c}"></span>
          <h3>${col.name}</h3>
          <span class="kanban-col-count">${colTasks.length}</span>
        </div>
        <div class="kanban-col-actions">
          ${em?`<button class="col-action-btn" onclick="event.stopPropagation();renameBoardColumn(${idx})" title="Renombrar"><i class="fas fa-pen"></i></button><input type="color" value="${c}" onclick="event.stopPropagation()" onchange="changeBoardColColor(${idx},this.value)" title="Color" style="width:20px;height:20px;border:none;border-radius:4px;cursor:pointer;padding:0"><button class="col-action-btn danger" onclick="event.stopPropagation();deleteBoardColumn(${idx})" title="Eliminar"><i class="fas fa-trash"></i></button>`:''}
          <button class="col-action-btn" onclick="openNewTaskModal(null,'${col.name}')" title="Nueva tarea" style="color:${c}"><i class="fas fa-plus"></i></button>
        </div>
      </div>
      <div class="kanban-col-body">
        ${cardsHTML}${emptyState}
      </div>
      <div class="kanban-add-task" onclick="openNewTaskModal(null,'${col.name}')"><i class="fas fa-plus" style="margin-right:.3rem"></i>Nueva tarea</div>
    </div>`;
  }).join('');
  const addColBtn=em?`<div class="kanban-add-col" onclick="addBoardColumn()"><span><i class="fas fa-plus" style="font-size:1.3rem;margin-bottom:.4rem;display:block"></i><span style="font-size:.82rem;font-weight:600">Nueva Columna</span></span></div>`:'';
  return filterBar+`<div class="kanban-board">${colsHTML}${addColBtn}</div>`;
}

async function renderTimelineView(){let filtered=applyFilters(tasks).filter(t=>t.fecha_vencimiento||t.fecha_inicio);if(filtered.length===0)return`<div style="text-align:center;padding:4rem;color:var(--mt)"><div style="font-size:3rem;margin-bottom:1rem"><i class="feather" data-icon="calendar" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></div><div style="font-size:1.1rem;font-weight:600;margin-bottom:.5rem">No hay tareas con fechas</div><div style="font-size:.85rem">Agrega fechas de inicio o vencimiento a tus tareas para visualizarlas en el timeline</div></div>`;const dts=filtered.flatMap(t=>[t.fecha_inicio,t.fecha_vencimiento].filter(Boolean)).map(d=>new Date(d));const mn=new Date(Math.min(...dts));const mx=new Date(Math.max(...dts));mn.setDate(mn.getDate()-7);mx.setDate(mx.getDate()+7);const td=Math.ceil((mx-mn)/(1000*60*60*24));const dw=40;const tw=td*dw;let hHTML='';let cd=new Date(mn);while(cd<=mx){const ms=new Date(cd);const me=new Date(cd.getFullYear(),cd.getMonth()+1,0);const ve=me>mx?mx:me;const dm=Math.ceil((ve-ms)/(1000*60*60*24))+1;hHTML+=`<div style="width:${dm*dw}px;text-align:center;padding:.5rem;border-right:1px solid var(--border);background:var(--card);font-size:.75rem;font-weight:600;color:var(--fg)">${ms.toLocaleDateString('es-MX',{month:'short',year:'numeric'})}</div>`;cd.setMonth(cd.getMonth()+1);cd.setDate(1)}let rHTML='';for(const proj of projects){const pTasks=filtered.filter(t=>t.proyecto_id===proj.id);if(pTasks.length===0)continue;const cfg=getProjectConfig(proj);rHTML+=`<div style="display:flex;border-bottom:1px solid var(--border)"><div style="width:200px;flex-shrink:0;padding:1rem;background:var(--card);border-right:1px solid var(--border);display:flex;align-items:center;gap:.5rem">${getProjectIconBox(proj,32)}<div style="font-size:.85rem;font-weight:600;color:var(--fg)">${proj.name}</div></div><div style="position:relative;flex:1;min-height:80px;padding:.5rem 0">${pTasks.map(t=>{const sd=t.fecha_inicio?new Date(t.fecha_inicio):new Date(t.fecha_vencimiento);const ed=t.fecha_vencimiento?new Date(t.fecha_vencimiento):new Date(sd);const dss=Math.ceil((sd-mn)/(1000*60*60*24));const dur=Math.max(1,Math.ceil((ed-sd)/(1000*60*60*24))+1);const l=dss*dw;const w=dur*dw;const iso=ed<new Date()&&t.estado!=='Completada';const bc=iso?'#EF4444':t.estado==='Completada'?'#10B981':cfg.color;return`<div onclick="openTaskModal(${t.id})" style="position:absolute;left:${l}px;top:${Math.random()*40}px;width:${w}px;height:28px;background:${bc}30;border:2px solid ${bc};border-radius:6px;cursor:pointer;display:flex;align-items:center;padding:0 .5rem;transition:all .2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,.15)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'" title="${esc(t.titulo)}"><div style="font-size:.7rem;font-weight:600;color:${bc};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${t.task_id||'#'+t.id}: ${esc(t.titulo).substring(0,30)}${t.titulo.length>30?'...':''}</div></div>`}).join('')}</div></div>`}return`<div style="overflow-x:auto;overflow-y:auto;max-height:calc(100vh - 300px);border:1px solid var(--border);border-radius:12px"><div style="display:flex;position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:2px solid var(--border)"><div style="width:200px;flex-shrink:0;padding:.5rem 1rem;background:var(--card);border-right:1px solid var(--border);font-size:.85rem;font-weight:700;color:var(--fg)">Proyectos</div><div style="display:flex">${hHTML}</div></div>${rHTML}</div>`}

async function renderTareas(m){
  if(!tasksLoaded){
    m.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem;color:var(--mt)"><div style="animation:spin 1s linear infinite;font-size:3rem;margin-bottom:1rem"><i class="feather" data-icon="settings" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></div><div style="font-size:1.1rem;font-weight:600">Cargando tareas...</div></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>`;
    await loadTasks();
  }
  // Si est√° en vista de proyectos, mostrar panel de proyectos
  if(tasksSubView==='proyectos'){
    await renderProyectos(m);
    return;
  }
  // Vista de tareas - mostrar barra de vistas y tareas
  const vBar=`<div class="styly-view-bar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem"><div class="styly-view-tabs" style="display:flex;gap:.5rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:.5rem;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)"><button onclick="switchView('list')" class="view-btn ${taskView==='list'?'active':''}" title="Vista de Lista"><i class="fas fa-list"></i> Lista</button><button onclick="switchView('board')" class="view-btn ${taskView==='board'?'active':''}" title="Vista de Tablero"><i class="fas fa-columns"></i> Tablero</button><button onclick="switchView('timeline')" class="view-btn ${taskView==='timeline'?'active':''}" title="Vista de L√≠nea de Tiempo"><i class="fas fa-chart-gantt"></i> Timeline</button></div><div class="styly-view-actions" style="display:flex;gap:.5rem"><button onclick="openNewTaskModal()" class="glass-btn" style="white-space:nowrap"><i class="fas fa-plus"></i> Nueva Tarea</button><button onclick="openBulkImportModal()" class="glass-btn" style="white-space:nowrap"><i class="fas fa-file-import"></i> Importar</button><button onclick="switchTasksSubView('proyectos')" class="glass-btn" style="white-space:nowrap" title="Administrar Proyectos"><i class="fas fa-folder"></i> Proyectos</button></div></div>`;
  m.innerHTML=vBar;
  if(taskView==='list')m.innerHTML+=await renderListView();
  else if(taskView==='board'){m.innerHTML+=await renderBoardView();setTimeout(initBoardSwipe,50)}
  else if(taskView==='timeline')m.innerHTML+=await renderTimelineView()
}

// ================================================================
// DASHBOARD DE TAREAS CON ESTAD√çSTICAS Y ANAL√çTICOS
// ================================================================
async function renderDashboard(m){
  await loadTasks();

  // Calcular todas las estad√≠sticas
  const total=tasks.length;
  const pending=tasks.filter(t=>t.estado==='Pendiente').length;
  const inProgress=tasks.filter(t=>t.estado==='En Progreso').length;
  const completed=tasks.filter(t=>t.estado==='Completada').length;
  const completionRate=total>0?Math.round((completed/total)*100):0;

  // Estad√≠sticas por usuario
  const userStats={};
  users.forEach(u=>{
    userStats[u.name]={name:u.name,total:0,pending:0,inProgress:0,completed:0,completion:0};
  });
  tasks.forEach(t=>{
    if(t.asignados&&t.asignados.length>0){
      t.asignados.forEach(a=>{
        if(userStats[a.name]){
          userStats[a.name].total++;
          if(t.estado==='Pendiente')userStats[a.name].pending++;
          else if(t.estado==='En Progreso')userStats[a.name].inProgress++;
          else if(t.estado==='Completada')userStats[a.name].completed++;
        }
      });
    }
  });
  Object.values(userStats).forEach(u=>{
    u.completion=u.total>0?Math.round((u.completed/u.total)*100):0;
  });

  // Estad√≠sticas por proyecto
  const projStats={};
  projects.forEach(p=>{
    projStats[p.name]={name:p.name,iconBox:getProjectIconBox(p,28),color:p.color||'#6B7280',total:0,pending:0,completed:0,completion:0};
  });
  tasks.forEach(t=>{
    const proj=projects.find(p=>p.id===t.proyecto_id);
    if(proj&&projStats[proj.name]){
      projStats[proj.name].total++;
      if(t.estado==='Completada')projStats[proj.name].completed++;
      if(t.estado==='Pendiente')projStats[proj.name].pending++;
    }
  });
  Object.values(projStats).forEach(p=>{
    p.completion=p.total>0?Math.round((p.completed/p.total)*100):0;
  });

  // Estad√≠sticas por prioridad
  const byPriority={Alta:0,Media:0,Baja:0};
  const byPriorityDone={Alta:0,Media:0,Baja:0};
  tasks.forEach(t=>{
    if(byPriority[t.prioridad]!==undefined){
      byPriority[t.prioridad]++;
      if(t.estado==='Completada')byPriorityDone[t.prioridad]++;
    }
  });

  const usersList=Object.values(userStats).filter(u=>u.total>0).sort((a,b)=>b.total-a.total);
  const projList=Object.values(projStats).sort((a,b)=>b.total-a.total);

  m.innerHTML=`
    <div style="padding:0">
      <!-- KPI CARDS -->
      <div class="dash-kpi-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem">
        <div style="background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(59,130,246,.05));border:2px solid #3B82F6;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Total de Tareas</div>
          <div style="font-size:2.5rem;font-weight:700;color:#3B82F6">${total}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">Tareas en el sistema</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(239,68,68,.1),rgba(239,68,68,.05));border:2px solid #EF4444;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem"><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#EF4444" aria-hidden="true"></i> Pendientes</div>
          <div style="font-size:2.5rem;font-weight:700;color:#EF4444">${pending}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${total>0?Math.round((pending/total)*100):'0'}% del total</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(245,158,11,.05));border:2px solid #F59E0B;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem"><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#FCD34D" aria-hidden="true"></i> En Progreso</div>
          <div style="font-size:2.5rem;font-weight:700;color:#F59E0B">${inProgress}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${total>0?Math.round((inProgress/total)*100):'0'}% del total</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(16,185,129,.05));border:2px solid #10B981;border-radius:12px;padding:1.5rem">
          <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem"><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Completadas</div>
          <div style="font-size:2.5rem;font-weight:700;color:#10B981">${completed}</div>
          <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${completionRate}% de completaci√≥n</div>
        </div>
      </div>

      <!-- DOS COLUMNAS -->
      <div class="dash-two-col" style="display:grid;grid-template-columns:1fr 1fr;gap:2rem">
        <!-- COLUMNA IZQUIERDA: Usuarios y Proyectos -->
        <div>
          <h3 style="font-size:1.1rem;font-weight:700;color:var(--fg);margin-bottom:1rem"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Carga de Trabajo por Usuario</h3>
          ${usersList.map(u=>`
            <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:.75rem">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                <div style="font-weight:600;color:var(--fg)">${u.name}</div>
                <div style="font-size:.75rem;font-weight:700;background:var(--sy-bg);color:var(--sy);padding:2px 8px;border-radius:4px">${u.completion}%</div>
              </div>
              <div style="display:flex;gap:.5rem;font-size:.75rem;color:var(--mt);margin-bottom:.5rem">
                <span><i class="feather" data-icon="pin" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> ${u.total} tareas</span>
                <span><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#EF4444" aria-hidden="true"></i> ${u.pending}</span>
                <span><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#FCD34D" aria-hidden="true"></i> ${u.inProgress}</span>
                <span><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> ${u.completed}</span>
              </div>
              <div style="width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
                <div style="width:${u.completion}%;height:100%;background:linear-gradient(90deg,#3B82F6,#10B981);transition:width .3s"></div>
              </div>
            </div>
          `).join('')}
        </div>

        <!-- COLUMNA DERECHA: Proyectos -->
        <div>
          <h3 style="font-size:1.1rem;font-weight:700;color:var(--fg);margin-bottom:1rem">üéØ Progreso por Proyecto</h3>
          ${projList.map(p=>`
            <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:.75rem">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                <div style="font-weight:600;color:var(--fg);display:flex;align-items:center;gap:.5rem">${p.iconBox}${p.name}</div>
                <div style="font-size:.75rem;font-weight:700;background:var(--sy-bg);color:var(--sy);padding:2px 8px;border-radius:4px">${p.completion}%</div>
              </div>
              <div style="display:flex;gap:.5rem;font-size:.75rem;color:var(--mt);margin-bottom:.5rem">
                <span><i class="feather" data-icon="pin" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> ${p.total} tareas</span>
                <span><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> ${p.completed}</span>
              </div>
              <div style="width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
                <div style="width:${p.completion}%;height:100%;background:linear-gradient(90deg,#3B82F6,#10B981);transition:width .3s"></div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- PRIORIDADES -->
      <div style="margin-top:2rem">
        <h3 style="font-size:1.1rem;font-weight:700;color:var(--fg);margin-bottom:1rem"><i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Tareas por Prioridad</h3>
        <div class="dash-priority-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem">
          <div style="background:rgba(220,38,38,.1);border:1px solid #DC2626;border-radius:10px;padding:1.5rem;text-align:center">
            <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem"><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#EF4444" aria-hidden="true"></i> Alta Prioridad</div>
            <div style="font-size:2rem;font-weight:700;color:#DC2626">${byPriority.Alta}</div>
            <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${byPriorityDone.Alta} completadas (${byPriority.Alta>0?Math.round((byPriorityDone.Alta/byPriority.Alta)*100):'0'}%)</div>
          </div>
          <div style="background:rgba(217,119,6,.1);border:1px solid #D97706;border-radius:10px;padding:1.5rem;text-align:center">
            <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem"><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#FCD34D" aria-hidden="true"></i> Prioridad Media</div>
            <div style="font-size:2rem;font-weight:700;color:#D97706">${byPriority.Media}</div>
            <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${byPriorityDone.Media} completadas (${byPriority.Media>0?Math.round((byPriorityDone.Media/byPriority.Media)*100):'0'}%)</div>
          </div>
          <div style="background:rgba(107,114,128,.1);border:1px solid #6B7280;border-radius:10px;padding:1.5rem;text-align:center">
            <div style="font-size:.85rem;color:var(--mt);margin-bottom:.5rem"><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#10B981" aria-hidden="true"></i> Baja Prioridad</div>
            <div style="font-size:2rem;font-weight:700;color:#6B7280">${byPriority.Baja}</div>
            <div style="font-size:.75rem;color:var(--mt);margin-top:.5rem">${byPriorityDone.Baja} completadas (${byPriority.Baja>0?Math.round((byPriorityDone.Baja/byPriority.Baja)*100):'0'}%)</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function toggleProject(projId){const el=document.getElementById(projId);const icon=document.getElementById('toggle-'+projId);if(el){const hidden=el.style.display==='none';el.style.display=hidden?'block':'none';if(icon)icon.textContent=hidden?'‚ñº':'‚ñ∂'}}

async function openTaskModal(taskId){
  const task=tasks.find(t=>t.id===taskId);if(!task)return;
  const proj=projects.find(p=>p.id===task.proyecto_id);
  const projName=proj?proj.name:'Sin proyecto';
  const assignedNames=task.asignados&&task.asignados.length>0?task.asignados.map(a=>a.name).join(', '):'Sin asignar';
  const s=getStatusStyle(task.estado);
  const pc={'Alta':{bg:'rgba(239,68,68,.12)',c:'#DC2626'},'Media':{bg:'rgba(245,158,11,.12)',c:'#D97706'},'Baja':{bg:'rgba(107,114,128,.1)',c:'#6B7280'}};
  const p=pc[task.prioridad]||pc['Media'];
  const isOverdue=task.fecha_vencimiento&&new Date(task.fecha_vencimiento)<new Date()&&task.estado!=='Completada';

  // Fetch files
  let archivosHTML='<div style="color:var(--mt);font-size:.85rem">Cargando archivos...</div>';
  const modal=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()">
<div class="modal-box" style="max-width:650px;max-height:90vh;overflow-y:auto">
  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.25rem">
    <div style="display:flex;align-items:center;gap:.5rem">
      <span style="padding:4px 10px;border-radius:6px;background:var(--sy-bg);font-size:.75rem;font-weight:700;color:var(--sy)">${task.task_id||'#'+task.id}</span>
      <span style="padding:4px 10px;border-radius:6px;background:${s.bg};font-size:.75rem;font-weight:600;color:${s.c}"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${s.c};margin-right:.3rem;vertical-align:middle"></span>${task.estado}</span>
      <span style="padding:4px 10px;border-radius:6px;background:${p.bg};font-size:.75rem;font-weight:600;color:${p.c}">${task.prioridad}</span>
    </div>
    <button onclick="closeModal()" style="padding:.5rem;border:none;background:transparent;color:var(--mt);cursor:pointer;font-size:1.3rem;line-height:1">&times;</button>
  </div>

  <h2 style="font-size:1.3rem;font-weight:700;color:var(--fg);margin:0 0 1rem 0;line-height:1.4">${esc(task.titulo)}</h2>

  <div style="display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
    <div style="display:flex;align-items:center;gap:.4rem;font-size:.85rem;color:var(--mt)"><i class="fas fa-folder" style="color:var(--sy)"></i> ${esc(projName)}</div>
    ${task.seccion?`<div style="display:flex;align-items:center;gap:.4rem;font-size:.85rem;color:var(--mt)"><i class="fas fa-tag" style="color:#8B5CF6"></i> ${esc(task.seccion)}</div>`:''}
    <div style="display:flex;align-items:center;gap:.4rem;font-size:.85rem;color:var(--mt)"><i class="fas fa-user" style="color:#3B82F6"></i> ${esc(assignedNames)}</div>
  </div>

  ${task.fecha_inicio||task.fecha_vencimiento?`<div style="display:flex;align-items:center;gap:.5rem;padding:.75rem 1rem;background:${isOverdue?'rgba(239,68,68,.08)':'rgba(59,130,246,.06)'};border:1px solid ${isOverdue?'rgba(239,68,68,.2)':'rgba(59,130,246,.15)'};border-radius:10px;margin-bottom:1.25rem;font-size:.85rem;color:${isOverdue?'#DC2626':'var(--fg)'}">
    <i class="far fa-calendar-alt" style="color:${isOverdue?'#DC2626':'#3B82F6'}"></i>
    ${task.fecha_inicio?`<span>${formatDateShort(task.fecha_inicio)}</span>`:''}
    ${task.fecha_inicio&&task.fecha_vencimiento?'<span style="color:var(--mt)">‚Üí</span>':''}
    ${task.fecha_vencimiento?`<span style="font-weight:600">${formatDateShort(task.fecha_vencimiento)}</span>`:''}
    ${isOverdue?'<span style="font-weight:700;margin-left:.25rem">(Vencida)</span>':''}
  </div>`:''}

  ${task.descripcion?`<div style="margin-bottom:1.25rem"><div style="font-size:.75rem;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem"><i class="fas fa-align-left" style="margin-right:.3rem"></i>Descripcion</div><div style="font-size:.9rem;color:var(--fg);line-height:1.6;padding:.75rem 1rem;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px">${esc(task.descripcion)}</div></div>`:''}

  ${task.notas?`<div style="margin-bottom:1.25rem"><div style="font-size:.75rem;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem"><i class="fas fa-sticky-note" style="margin-right:.3rem"></i>Notas</div><div style="font-size:.9rem;color:var(--fg);line-height:1.6;padding:.75rem 1rem;background:rgba(139,92,246,.05);border:1px solid rgba(139,92,246,.15);border-radius:10px;font-style:italic">${esc(task.notas)}</div></div>`:''}

  <div style="margin-bottom:1.25rem">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <div style="font-size:.75rem;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px"><i class="fas fa-paperclip" style="margin-right:.3rem"></i>Archivos</div>
      <label style="padding:5px 12px;border-radius:8px;border:1px dashed var(--sy);background:transparent;color:var(--sy);cursor:pointer;font-size:.8rem;font-weight:600;transition:all .2s" onmouseover="this.style.background='rgba(139,92,246,.1)'" onmouseout="this.style.background='transparent'">
        <i class="fas fa-upload" style="margin-right:.3rem"></i>Subir
        <input type="file" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.txt" style="display:none" onchange="uploadTaskFiles(${task.id},this.files)">
      </label>
    </div>
    <div id="taskFilesContainer">${archivosHTML}</div>
  </div>

  <div class="modal-bottom-actions" style="display:flex;justify-content:space-between;gap:1rem;margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border)">
    <button onclick="deleteTask(${task.id});closeModal()" style="padding:.6rem 1rem;border-radius:10px;border:1px solid #EF4444;background:transparent;color:#EF4444;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s" onmouseover="this.style.background='#EF4444';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#EF4444'"><i class="fas fa-trash"></i> Eliminar</button>
    <div style="display:flex;gap:.75rem">
      <button onclick="closeModal()" class="m-cancel">Cerrar</button>
      <button onclick="openEditTaskModal(${task.id})" class="m-ok"><i class="fas fa-edit"></i> Editar</button>
    </div>
  </div>
</div></div>`;
  document.getElementById('modalRoot').innerHTML=modal;
  loadTaskFiles(task.id);
}

function formatFileSize(bytes){if(!bytes)return '0 B';const k=1024;const sizes=['B','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(1))+' '+sizes[i]}

async function loadTaskFiles(taskId){
  try{
    const r=await fetch(`/api/styly/tasks/${taskId}/archivos`,{headers:hdrs});
    const d=await r.json();
    const container=document.getElementById('taskFilesContainer');
    if(!container)return;
    const files=d.archivos||[];
    if(files.length===0){container.innerHTML='<div style="padding:1rem;text-align:center;color:var(--mt);font-size:.85rem;border:1px dashed var(--border);border-radius:10px">Sin archivos adjuntos</div>';return}
    container.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.75rem">${files.map(f=>{
      const isImage=f.tipo&&f.tipo.startsWith('image/');
      if(isImage){
        return`<div style="position:relative;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--card);transition:all .2s" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,.15)'" onmouseout="this.style.boxShadow='none'">
          <a href="${f.ruta}" target="_blank" style="display:block"><img src="${f.ruta}" alt="${esc(f.nombre)}" style="width:100%;height:100px;object-fit:cover;display:block"></a>
          <div style="padding:.5rem"><div style="font-size:.7rem;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${esc(f.nombre)}">${esc(f.nombre)}</div><div style="font-size:.65rem;color:var(--mt)">${formatFileSize(f.tamano)}</div></div>
          <button onclick="event.stopPropagation();deleteTaskFile(${f.id},${taskId})" style="position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:50%;border:none;background:rgba(0,0,0,.6);color:#fff;cursor:pointer;font-size:.65rem;display:flex;align-items:center;justify-content:center" title="Eliminar"><i class="fas fa-times"></i></button>
        </div>`;
      }else{
        const ext=f.nombre.split('.').pop().toUpperCase();
        const iconMap={'PDF':'fa-file-pdf','DOC':'fa-file-word','DOCX':'fa-file-word','XLS':'fa-file-excel','XLSX':'fa-file-excel','ZIP':'fa-file-archive','RAR':'fa-file-archive','TXT':'fa-file-alt'};
        const icon=iconMap[ext]||'fa-file';
        return`<div style="position:relative;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--card);padding:1rem;text-align:center;transition:all .2s" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,.15)'" onmouseout="this.style.boxShadow='none'">
          <a href="${f.ruta}" target="_blank" download style="text-decoration:none"><i class="fas ${icon}" style="font-size:2rem;color:var(--sy);margin-bottom:.5rem;display:block"></i></a>
          <div style="font-size:.7rem;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${esc(f.nombre)}">${esc(f.nombre)}</div>
          <div style="font-size:.65rem;color:var(--mt)">${formatFileSize(f.tamano)}</div>
          <button onclick="event.stopPropagation();deleteTaskFile(${f.id},${taskId})" style="position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:50%;border:none;background:rgba(0,0,0,.6);color:#fff;cursor:pointer;font-size:.65rem;display:flex;align-items:center;justify-content:center" title="Eliminar"><i class="fas fa-times"></i></button>
        </div>`;
      }
    }).join('')}</div>`;
  }catch(e){
    const container=document.getElementById('taskFilesContainer');
    if(container)container.innerHTML='<div style="color:#EF4444;font-size:.85rem">Error cargando archivos</div>';
  }
}

async function uploadTaskFiles(taskId,fileList){
  if(!fileList||fileList.length===0)return;
  const formData=new FormData();
  for(const file of fileList)formData.append('archivos',file);
  try{
    toast('Subiendo archivo(s)...');
    const r=await fetch(`/api/styly/tasks/${taskId}/archivos`,{method:'POST',headers:{'Authorization':hdrs['Authorization']},body:formData});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    toast(`${d.archivos.length} archivo(s) subidos`);
    loadTaskFiles(taskId);
  }catch(e){toast('Error: '+e.message)}
}

async function deleteTaskFile(fileId,taskId){
  if(!confirm('¬øEliminar este archivo?'))return;
  try{
    const r=await fetch(`/api/styly/archivos/${fileId}`,{method:'DELETE',headers:hdrs});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    toast('Archivo eliminado');
    loadTaskFiles(taskId);
  }catch(e){toast('Error: '+e.message)}
}

function openEditTaskModal(taskId){const task=tasks.find(t=>t.id===taskId);if(!task)return;const assignedUserId=task.asignados&&task.asignados.length>0?task.asignados[0].user_id:'';const modal=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" style="max-width:600px"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem"><div style="font-size:1.15rem;font-weight:700;color:var(--fg)">Editar Tarea<span style="font-size:.75rem;font-weight:600;color:var(--sy);margin-left:.5rem">${task.task_id||'#'+task.id}</span></div><button onclick="closeModal()" style="padding:.5rem;border:none;background:transparent;color:var(--mt);cursor:pointer;font-size:1.2rem">&times;</button></div><div class="modal-field"><label>Titulo</label><textarea id="editDesc" rows="2" style="resize:vertical">${esc(task.titulo)}</textarea></div><div class="modal-field"><label>Notas</label><textarea id="editNotas" rows="3" placeholder="Notas detalladas de la tarea..." style="resize:vertical">${esc(task.notas||'')}</textarea></div><div class="modal-field"><label>Proyecto</label><select id="editProject">${projects.map(p=>`<option value="${p.id}" ${task.proyecto_id==p.id?'selected':''}>${p.name}</option>`).join('')}</select></div><div class="modal-field"><label>Seccion (opcional)</label><input type="text" id="editModule" value="${task.seccion||''}" placeholder="Ej: Dashboard, Pagos, etc."></div><div class="modal-two-col" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem"><div class="modal-field"><label>Estado</label><select id="editStatus">${getStatusOptions(task.estado)}</select></div><div class="modal-field"><label>Prioridad</label><select id="editPriority"><option value="Alta" ${task.prioridad==='Alta'?'selected':''}>Alta</option><option value="Media" ${task.prioridad==='Media'?'selected':''}>Media</option><option value="Baja" ${task.prioridad==='Baja'?'selected':''}>Baja</option></select></div></div><div class="modal-field"><label>Asignado a</label><select id="editAssigned"><option value="">Sin asignar</option>${users.map(u=>`<option value="${u.id}" ${assignedUserId==u.id?'selected':''}>${u.name}</option>`).join('')}</select></div><div class="modal-two-col" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem"><div class="modal-field"><label>Fecha de Inicio</label><input type="date" id="editStartDate" value="${task.fecha_inicio||''}"></div><div class="modal-field"><label>Fecha de Vencimiento</label><input type="date" id="editDueDate" value="${task.fecha_vencimiento||''}"></div></div><div style="display:flex;justify-content:space-between;gap:1rem;margin-top:1.5rem"><button onclick="deleteTask(${task.id});closeModal()" style="padding:.65rem 1.25rem;border-radius:10px;border:1px solid #EF4444;background:transparent;color:#EF4444;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s" onmouseover="this.style.background='#EF4444';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#EF4444'"><i class="fas fa-trash"></i> Eliminar</button><div style="display:flex;gap:.75rem"><button onclick="closeModal()" class="m-cancel">Cancelar</button><button onclick="saveTask(${task.id})" class="m-ok"><i class="fas fa-save"></i> Guardar</button></div></div></div></div>`;document.getElementById('modalRoot').innerHTML=modal}

async function saveTask(taskId){const titulo=document.getElementById('editDesc')?.value?.trim();const notas=document.getElementById('editNotas')?.value?.trim()||null;const proyecto_id=document.getElementById('editProject')?.value;const seccion=document.getElementById('editModule')?.value?.trim()||null;const estado=document.getElementById('editStatus')?.value;const prioridad=document.getElementById('editPriority')?.value;const assignedUserId=document.getElementById('editAssigned')?.value||null;const fecha_inicio=document.getElementById('editStartDate')?.value||null;const fecha_vencimiento=document.getElementById('editDueDate')?.value||null;if(!titulo)return toast('T√≠tulo requerido');try{const payload={titulo,notas,proyecto_id,seccion,estado,prioridad,fecha_inicio,fecha_vencimiento};const r=await fetch(`/api/styly/tasks/${taskId}`,{method:'PUT',headers:hdrs,body:JSON.stringify(payload)});const d=await r.json();if(d.error)throw new Error(d.error);const task=tasks.find(t=>t.id===taskId);if(assignedUserId){const currentAssigned=task?.asignados||[];for(const a of currentAssigned){await fetch(`/api/styly/tasks/${taskId}/asignados/${a.user_id}`,{method:'DELETE',headers:hdrs}).catch(e=>console.log(e));}await fetch(`/api/styly/tasks/${taskId}/asignados`,{method:'POST',headers:hdrs,body:JSON.stringify({user_id:parseInt(assignedUserId)})});}else if(task){const currentAssigned=task?.asignados||[];for(const a of currentAssigned){await fetch(`/api/styly/tasks/${taskId}/asignados/${a.user_id}`,{method:'DELETE',headers:hdrs}).catch(e=>console.log(e));}}toast('Tarea actualizada');closeModal();tasksLoaded=false;await renderTareas(document.getElementById('modContent'));openTaskModal(taskId)}catch(e){toast('Error: '+e.message)}}

function openNewTaskModal(projectId=null,status='Pendiente',userId=null){const modal=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" style="max-width:600px"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem"><div style="font-size:1.15rem;font-weight:700;color:var(--fg)"><i class="fas fa-plus-circle" style="color:var(--sy);margin-right:.5rem"></i>Nueva Tarea</div><button onclick="closeModal()" style="padding:.5rem;border:none;background:transparent;color:var(--mt);cursor:pointer;font-size:1.2rem">&times;</button></div><div class="modal-field"><label>T√≠tulo *</label><textarea id="newDesc" rows="2" placeholder="Nombre de la tarea..." style="resize:vertical"></textarea></div><div class="modal-field"><label>Notas</label><textarea id="newNotas" rows="3" placeholder="Notas detalladas de la tarea (opcional)..." style="resize:vertical"></textarea></div><div class="modal-field"><label style="display:flex;justify-content:space-between;align-items:center">Proyecto * <button onclick="openCreateProjectModal()" title="Crear nuevo proyecto" style="padding:4px 8px;border-radius:4px;border:1px solid var(--sy);background:transparent;color:var(--sy);cursor:pointer;font-size:.75rem"><i class="fas fa-plus"></i> Nuevo</button></label><select id="newProject">${projects.length===0?'<option value="">-- Sin proyectos disponibles --</option>':projects.map(p=>`<option value="${p.id}" ${projectId==p.id?'selected':''}>${p.name}</option>`).join('')}</select></div><div class="modal-field"><label>Secci√≥n (opcional)</label><input type="text" id="newModule" placeholder="Ej: Dashboard, Pagos, etc."></div><div class="modal-two-col" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem"><div class="modal-field"><label>Estado</label><select id="newStatus">${getStatusOptions(status)}</select></div><div class="modal-field"><label>Prioridad</label><select id="newPriority"><option value="Media" selected><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#FCD34D" aria-hidden="true"></i> Media</option><option value="Alta"><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#EF4444" aria-hidden="true"></i> Alta</option><option value="Baja"><i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#10B981" aria-hidden="true"></i> Baja</option></select></div></div><div class="modal-field"><label style="display:flex;justify-content:space-between;align-items:center">Asignado a <button onclick="openCreateUserModal()" title="Crear nuevo usuario" style="padding:4px 8px;border-radius:4px;border:1px solid var(--sy);background:transparent;color:var(--sy);cursor:pointer;font-size:.75rem"><i class="fas fa-plus"></i> Nuevo</button></label><select id="newAssigned"><option value="">Sin asignar</option>${users.map(u=>`<option value="${u.id}" ${userId==u.id?'selected':''}>${u.name}</option>`).join('')}</select></div><div class="modal-two-col" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem"><div class="modal-field"><label>Fecha de Inicio</label><input type="date" id="newStartDate"></div><div class="modal-field"><label>Fecha de Vencimiento</label><input type="date" id="newDueDate"></div></div><div class="modal-actions" style="margin-top:1.5rem;display:flex;justify-content:flex-end;gap:.75rem"><button onclick="closeModal()" class="m-cancel">Cancelar</button><button onclick="createTask()" class="m-ok"><i class="fas fa-plus"></i> Crear Tarea</button></div></div></div>`;document.getElementById('modalRoot').innerHTML=modal}

function renderIconGrid(selectedIcon='folder'){return ICON_BANK.map(ic=>`<button type="button" onclick="selectProjectIcon('${ic.id}')" title="${ic.name}" style="width:44px;height:44px;border-radius:10px;border:2px solid ${ic.id===selectedIcon?'var(--sy)':'var(--border)'};background:${ic.id===selectedIcon?'var(--sy-bg)':'var(--card)'};cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;color:${ic.id===selectedIcon?'var(--sy)':'var(--fg)'}" onmouseover="if(this.querySelector('i').dataset.icon!==document.getElementById('projIconValue').value){this.style.borderColor='var(--sy)';this.style.background='rgba(236,72,153,.04)'}" onmouseout="if(this.querySelector('i').dataset.icon!==document.getElementById('projIconValue').value){this.style.borderColor='var(--border)';this.style.background='var(--card)'}"><i class="feather" data-icon="${ic.id}" style="display:inline-block;width:20px;height:20px;color:currentColor" aria-hidden="true"></i></button>`).join('')}
function renderColorGrid(selectedColor='#3B82F6'){return COLOR_PRESETS.map(c=>`<button type="button" onclick="selectProjectColor('${c.hex}')" title="${c.name}" style="width:36px;height:36px;border-radius:50%;border:3px solid ${c.hex===selectedColor?'#fff':'transparent'};background:${c.hex};cursor:pointer;transition:all .2s;box-shadow:${c.hex===selectedColor?'0 0 0 2px var(--sy)':'none'}" onmouseover="this.style.transform='scale(1.15)'" onmouseout="this.style.transform='scale(1)'"></button>`).join('')}
function selectProjectIcon(iconId){document.getElementById('projIconValue').value=iconId;document.querySelectorAll('#iconGrid button').forEach(b=>{const ic=b.querySelector('i');if(ic){const isSelected=ic.dataset.icon===iconId;b.style.borderColor=isSelected?'var(--sy)':'var(--border)';b.style.background=isSelected?'var(--sy-bg)':'var(--card)';b.style.color=isSelected?'var(--sy)':'var(--fg)'}});const preview=document.getElementById('iconPreview');if(preview){preview.innerHTML=`<i class="feather" data-icon="${iconId}" style="display:inline-block;width:24px;height:24px;color:currentColor" aria-hidden="true"></i>`;if(window.loadFeatherIcons)loadFeatherIcons()}}
function selectProjectColor(hex){document.getElementById('projColorValue').value=hex;document.getElementById('projColorPicker').value=hex;document.querySelectorAll('#colorGrid button').forEach(b=>{const isSelected=b.title===COLOR_PRESETS.find(c=>c.hex===hex)?.name;b.style.borderColor=isSelected?'#fff':'transparent';b.style.boxShadow=isSelected?'0 0 0 2px var(--sy)':'none'});const preview=document.getElementById('iconPreviewBox');if(preview)preview.style.background=hex}
function openCreateProjectModal(context='task'){window.projectCreationContext=context;const modal=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" style="max-width:560px;max-height:90vh;overflow-y:auto"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem"><div style="font-size:1.15rem;font-weight:700;color:var(--fg)"><i class="fas fa-folder-plus" style="color:var(--sy);margin-right:.5rem"></i>Nuevo Proyecto</div><button onclick="closeModal()" style="padding:.5rem;border:none;background:transparent;color:var(--mt);cursor:pointer;font-size:1.2rem">&times;</button></div><div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:12px"><div id="iconPreviewBox" style="width:56px;height:56px;border-radius:14px;background:#3B82F6;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;flex-shrink:0"><span id="iconPreview"><i class="feather" data-icon="folder" style="display:inline-block;width:24px;height:24px;color:currentColor" aria-hidden="true"></i></span></div><div style="flex:1"><div style="font-size:.75rem;color:var(--mt);margin-bottom:.25rem">Vista previa</div><div style="font-size:1rem;font-weight:600;color:var(--fg)" id="projNamePreview">Nuevo Proyecto</div></div></div><input type="hidden" id="projIconValue" value="folder"><input type="hidden" id="projColorValue" value="#3B82F6"><div class="modal-field"><label>Nombre del Proyecto *</label><input type="text" id="projName" placeholder="Ej: Rediseno Web, Campana Q1, etc." oninput="const p=document.getElementById('projNamePreview');if(p)p.textContent=this.value||'Nuevo Proyecto'" style="width:100%"></div><div class="modal-field"><label>Descripcion (opcional)</label><textarea id="projDesc" rows="2" placeholder="Descripcion breve..." style="resize:vertical"></textarea></div><div class="modal-field"><label>Icono del Proyecto</label><div id="iconGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(44px,1fr));gap:.4rem;max-height:200px;overflow-y:auto;padding:.5rem;background:var(--bg);border:1px solid var(--border);border-radius:10px">${renderIconGrid('folder')}</div></div><div class="modal-field"><label>Color del Proyecto</label><div style="display:flex;align-items:center;gap:1rem"><div id="colorGrid" style="display:flex;gap:.5rem;flex-wrap:wrap;flex:1">${renderColorGrid('#3B82F6')}</div><input type="color" id="projColorPicker" value="#3B82F6" onchange="selectProjectColor(this.value)" style="width:40px;height:36px;border:none;border-radius:8px;cursor:pointer;flex-shrink:0" title="Color personalizado"></div></div><div style="display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem"><button onclick="closeModal()" class="m-cancel">Cancelar</button><button onclick="createProject()" class="m-ok"><i class="fas fa-check"></i> Crear Proyecto</button></div></div></div>`;document.getElementById('modalRoot').innerHTML=modal;if(window.loadFeatherIcons)loadFeatherIcons()}

async function createProject(){const name=document.getElementById('projName')?.value?.trim();const description=document.getElementById('projDesc')?.value?.trim()||null;const color=document.getElementById('projColorValue')?.value||document.getElementById('projColorPicker')?.value||'#3B82F6';const icono=document.getElementById('projIconValue')?.value||'folder';if(!name)return toast('Nombre del proyecto requerido');try{const r=await fetch('/api/styly/projects',{method:'POST',headers:hdrs,body:JSON.stringify({name,description,color,icono})});const d=await r.json();if(d.error)throw new Error(d.error);toast('Proyecto creado');projects.push(d.project);const newProjectId=d.project.id;const context=window.projectCreationContext||'task';closeModal();await new Promise(resolve=>setTimeout(resolve,100));if(context==='admin'){renderProyectos(document.getElementById('modContent'))}else{openNewTaskModal(newProjectId)}}catch(e){toast('Error: '+e.message)}}

function openEditProjectModal(projectId){const p=projects.find(pr=>pr.id===projectId);if(!p)return toast('Proyecto no encontrado');const curIcon=p.icono||'folder';const curColor=p.color||'#3B82F6';const modal=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" style="max-width:560px;max-height:90vh;overflow-y:auto"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem"><div style="font-size:1.15rem;font-weight:700;color:var(--fg)"><i class="fas fa-edit" style="color:var(--sy);margin-right:.5rem"></i>Editar Proyecto</div><button onclick="closeModal()" style="padding:.5rem;border:none;background:transparent;color:var(--mt);cursor:pointer;font-size:1.2rem">&times;</button></div><div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:12px"><div id="iconPreviewBox" style="width:56px;height:56px;border-radius:14px;background:${curColor};display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;flex-shrink:0"><span id="iconPreview"><i class="feather" data-icon="${curIcon}" style="display:inline-block;width:24px;height:24px;color:currentColor" aria-hidden="true"></i></span></div><div style="flex:1"><div style="font-size:.75rem;color:var(--mt);margin-bottom:.25rem">Vista previa</div><div style="font-size:1rem;font-weight:600;color:var(--fg)" id="projNamePreview">${esc(p.name)}</div></div></div><input type="hidden" id="projIconValue" value="${curIcon}"><input type="hidden" id="projColorValue" value="${curColor}"><input type="hidden" id="editProjId" value="${p.id}"><div class="modal-field"><label>Nombre del Proyecto *</label><input type="text" id="projName" value="${esc(p.name)}" oninput="const pv=document.getElementById('projNamePreview');if(pv)pv.textContent=this.value||'Proyecto'" style="width:100%"></div><div class="modal-field"><label>Descripcion (opcional)</label><textarea id="projDesc" rows="2" style="resize:vertical">${esc(p.description||'')}</textarea></div><div class="modal-field"><label>Icono del Proyecto</label><div id="iconGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(44px,1fr));gap:.4rem;max-height:200px;overflow-y:auto;padding:.5rem;background:var(--bg);border:1px solid var(--border);border-radius:10px">${renderIconGrid(curIcon)}</div></div><div class="modal-field"><label>Color del Proyecto</label><div style="display:flex;align-items:center;gap:1rem"><div id="colorGrid" style="display:flex;gap:.5rem;flex-wrap:wrap;flex:1">${renderColorGrid(curColor)}</div><input type="color" id="projColorPicker" value="${curColor}" onchange="selectProjectColor(this.value)" style="width:40px;height:36px;border:none;border-radius:8px;cursor:pointer;flex-shrink:0" title="Color personalizado"></div></div><div style="display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem"><button onclick="closeModal()" class="m-cancel">Cancelar</button><button onclick="updateProject()" class="m-ok"><i class="fas fa-save"></i> Guardar Cambios</button></div></div></div>`;document.getElementById('modalRoot').innerHTML=modal;if(window.loadFeatherIcons)loadFeatherIcons()}

async function updateProject(){const id=document.getElementById('editProjId')?.value;const name=document.getElementById('projName')?.value?.trim();const description=document.getElementById('projDesc')?.value?.trim()||null;const color=document.getElementById('projColorValue')?.value||'#3B82F6';const icono=document.getElementById('projIconValue')?.value||'folder';if(!name)return toast('Nombre del proyecto requerido');try{const r=await fetch(`/api/styly/projects/${id}`,{method:'PUT',headers:hdrs,body:JSON.stringify({name,description,color,icono})});const d=await r.json();if(d.error)throw new Error(d.error);toast('Proyecto actualizado');const idx=projects.findIndex(p=>p.id==id);if(idx!==-1)projects[idx]={...projects[idx],name,description,color,icono};closeModal();renderProyectos(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}

function openCreateUserModal(){const modal=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" style="max-width:500px"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem"><div style="font-size:1.15rem;font-weight:700;color:var(--fg)"><i class="fas fa-user-plus" style="color:var(--sy);margin-right:.5rem"></i>Nuevo Usuario</div><button onclick="closeModal()" style="padding:.5rem;border:none;background:transparent;color:var(--mt);cursor:pointer;font-size:1.2rem">&times;</button></div><div class="modal-field"><label>Nombre Completo *</label><input type="text" id="userName" placeholder="Ej: Juan P√©rez" style="width:100%"></div><div class="modal-field"><label>Email *</label><input type="email" id="userEmail" placeholder="correo@ejemplo.com" style="width:100%"></div><div class="modal-field"><label>Contrase√±a *</label><input type="password" id="userPassword" placeholder="M√≠nimo 6 caracteres" style="width:100%"></div><div style="display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem"><button onclick="closeModal()" class="m-cancel">Cancelar</button><button onclick="createUser()" class="m-ok"><i class="fas fa-check"></i> Crear Usuario</button></div></div></div>`;document.getElementById('modalRoot').innerHTML=modal}

async function createUser(){const name=document.getElementById('userName')?.value?.trim();const email=document.getElementById('userEmail')?.value?.trim();const password=document.getElementById('userPassword')?.value;if(!name)return toast('Nombre requerido');if(!email)return toast('Email requerido');if(!password||password.length<6)return toast('Contrase√±a m√≠nimo 6 caracteres');try{const r=await fetch('/api/styly/users',{method:'POST',headers:hdrs,body:JSON.stringify({name,email,password})});const d=await r.json();if(d.error)throw new Error(d.error);toast('Usuario creado');users.push(d.user);const newUserId=d.user.id;closeModal();await new Promise(resolve=>setTimeout(resolve,100));openNewTaskModal(null,'Pendiente',newUserId)}catch(e){toast('Error: '+e.message)}}

async function createTask(){const titulo=document.getElementById('newDesc')?.value?.trim();const notas=document.getElementById('newNotas')?.value?.trim()||null;const proyecto_id=document.getElementById('newProject')?.value;const seccion=document.getElementById('newModule')?.value?.trim()||null;const estado=document.getElementById('newStatus')?.value;const prioridad=document.getElementById('newPriority')?.value;const assignedUserId=document.getElementById('newAssigned')?.value||null;const fecha_inicio=document.getElementById('newStartDate')?.value||null;const fecha_vencimiento=document.getElementById('newDueDate')?.value||null;if(!titulo)return toast('T√≠tulo requerido');if(!proyecto_id)return toast('Proyecto requerido');try{const nextId=Math.max(0,...tasks.map(t=>{const match=t.task_id?.match(/T-(\d+)/);return match?parseInt(match[1]):0}))+1;const taskId=`T-${String(nextId).padStart(3,'0')}`;const payload={task_id:taskId,titulo,notas,proyecto_id,seccion,prioridad,fecha_inicio,fecha_vencimiento};if(assignedUserId){payload.asignados=[parseInt(assignedUserId)];}const r=await fetch('/api/styly/tasks',{method:'POST',headers:hdrs,body:JSON.stringify(payload)});const d=await r.json();if(d.error)throw new Error(d.error);toast('Tarea creada');closeModal();tasksLoaded=false;renderTareas(document.getElementById('modContent'))}catch(e){toast('Error: '+e.message)}}

async function renderProyectos(m){
  const header=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem"><h2 style="color:var(--fg);margin:0;font-size:1.5rem"><i class="fas fa-folder" style="margin-right:.5rem;color:var(--sy)"></i>Administrar Proyectos</h2><div style="display:flex;gap:.5rem"><button onclick="openCreateProjectModal('admin')" class="glass-btn"><i class="fas fa-plus"></i> Nuevo Proyecto</button><button onclick="switchTasksSubView('tareas')" class="glass-btn" style="background:rgba(139,92,246,0.15)"><i class="fas fa-arrow-left"></i> Volver</button></div></div>`;
  if(!projects||projects.length===0){
    m.innerHTML=header+`<div style="text-align:center;padding:3rem;color:var(--mt)"><div style="font-size:2.5rem;margin-bottom:1rem"><i class="feather" data-icon="folder" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></div><div style="font-size:1rem;font-weight:600">No hay proyectos</div><div style="font-size:.85rem;margin-top:.5rem">Crea tu primer proyecto para comenzar</div></div>`;
    return;
  }
  const projectsList=projects.map(p=>{const cfg=getProjectConfig(p);const taskCount=tasks.filter(t=>t.proyecto_id===p.id).length;const doneCount=tasks.filter(t=>t.proyecto_id===p.id&&t.estado==='Completada').length;return`<div class="project-admin-card" style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;background:linear-gradient(135deg,${cfg.color}15,${cfg.color}05);border:2px solid ${cfg.color}40;border-radius:14px;margin-bottom:1rem;transition:all .2s"><div style="display:flex;align-items:center;gap:.75rem;flex:1;min-width:0">${getProjectIconBox(p,44)}<div style="min-width:0"><div style="font-size:1.1rem;font-weight:700;color:var(--fg)">${esc(p.name)}</div><div style="font-size:.8rem;color:var(--mt);margin-top:.15rem">${p.description||'Sin descripcion'}</div><div style="font-size:.75rem;color:var(--mt);font-weight:400;margin-top:.35rem;display:flex;flex-wrap:wrap;gap:.75rem"><span>${taskCount} tareas</span><span>${doneCount} completadas</span><span>${new Date(p.created_at).toLocaleDateString('es-MX')}</span></div></div></div><div style="display:flex;gap:.5rem;flex-shrink:0"><button onclick="openEditProjectModal(${p.id})" style="padding:.5rem .85rem;border-radius:10px;border:1px solid rgba(139,92,246,0.4);background:rgba(139,92,246,0.1);color:#8B5CF6;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap" onmouseover="this.style.background='#8B5CF6';this.style.color='#fff'" onmouseout="this.style.background='rgba(139,92,246,0.1)';this.style.color='#8B5CF6'"><i class="fas fa-edit"></i> Editar</button><button onclick="deleteProject(${p.id})" style="padding:.5rem .85rem;border-radius:10px;border:1px solid rgba(239,68,68,0.4);background:rgba(239,68,68,0.1);color:#EF4444;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap" onmouseover="this.style.background='#EF4444';this.style.color='#fff'" onmouseout="this.style.background='rgba(239,68,68,0.1)';this.style.color='#EF4444'"><i class="fas fa-trash"></i> Eliminar</button></div></div>`}).join('');
  m.innerHTML=header+projectsList;
  if(window.loadFeatherIcons)loadFeatherIcons()
}

async function deleteProject(id){
  if(!confirm('¬øEst√°s seguro de que deseas eliminar este proyecto? No se puede deshacer.'))return;
  try{
    console.log('Deleting project',id,'with headers',hdrs);
    const r=await fetch(`/api/styly/projects/${id}`,{method:'DELETE',headers:hdrs});
    console.log('Delete response status:',r.status);
    const text=await r.text();
    console.log('Delete response text:',text.substring(0,200));
    if(!r.ok){
      throw new Error(`Error HTTP ${r.status}: ${text.includes('<')?'Error del servidor':text}`);
    }
    let d;
    try{d=JSON.parse(text)}catch{throw new Error('Respuesta no v√°lida: '+text.substring(0,100))}
    if(d.error)throw new Error(d.error);
    toast('Proyecto eliminado');
    projects=projects.filter(p=>p.id!==id);
    await renderProyectos(document.getElementById('modContent'));
  }catch(e){
    console.error('deleteProject error:',e.message);
    toast('Error: '+e.message);
  }
}

// ================================================================
// BULK IMPORT FEATURE
// ================================================================
let parsedImportTasks = [];
let importFileName = '';

function openBulkImportModal() {
  parsedImportTasks = [];
  importFileName = '';
  const modal = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal-box" style="max-width:750px;max-height:90vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem">
        <div style="font-size:1.15rem;font-weight:700;color:var(--fg)"><i class="fas fa-file-import" style="color:var(--sy);margin-right:.5rem"></i>Importar Tareas desde Excel</div>
        <button onclick="closeModal()" style="padding:.5rem;border:none;background:transparent;color:var(--mt);cursor:pointer;font-size:1.2rem">&times;</button>
      </div>

      <div class="import-actions-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
        <button onclick="downloadTemplate()" class="glass-btn" style="padding:1.25rem;display:flex;flex-direction:column;align-items:center;gap:.5rem;text-align:center">
          <i class="fas fa-download" style="font-size:1.5rem;color:var(--sy)"></i>
          <span style="font-weight:600">Descargar Template</span>
          <span style="font-size:.75rem;color:var(--mt)">Archivo Excel con formato y ejemplo</span>
        </button>
        <label style="padding:1.25rem;display:flex;flex-direction:column;align-items:center;gap:.5rem;text-align:center;cursor:pointer;background:rgba(139,92,246,0.08);border:2px dashed rgba(139,92,246,0.3);border-radius:12px;transition:all .3s" onmouseover="this.style.borderColor='var(--sy)';this.style.background='rgba(139,92,246,0.15)'" onmouseout="this.style.borderColor='rgba(139,92,246,0.3)';this.style.background='rgba(139,92,246,0.08)'">
          <i class="fas fa-upload" style="font-size:1.5rem;color:var(--sy)"></i>
          <span style="font-weight:600">Subir Archivo</span>
          <span style="font-size:.75rem;color:var(--mt)">.xlsx, .xls o .csv</span>
          <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(this.files[0])" style="display:none">
        </label>
      </div>

      <div id="importPreview"></div>
      <div id="importActions" style="display:none;margin-top:1rem;display:flex;justify-content:flex-end;gap:.75rem">
      </div>
    </div>
  </div>`;
  document.getElementById('modalRoot').innerHTML = modal;
}

function downloadTemplate() {
  if (typeof XLSX === 'undefined') { toast('Error: libreria XLSX no cargada'); return; }

  const headers = ['task_id', 'titulo', 'descripcion', 'notas', 'proyecto', 'seccion', 'prioridad', 'asignado', 'fecha_inicio', 'fecha_vencimiento'];
  const example = ['T-001', 'Dise√±o del panel principal', 'Crear layout responsive', 'Incluir dise√±o mobile-first, animaciones suaves, componentes reutilizables', 'STYLY Panel', 'Frontend', 'Alta', 'Admin', '2026-02-10', '2026-02-24'];
  const instructions = ['(auto)', '* Requerido', 'Breve descripcion', 'Detalles y notas extensas (opcional)', '* Nombre del proyecto (debe existir)', 'Categoria o modulo (opcional)', 'Alta / Media / Baja', 'Nombre del usuario (opcional)', 'YYYY-MM-DD (opcional)', 'YYYY-MM-DD (opcional)'];

  const ws = XLSX.utils.aoa_to_sheet([headers, example, instructions]);

  // Column widths
  ws['!cols'] = [
    {wch: 10}, {wch: 30}, {wch: 30}, {wch: 45},
    {wch: 20}, {wch: 15}, {wch: 10}, {wch: 15}, {wch: 14}, {wch: 14}
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Tareas');
  XLSX.writeFile(wb, 'STYLY_Template_Tareas.xlsx');
  toast('Template descargado');
}

function handleFileUpload(file) {
  if (!file) return;
  importFileName = file.name;
  if (typeof XLSX === 'undefined') { toast('Error: libreria XLSX no cargada'); return; }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });

      if (rows.length === 0) { toast('El archivo esta vacio'); return; }

      // Filter out instruction rows (rows where titulo starts with '*' or '(' or is empty)
      const validRows = rows.filter(r =>
        r.titulo && !r.titulo.startsWith('*') && !r.titulo.startsWith('(')
      );

      if (validRows.length === 0) { toast('No se encontraron tareas validas'); return; }

      parsedImportTasks = validRows.map(r => ({
        task_id: r.task_id || '',
        titulo: r.titulo || '',
        descripcion: r.descripcion || '',
        notas: r.notas || '',
        proyecto: r.proyecto || '',
        seccion: r.seccion || '',
        prioridad: r.prioridad || 'Media',
        asignado: r.asignado || '',
        fecha_inicio: formatExcelDate(r.fecha_inicio),
        fecha_vencimiento: formatExcelDate(r.fecha_vencimiento)
      }));

      renderImportPreview();
    } catch (err) {
      toast('Error leyendo archivo: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function formatExcelDate(val) {
  if (!val) return '';
  // If it's already a string in YYYY-MM-DD format
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  // If it's an Excel date number
  if (typeof val === 'number') {
    const d = new Date((val - 25569) * 86400 * 1000);
    return d.toISOString().split('T')[0];
  }
  // Try parsing as date string
  const d = new Date(val);
  if (!isNaN(d.getTime())) return d.toISOString().split('T')[0];
  return '';
}

function renderImportPreview() {
  const preview = document.getElementById('importPreview');
  if (!parsedImportTasks.length) {
    preview.innerHTML = '';
    return;
  }

  // Check which projects exist
  const existingProjects = projects.map(p => p.name.toLowerCase());
  const missingProjects = [...new Set(
    parsedImportTasks
      .map(t => t.proyecto)
      .filter(p => p && !existingProjects.includes(p.toLowerCase()))
  )];

  let html = `<div style="margin-bottom:1rem">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
      <span style="font-weight:600;color:var(--fg)">${parsedImportTasks.length} tareas encontradas</span>
      <span style="font-size:.8rem;color:var(--mt)">${importFileName || 'Archivo cargado'}</span>
    </div>`;

  if (missingProjects.length > 0) {
    html += `<div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:.75rem;margin-bottom:1rem;font-size:.85rem">
      <strong style="color:#D97706"><i class="fas fa-exclamation-triangle"></i> Proyectos no encontrados:</strong>
      <span style="color:var(--mt)"> ${missingProjects.join(', ')} ‚Äî se crearan automaticamente</span>
    </div>`;
  }

  html += `<div style="overflow-x:auto;border:1px solid var(--border);border-radius:10px">
    <table style="width:100%;border-collapse:collapse;font-size:.8rem">
      <thead><tr style="background:rgba(255,255,255,0.05)">
        <th style="padding:.6rem;text-align:left;border-bottom:1px solid var(--border);color:var(--mt)">#</th>
        <th style="padding:.6rem;text-align:left;border-bottom:1px solid var(--border);color:var(--mt)">Titulo</th>
        <th style="padding:.6rem;text-align:left;border-bottom:1px solid var(--border);color:var(--mt)">Notas</th>
        <th style="padding:.6rem;text-align:left;border-bottom:1px solid var(--border);color:var(--mt)">Proyecto</th>
        <th style="padding:.6rem;text-align:left;border-bottom:1px solid var(--border);color:var(--mt)">Prioridad</th>
        <th style="padding:.6rem;text-align:left;border-bottom:1px solid var(--border);color:var(--mt)">Vence</th>
      </tr></thead>
      <tbody>`;

  parsedImportTasks.forEach((t, i) => {
    const isMissing = t.proyecto && !existingProjects.includes(t.proyecto.toLowerCase());
    html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
      <td style="padding:.5rem;color:var(--mt)">${i + 1}</td>
      <td style="padding:.5rem;color:var(--fg);font-weight:500">${esc(t.titulo)}</td>
      <td style="padding:.5rem;color:var(--mt);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(t.notas)}">${esc(t.notas ? t.notas.substring(0, 40) + (t.notas.length > 40 ? '...' : '') : '-')}</td>
      <td style="padding:.5rem;color:${isMissing ? '#D97706' : 'var(--fg)'}">${esc(t.proyecto) || '-'}${isMissing ? ' <i class="fas fa-plus-circle" style="font-size:.65rem"></i>' : ''}</td>
      <td style="padding:.5rem"><span style="padding:2px 6px;border-radius:4px;font-size:.7rem;font-weight:600;background:${t.prioridad === 'Alta' ? 'rgba(239,68,68,.15)' : t.prioridad === 'Baja' ? 'rgba(107,114,128,.1)' : 'rgba(245,158,11,.15)'};color:${t.prioridad === 'Alta' ? '#DC2626' : t.prioridad === 'Baja' ? '#6B7280' : '#D97706'}">${t.prioridad}</span></td>
      <td style="padding:.5rem;color:var(--mt)">${t.fecha_vencimiento || '-'}</td>
    </tr>`;
  });

  html += `</tbody></table></div></div>
    <div style="display:flex;justify-content:flex-end;gap:.75rem;margin-top:1rem">
      <button onclick="parsedImportTasks=[];document.getElementById('importPreview').innerHTML='';toast('Datos limpiados')" class="m-cancel">Limpiar</button>
      <button onclick="confirmBulkImport()" class="m-ok"><i class="fas fa-check"></i> Importar ${parsedImportTasks.length} Tareas</button>
    </div>`;

  preview.innerHTML = html;
}

async function confirmBulkImport() {
  if (!parsedImportTasks.length) { toast('No hay tareas para importar'); return; }

  try {
    // 1. Create missing projects first
    const existingProjectMap = {};
    projects.forEach(p => { existingProjectMap[p.name.toLowerCase()] = p.id; });

    const uniqueProjects = [...new Set(parsedImportTasks.map(t => t.proyecto).filter(Boolean))];
    for (const projName of uniqueProjects) {
      if (!existingProjectMap[projName.toLowerCase()]) {
        const r = await fetch('/api/styly/projects', {
          method: 'POST', headers: hdrs,
          body: JSON.stringify({ name: projName, description: '', color: '#3B82F6' })
        });
        const d = await r.json();
        if (d.project && d.project.id) {
          existingProjectMap[projName.toLowerCase()] = d.project.id;
          projects.push(d.project);
        }
      }
    }

    // 2. Auto-generate task IDs for tasks without one
    const existingIds = tasks.map(t => {
      const match = t.task_id?.match(/T-(\d+)/);
      return match ? parseInt(match[1]) : 0;
    });
    let nextId = Math.max(0, ...existingIds) + 1;

    // 3. Map tasks to API format
    const apiTasks = parsedImportTasks.map(t => {
      const taskId = t.task_id || `T-${String(nextId++).padStart(3, '0')}`;
      return {
        task_id: taskId,
        titulo: t.titulo,
        descripcion: t.descripcion || null,
        notas: t.notas || null,
        proyecto_id: existingProjectMap[t.proyecto.toLowerCase()] || (projects.length > 0 ? projects[0].id : 1),
        seccion: t.seccion || null,
        prioridad: t.prioridad || 'Media',
        fecha_inicio: t.fecha_inicio || null,
        fecha_vencimiento: t.fecha_vencimiento || null,
        asignados: t.asignado ? [t.asignado] : []
      };
    });

    // 4. Send to bulk-create
    const r = await fetch('/api/styly/tasks/bulk-create', {
      method: 'POST', headers: hdrs,
      body: JSON.stringify({ tasks: apiTasks })
    });

    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Error en importacion');

    toast(`${d.created}/${d.total_attempted} tareas importadas`);
    closeModal();
    tasksLoaded = false;
    renderTareas(document.getElementById('modContent'));
  } catch (e) {
    toast('Error: ' + e.message);
  }
}

renderTab();
</script>
<script src="/emoji-to-svg.js"></script></body>
</html>
