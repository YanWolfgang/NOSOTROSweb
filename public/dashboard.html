<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Central â€” Dashboard</title>
<link rel="icon" type="image/png" href="/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/styles.css">
<style>
/* ========== MOBILE-FIRST DASHBOARD APP ========== */

/* --- Stats row: horizontal scroll on mobile --- */
@media(max-width:768px){
  .stats-row{display:flex!important;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;gap:.5rem;padding-bottom:.5rem;scrollbar-width:none;grid-template-columns:unset!important}
  .stats-row::-webkit-scrollbar{display:none}
  .stats-row .stat-box{min-width:160px;flex-shrink:0;scroll-snap-align:start;padding:.85rem}
  .stats-row .stat-box .s-value{font-size:1.4rem}
  .stats-row .stat-box .s-label{font-size:.7rem}
  .stats-row .stat-box .s-sub{font-size:.7rem}

  /* Dash cols stack */
  .dash-cols{grid-template-columns:1fr!important;gap:1rem}
  .dash-section{margin-bottom:1.25rem}
  .dash-section-title{font-size:.9rem}

  /* Emp card mobile */
  .emp-card{padding:.7rem}
  .emp-row{flex-wrap:wrap;gap:.5rem;padding:.7rem 0}
  .emp-info{flex-basis:calc(100% - 50px);min-width:0}
  .emp-stats{width:100%;justify-content:space-around;padding-top:.4rem;border-top:1px solid var(--glass-border);margin-top:.2rem}
  .emp-num{min-width:unset;flex:1}
  .emp-num .n{font-size:.9rem}
  .emp-biz-chips{margin-top:.2rem}
  .emp-alert{font-size:.75rem;padding:.45rem .7rem}

  /* Calendar mobile */
  .cal-mini{padding:.7rem}
  .cal-day{padding:.45rem 0}
  .cal-day-item{padding:.35rem .5rem;font-size:.74rem;min-height:36px;align-items:center}

  /* Biz intel: horizontal scroll */
  .biz-intel-grid{display:flex!important;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;gap:.6rem;padding-bottom:.5rem;scrollbar-width:none;grid-template-columns:unset!important}
  .biz-intel-grid::-webkit-scrollbar{display:none}
  .biz-intel-card{min-width:240px;flex-shrink:0;scroll-snap-align:start}

  /* Styly section header buttons */
  .dash-section-title[style*="flex"]{flex-direction:column;align-items:flex-start!important;gap:.6rem!important}
  .dash-section-title[style*="flex"]>div{width:100%;display:flex;gap:.4rem}
  .dash-section-title[style*="flex"]>div>*{flex:1;text-align:center;justify-content:center;min-height:40px;display:inline-flex;align-items:center;font-size:.78rem!important;padding:.5rem .6rem!important}

  /* Trend cards */
  .trend-card{padding:.7rem .85rem}
  .trend-text{font-size:.8rem}
  .trend-action{padding:.4rem .7rem;font-size:.74rem;min-height:36px;display:inline-flex;align-items:center}

  /* Report button */
  .report-btn{min-height:52px;font-size:.9rem;border-radius:14px}

  /* AI section mobile */
  .ai-bar{gap:.4rem}
  .ai-bar input{min-height:48px;font-size:.9rem;border-radius:14px;padding:.7rem 1rem}
  .ai-bar button{min-height:48px;border-radius:14px;padding:.7rem 1.1rem;font-size:.85rem}
  .ai-chips{gap:.35rem;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:.3rem}
  .ai-chips::-webkit-scrollbar{display:none}
  .ai-chip{flex-shrink:0;min-height:38px;display:inline-flex;align-items:center;padding:.4rem .85rem;font-size:.8rem}
  .ai-answer{padding:.85rem 1rem;font-size:.86rem}
  .chat-toggle{font-size:.84rem;min-height:44px;display:inline-flex;align-items:center}

  /* Chat mobile */
  .chat-messages{height:300px}
  .chat-msg{max-width:88%;font-size:.86rem}
  .chat-input input{min-height:46px;font-size:.86rem}
  .chat-input button{min-height:46px;padding:.5rem 1rem}
  .chat-header{flex-wrap:wrap;gap:.4rem}
  .chat-header select{min-height:36px;flex:1}
  .chat-header button{min-height:36px}

  /* Report modal */
  .report-modal{padding:1rem;border-radius:18px;max-height:92vh}
  .report-actions{flex-direction:column;gap:.4rem}
  .report-actions button{width:100%;min-height:46px;text-align:center;border-radius:12px;font-size:.84rem}

  /* Page header */
  .page-header{margin-bottom:1rem}
  .page-header h1{font-size:1.2rem}
  .page-header p{font-size:.82rem}

  /* Content area padding */
  .content{padding:.85rem!important;padding-top:3.6rem!important}
}

/* Extra small screens */
@media(max-width:380px){
  .stats-row .stat-box{min-width:145px}
  .biz-intel-card{min-width:220px}
  .content{padding:.65rem!important;padding-top:3.4rem!important}
  .ai-bar{flex-direction:column}
  .ai-bar button{width:100%}
}

/* Styly section header */
.styly-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem}
.styly-header-actions{display:flex;gap:.5rem}
.styly-btn-ai,.styly-btn-go{padding:.45rem .85rem;border-radius:10px;font-size:.78rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:.3rem;min-height:38px;transition:all .2s ease}
.styly-btn-ai{border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur)}
.styly-btn-ai:hover{border-color:var(--accent);background:rgba(139,92,246,.08)}
.styly-btn-go{background:#EC4899;color:#fff;border:none;text-decoration:none}
.styly-btn-go:hover{background:#db2777}
@media(max-width:768px){
  .styly-header{flex-direction:column;align-items:flex-start;gap:.6rem}
  .styly-header-actions{width:100%;gap:.4rem}
  .styly-btn-ai,.styly-btn-go{flex:1;justify-content:center;min-height:44px;border-radius:12px;font-size:.82rem}
}

/* ========== KPI & CHARTS (all screens) ========== */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.6rem;margin-bottom:1.25rem}
.kpi-card{background:var(--card);border:1px solid var(--glass-border);border-radius:16px;padding:1rem;text-align:center;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur);transition:all .3s ease}
.kpi-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.15)}
.kpi-label{font-size:.68rem;color:var(--mt);font-weight:600;text-transform:uppercase;letter-spacing:.04em}
.kpi-value{font-size:1.8rem;font-weight:800;margin:.2rem 0}
.kpi-bar{background:rgba(255,255,255,.08);height:5px;border-radius:3px;margin-top:.5rem;overflow:hidden}
.kpi-bar-fill{height:100%;border-radius:3px;transition:width .6s ease}

/* Donut Chart */
.donut-wrap{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.3rem}
.donut{position:relative;width:72px;height:72px}
.donut svg{width:100%;height:100%;transform:rotate(-90deg)}
.donut circle{fill:none;stroke-width:6;stroke-linecap:round}
.donut .donut-bg{stroke:rgba(255,255,255,.08)}
.donut .donut-fill{transition:stroke-dashoffset .8s ease}
.donut-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:800}

/* Two-col sections */
.dash-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem}
.dash-grid-2-1{display:grid;grid-template-columns:2fr 1fr;gap:1rem;margin-bottom:1rem}
.dash-panel{background:var(--card);border:1px solid var(--glass-border);border-radius:16px;padding:1.1rem;-webkit-backdrop-filter:var(--blur);backdrop-filter:var(--blur);transition:all .3s ease}
.dash-panel:hover{border-color:rgba(139,92,246,.2);box-shadow:0 4px 20px rgba(0,0,0,.1)}
.dash-panel-title{font-weight:700;color:var(--fg);font-size:.88rem;margin-bottom:.8rem;display:flex;align-items:center;gap:.4rem}

/* Progress rows */
.progress-row{margin-bottom:.75rem}
.progress-row:last-child{margin-bottom:0}
.progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem}
.progress-name{font-size:.8rem;font-weight:600;color:var(--fg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:55%}
.progress-meta{font-size:.72rem;font-weight:600;display:flex;align-items:center;gap:.3rem}
.progress-track{background:rgba(255,255,255,.06);height:8px;border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width .6s ease}
.progress-stacked{display:flex;gap:1px;height:8px;border-radius:4px;overflow:hidden;background:rgba(255,255,255,.06)}
.progress-stacked>div{height:100%;transition:width .6s ease}

/* User load badges */
.user-badges{display:flex;gap:.35rem;font-size:.7rem;flex-wrap:wrap}
.user-badge{padding:2px 7px;border-radius:5px;font-weight:600}
.user-badge.red{background:rgba(239,68,68,.12);color:#EF4444}
.user-badge.yellow{background:rgba(245,158,11,.12);color:#F59E0B}
.user-badge.green{background:rgba(16,185,129,.12);color:#10B981}

/* Urgent task card */
.urgent-item{display:flex;align-items:flex-start;gap:.7rem;padding:.75rem;border-radius:12px;border-left:3px solid #EF4444;background:rgba(239,68,68,.04);margin-bottom:.5rem;transition:background .2s ease}
.urgent-item:hover{background:rgba(239,68,68,.07)}
.urgent-item .urgent-body{flex:1;min-width:0}
.urgent-item .urgent-id{font-size:.72rem;font-weight:700;color:#EC4899}
.urgent-item .urgent-desc{font-size:.84rem;color:var(--fg);margin-top:.2rem;line-height:1.45}
.urgent-item .urgent-meta{font-size:.72rem;color:var(--mt);margin-top:.3rem;display:flex;align-items:center;gap:.25rem;flex-wrap:wrap}
.urgent-item select{padding:.4rem .6rem;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg);font-size:.76rem;cursor:pointer;flex-shrink:0;min-height:38px;transition:border-color .2s}
.urgent-item select:hover{border-color:var(--accent)}

/* Priority chart */
.priority-row{margin-bottom:.9rem}
.priority-row:last-child{margin-bottom:0}
.priority-header{display:flex;justify-content:space-between;font-size:.82rem;margin-bottom:.4rem;align-items:center}
.priority-label{font-weight:600;display:flex;align-items:center;gap:.35rem}
.priority-count{color:var(--mt);font-weight:500}

/* Activity feed */
.activity-item{display:flex;align-items:center;gap:.6rem;padding:.6rem 0;border-bottom:1px solid var(--glass-border);transition:background .2s}
.activity-item:last-child{border-bottom:none}
.activity-item:hover{background:rgba(255,255,255,.02);border-radius:8px;padding-left:.4rem;padding-right:.4rem}
.activity-badge{padding:4px 10px;border-radius:8px;font-size:.7rem;font-weight:700;white-space:nowrap;flex-shrink:0}
.activity-id{font-size:.8rem;font-weight:600;color:#EC4899;flex-shrink:0}
.activity-desc{font-size:.82rem;color:var(--fg);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.activity-date{font-size:.72rem;color:var(--mt);flex-shrink:0}

/* ========== LIGHT THEME FIXES ========== */
[data-theme="light"] .kpi-bar{background:rgba(0,0,0,.06)}
[data-theme="light"] .donut .donut-bg{stroke:rgba(0,0,0,.08)}
[data-theme="light"] .progress-track,[data-theme="light"] .progress-stacked{background:rgba(0,0,0,.06)}
[data-theme="light"] .urgent-item{background:rgba(239,68,68,.05)}
[data-theme="light"] .urgent-item:hover{background:rgba(239,68,68,.08)}
[data-theme="light"] .dash-panel:hover{border-color:rgba(139,92,246,.15);box-shadow:0 4px 20px rgba(0,0,0,.06)}
[data-theme="light"] .activity-item:hover{background:rgba(0,0,0,.02)}
[data-theme="light"] .user-badge.red{background:rgba(239,68,68,.08);color:#DC2626}
[data-theme="light"] .user-badge.yellow{background:rgba(245,158,11,.08);color:#D97706}
[data-theme="light"] .user-badge.green{background:rgba(16,185,129,.08);color:#059669}
[data-theme="light"] .kpi-card:hover{box-shadow:0 8px 24px rgba(0,0,0,.08)}

/* ========== DESKTOP/TABLET ENHANCEMENTS ========== */
@media(min-width:769px){
  .kpi-grid{gap:.75rem}
  .kpi-card{padding:1.1rem}
  .dash-grid-2{gap:1.25rem}
  .dash-grid-2-1{gap:1.25rem}
  .dash-panel{padding:1.2rem}
}
@media(min-width:1200px){
  .kpi-grid{grid-template-columns:repeat(5,1fr)}
  .dash-panel-title{font-size:.9rem}
  .progress-name{font-size:.82rem}
  .urgent-item .urgent-desc{font-size:.86rem}
}

/* ========== KPI & GRID MOBILE ========== */
@media(max-width:768px){
  .kpi-grid{display:flex!important;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;gap:.5rem;padding-bottom:.4rem;scrollbar-width:none;grid-template-columns:unset!important}
  .kpi-grid::-webkit-scrollbar{display:none}
  .kpi-card{min-width:130px;flex-shrink:0;scroll-snap-align:start;padding:.85rem .7rem;border-radius:14px}
  .kpi-value{font-size:1.5rem}
  .kpi-label{font-size:.65rem}
  .donut{width:56px;height:56px}
  .donut-center{font-size:.9rem}

  .dash-grid-2,.dash-grid-2-1{grid-template-columns:1fr}
  .dash-panel{padding:.85rem;border-radius:14px}
  .dash-panel-title{font-size:.85rem}
  .progress-name{max-width:50%;font-size:.76rem}
  .progress-track,.progress-stacked{height:10px;border-radius:5px}

  .urgent-item{flex-direction:column;gap:.5rem}
  .urgent-item select{width:100%;min-height:44px;font-size:.82rem;border-radius:12px}

  .activity-item{flex-direction:column;align-items:flex-start;gap:.3rem;padding:.6rem 0}
  .activity-item>:first-child{order:0}
  .activity-desc{white-space:normal;line-height:1.4}
  .activity-date{align-self:flex-end;margin-top:-.4rem}
}
@media(max-width:380px){
  .kpi-card{min-width:120px;padding:.7rem .6rem}
  .kpi-value{font-size:1.3rem}
  .donut{width:48px;height:48px}
  .donut-center{font-size:.8rem}
}
.toast-container{position:fixed;top:1rem;right:1rem;z-index:9999;display:flex;flex-direction:column;gap:.4rem;pointer-events:none}
.toast{padding:.7rem 1.2rem;border-radius:12px;font-size:.84rem;font-weight:500;color:#fff;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);box-shadow:0 8px 32px rgba(0,0,0,.2);animation:toastIn .3s ease,toastOut .3s ease 2.7s both;max-width:350px;pointer-events:auto}
.toast.success{background:rgba(16,185,129,.9);border:1px solid rgba(16,185,129,.3)}
.toast.error{background:rgba(239,68,68,.9);border:1px solid rgba(239,68,68,.3)}
.toast.info{background:rgba(59,130,246,.9);border:1px solid rgba(59,130,246,.3)}
@keyframes toastIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateY(-10px)}}
</style>
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="content" id="content"></main>
</div>

<!-- Report Modal -->
<div id="reportOverlay" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeReport()">
  <div class="report-modal">
    <div id="reportBody"></div>
    <div class="report-actions">
      <button onclick="closeReport()">Cerrar</button>
      <button onclick="copyReport()"><i class="feather" data-icon="list" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Copiar</button>
      <button onclick="downloadReport()">ðŸ“¥ Descargar</button>
      <button class="primary" onclick="closeReport()">Listo</button>
    </div>
  </div>
</div>

<!-- Command Confirmation Modal -->
<div id="cmdOverlay" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeCmdModal()">
  <div class="report-modal" style="max-width:550px">
    <div id="cmdPreview"></div>
    <div class="report-actions">
      <button onclick="closeCmdModal()">Cancelar</button>
      <button class="primary" id="cmdConfirmBtn" onclick="confirmCommand()"><i class="feather" data-icon="check" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Ejecutar</button>
    </div>
  </div>
</div>

<script>
const BUSINESSES=[
  {id:'nosotros',name:'NOSOTROS',icon:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#8B5CF6',desc:'Plataforma de contenido digital con IA',url:'/nosotros.html'},
  {id:'duelazo',name:'DUELAZO',icon:'<i class="feather" data-icon="activity" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#10B981',desc:'Contenido deportivo y apuestas',url:'/duelazo.html'},
  {id:'spacebox',name:'SPACEBOX',icon:'<i class="feather" data-icon="package" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#3B82F6',desc:'Mini bodegas y almacenaje',url:'/spacebox.html'},
  {id:'styly',name:'STYLY',icon:'<i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',color:'#EC4899',desc:'Software para belleza y bienestar',url:'/styly.html'}
];
const BIZ_COLORS={nosotros:'#8B5CF6',duelazo:'#10B981',spacebox:'#3B82F6',styly:'#EC4899'};
const BIZ_ICONS={nosotros:'<i class="feather" data-icon="newspaper" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',duelazo:'<i class="feather" data-icon="activity" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',spacebox:'<i class="feather" data-icon="package" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>',styly:'<i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'};
const EMP_COLORS=['#8B5CF6','#10B981','#3B82F6','#EC4899','#F59E0B','#EF4444','#06B6D4','#84CC16'];

let user=null, token='';
const hdrs={};

function init(){
  token=localStorage.getItem('token');
  if(!token){window.location.href='/index.html';return}
  user=JSON.parse(localStorage.getItem('user')||'{}');
  hdrs['Authorization']='Bearer '+token;
  hdrs['Content-Type']='application/json';
  renderSidebar('dashboard');
  renderDashboard();
}

// ========== SIDEBAR ==========
function renderSidebar(active){
  const bs=user.businesses||[];
  const isAdmin=user.role==='admin';
  const items=BUSINESSES.filter(b=>isAdmin||bs.includes(b.id));
  document.getElementById('sidebar').innerHTML=`
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-header"><h2>Panel <span>Central</span></h2></div>
    <div class="sidebar-section">
      <div class="sidebar-label">General</div>
      <a href="/dashboard.html" class="sidebar-item ${active==='dashboard'?'active':''}"><span class="icon"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Dashboard</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Negocios</div>
      ${items.map(b=>`<a href="${b.url}" class="sidebar-item ${active===b.id?'active':''}" style="--accent:${b.color}"><span class="icon">${b.icon}</span>${b.name}</a>`).join('')}
    </div>
    ${isAdmin?`<div class="sidebar-section"><div class="sidebar-label">Admin</div><a href="/admin.html" class="sidebar-item ${active==='admin'?'active':''}"><span class="icon"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></span>Usuarios</a></div>`:''}
    <div class="sidebar-footer">
      <div class="sidebar-avatar">${(user.name||'U')[0].toUpperCase()}</div>
      <div class="sidebar-user"><div class="name">${user.name||'Usuario'}</div><div class="role">${user.role||'editor'}</div></div>
      <button class="theme-btn" onclick="toggleTheme()" title="Cambiar tema"><i class="feather" data-icon="moon" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
      <button class="theme-btn" onclick="logout()" title="Cerrar sesion" style="font-size:.75rem"><i class="feather" data-icon="share-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i></button>
    </div>`;
}

// ========== MAIN RENDER ==========
function renderDashboard(){
  const c=document.getElementById('content');
  c.innerHTML=`
    <div class="page-header"><h1>Dashboard</h1><p>Resumen general de actividad</p></div>

    <!-- AI PANEL -->
    <div class="dash-section" id="aiSection">
      <div class="ai-bar">
        <input type="text" id="aiInput" placeholder="Pregunta algo..." onkeydown="if(event.key==='Enter')askAI()">
        <button onclick="askAI()" id="aiBtn"><i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Preguntar</button>
      </div>
      <div class="ai-chips" id="aiChips"></div>
      <div class="ai-chips" id="cmdChips" style="margin-top:4px"></div>
      <div id="aiAnswer" style="display:none"></div>
      <span class="chat-toggle" id="chatToggle" onclick="toggleChat()"><i class="feather" data-icon="message-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Abrir chat completo con IA</span>
      <div id="chatPanel" style="display:none"></div>
    </div>

    <!-- STATS ROW -->
    <div class="stats-row" id="statsRow">
      <div class="stat-box"><div class="s-label">Contenido esta semana</div><div class="s-value">--</div></div>
      <div class="stat-box"><div class="s-label">Groq requests hoy</div><div class="s-value">--</div></div>
      <div class="stat-box"><div class="s-label">Aprobados</div><div class="s-value">--</div></div>
      <div class="stat-box"><div class="s-label">Pendientes</div><div class="s-value">--</div></div>
    </div>

    <!-- TWO COLUMNS -->
    <div class="dash-cols">
      <div>
        <div class="dash-section-title"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Equipo â€” Esta semana</div>
        <div class="emp-card" id="empCard"><div style="color:var(--mt);font-size:.82rem;padding:1rem;text-align:center">Cargando...</div></div>
      </div>
      <div>
        <div class="dash-section-title"><i class="feather" data-icon="calendar" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Proximos 7 dias</div>
        <div class="cal-mini" id="calMini"><div style="color:var(--mt);font-size:.82rem;padding:1rem;text-align:center">Cargando...</div></div>
      </div>
    </div>

    <!-- BIZ INTEL GRID -->
    <div class="dash-section">
      <div class="dash-section-title"><i class="feather" data-icon="trending-up" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Inteligencia por Negocio</div>
      <div class="biz-intel-grid" id="bizGrid"></div>
    </div>

    <!-- STYLY TASKS INTEGRATION -->
    <div class="dash-section">
      <div class="dash-section-title styly-header">
        <span><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Tareas STYLY</span>
        <div class="styly-header-actions">
          <button onclick="askAI('Dame un anÃ¡lisis completo del estado de las tareas de desarrollo de Styly: bottlenecks, prioridades y recomendaciones')" class="styly-btn-ai"><i class="feather" data-icon="cpu" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Analizar</button>
          <a href="/styly.html" onclick="localStorage.setItem('styly_tab','tareas')" class="styly-btn-go"><i class="feather" data-icon="monitor" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> STYLY</a>
        </div>
      </div>
      <div id="stylyTasksArea"></div>
    </div>

    <!-- TRENDS -->
    <div class="dash-section">
      <div class="dash-section-title"><i class="feather" data-icon="flame" style="display:inline-block;width:1em;height:1em;color:#F59E0B" aria-hidden="true"></i> Tendencias Detectadas</div>
      <div id="trendsArea"></div>
    </div>

    <!-- WEEKLY REPORT -->
    <button class="report-btn" onclick="genReport()" id="reportBtn"><i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Generar Reporte Semanal</button>
  `;

  // Start placeholder rotation
  rotatePlaceholder();
  // Load all data
  loadSuggestions();
  renderCmdChips();
  loadStats();
  loadTeam();
  loadCalendar();
  loadBizIntel();
  loadStylyTasksIntel();
  loadTrends();
}

// ========== PLACEHOLDER ROTATION ==========
const PLACEHOLDERS=['Que genero el equipo esta semana?','Que negocio necesita atencion?','Dame tendencias de hoy','Como va el rendimiento?','Distribuye tareas 60/40 entre Admin y Emilio','Analiza todas las tareas de STYLY','Genera 5 tareas de contenido en STYLY','Cambia prioridad a Alta donde status=Pendiente'];
let phIdx=0, phInterval;
function rotatePlaceholder(){
  const inp=document.getElementById('aiInput');if(!inp)return;
  phInterval=setInterval(()=>{
    phIdx=(phIdx+1)%PLACEHOLDERS.length;
    inp.style.opacity='0';
    setTimeout(()=>{inp.placeholder=PLACEHOLDERS[phIdx];inp.style.opacity='1'},200);
  },3500);
}

// ========== TOAST NOTIFICATIONS ==========
function showToast(message,type='info'){let c=document.querySelector('.toast-container');if(!c){c=document.createElement('div');c.className='toast-container';document.body.appendChild(c)}const t=document.createElement('div');t.className='toast '+type;t.textContent=message;c.appendChild(t);setTimeout(()=>t.remove(),3000)}

// ========== COMMAND DETECTION ==========
const COMMAND_PREFIXES=['distribuye','distribui','reparte','asigna','genera','crea','agrega','cambia','actualiza','edita','modifica','analiza','reporta','resume','agenda','planifica','programa','duplica','copia','aprueba','completa'];
function isCommand(text){const l=text.toLowerCase().trim();return COMMAND_PREFIXES.some(p=>l.startsWith(p))}

// ========== AI QUICK ASK (with command routing) ==========
async function askAI(q){
  const inp=document.getElementById('aiInput');
  const question=q||inp.value.trim();
  if(!question)return;
  inp.value='';
  if(isCommand(question)){await processCommand(question);return}
  await askAIRegular(question);
}

async function askAIRegular(question){
  const btn=document.getElementById('aiBtn');
  btn.disabled=true;btn.textContent='Pensando...';
  const ansDiv=document.getElementById('aiAnswer');
  ansDiv.style.display='block';
  ansDiv.innerHTML='<div class="ai-answer"><div class="loader-dots" style="display:flex;gap:4px"><span></span><span></span><span></span></div></div>';
  try{
    const r=await fetch('/api/ai/ask',{method:'POST',headers:hdrs,body:JSON.stringify({question})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    ansDiv.innerHTML=`<div class="ai-answer"><button class="close-btn" onclick="document.getElementById('aiAnswer').style.display='none'">&times;</button>${md(d.answer)}</div>`;
    typeEffect(ansDiv.querySelector('.ai-answer'));
  }catch(e){ansDiv.innerHTML=`<div class="ai-answer" style="border-left-color:#EF4444">Error: ${esc(e.message)}<button class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</button></div>`}
  btn.disabled=false;btn.innerHTML='<i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Preguntar';
}

// ========== COMMAND PROCESSING ==========
let pendingCommand=null;

async function processCommand(command){
  const btn=document.getElementById('aiBtn');
  btn.disabled=true;btn.innerHTML='<i class="feather" data-icon="cpu" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Procesando...';
  const ansDiv=document.getElementById('aiAnswer');
  ansDiv.style.display='block';
  ansDiv.innerHTML='<div class="ai-answer"><div class="loader-dots" style="display:flex;gap:4px"><span></span><span></span><span></span></div><br><span style="font-size:.8rem;color:var(--mt)">Interpretando comando...</span></div>';
  try{
    const r=await fetch('/api/ai/process-command',{method:'POST',headers:hdrs,body:JSON.stringify({command})});
    const parsed=await r.json();
    if(parsed.error)throw new Error(parsed.error);
    if(parsed.action==='unknown'){
      ansDiv.innerHTML=`<div class="ai-answer" style="border-left-color:#F59E0B"><button class="close-btn" onclick="document.getElementById('aiAnswer').style.display='none'">&times;</button><strong>Comando no reconocido</strong><br><br>${esc(parsed.summary)}</div>`;
    }else if(parsed.action==='analyze'){
      ansDiv.innerHTML=`<div class="ai-answer"><button class="close-btn" onclick="document.getElementById('aiAnswer').style.display='none'">&times;</button><div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><span style="padding:4px 10px;border-radius:6px;background:rgba(139,92,246,.12);color:#8B5CF6;font-size:.75rem;font-weight:700">ANALISIS IA</span></div>${md(parsed.analysisResult||parsed.summary)}</div>`;
      typeEffect(ansDiv.querySelector('.ai-answer'));
    }else if(parsed.requiresConfirmation){
      ansDiv.innerHTML='';ansDiv.style.display='none';
      showCommandConfirmation(parsed);
    }else{
      await executeAction(parsed);
    }
  }catch(e){
    ansDiv.innerHTML=`<div class="ai-answer" style="border-left-color:#EF4444"><button class="close-btn" onclick="document.getElementById('aiAnswer').style.display='none'">&times;</button>Error: ${esc(e.message)}</div>`;
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.innerHTML='<i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Preguntar';
}

function showCommandConfirmation(parsed){
  pendingCommand=parsed;
  const preview=document.getElementById('cmdPreview');
  let html='';
  if(parsed.action==='distribute'){
    html=`<h3 style="margin:0 0 .8rem 0;font-size:1.1rem;color:var(--tx)"><i class="feather" data-icon="share-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Distribuir Tareas</h3><p style="color:var(--mt);font-size:.84rem;margin-bottom:1rem">${esc(parsed.summary)}</p><div style="background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;padding:.8rem;margin-bottom:.75rem">${(parsed.params.users||[]).map(u=>`<div style="display:flex;justify-content:space-between;padding:.4rem 0;font-size:.9rem;border-bottom:1px solid var(--glass-border)"><span style="color:var(--tx)">${esc(u.name)}</span><span style="font-weight:700;color:#8B5CF6">${u.percentage}%</span></div>`).join('')}</div><div style="font-size:.8rem;color:var(--mt)">~${parsed.affectedCount||'?'} tareas seran distribuidas</div>`;
  }else if(parsed.action==='generate'){
    html=`<h3 style="margin:0 0 .8rem 0;font-size:1.1rem;color:var(--tx)"><i class="feather" data-icon="plus-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Generar Tareas</h3><p style="color:var(--mt);font-size:.84rem;margin-bottom:1rem">${esc(parsed.summary)}</p><div style="font-size:.9rem;color:var(--tx)"><div style="margin-bottom:.3rem">Cantidad: <strong>${parsed.params.count||0}</strong></div><div style="margin-bottom:.3rem">Tipo: <strong>${esc(parsed.params.tipo||'General')}</strong></div>${parsed.params.asignado_nombre?`<div style="margin-bottom:.3rem">Asignado a: <strong>${esc(parsed.params.asignado_nombre)}</strong></div>`:''}<div>Prioridad: <strong>${esc(parsed.params.prioridad||'Media')}</strong></div></div>`;
  }else if(parsed.action==='bulk_edit'){
    const filters=parsed.params.filters||{};const changes=parsed.params.changes||{};
    const isAssign=changes.asignado_nombre||changes.asignado;
    const icon=isAssign?'user-plus':'edit-3';
    const title=isAssign?'Asignar Tareas':'Edicion Masiva';
    html=`<h3 style="margin:0 0 .8rem 0;font-size:1.1rem;color:var(--tx)"><i class="feather" data-icon="${icon}" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> ${title}</h3><p style="color:var(--mt);font-size:.84rem;margin-bottom:1rem">${esc(parsed.summary)}</p><div style="font-size:.9rem;color:var(--tx)"><div style="margin-bottom:.5rem"><strong>Filtros:</strong> ${Object.entries(filters).map(([k,v])=>`<span style="display:inline-block;padding:2px 8px;border-radius:6px;background:rgba(59,130,246,.1);color:#3B82F6;font-size:.8rem;margin:2px">${esc(k)}=${esc(v)}</span>`).join(' ')}</div><div style="margin-bottom:.5rem"><strong>${isAssign?'Asignar a':'Cambios'}:</strong> ${Object.entries(changes).map(([k,v])=>`<span style="display:inline-block;padding:2px 8px;border-radius:6px;background:rgba(16,185,129,.1);color:#10B981;font-size:.8rem;margin:2px">${isAssign?esc(v):esc(k)+' â†’ '+esc(v)}</span>`).join(' ')}</div><div style="color:#F59E0B;font-weight:600">~${parsed.affectedCount||0} tareas afectadas</div></div>`;
  }
  preview.innerHTML=html;
  document.getElementById('cmdOverlay').style.display='flex';
  if(window.loadFeatherIcons)loadFeatherIcons();
}

function closeCmdModal(){document.getElementById('cmdOverlay').style.display='none';pendingCommand=null}
function confirmCommand(){if(pendingCommand)executeAction(pendingCommand)}

// ========== ACTION EXECUTORS ==========
async function executeAction(parsed){
  closeCmdModal();
  const ansDiv=document.getElementById('aiAnswer');
  ansDiv.style.display='block';
  ansDiv.innerHTML='<div class="ai-answer"><div class="loader-dots" style="display:flex;gap:4px"><span></span><span></span><span></span></div><br><span style="font-size:.8rem;color:var(--mt)">Ejecutando comando...</span></div>';
  try{
    let result='';
    switch(parsed.action){
      case 'distribute':result=await executeDistribute(parsed.params);break;
      case 'generate':result=await executeGenerate(parsed.params);break;
      case 'bulk_edit':result=await executeBulkEdit(parsed.params);break;
      default:throw new Error('Accion no soportada: '+parsed.action);
    }
    ansDiv.innerHTML=`<div class="ai-answer" style="border-left-color:#10B981"><button class="close-btn" onclick="document.getElementById('aiAnswer').style.display='none'">&times;</button><div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><span style="padding:4px 10px;border-radius:6px;background:rgba(16,185,129,.12);color:#10B981;font-size:.75rem;font-weight:700">EJECUTADO</span></div>${md(result)}</div>`;
    loadStylyTasksIntel();
    showToast('Comando ejecutado correctamente','success');
  }catch(e){
    ansDiv.innerHTML=`<div class="ai-answer" style="border-left-color:#EF4444"><button class="close-btn" onclick="document.getElementById('aiAnswer').style.display='none'">&times;</button><strong>Error:</strong> ${esc(e.message)}</div>`;
    showToast('Error: '+e.message,'error');
  }
}

async function executeDistribute(params){
  const tasksR=await fetch('/api/styly/tasks',{headers:hdrs});
  const tasksD=await tasksR.json();
  let allTasks=tasksD.tasks||[];
  const filters=params.filters||{};
  // Filter: unassigned + matching filters
  let targetTasks=allTasks.filter(t=>{
    if(t.estado==='Completada')return false;
    if(t.asignados&&t.asignados.length>0)return false;
    if(filters.estado&&t.estado!==filters.estado)return false;
    if(filters.prioridad&&t.prioridad!==filters.prioridad)return false;
    return true;
  });
  // Sort by priority
  const prioOrder={'Alta':0,'Media':1,'Baja':2};
  targetTasks.sort((a,b)=>(prioOrder[a.prioridad]||1)-(prioOrder[b.prioridad]||1));
  if(targetTasks.length===0)return'No se encontraron tareas sin asignar que coincidan con los filtros.';
  // Get users
  const usersR=await fetch('/api/styly/users',{headers:hdrs});
  const usersD=await usersR.json();
  const allUsers=usersD.users||[];
  // Distribute
  const distribution=params.users||[];
  let assigned=0;const results=[];
  for(const dist of distribution){
    const user=allUsers.find(u=>u.name.toLowerCase().includes(dist.name.toLowerCase()));
    if(!user){results.push('- Usuario "'+dist.name+'" no encontrado, omitido');continue}
    const count=Math.round(targetTasks.length*dist.percentage/100);
    const batch=targetTasks.splice(0,count);
    for(const task of batch){
      await fetch('/api/styly/tasks/'+task.id+'/asignados',{method:'POST',headers:hdrs,body:JSON.stringify({user_id:user.id})});
      assigned++;
    }
    results.push('- **'+user.name+'**: '+count+' tareas ('+dist.percentage+'%)');
  }
  return'## Distribucion completada\n\n'+assigned+' tareas asignadas:\n\n'+results.join('\n');
}

async function executeGenerate(params){
  const{count,tipo,proyecto_nombre,asignado_nombre,prioridad}=params;
  // Resolve project
  let proyecto_id=params.proyecto_id;
  if(!proyecto_id&&proyecto_nombre){
    const projR=await fetch('/api/styly/projects',{headers:hdrs});
    const projD=await projR.json();
    const proj=(projD.projects||[]).find(p=>(p.name||p.nombre||'').toLowerCase().includes(proyecto_nombre.toLowerCase()));
    if(proj)proyecto_id=proj.id;
  }
  if(!proyecto_id){
    const projR=await fetch('/api/styly/projects',{headers:hdrs});
    const projD=await projR.json();
    if(projD.projects&&projD.projects.length>0)proyecto_id=projD.projects[0].id;
  }
  // Resolve user
  let asignadoIds=[];
  if(asignado_nombre){
    const usersR=await fetch('/api/styly/users',{headers:hdrs});
    const usersD=await usersR.json();
    const user=(usersD.users||[]).find(u=>u.name.toLowerCase().includes(asignado_nombre.toLowerCase()));
    if(user)asignadoIds=[user.id];
  }
  // Build tasks
  const ts=Date.now();const tasks=[];
  for(let i=1;i<=count;i++){
    const deadline=new Date();deadline.setDate(deadline.getDate()+7);
    tasks.push({
      task_id:'AI-'+String(ts).slice(-4)+'-'+i,
      titulo:(tipo||'Tarea')+' #'+i,
      proyecto_id:proyecto_id,
      prioridad:prioridad||'Media',
      fecha_vencimiento:deadline.toISOString().split('T')[0],
      asignados:asignadoIds
    });
  }
  const r=await fetch('/api/styly/tasks/bulk-create',{method:'POST',headers:hdrs,body:JSON.stringify({tasks})});
  const d=await r.json();
  if(d.error)throw new Error(d.error);
  return'## Tareas generadas\n\n**'+d.created+'** tareas creadas de '+d.total_attempted+' intentadas.'+(asignado_nombre?'\n\nAsignadas a: **'+asignado_nombre+'**':'');
}

async function executeBulkEdit(params){
  const{filters,changes}=params;
  const tasksR=await fetch('/api/styly/tasks',{headers:hdrs});
  const tasksD=await tasksR.json();
  let allTasks=tasksD.tasks||[];
  console.log('[BulkEdit] Total tasks:',allTasks.length,'Filters:',JSON.stringify(filters),'Changes:',JSON.stringify(changes));
  // Apply filters â€” support both "proyecto" and "proyecto_nombre"
  const projFilter=filters.proyecto_nombre||filters.proyecto||null;
  let targetTasks=allTasks.filter(t=>{
    if(filters.estado&&t.estado!==filters.estado)return false;
    if(filters.prioridad&&t.prioridad!==filters.prioridad)return false;
    if(projFilter){
      const pn=(t.proyecto_nombre||'').toLowerCase();
      if(!pn.includes(projFilter.toLowerCase()))return false;
    }
    if(filters.asignado){
      const names=(t.asignados||[]).map(a=>(a.name||'').toLowerCase());
      if(!names.some(n=>n.includes(filters.asignado.toLowerCase())))return false;
    }
    return true;
  });
  console.log('[BulkEdit] Filtered tasks:',targetTasks.length,targetTasks.map(t=>t.titulo+' ['+t.estado+'] ['+t.proyecto_nombre+']'));
  if(targetTasks.length===0){
    // Debug: show what projects exist
    const projectNames=[...new Set(allTasks.map(t=>t.proyecto_nombre))];
    const estados=[...new Set(allTasks.map(t=>t.estado))];
    console.log('[BulkEdit] Available projects:',projectNames,'Available estados:',estados);
    return'No se encontraron tareas que coincidan con los filtros.\n\nProyectos disponibles: '+projectNames.join(', ')+'\nEstados encontrados: '+estados.join(', ');
  }
  let updated=0;const results=[];
  // Handle assignment change
  const assignName=changes.asignado_nombre||changes.asignado||null;
  if(assignName){
    const usersR=await fetch('/api/styly/users',{headers:hdrs});
    const usersD=await usersR.json();
    const user=(usersD.users||[]).find(u=>u.name.toLowerCase().includes(assignName.toLowerCase()));
    if(!user)return'Usuario "'+assignName+'" no encontrado en el sistema.';
    for(const task of targetTasks){
      const r=await fetch('/api/styly/tasks/'+task.id+'/asignados',{method:'POST',headers:hdrs,body:JSON.stringify({user_id:user.id})});
      const d=await r.json();
      if(d.ok)updated++;
    }
    results.push('Asignadas a **'+user.name+'**');
  }
  // Handle other field changes (estado, prioridad)
  const fieldChanges={};
  if(changes.estado)fieldChanges.estado=changes.estado;
  if(changes.prioridad)fieldChanges.prioridad=changes.prioridad;
  if(Object.keys(fieldChanges).length>0){
    let fieldUpdated=0;
    for(const task of targetTasks){
      const r=await fetch('/api/styly/tasks/'+task.id,{method:'PUT',headers:hdrs,body:JSON.stringify(fieldChanges)});
      const d=await r.json();
      if(!d.error)fieldUpdated++;
    }
    if(!assignName)updated=fieldUpdated;
    results.push(Object.entries(fieldChanges).map(([k,v])=>'`'+k+' â†’ '+v+'`').join(', '));
  }
  return'## Edicion masiva completada\n\n**'+updated+'** tareas actualizadas de '+targetTasks.length+' encontradas.\n\n'+results.join('\n');
}

function typeEffect(el){
  const html=el.innerHTML;
  const closeBtn=html.match(/<button.*?<\/button>/)?.[0]||'';
  const content=html.replace(/<button.*?<\/button>/,'');
  el.innerHTML=closeBtn;
  let i=0;
  const raw=content;
  el.insertAdjacentHTML('beforeend','<span id="typeTarget"></span>');
  const target=document.getElementById('typeTarget');
  // For performance, insert in chunks
  const chunkSize=5;
  const timer=setInterval(()=>{
    if(i>=raw.length){clearInterval(timer);target.outerHTML=raw;return}
    target.innerHTML=raw.slice(0,i+chunkSize);
    i+=chunkSize;
  },10);
}

// ========== AI SUGGESTIONS ==========
async function loadSuggestions(){
  try{
    const r=await fetch('/api/ai/suggestions',{headers:hdrs});
    const d=await r.json();
    const el=document.getElementById('aiChips');if(!el)return;
    el.innerHTML=(d.suggestions||[]).map((s,i)=>
      `<span class="ai-chip" onclick="askAI('${esc(s.question)}')" style="animation:stagger .3s ease ${i*100}ms both">${s.icon} ${esc(s.text)}</span>`
    ).join('');
  }catch(_){}
}

const CMD_CHIPS=[
  {icon:'share-2',text:'Distribuir tareas',cmd:'Distribuye las tareas pendientes entre el equipo equitativamente'},
  {icon:'plus-circle',text:'Generar tareas',cmd:'Genera 5 tareas de desarrollo en STYLY'},
  {icon:'edit-3',text:'Edicion masiva',cmd:'Cambia prioridad a Alta en todas las tareas pendientes'},
  {icon:'bar-chart-2',text:'Analizar STYLY',cmd:'Analiza todas las tareas de STYLY'}
];
function renderCmdChips(){
  const el=document.getElementById('cmdChips');if(!el)return;
  el.innerHTML=CMD_CHIPS.map((c,i)=>
    `<span class="ai-chip" onclick="askAI('${esc(c.cmd)}')" style="background:rgba(139,92,246,0.12);border:1px solid rgba(139,92,246,0.25);animation:stagger .3s ease ${i*100+200}ms both"><i class="feather" data-icon="${c.icon}" style="display:inline-block;width:.85em;height:.85em"></i> ${esc(c.text)}</span>`
  ).join('');
}

// ========== CHAT ==========
let chatOpen=false, chatConvId=null, chatConvs=[];
function toggleChat(){
  chatOpen=!chatOpen;
  const panel=document.getElementById('chatPanel');
  const toggle=document.getElementById('chatToggle');
  if(chatOpen){
    panel.style.display='block';
    toggle.innerHTML='<i class="feather" data-icon="message-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Cerrar chat';
    renderChat();
    loadConversations();
  }else{
    panel.style.display='none';
    toggle.innerHTML='<i class="feather" data-icon="message-circle" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Abrir chat completo con IA';
  }
}

async function loadConversations(){
  try{
    const r=await fetch('/api/ai/conversations',{headers:hdrs});
    const d=await r.json();chatConvs=d.conversations||[];
    renderChatSelector();
  }catch(_){}
}

function renderChatSelector(){
  const sel=document.getElementById('chatConvSel');if(!sel)return;
  sel.innerHTML=`<option value="">Nueva conversacion</option>`+chatConvs.map(c=>{
    const exp=Math.ceil((new Date(c.expires_at)-Date.now())/(86400000));
    return`<option value="${c.id}" ${c.id===chatConvId?'selected':''}>${esc(c.title)} (${exp}d)</option>`;
  }).join('');
}

function renderChat(){
  document.getElementById('chatPanel').innerHTML=`
    <div class="chat-panel">
      <div class="chat-header">
        <span><i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Asistente IA</span>
        <select id="chatConvSel" onchange="switchConv(this.value)"><option value="">Nueva conversacion</option></select>
        <button onclick="newConv()">+ Nueva</button>
        <div style="margin-left:auto"><button onclick="toggleChat()">Cerrar</button></div>
      </div>
      <div class="chat-messages" id="chatMsgs"><div style="color:var(--mt);text-align:center;padding:2rem;font-size:.82rem">Inicia una conversacion...</div></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Escribe un mensaje..." onkeydown="if(event.key==='Enter')sendChat()">
        <button onclick="sendChat()">Enviar</button>
      </div>
      <div class="chat-notice">Las conversaciones se guardan 7 dias. ${chatConvId?`<a onclick="downloadConv()">ðŸ“¥ Descargar esta conversacion</a>`:''}</div>
    </div>`;
}

async function newConv(){
  try{
    const r=await fetch('/api/ai/conversations',{method:'POST',headers:hdrs,body:JSON.stringify({title:'Chat '+ new Date().toLocaleDateString('es-MX')})});
    const d=await r.json();chatConvId=d.conversation.id;
    await loadConversations();renderChat();renderChatSelector();
  }catch(_){}
}

async function switchConv(id){
  if(!id){chatConvId=null;renderChat();return}
  chatConvId=parseInt(id);
  try{
    const r=await fetch('/api/ai/conversations/'+chatConvId,{headers:hdrs});
    const d=await r.json();
    const msgs=d.conversation.messages||[];
    const el=document.getElementById('chatMsgs');
    el.innerHTML=msgs.length?msgs.map(m=>`<div class="chat-msg ${m.role==='user'?'user':'bot'}">${m.role==='user'?esc(m.content):md(m.content)}</div>`).join(''):'<div style="color:var(--mt);text-align:center;padding:2rem;font-size:.82rem">Conversacion vacia</div>';
    el.scrollTop=el.scrollHeight;
    renderChatNotice();
  }catch(_){}
}

function renderChatNotice(){
  const n=document.querySelector('.chat-notice');
  if(n)n.innerHTML=`Las conversaciones se guardan 7 dias. ${chatConvId?`<a onclick="downloadConv()">ðŸ“¥ Descargar esta conversacion</a>`:''}`;
}

async function sendChat(){
  const inp=document.getElementById('chatInput');
  const q=inp.value.trim();if(!q)return;
  inp.value='';

  // Create conversation if needed
  if(!chatConvId)await newConv();

  const el=document.getElementById('chatMsgs');
  // Clear placeholder
  if(el.querySelector('div[style]'))el.innerHTML='';
  el.innerHTML+=`<div class="chat-msg user">${esc(q)}</div>`;
  el.innerHTML+=`<div class="chat-msg bot" id="botTyping"><div class="loader-dots" style="display:flex;gap:4px"><span></span><span></span><span></span></div></div>`;
  el.scrollTop=el.scrollHeight;

  try{
    const r=await fetch('/api/ai/ask',{method:'POST',headers:hdrs,body:JSON.stringify({question:q,conversation_id:chatConvId})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    const typing=document.getElementById('botTyping');
    if(typing)typing.outerHTML=`<div class="chat-msg bot">${md(d.answer)}</div>`;
    el.scrollTop=el.scrollHeight;
  }catch(e){
    const typing=document.getElementById('botTyping');
    if(typing)typing.outerHTML=`<div class="chat-msg bot" style="border-color:#EF4444">Error: ${esc(e.message)}</div>`;
  }
}

function downloadConv(){
  if(!chatConvId)return;
  window.open('/api/ai/conversations/'+chatConvId+'/download?token='+token,'_blank');
}

// ========== STATS ROW ==========
async function loadStats(){
  try{
    const r=await fetch('/api/admin/business-stats',{headers:hdrs});
    const d=await r.json();
    if(d.error)return;
    const pending=d.pendingApproval||[];
    const totalPending=pending.reduce((s,p)=>s+p.count,0);
    const totalApproved=d.businesses.reduce((s,b)=>s+b.approved,0);
    const el=document.getElementById('statsRow');
    el.innerHTML=`
      <div class="stat-box">
        <div class="s-label">Contenido esta semana</div>
        <div class="s-value">${d.totalThisWeek}<span class="stat-change ${d.weekChange>=0?'up':'down'}">${d.weekChange>=0?'â†‘':'â†“'}${Math.abs(d.weekChange)}%</span></div>
        <div class="s-sub">vs ${d.totalLastWeek} semana pasada</div>
      </div>
      <div class="stat-box">
        <div class="s-label">Aprobados</div>
        <div class="s-value">${totalApproved}</div>
        <div class="s-sub">${d.totalThisWeek?Math.round(totalApproved/d.totalThisWeek*100):0}% ratio aprobacion</div>
      </div>
      <div class="stat-box">
        <div class="s-label">Negocios activos</div>
        <div class="s-value">${d.businesses.length}<span style="font-size:.8rem;color:var(--mt)"> / 4</span></div>
        <div class="s-sub">${d.businesses.map(b=>BIZ_ICONS[b.business]||'').join(' ')}</div>
      </div>
      <div class="stat-box">
        <div class="s-label">Pendientes por aprobar</div>
        <div class="s-value">${totalPending}</div>
        <div class="s-sub">${pending.map(p=>(BIZ_ICONS[p.business]||'')+p.count).join(' ')}</div>
      </div>`;
  }catch(_){}
}

// ========== TEAM STATS ==========
async function loadTeam(){
  const el=document.getElementById('empCard');if(!el)return;
  if(user.role!=='admin'){el.innerHTML='<div style="color:var(--mt);font-size:.82rem;padding:1rem;text-align:center">Solo admins ven stats del equipo</div>';return}
  try{
    const r=await fetch('/api/admin/team-stats',{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    const team=d.team||[];
    if(!team.length){el.innerHTML='<div style="color:var(--mt);font-size:.82rem;padding:1rem;text-align:center">No hay empleados activos</div>';return}

    let alerts=[];
    const now=Date.now();

    el.innerHTML=team.map((t,i)=>{
      const ratio=t.generated>0?Math.round(t.approved/t.generated*100):0;
      const lastMs=t.last_activity?now-new Date(t.last_activity).getTime():Infinity;
      const lastDays=Math.floor(lastMs/86400000);
      let lastLabel=t.last_activity?(lastDays===0?'Hoy':lastDays===1?'Ayer':`Hace ${lastDays}d`):'Sin actividad';
      const isInactive=lastDays>=3;
      if(isInactive)alerts.push({type:'red',text:`${t.name} no ha generado contenido en ${lastDays}+ dias`});
      if(t.generated>=3&&ratio<50)alerts.push({type:'yellow',text:`${t.name} tiene ratio de aprobacion bajo (${ratio}%)`});
      if(t.generated>=5)alerts.push({type:'green',text:`${t.name} lleva buena racha generando contenido`});

      const byBiz=t.by_business||{};
      return`<div class="emp-row">
        <div class="emp-avatar" style="background:${EMP_COLORS[i%EMP_COLORS.length]}">${(t.name||'?')[0].toUpperCase()}</div>
        <div class="emp-info">
          <div class="emp-name">${esc(t.name)} <span style="font-size:.65rem;color:var(--mt)">${esc(t.role)}</span></div>
          <div class="emp-biz-chips">${Object.entries(byBiz).map(([b,n])=>`<span class="emp-biz-chip" style="background:${BIZ_COLORS[b]||'#666'}">${BIZ_ICONS[b]||''} ${n}</span>`).join('')}</div>
        </div>
        <div class="emp-stats">
          <div class="emp-num"><div class="n">${t.generated}</div><div class="l">Gen</div></div>
          <div class="emp-num"><div class="n">${t.approved}</div><div class="l">Apr</div></div>
          <div class="emp-num"><div class="n">${ratio}%</div><div class="l">Ratio</div></div>
          <div class="emp-num"><div class="n" style="font-size:.72rem;${isInactive?'color:#EF4444':''}">${lastLabel}</div><div class="l">Ultima</div></div>
        </div>
      </div>`;
    }).join('')+
    (alerts.length?'<div style="margin-top:.5rem">'+alerts.slice(0,5).map(a=>`<div class="emp-alert ${a.type}">${a.type==='red'?'<i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#EF4444" aria-hidden="true"></i>':a.type==='yellow'?'<i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#FCD34D" aria-hidden="true"></i>':'<i class="feather" data-icon="circle" style="display:inline-block;width:1em;height:1em;color:#10B981" aria-hidden="true"></i>'} ${esc(a.text)}</div>`).join('')+'</div>':'');
  }catch(e){el.innerHTML=`<div style="color:var(--mt);font-size:.82rem;padding:1rem">${esc(e.message)}</div>`}
}

// ========== CALENDAR 7 DAYS ==========
async function loadCalendar(){
  const el=document.getElementById('calMini');if(!el)return;
  try{
    const r=await fetch('/api/admin/upcoming-content',{headers:hdrs});
    const d=await r.json();
    const items=d.items||[];
    const days=[];
    const today=new Date();today.setHours(0,0,0,0);
    const dayNames=['Dom','Lun','Mar','Mie','Jue','Vie','Sab'];
    for(let i=0;i<7;i++){
      const dt=new Date(today);dt.setDate(dt.getDate()+i);
      const ds=dt.toISOString().slice(0,10);
      days.push({
        label:i===0?'Hoy':i===1?'Manana':dayNames[dt.getDay()]+' '+dt.getDate(),
        date:ds,
        items:items.filter(it=>(it.scheduled_date||'').slice(0,10)===ds)
      });
    }
    el.innerHTML=days.map(day=>`
      <div class="cal-day">
        <div class="cal-day-header"><span>${day.label}</span><span class="date">${day.date.slice(5)}</span></div>
        ${day.items.length?day.items.map(it=>`
          <div class="cal-day-item" style="background:${BIZ_COLORS[it.business]||'#666'}22">
            <span>${BIZ_ICONS[it.business]||'<i class="feather" data-icon="clipboard" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i>'}</span>
            <span>${esc(it.format_type||'')}</span>
            <span style="margin-left:auto;opacity:.6">${it.scheduled_platform||''}</span>
          </div>`).join('')
          :`<div class="cal-day-empty">Sin contenido agendado</div>`}
      </div>`).join('');
  }catch(e){el.innerHTML=`<div style="color:var(--mt);font-size:.82rem;padding:1rem">${esc(e.message)}</div>`}
}

// ========== BUSINESS INTELLIGENCE ==========
async function loadBizIntel(){
  const grid=document.getElementById('bizGrid');if(!grid)return;
  try{
    const [statsR, fmtR, upR]=await Promise.all([
      fetch('/api/admin/business-stats',{headers:hdrs}).then(r=>r.json()),
      fetch('/api/admin/format-usage',{headers:hdrs}).then(r=>r.json()),
      fetch('/api/admin/upcoming-content',{headers:hdrs}).then(r=>r.json())
    ]);

    const bizStats={};(statsR.businesses||[]).forEach(b=>bizStats[b.business]=b);
    const usage=fmtR.usage||{};
    const upcoming=upR.items||[];

    // Ideas count
    let ideasByBiz={};
    try{
      // We don't have a direct endpoint for ideas count per biz, calculate from suggestions context
    }catch(_){}

    grid.innerHTML=BUSINESSES.map(biz=>{
      const st=bizStats[biz.id]||{total:0,approved:0,drafts:0};
      const u=usage[biz.id]||{used:[],unused:[]};
      const upCount=upcoming.filter(i=>i.business===biz.id).length;
      return`<div class="biz-intel-card" style="--c:${biz.color}">
        <div class="bi-header"><span class="bi-icon">${biz.icon}</span><span class="bi-name">${biz.name}</span></div>
        <div class="bi-stat"><span class="k">Generado esta semana</span><span>${st.total}</span></div>
        <div class="bi-stat"><span class="k">Aprobados</span><span>${st.approved}</span></div>
        <div class="bi-stat"><span class="k">Agendado prox 7d</span><span>${upCount}</span></div>
        <div class="bi-formats">
          ${u.used.map(f=>`<span class="bi-fmt used">${f.format_type} (${f.times_used})</span>`).join('')}
          ${u.unused.map(f=>`<span class="bi-fmt unused">${f}</span>`).join('')}
        </div>
        ${upCount===0?'<span class="bi-no-sched">Sin agendar esta semana</span>':''}
        <a class="bi-go" href="${biz.url}">Ir al modulo â†’</a>
      </div>`;
    }).join('');
  }catch(e){grid.innerHTML=`<div style="color:var(--mt)">${esc(e.message)}</div>`}
}

// ========== STYLY TASKS INTELLIGENCE (Full Integration) ==========
let stylyTasksCache=null;
async function loadStylyTasksIntel(){
  const el=document.getElementById('stylyTasksArea');if(!el)return;
  el.innerHTML='<div style="color:var(--mt);font-size:.82rem;padding:1rem;text-align:center"><div class="loader-dots" style="display:inline-flex;gap:4px"><span></span><span></span><span></span></div><br>Cargando tareas de STYLY...</div>';
  try{
    const r=await fetch('/api/styly/tasks/analytics',{headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    stylyTasksCache=d;
    renderStylyTasks(el,d);
  }catch(e){el.innerHTML=`<div style="color:var(--mt);font-size:.82rem;padding:1rem">Error: ${esc(e.message)}</div>`}
}

function renderStylyTasks(el,d){
  const s=d.stats;
  const projEntries=Object.entries(d.byProject).sort((a,b)=>b[1].total-a[1].total);
  const userEntries=Object.entries(d.byUser).filter(([k])=>k!=='Sin asignar').sort((a,b)=>b[1].total-a[1].total);
  const bp=d.byPriority;
  const urgent=d.urgent||[];
  const recent=d.recentlyUpdated||[];

  // Donut chart SVG values
  const R=28, C=2*Math.PI*R;
  const offset=C-(s.completionRate/100)*C;

  el.innerHTML=`
    <!-- KPI ROW -->
    <div class="kpi-grid">
      <div class="kpi-card" style="border-top:3px solid #3B82F6">
        <div class="kpi-label">Total</div>
        <div class="kpi-value" style="color:#3B82F6">${s.total}</div>
      </div>
      <div class="kpi-card" style="border-top:3px solid #EF4444">
        <div class="kpi-label">Pendientes</div>
        <div class="kpi-value" style="color:#EF4444">${s.pendiente}</div>
        <div class="kpi-bar"><div class="kpi-bar-fill" style="background:#EF4444;width:${s.total>0?s.pendiente/s.total*100:0}%"></div></div>
      </div>
      <div class="kpi-card" style="border-top:3px solid #F59E0B">
        <div class="kpi-label">En Progreso</div>
        <div class="kpi-value" style="color:#F59E0B">${s.enProgreso}</div>
        <div class="kpi-bar"><div class="kpi-bar-fill" style="background:#F59E0B;width:${s.total>0?s.enProgreso/s.total*100:0}%"></div></div>
      </div>
      <div class="kpi-card" style="border-top:3px solid #10B981">
        <div class="kpi-label">Completadas</div>
        <div class="kpi-value" style="color:#10B981">${s.completada}</div>
        <div class="kpi-bar"><div class="kpi-bar-fill" style="background:#10B981;width:${s.total>0?s.completada/s.total*100:0}%"></div></div>
      </div>
      <div class="kpi-card" style="border-top:3px solid #EC4899">
        <div class="kpi-label">Completado</div>
        <div class="donut-wrap">
          <div class="donut">
            <svg viewBox="0 0 64 64"><circle class="donut-bg" cx="32" cy="32" r="${R}"/><circle class="donut-fill" cx="32" cy="32" r="${R}" stroke="#EC4899" stroke-dasharray="${C}" stroke-dashoffset="${offset}"/></svg>
            <div class="donut-center" style="color:#EC4899">${s.completionRate}%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TWO COLUMNS: Projects + Users -->
    <div class="dash-grid-2">
      <div class="dash-panel">
        <div class="dash-panel-title"><i class="feather" data-icon="target" style="display:inline-block;width:1em;height:1em;color:#EC4899" aria-hidden="true"></i> Progreso por Proyecto</div>
        ${projEntries.map(([name,p])=>{
          const pct=p.completion;
          const color=p.color||'#6B7280';
          return `<div class="progress-row">
            <div class="progress-header">
              <span class="progress-name">${esc(name)}</span>
              <span class="progress-meta" style="color:${color}">${pct}% <span style="color:var(--mt);font-weight:400">(${p.completada}/${p.total})</span></span>
            </div>
            <div class="progress-track"><div class="progress-fill" style="background:${color};width:${pct}%"></div></div>
          </div>`;
        }).join('')}
      </div>

      <div class="dash-panel">
        <div class="dash-panel-title"><i class="feather" data-icon="users" style="display:inline-block;width:1em;height:1em;color:#8B5CF6" aria-hidden="true"></i> Carga por Usuario</div>
        ${userEntries.map(([name,u])=>`
          <div class="progress-row">
            <div class="progress-header">
              <span class="progress-name">${esc(name)}</span>
              <div class="user-badges">
                <span class="user-badge red">${u.pendiente}</span>
                <span class="user-badge yellow">${u.enProgreso||0}</span>
                <span class="user-badge green">${u.completada}</span>
              </div>
            </div>
            <div class="progress-stacked">
              <div style="background:#10B981;width:${u.total>0?u.completada/u.total*100:0}%"></div>
              <div style="background:#F59E0B;width:${u.total>0?(u.enProgreso||0)/u.total*100:0}%"></div>
              <div style="background:#EF4444;width:${u.total>0?u.pendiente/u.total*100:0}%"></div>
            </div>
          </div>`).join('')}
      </div>
    </div>

    <!-- URGENT TASKS + PRIORITY BREAKDOWN -->
    <div class="dash-grid-2-1">
      <div class="dash-panel">
        <div class="dash-panel-title"><i class="feather" data-icon="alert-triangle" style="display:inline-block;width:1em;height:1em;color:#EF4444" aria-hidden="true"></i> Tareas Urgentes (Alta Prioridad)</div>
        ${urgent.length===0?'<div style="color:var(--mt);font-size:.82rem;text-align:center;padding:1rem"><i class="feather" data-icon="check-circle" style="display:inline-block;width:1em;height:1em;color:#10B981" aria-hidden="true"></i> No hay tareas urgentes pendientes</div>':
        urgent.slice(0,6).map(t=>`
          <div class="urgent-item">
            <div class="urgent-body">
              <div class="urgent-id">${esc(t.task_id)} Â· ${esc(t.module)}</div>
              <div class="urgent-desc">${esc(t.description)}</div>
              <div class="urgent-meta"><i class="feather" data-icon="user" style="display:inline-block;width:.8em;height:.8em;color:currentColor" aria-hidden="true"></i> ${esc(t.assigned_to||'Sin asignar')} ${t.project?'Â· <i class="feather" data-icon="folder" style="display:inline-block;width:.8em;height:.8em;color:currentColor" aria-hidden="true"></i> '+esc(t.project):''}</div>
            </div>
            <select onchange="updateStylyTask(${t.id},this.value)">
              <option value="Pendiente" ${(t.status||'').toLowerCase()==='pendiente'?'selected':''}>Pendiente</option>
              <option value="En Progreso" ${(t.status||'').toLowerCase()==='en progreso'?'selected':''}>En Progreso</option>
              <option value="Completada" ${(t.status||'').toLowerCase()==='completada'?'selected':''}>Completada</option>
            </select>
          </div>
        `).join('')+
        (urgent.length>6?`<div style="font-size:.75rem;color:var(--mt);text-align:center;margin-top:.5rem">+${urgent.length-6} tareas urgentes mas</div>`:'')}
      </div>

      <div class="dash-panel">
        <div class="dash-panel-title"><i class="feather" data-icon="zap" style="display:inline-block;width:1em;height:1em;color:#F59E0B" aria-hidden="true"></i> Por Prioridad</div>
        <div class="priority-row">
          <div class="priority-header"><span class="priority-label" style="color:#DC2626"><i class="feather" data-icon="circle" style="display:inline-block;width:.7em;height:.7em;color:#DC2626" aria-hidden="true"></i> Alta</span><span class="priority-count">${bp.alta.done}/${bp.alta.total}</span></div>
          <div class="progress-track"><div class="progress-fill" style="background:linear-gradient(90deg,#DC2626,#EF4444);width:${bp.alta.total>0?bp.alta.done/bp.alta.total*100:0}%"></div></div>
        </div>
        <div class="priority-row">
          <div class="priority-header"><span class="priority-label" style="color:#D97706"><i class="feather" data-icon="circle" style="display:inline-block;width:.7em;height:.7em;color:#D97706" aria-hidden="true"></i> Media</span><span class="priority-count">${bp.media.done}/${bp.media.total}</span></div>
          <div class="progress-track"><div class="progress-fill" style="background:linear-gradient(90deg,#D97706,#F59E0B);width:${bp.media.total>0?bp.media.done/bp.media.total*100:0}%"></div></div>
        </div>
        <div class="priority-row">
          <div class="priority-header"><span class="priority-label" style="color:#10B981"><i class="feather" data-icon="circle" style="display:inline-block;width:.7em;height:.7em;color:#10B981" aria-hidden="true"></i> Baja</span><span class="priority-count">${bp.baja.done}/${bp.baja.total}</span></div>
          <div class="progress-track"><div class="progress-fill" style="background:linear-gradient(90deg,#059669,#10B981);width:${bp.baja.total>0?bp.baja.done/bp.baja.total*100:0}%"></div></div>
        </div>
      </div>
    </div>

    <!-- RECENT ACTIVITY -->
    ${recent.length?`
    <div class="dash-panel">
      <div class="dash-panel-title"><i class="feather" data-icon="clock" style="display:inline-block;width:1em;height:1em;color:var(--mt)" aria-hidden="true"></i> Actividad Reciente</div>
      ${recent.map(t=>{
        const stLow=(t.status||'').toLowerCase();
        const stColor=stLow==='completada'?'#10B981':(stLow==='en progreso'?'#F59E0B':'#EF4444');
        const stBg=stLow==='completada'?'rgba(16,185,129,.15)':(stLow==='en progreso'?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)');
        return`<div class="activity-item">
          <span class="activity-badge" style="background:${stBg};color:${stColor}">${esc(t.status)}</span>
          <span class="activity-id">${esc(t.task_id)}</span>
          <span class="activity-desc">${esc(t.description)}</span>
          <span class="activity-date">${t.updated_at?new Date(t.updated_at).toLocaleDateString('es-MX',{day:'2-digit',month:'short'}):''}</span>
        </div>`;
      }).join('')}
    </div>`:''}
  `;
}

async function updateStylyTask(id,estado){
  try{
    const r=await fetch('/api/styly/tasks/'+id,{method:'PUT',headers:hdrs,body:JSON.stringify({estado})});
    const d=await r.json();if(d.error)throw new Error(d.error);
    loadStylyTasksIntel();
  }catch(e){console.error('Error updating task:',e.message)}
}

// ========== TRENDS ==========
async function loadTrends(){
  const el=document.getElementById('trendsArea');if(!el)return;
  try{
    const r=await fetch('/api/admin/trends',{headers:hdrs});
    const d=await r.json();
    const trends=d.trends||[];
    el.innerHTML=trends.length?trends.map(t=>`
      <div class="trend-card">
        <span class="trend-icon">${t.icon||'<i class="feather" data-icon="flame" style="display:inline-block;width:1em;height:1em;color:#F59E0B" aria-hidden="true"></i>'}</span>
        <span class="trend-text">${esc(t.text)}</span>
        <a class="trend-action" href="${t.action||'#'}">Crear contenido â†’</a>
      </div>`).join(''):'<div style="color:var(--mt);font-size:.82rem;text-align:center;padding:1rem">No hay tendencias detectadas hoy</div>';
  }catch(_){}
}

// ========== WEEKLY REPORT ==========
let lastReport='';
async function genReport(){
  const btn=document.getElementById('reportBtn');
  btn.disabled=true;btn.textContent='<i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Analizando datos de la semana...';
  try{
    const r=await fetch('/api/ai/weekly-report',{method:'POST',headers:hdrs});
    const d=await r.json();if(d.error)throw new Error(d.error);
    lastReport=d.report;
    document.getElementById('reportBody').innerHTML=`<div class="report-content">${md(d.report)}</div>`;
    document.getElementById('reportOverlay').style.display='flex';
  }catch(e){alert('Error: '+e.message)}
  btn.disabled=false;btn.textContent='<i class="feather" data-icon="bar-chart-2" style="display:inline-block;width:1em;height:1em;color:currentColor" aria-hidden="true"></i> Generar Reporte Semanal';
}

function closeReport(){document.getElementById('reportOverlay').style.display='none'}
function copyReport(){navigator.clipboard.writeText(lastReport).then(()=>alert('Copiado al portapapeles'))}
function downloadReport(){
  const blob=new Blob([lastReport],{type:'text/plain'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='reporte-semanal-'+new Date().toISOString().slice(0,10)+'.txt';
  a.click();URL.revokeObjectURL(a.href);
}

// ========== UTILITIES ==========
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function md(text){
  return String(text||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^### (.+)$/gm,'<h4>$1</h4>')
    .replace(/^## (.+)$/gm,'<h3>$1</h3>')
    .replace(/^# (.+)$/gm,'<h2>$1</h2>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^- (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>')
    .replace(/^---$/gm,'<hr>')
    .replace(/\n{2,}/g,'<br><br>')
    .replace(/\n/g,'<br>');
}

function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
function toggleTheme(){
  const t=document.documentElement.getAttribute('data-theme')==='light'?'':'light';
  document.documentElement.setAttribute('data-theme',t);
  localStorage.setItem('theme',t);
}
function logout(){localStorage.clear();window.location.href='/index.html'}

// Apply saved theme
if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light');
init();
</script>
<script src="/emoji-to-svg.js"></script></body>
</html>
